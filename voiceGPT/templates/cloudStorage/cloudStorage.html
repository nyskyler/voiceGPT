{% extends "base2.html" %}
{% block content %}
<style>
  #myRow {
    display: flex;
    flex-direction: row;
  }
  #sidebar {
    display: flex;
    flex-direction: column;
    flex: auto;
    height: 94vh;
    border-right: 1px solid #DDDDDD;
    transform: translateX(0); /* 기본 위치 */
    transition: transform 0.5s ease, width 0.5s ease; /* 슬라이드 애니메이션 */
    padding: 0px; 
    margin: 0 auto;
  }
  #nav_dir, #nav_dir_modal {
    flex: auto;
    padding: 1rem;
    overflow-y: auto;
    background-color: #F6F7FA;
  }
  #toc, #toc_modal {
    white-space: nowrap; /* 줄 바꿈 방지 */
    overflow-x: auto;    /* 가로 스크롤 표시 */
    display: block;      /* ul 기본 블록 요소로 설정 */
  }
  #toc li, #toc_modal li {
    display: inline-block; /* 목록 항목을 인라인 블록으로 설정하여 한 줄에 표시 */
  }
  #nav_dir .list-group-item, #nav_dir_modal .list-group-item {
    border: none;
    background-color: #F6F7FA;
    font-size: 0.85rem;
    padding-top: 0.2rem;
    padding-bottom: 0.2rem;
  }
  #storage_info {
    padding: 0.6rem 1rem 1rem 1rem;
    border-top: 1px solid #DDDDDD;
    background-color: #F6F7FA;
    /* 기본 높이만 차지 */
    /* flex-shrink: 0; */
  }

  #storage_info span {
    font-size: 0.8rem;
  }
  #toc_modal {
    max-height: 400px;
    overflow: auto;
  }
  #nav_files {
    display: flex;
    flex-direction: column;
    flex: auto;
    height: 94vh;
    transition: flex 0.5s ease; /* 슬라이드 애니메이션 */
  }
  .sidebar-hidden {
    transform: translateX(-100%);
    transition: transform 0.5s ease, width 0.5s ease;
    width: 0%;
    padding: 0px;
  }
  .nav_files_expanded {
    flex-grow: 1; /* 부모 너비를 기준으로 남은 공간 채우기 */
    transition: flex-grow 0.5s ease;
  }
  .btn-file, .btn-folder {
    margin-left: 0.2rem; 
    padding: 0.2rem 0.6rem 0.3rem 0.6rem;
    background-color: #F1F3F9; 
  }
  .btn-file:hover, .btn-folder:hover {
    background-color: #D1D1D1; 
  }
  button span {
    font-size: 0.8rem; 
    font-weight: bold; 
  }
  .dropdown-menu {
    min-width: auto !important;  /* 기본 너비 제한 해제 */
    width: fit-content !important; /* 내용에 맞게 자동 조정 */
  }

  #file_list {
    display: flex;
    flex-direction: row;
    flex: auto;
    overflow-y: auto;
    padding: 1rem;
  }
  #placeholder {
    flex: auto;
  }
  #my_table {
    flex: auto;
    min-width: 600px;
    overflow-y: auto;
    padding-left: 0.3rem;
    padding-right: 0.3rem;
  }
  #my_table.invisible {
    display: none;
  }
  #my_grid {
    flex: auto;
    min-width: 600px;
    overflow-y: auto;
  }
  #my_grid.invisible {
    display: none;
  }
  #right_panel {
    display: flex;
    flex-direction: column;
    width: 350px;
    min-width: 300px;
    height: 100%;
    border-left: 1px solid #DDDDDD;
    padding: 1rem; 
  }
  #right_panel.hidden {
    /* width: 0%; */
    display: none;
  }
  .invisible {
    display: none;
  }
  .currentMode {
    color: #4078FF !important; 
  }
  #toggleAllCheckboxId {
    font-size: 1.2rem;
  }
  .table-hover td, .table-hover th {
    white-space: nowrap;
  }
  .flex-grow {
    width: 100%;
    white-space: normal;
    font-size: 0.9rem;
  }
  .table thead th {
    position: relative;
    /* top: 0; 테이블 헤더가 스크롤될 때 고정 위치 */
    background-color: white; /* 헤더 배경색 설정 */
    z-index: 1; /* 다른 콘텐츠보다 위에 표시되도록 설정 */
    font-weight: normal;
    font-size: 0.7rem;
    color: #767780;
  }
  th .resizer {
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    cursor: col-resize;
    user-select: none;
  }

  .table tr .mobile {
    color: #9398A0;
    font-size: 0.8rem;
    font-weight: normal;
  }
  tbody#rp_text_info tr td {
    border: none !important;
  }
  span#rp_title {
    word-break: break-word;  /* 긴 단어를 적절히 줄바꿈 */
    white-space: normal;
  }
  td.td_key {
    color: #767780;
    white-space: nowrap;
    font-weight: normal;
    font-size: 0.8rem;
  }
  td.td_value {
    color: black;
    font-weight: normal;
    font-size: 0.8rem;
    word-break: break-word;  /* 긴 단어를 적절히 줄바꿈 */
    white-space: normal;
  }
  #table_body td.file,
  #table_body td.directory {
    word-break: break-word;  /* 긴 단어를 적절히 줄바꿈 */
    white-space: normal;    /* 텍스트가 줄 바꿈을 허용 */
  }
  #grid_content {
    display: flex;         /* Flexbox 레이아웃 사용 */
    flex-flow: row wrap;    /* 줄바꿈 허용 */
    justify-content: flex-start;
    padding: 3rem;
    gap: 1rem;             /* 요소 간격 설정 */
  }
  #grid_content i {
    font-size: 4.5rem;
    padding: 2.5rem;
  }
  #grid_content p, #progressDiv p {
    white-space: nowrap;
    overflow: hidden; 
    text-overflow: ellipsis;
    margin: 0;
  }
  #grid_content .card-body {
    padding: 0px;
  }
  #grid_content .card span.hidden {
    display: none;
  }
  .form-check-input:focus {
    box-shadow: none;
  }
  #home {
    margin-left: 1rem;
  }
  #breadcrumb li {
    cursor: pointer;
  }
  #banner {
    flex: 0 0 auto;
    /* padding-top: 0.9rem;
    padding-bottom: 0.5rem; */
    border-bottom: 1px solid #DDDDDD;
  }
  #top_banner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding-top: 0.6rem;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    /* padding: 0 10px; */
  }
  .cursor-pointer {
    cursor: pointer; /* 포인터 모양으로 변경 */
  }
  #toggleButton {
    display: none;
  }
  /* Toggle Button */
  .toggle-btn {
    border: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    outline: none;
    margin-right: 0.3rem;
  }
  .toggle-btn i {
    font-size: 1.2rem;
  }
  .btn-margin {
    margin-left: 0.8rem;
  }
  #searchInput:focus, #searchInput2:focus, #topicInput:focus {
    outline: none;
    box-shadow: none;
    border-color: black;
  }
  .btn-transparent {
    background-color: transparent;
    border: none;
  }
  .btn-transparent:hover {
    background-color: rgba(0, 0, 0, 0.1); /* 호버 시 배경색 추가 (선택 사항) */
  }

  @media (min-width: 1024px) and (max-width: 1366px) {
  /* 아이패드 프로 12.9인치 화면에만 적용할 스타일 */
    #sidebar {
      height: 94vh;
    }
    #nav_dir {
      height: 86vh;
    }
    #nav_files {
      height: 94vh;
    }
  } 

  @media (max-width: 767.98px) and (orientation: portrait) {
    #nav_files {
      height:92vh; /* 모바일에서는 전체 화면 높이로 설정 */
    }
    .toggle-btn {
      display: none;
    }
    #fontIncrease, #fontDecrease {
      display: none;
    }
    #sidebar {
      display: none;
    }
    .mobile {
      display: none;
    }
    #my_table {
      min-width: 300px;
    }
    #my_grid {
      min-width: 300px;
    }
    #right_panel, #infoToggleBtn {
      display: none;
    }
    form#searchForm {
      display: none !important;
    }
    #toggleButton {
      display: inline-block;
    }
    #home {
      margin-left: 0rem;
    }
    #grid_content {
     padding: 1.8rem;
  }
  }
</style>
<div class="container-fluid">
  <div id="myRow" class="row">
    <div id="sidebar" class="col-12 col-md-2">
      <div id="nav_dir">
        <ul id="toc" class="list-group list-group-flush"></ul>
      </div>
      <div id="storage_info">
        <div style="margin-bottom: 0.5rem;">
          <span style="margin-right: 0.3rem;"><i class="fa-regular fa-hard-drive"></i></span>
          <span id="used" style="font-weight: bold; color: #4078FF;"></span>
          <span> / </span>
          <span id="total"></span>
        </div>
        <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
          <div id="storage_bar" class="progress-bar"></div>
        </div>
      </div>
    </div>
    <div id="nav_files" class="col-12 col-md-10 p-0">
      <div id="top_banner" style="display: flex; align-items: center;">
        <div style="display: inline-block;">
          <span>
            <button id="toggleButton" class="toggle-btn btn btn-transparent">
              <!-- <i class="fa-regular fa-square-caret-left"></i>FontAwesome icon -->
              <i class="fa-solid fa-chevron-left"></i>
            </button>
          </span>
          <nav class="fs-5" style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;); display: inline-block;" aria-label="breadcrumb">
            <ol id="breadcrumb" class="breadcrumb">
            </ol>
          </nav>
        </div>
        <form id="searchForm" style="display: flex; align-items: center; margin-right: 0.7rem;">
          <div class="input-group" style="display: flex; align-items: center; border: none; outline: none;">
            <input type="text" style="border: 1px solid black; border-right: 0; border-radius: 4px 0 0 4px; font-size: 0.8rem;" minlength="1" maxlength="12" id="searchInput" name="serachInput" class="form-control" aria-label="Message" aria-describedby="send-button" autocomplete="off" rows="1" placeholder="파일, 폴더, 확장자 검색">
            <button id="searchBtn" class="btn btn-light" style="margin-left: 0; border: 1px solid black; border-left: 0; border-radius: 0 4px 4px 0; font-size: 0.8rem;" type="submit">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </div>
        </form>
      </div>
      <div id="banner">
        <div class="header">
          <span>
            <button id="toggleAllCheckboxId" class="btn btn-transparent"><i class="fa-regular fa-square" style="color: #DEE2E6;"></i></button>
            <span class="dropdown">
              <button id="uploadBtn" class="btn btn-transparent" data-bs-toggle="dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #4078FF; padding: 0.2rem 0.6rem 0.3rem 0.6rem;"><i class="fa-solid fa-arrow-up-from-bracket" style="font-size: 0.9rem;  color: white;"></i><span style="color: white;"> 올리기</span></button>
              <ul class="dropdown-menu">
                <li><button id="fileUploadBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;"><label id="file-label" for="inputFiles">파일 올리기</label></button></li>
                <input id="inputFiles" type="file" accept="*/*" style="display:none" multiple>
                <li><button id="folderUploadBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;"><label id="folder-label" for="inputFolder">폴더 올리기</label></button></li>
                <input id="inputFolder" type="file" webkitdirectory directory multiple style="display: none;">
              </ul>
            </span>
            <!-- 새 폴더의 이름을 입력받는 모달창 -->
            <button type="button" id="newfolderBtn" class="btn btn-folder" data-bs-toggle="modal" data-bs-target="#createFolderModal" data-bs-whatever="{{ g.user.username }}"><span>새 폴더</span></button>
            <div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="createFolderModalLabel"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="createFolderForm">
                      <div class="mb-3">
                        <label for="folder_name" class="col-form-label"></label>
                        <input type="text" class="form-control inputField" id="folder_name" minlength="1" maxlength="30" placeholder="새 폴더" autocomplete="off">
                      </div>
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary" form="createFolderForm">확인</button>
                  </div>
                </div>
              </div>
            </div>
            <button id="pasteBtn" class="btn btn-file invisible"><span>붙여넣기</span></button>
            <span id="btnFiles" class="invisible">
              <button id="downloadBtn" class="btn btn-file"><span>내려받기</span></button>
              <!-- <button id="shareBtn" class="btn btn-file mobile"><span>공유</span></button> -->
              <!-- 삭제 확인 모달창 -->
              <button type="button" id="deleteBtn" class="btn btn-file" data-bs-toggle="modal" data-bs-target="#deleteModal" data-bs-whatever="{{ g.user.username }}"><span>삭제</span></button>
              <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="deleteModalLabel"></h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p>공유 중이거나 즐겨 찾는 파일도 함께 삭제됩니다.</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                      <button type="button" id="confirmDeleteBtn" class="btn btn-primary">확인</button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" id="changeNameBtnForModal" style="font-size: 0.9rem; text-align: center; display: none;" data-bs-toggle="modal" data-bs-target="#changeNameModal" data-bs-whatever="{{ g.user.username }}"></button>
              <!-- 폴더 또는 파일의 새 이름을 입력받는 모달창 -->
              <div class="modal fade" id="changeNameModal" tabindex="-1" aria-labelledby="changeNameModalLabel">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="changeNameModalLabel"></h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form id="changeNameForm">
                        <div class="mb-3">
                          <label for="target_name" class="col-form-label"></label>
                          <input type="text" class="form-control inputField" id="target_name" minlength="1" maxlength="50" placeholder="" autocomplete="off">
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                      <button type="submit" class="btn btn-primary" form="changeNameForm">확인</button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" id="moveResourcesBtnForModal" style="font-size: 0.9rem; text-align: center; display: none;" data-bs-toggle="modal" data-bs-target="#moveResourcesModal" data-bs-whatever="{{ g.user.username }}"></button>
              <!-- 선택한 파일 또는 폴더를 위치시킬 경로를 선택하는 모달창 -->
              <div class="modal fade" id="moveResourcesModal" tabindex="-1" aria-labelledby="moveResourcesModalLabel">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="moveResourcesModalLabel"></h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div id="nav_dir_modal">
                        <ul id="toc_modal" class="list-group list-group-flush"></ul>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                      <button type="button" id="toc_modal_confirm" class="btn btn-primary">확인</button>
                    </div>
                  </div>
                </div>
              </div>
              <span class="dropdown">
                <button id="uploadBtn" class="btn btn-file" data-bs-toggle="dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa-solid fa-ellipsis"></i></button>
                <ul class="dropdown-menu">
                  <li><button id="transferFilesBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;">잘라내기</button></li>
                  <li><button id="copyFilesBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;">복사</button></li>
                  <li><button id="moveFilesBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;">이동</button></li>
                  <li><button id="compressBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;">압축하기</button></li>
                  <li><button id="extractBtn" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;">압축 풀기</button></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><button type="button" id="changeNameBtn" class="dropdown-item" style="font-size: 0.9rem; text-align: center;">이름 바꾸기</button></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><button id="" class="dropdown-item" type="button" style="font-size: 0.9rem; text-align: center;"><label id="file-label" for="inputFiles">링크 공유</label></button></li>
                  <input id="inputFiles" type="file" accept="*/*" style="display:none" multiple>                  
                </ul>
              </span>
              </span>
            </span>
            <span>
            <button id="tableBtn" class="btn btn-transparent currentMode"><i class="fa-solid fa-bars"></i></button>
            <button id="gridBtn" class="btn btn-transparent"><i class="fa-solid fa-grip"></i></button>
            <button id="infoToggleBtn" class="btn btn-transparent"><i class="fa-solid fa-circle-info" style="color: #4078FF;"></i></button>
            </span>
          </span>
        </div>
        <!-- 📌 다운로드 진행률 바 -->
        <div id="progressDiv" class="invisible" style="width: 100%; background: #ddd; border-radius: 5px; margin-top: 10px;">
          <p style="font-size: 0.8rem; text-align: center;"></p>
          <div id="downloadProgress" style="
            width: 0%;
            height: 1.2rem;
            font-size: 0.8rem;
            background: #4078FF;
            text-align: center;
            /* line-height: 25px; */
            line-height: normal;
            color: white;
            border-radius: 2px;">
            0%
          </div>
          <div id="downloadProgress2" style="
            width: 0%;
            height: 1.2rem;
            font-size: 0.8rem;
            background: #FF6347;
            text-align: center;
            /* line-height: 25px; */
            line-height: normal;
            color: white;
            border-radius: 2px;">
            0%
          </div>
        </div>
      </div>
      <div id="file_list" style="padding: 0px;">
        <div id="placeholder" class="invisible text-center flex-column align-items-center justify-content-start" style="margin-top: 5rem;">
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="placeholder-glow fs-5 mb-3">
            <span class="placeholder col-8"></span>
          </p>
          <div class="d-flex gap-3">
            <div class="placeholder-glow">
              <div class="placeholder rounded bg-warning" style="width: 80px; height: 80px;"></div>
            </div>
            <div class="placeholder-glow">
              <div class="placeholder rounded bg-primary" style="width: 80px; height: 80px;"></div>
            </div>
            <div class="placeholder-glow">
              <div class="placeholder rounded bg-secondary" style="width: 80px; height: 80px;"></div>
            </div>
          </div>
          <p class="mt-4 text-muted">데이터를 불러오는 중입니다... 잠시만 기다려 주세요.</p>
        </div>
        <div id="my_table">
          <table class="table table-hover">
            <thead>
              <tr id="table_header">
              </tr>
            </thead>
            <tbody id="table_body">
            </tbody>
          </table>
        </div>
        <div id="my_grid" class="invisible">
          <div id="grid_content">
          </div> 
        </div>
        <div id="right_panel">
          <div id="rp_header" class="fs-5">
            <span id="rp_title" class="fw-semibold"></span>
          </div>
          <div id="rp_thumb"></div>
          <table class="table">
            <tbody id="rp_text_info">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script type="module">
  import { createStore } from 'https://cdnjs.cloudflare.com/ajax/libs/redux/5.0.1/redux.legacy-esm.js';

  // 'invisible' 클래스를 토글하는 함수
  function toggleVisibility(item, isInvisible) {
    if (isInvisible) {
      item.classList.add('invisible');
      const icon = item.querySelector('.fa-solid');
      if (icon && icon.classList.contains('fa-folder-open')) {
        icon.classList.remove('fa-folder-open');
        icon.classList.add('fa-folder');
        item.classList.remove('open');
      }
    } else {
      item.classList.remove('invisible');
    }
  }

  // 아이콘을 변경하는 함수
  function toggleFolderIcon(item, isOpen) {
    const icon = item.querySelector('.fa-solid');
    if (icon) {
      if (isOpen) {
        icon.classList.remove('fa-folder');
        icon.classList.add('fa-folder-open');
      } else {
        icon.classList.remove('fa-folder-open');
        icon.classList.add('fa-folder');
      }
    }
  }

  // 하위 아이템을 숨기거나 표시하는 함수
  function handleSubItems(item, shouldDisplay) {
    const targetIds = JSON.parse(item.dataset.subids);
    targetIds.forEach(id => {
      const subItem = document.querySelector(`.list-group-item[data-id='${id}']`);
      if (subItem) {
        toggleVisibility(subItem, shouldDisplay);
        // 하위 항목이 토글되었으면, 그 하위 아이템의 subids도 처리
        if (shouldDisplay) {
          handleSubItems(subItem, shouldDisplay);
        }
      }
    });
  }

  // 특정 ID들의 항목을 표시하는 함수
  function displayTagsById(subids, modal=undefined) {
    let listItems = null;
    if (modal) {
      listItems = document.querySelectorAll('#toc_modal .list-group-item');
    } else {
      listItems = document.querySelectorAll('#toc .list-group-item');
    }
    
    listItems.forEach(item => {
      const itemId = parseInt(item.dataset.id, 10);
      
      // 클릭된 ID가 포함된 아이템만 처리
      if (subids.includes(itemId)) {
        const isCurrentlyInvisible = item.classList.contains('invisible');
        const shouldDisplay = !isCurrentlyInvisible;  // 서브 요소가 가려져 있을 경우, shouldDisplay에 false가 담김
        
        toggleVisibility(item, shouldDisplay);
        
        // 하위 항목을 표시하려면, 하위 아이템이 보이도록 처리
        if (shouldDisplay) {
          handleSubItems(item, shouldDisplay);
        }
      }
    });
  }

  function getStyledDirectoryName(d_path, depth, path) {
    return '&emsp;'.repeat(depth) + '<i class="fa-solid fa-folder" style="color: #4078FF;"></i>' + '&emsp;' + d_path; 
  }

  const icons = {
    'folder': '<i class="fa-solid fa-folder" style="color: #4078FF;"></i>',
    'pdf': '<i class="fa-solid fa-file-pdf" style="color: #DA5A37"></i>',
    'zip': '<i class="fa-solid fa-file-zipper" style="color: #968069"></i>',
    'doc': '<i class="fa-solid fa-file-word" style="color: #457DD8"></i>',
    'docx': '<i class="fa-solid fa-file-word" style="color: #457DD8"></i>',
    'ppt': '<i class="fa-solid fa-file-powerpoint" style="color: #E76C4E"></i>',
    'pptx': '<i class="fa-solid fa-file-powerpoint" style="color: #E76C4E"></i>',
    'xls': '<i class="fa-solid fa-file-excel" style="color: #30A364"></i>',
    'xlsx': '<i class="fa-solid fa-file-excel" style="color: #30A364"></i>',
    'hwp': '<i class="fa-solid fa-file-signature" style="color: #43A6DD"></i>',
    'hwpx': '<i class="fa-solid fa-file-signature" style="color: #43A6DD"></i>',
    'video': '<i class="fa-solid fa-file-video" style="color: #01C75A"></i>',
    'mp3': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'webm': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'aac': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'm4a': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'wav': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'flac': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'html': '<i class="fa-solid fa-file-code" style="color: #1DB45B"></i>',
  }

  let toc_flag = true;
  let toc_event_flag = true;
  function TOC() {
    const { directoryTree } = store.getState();
    const html_for_toc = directoryTree
      .filter(item => item.type === 'directory')
      .map(({ id, path, children, pathForDisplay, subdirectoryDepth }) => `
        <a href='#' data-id="${id}" data-subids="${JSON.stringify(children)}" class="list-group-item ${path.includes('/') ? 'invisible' : ''}">
          ${getStyledDirectoryName(pathForDisplay, subdirectoryDepth, path)}
        </a>
      `).join('');
    
    const $toc = document.getElementById('toc');
    $toc.innerHTML = html_for_toc;
    if (!toc_event_flag) {
      return;
    }
    $toc.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      allowSubscriptionCall = true;
      const elem = e.target.closest('.list-group-item');
      if (elem) {
        const id = elem.dataset.id;
        const dir_path = directoryTree.filter(item => item.id == id)[0]?.path;
        const subIds = JSON.parse(elem.dataset.subids);
        if (subIds.length > 0) {
          if (!elem.classList.contains('open')) {
            toggleFolderIcon(elem, true);
            elem.classList.add('open');
          } else {
            toggleFolderIcon(elem, false);
            elem.classList.remove('open');
          }
          displayTagsById(subIds);
        }
        
        if (dir_path && toc_flag) {
          await fetchDirectoryDetails(dir_path);
        }
      }
    });
    toc_event_flag = false;
    //
  }

  function getFileExtensionIcon(_ext) {
    if (_ext) {
      const ext = _ext.split('.')[1].toLowerCase();
      let tag = icons[ext] || `<i class="fa-regular fa-file"></i>`;
      return tag;
    } else {
      return `<i class="fa-regular fa-file"></i>`;
    }
  }

  function convertBytesToReadableUnit(sizeBytes) {
    let size;
    if (sizeBytes < 1_000_000) {  // Less than 1 MB
      size = `${(sizeBytes / 1_024).toFixed(1)}KB`;
    } else if (sizeBytes < 1_073_741_824) {  // Less than 1 GB (1_073_741_824 bytes = 1 GB)
      size = `${(sizeBytes / 1_048_576).toFixed(1)}MB`;
    } else {  // 1 GB or more
      size = `${(sizeBytes / 1_073_741_824).toFixed(2)}GB`;
    }
    return size;
  }

  function initializeTableHeader() {
    const $table_header = document.getElementById('table_header');
    const $ths = $table_header.querySelectorAll('th');
    $ths.forEach(th => {
      th.remove();
    });
    $table_header.innerHTML = `
      <th scope="col">   </th>
      <th scope="col" data-id="type">종류 </th>
      <th scope="col" data-id="name" class="flex-grow">이름 </th>
      <th scope="col" data-id="size" class="mobile">크기 </th>
      <th scope="col" data-id="date" class="mobile">수정한 날짜 </th>
    `;  

    const ths = document.querySelectorAll('#table_header th');
    ths.forEach((th, idx) => {
      if (idx == 0) {
        return;
      }
      th.addEventListener('click', () => {
        const $elem = document.querySelector('th i');
        if ($elem) {
          $elem.remove();
        }
  
        th.classList.toggle('oddEvenToggle');
        // console.log(th);
        const oddEven = th.classList.contains('oddEvenToggle') ? 'odd' : 'even';
        const $iconEl = document.createElement('i');
        $iconEl.classList.add('fa-solid');
        oddEven == 'odd' ? $iconEl.classList.add('fa-arrow-up') : $iconEl.classList.add('fa-arrow-down');
        // console.log(oddEven);
        th.appendChild($iconEl);
        store.dispatch({ type: 'UPDATE', target: 'sort_table', rule: th.dataset.id, count: oddEven });
      });
    });
  }

  const fetchItemThumbnailAndDetails = async (item_path) => {
    // fetch를 사용하여 서버에서 이미지를 가져오고, Blob과 URL.createObjectURL을 사용하여 이미지를 웹 페이지에 표시하기
    const state = store.getState();
    const url = `${_URL}/cloudstorage/getThumbnailAndDetails/${item_path}`;
    try {
      const response = await fetch(url, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`Error: ${response.status}`);
      }
      if (response.status === 204) {
        console.log('No Content');
        return;
      }

      const $thumbnail = document.getElementById('rp_thumb');
      const $rp_text_info = document.getElementById('rp_text_info');
      $thumbnail.innerHTML = '';
      $rp_text_info.innerHTML = '';
      const res = await response.json();
      // console.log(res.info);
      const mediaTypesForThumbnails = ['pdf', 'image', 'video'];

      if (mediaTypesForThumbnails.includes(res.type)) {
        const thumbnailBase64 = res.data;
        const imageUrl = `data:image/png;base64,${thumbnailBase64}`;
        const $imgElement = document.createElement('img');
        $imgElement.src = imageUrl;
        $imgElement.style.width = '100%'; // Adjust based on container
        $imgElement.style.paddingTop = '0.8rem';
        $imgElement.style.paddingBottom = '0.8rem';
        $thumbnail.appendChild($imgElement);
      } else {
        const $divElement = document.createElement('div');
        $divElement.innerHTML = icons[res.type] || '<i class="fa-regular fa-file"></i>';
        $divElement.style.width = '100%'; // Adjust based on container
        $divElement.style.textAlign = 'center'
        $divElement.style.fontSize = '6rem';
        $divElement.style.paddingTop = '0.8rem';
        $divElement.style.paddingBottom = '0.8rem';
        $divElement.style.backgroundColor = '#F5F6F9';
        $thumbnail.appendChild($divElement);
      }
      
      const $fragment = document.createDocumentFragment();

      Object.entries(res.info).forEach(item => {
        const $tr = document.createElement('tr');
        const $td_for_key = document.createElement('td');
        $td_for_key.classList.add('td_key');
        const $td_for_value = document.createElement('td');
        $td_for_value.classList.add('td_value');
        $td_for_key.textContent = item[0];
        $td_for_value.textContent = (item[1] == '/Users/yuseung-u/Desktop/pythonLab/voiceGPT' ? '/' : item[1]);
        // if (res.type == 'folder' && item[0] == '위치') {
        //   document.getElementById('rp_title').textContent = $td_for_value.textContent;
        // }
        $tr.appendChild($td_for_key);
        $tr.appendChild($td_for_value);
        $fragment.appendChild($tr);
      });
      $rp_text_info.appendChild($fragment);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function generateThumbnailOrIconTag(_type, _thumbnail, _size=25, card=false) {
    if (_type == 'Directory') {
      return '<i class="fa-solid fa-folder" style="color: #4078FF;"></i>';
    } else if (_thumbnail) {
      const thumbnailBase64 = _thumbnail;
      const imageUrl = `data:image/png;base64,${thumbnailBase64}`;
      return `<img src=${imageUrl} style="width:${_size}px; height:${_size}" padding:2px; text-align: center; ${card ? 'class="card-img-top" alt="..."' : ''}></img>`;
    } else {
      return getFileExtensionIcon(_type);
    }
  }

  function toggleElementVisibilityById(tag, hidden) {
    const flag = $(tag).hasClass('invisible');
    if (hidden && !flag) {  // 태그를 숨기고자 할 경우
      $(tag).addClass('invisible');
    } else if (!hidden && flag) { // 태그를 보이고자 할 경우
      $(tag).removeClass('invisible');
    }
  }

  function updateButtonIconBasedOnCheckboxes() { // 다른 체크박스 요소들이 체크되어 있는지 확인하여, 그 결과에 따라 특정 버튼 요소의 아이콘 모양을 바꿔주는 함수
    const state = store.getState();
    const { view_contents, selectedItems, checkedFilePathsForMove, checkedFilePathsForCopy } = state;
    const $toggleAllCheckboxId = document.getElementById('toggleAllCheckboxId');
    const $compressBtn = document.getElementById('compressBtn');
    const $extractBtn = document.getElementById('extractBtn');
    const $pasteBtn = document.getElementById('pasteBtn');

    if (selectedItems.length == 0) {
      $toggleAllCheckboxId.innerHTML = '<i class="fa-regular fa-square" style="color: #DEE2E6;"></i>';
      toggleElementVisibilityById('#btnFiles', true);
      toggleElementVisibilityById('#newfolderBtn', false);
    } else if (selectedItems && (selectedItems.length == view_contents.length)) {
      $toggleAllCheckboxId.innerHTML = '<i class="fa-solid fa-square-check" style="color: #4078FF;"></i>';
      toggleElementVisibilityById('#btnFiles', false);
      toggleElementVisibilityById('#newfolderBtn', true);
    } else {
      $toggleAllCheckboxId.innerHTML = '<i class="fa-solid fa-square-minus" style="color: #4078FF;"></i>';
      toggleElementVisibilityById('#btnFiles', false);
      toggleElementVisibilityById('#newfolderBtn', true);
    }

    const isZipFile = selectedItems?.length === 1 && selectedItems[0].endsWith('.zip');
    $compressBtn.classList.toggle('invisible', isZipFile);
    $extractBtn.classList.toggle('invisible', !isZipFile);

    const showPasteBtn = (checkedFilePathsForMove.length > 0 && selectedItems.length == 0) || (checkedFilePathsForCopy.length > 0 && selectedItems.length == 0)? false : true;
    $pasteBtn.classList.toggle('invisible', showPasteBtn);
  }

  function openFile(filename, isVideo = false, isAudio = false) {
    const url = `${_URL}/cloudstorage/view/${filename}`;
    
    if (isVideo) {
      // 동영상 플레이어 창 열기
        const videoPage = `
        <html>
          <head><title>동영상 플레이어</title></head>
          <body style="margin:0; overflow:hidden;">
            <video id="videoPlayer" controls autoplay style="width: 100%; height: 100vh;">
              <source src="${url}" type="video/mp4">
              브라우저가 비디오 태그를 지원하지 않습니다.
            </video>
            <script>
              document.addEventListener('DOMContentLoaded', function () {
                const video = document.getElementById('videoPlayer');
                video.requestFullscreen?.();
              });
          </body>
        </html>`;
      const videoWindow = window.open("", "_blank");
      videoWindow.document.write(videoPage);
    } else if (isAudio) {
      // 오디오 플레이어 창 열기
      const audioPage = `
        <html>
          <head><title>오디오 플레이어</title></head>
          <body>
            <audio controls autoplay style="width: 100%;">
              <source src="${url}" type="audio/${filename.split('.').pop()}">
              브라우저가 오디오 태그를 지원하지 않습니다.
            </audio>
          </body>
        </html>`;
      
      const audioWindow = window.open("", "_blank");
      audioWindow.document.write(audioPage);
    } else {
      // 일반 파일 열기
      window.open(url, '_blank');
    }
  }

  function article() {
    const state = store.getState();
    const { current_path, selectedItems, checkedFilePathsForMove } = state;
    let html_for_article = state.view_contents.map(
      ({ _type, _name, _size, _loc, _modified, _thumbnail }) => {
        const selected = selectedItems.map(item => item.split('/').pop());
        const isChecked = selected.includes(_name); // 선택 여부 확인
        const popoverContent = _loc ? `data-bs-toggle="popover" data-bs-title="위치" data-bs-content="${_loc}"` : '';
        return `<tr>
          <td><input class="form-check-input" type="checkbox" data-loc="${_loc}" data-type="${_type == 'Directory' ? 'directory' : 'file'}"  value="${_name}" ${isChecked ? "checked" : ""} aria-label="..."></td>
          <td class="${_loc ? 'popover-hover' : ''}" ${popoverContent}">${generateThumbnailOrIconTag(_type, _thumbnail, 25, false)}</td>
          <td class="flex-grow ${_type == 'Directory' ? 'directory' : 'file'}\" data-loc="${_loc}" style="${checkedFilePathsForMove?.includes(current_path.slice(1) + '/' + _name) ? 'color: #9CA1A8;' : ''}">${_name}</td>
          <td class="mobile">${convertBytesToReadableUnit(_size)}</td>
          <td class="mobile">${_modified}</td>
        </tr>`
    }).join('');

    document.getElementById('table_body').innerHTML = html_for_article;

    document.querySelectorAll('#table_body td.popover-hover').forEach(td => {
      let popover = new bootstrap.Popover(td, {
        trigger: "manual",
        placement: "left",
      });

      let hideTimeout;

      td.addEventListener("mouseenter", () => {
        clearTimeout(hideTimeout);
        popover.show();
      });

      td.addEventListener("mouseleave", () => {
        hideTimeout = setTimeout(() => {
          popover.hide();
        }, 100); // 팝오버가 사라지기 전 100ms 지연
      });

      td.addEventListener("click", () => {
        popover.hide(); // 팝오버를 수동으로 숨기기
      });
    });
  
    const dir_tds = document.querySelectorAll('#table_body td.directory');
    dir_tds.forEach(td => {
      td.addEventListener('click', async (e) => {
        e.stopPropagation();
        allowSubscriptionCall = true;
        
        let targetPath = null;
        const loc = e.target.dataset.loc;
        if (loc == 'undefined') {
          targetPath = `${current_path}/${td.textContent}`; 
        } else {
          targetPath = loc.slice(1);
        }
        toc_flag = false;
        await fetchDirectoryDetails(targetPath);
        toc_flag = true;
      });
    });

    const file_tds = document.querySelectorAll('#table_body td.file');
    file_tds.forEach(td => {
      td.addEventListener('click', async (e) => {
        e.stopPropagation();
        let currentPath = null;
        // allowSubscriptionCall = true;
        const loc = e.target.dataset.loc;
        currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
        currentPath = loc == 'undefined' ? current_path : `${loc.endsWith('/') ? loc.substring(0, loc.length - 1) : loc}`;

        const filename = td.textContent;
        const file_ext = filename.includes('.') ? filename.split('.')[1] : undefined;
        const image_exts = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'tiff', 'webp'];
        const video_exts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'];
        const audio_exts = ['mp3', 'aac', 'm4a', 'ogg', 'wav', 'flac', 'webm'];
        const code_exts = ['html', 'css', 'js', 'py'];
        const office_exts = ['hwp', 'hwpx', 'pdf'];
        // console.log(file_ext);
        if (video_exts.includes(file_ext)) {
          openFile(`${currentPath}/${filename}`, true, false);
        } else if (audio_exts.includes(file_ext)) {
          openFile(`${currentPath}/${filename}`, false, true);  // 비디오 파일
        } else if (image_exts.includes(file_ext) || code_exts.includes(file_ext) || office_exts.includes(file_ext)) {
          openFile(`${currentPath}/${filename}`);
        } 
      });
    });

    // 각 체크박스에 이벤트 리스너 추가
    const checkboxes = document.querySelectorAll('#table_body .form-check-input');
    checkboxes.forEach(checkbox => {
      const row = checkbox.closest('tr');
      if (checkbox.checked) {
        row.classList.add('table-active');
      }
      checkbox.addEventListener('change', (event) => {
        event.stopPropagation();
        row.classList.add('table-active');
        const nameTd = row.querySelector('td:nth-child(3)');
        let targetFullPath = null;

        if (nameTd.dataset.loc === 'undefined') {
          targetFullPath = current_path + '/' + nameTd.textContent;
        } else if (nameTd.dataset.loc.endsWith('/')) {
          targetFullPath = nameTd.dataset.loc.slice(1) + nameTd.textContent;
        } else {
          targetFullPath = nameTd.dataset.loc.slice(1);
        }

        if (event.target.checked) { // 체크 상태인 경우에만 실행
          document.getElementById('rp_title').textContent = nameTd.textContent;
          fetchItemThumbnailAndDetails(targetFullPath);
          store.dispatch({ type: "ADD_SELECTED_ITEM", payload: targetFullPath });
        } else { // 체크 해제된 경우
          row.classList.remove('table-active');
          store.dispatch({ type: "REMOVE_SELECTED_ITEM", payload: targetFullPath });
        }
      });
    });
  }

  function grid_article() {
    const { current_path, selectedItems, view_contents } = store.getState();
    let html_for_article = view_contents.map(
      ({ _type, _name, _loc, _size, _thumbnail }) => {
        const selected = selectedItems.map(item => item.split('/').pop());
        const isChecked = selected.includes(_name); // 선택 여부 확인
        const popoverContent = _loc ? `data-bs-toggle="popover" data-bs-title="위치" data-bs-content="${_loc}"` : '';
        return `
        <div class="card mb-5 text-center ${_type == 'Directory' ? 'directory' : 'file'}" data-loc="${_loc}" style="width: 150px; height: 150px; position: relative;">
          ${generateThumbnailOrIconTag(_type, _thumbnail, 148, true)}
          <span class="hidden" style="position: absolute; top: 5px; left: 5px;">
            <input class="form-check-input" type="checkbox" data-loc="${_loc}" data-type="${_type == 'Directory' ? 'directory' : 'file'}" value="${_name}" ${isChecked ? "checked" : ""} aria-label="..."> 
          </span>
          <div class="card-body">
            <p class="card-text ${_loc ? 'popover-hover' : ''}" ${popoverContent} style="font-size: 0.8rem;">${_name}</p>
            <p class="card-text" style="font-size: 0.7rem;" class="text-body-secondary">${convertBytesToReadableUnit(_size)}</p>
          </div>
        </div>
        `
      }).join('');

    const gridContent = document.getElementById('grid_content');
    gridContent.innerHTML = html_for_article;

    document.querySelectorAll('#grid_content p.popover-hover').forEach(td => {
      let popover = new bootstrap.Popover(td, {
        trigger: "manual",
        placement: "bottom",
      });

      let hideTimeout;

      td.addEventListener("mouseenter", () => {
        clearTimeout(hideTimeout);
        popover.show();
      });

      td.addEventListener("mouseleave", () => {
        hideTimeout = setTimeout(() => {
          popover.hide();
        }, 100); // 팝오버가 사라지기 전 100ms 지연
      });

      td.addEventListener("click", () => {
        popover.hide(); // 팝오버를 수동으로 숨기기
      });
    });

    const dir_divs = document.querySelectorAll('#grid_content div.directory');
    dir_divs.forEach(dir_div => {
      dir_div.addEventListener('click', async (e) => {
        e.stopPropagation();
        allowSubscriptionCall = true;
        const $file_name = dir_div.querySelector('input').getAttribute('value');
        let targetPath = null;
        const loc = e.target.closest('div').dataset.loc;
        if (loc === 'undefined') {
          targetPath = `${current_path}/${$file_name}`; 
        } else {
          targetPath = loc.slice(1);
        }

        toc_flag = false;
        await fetchDirectoryDetails(targetPath);
        toc_flag = true;
      });
    });  

    const file_divs = document.querySelectorAll('#grid_content div.file');
    file_divs.forEach(file_div => {
      file_div.addEventListener('dblclick', async (e) => {
        e.stopPropagation();
        let currentPath = null;
        const loc = e.target.closest('div').dataset.loc;
        currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
        currentPath = loc === 'undefined' ? current_path : `${loc.endsWith('/') ? loc.substring(0, loc.length - 1) : loc}`;
        
        // const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
        const file_name = file_div.querySelector('input').getAttribute('value');
        const file_ext = file_name.includes('.') ? file_name.split('.')[1] : undefined;
        const image_exts = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'tiff', 'webp'];
        const video_exts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'];
        const audio_exts = ['mp3', 'aac', 'm4a', 'ogg', 'wav', 'flac', 'webm'];
        const code_exts = ['html', 'css', 'js', 'py'];
        const office_exts = ['hwp', 'hwpx', 'pdf'];
        if (video_exts.includes(file_ext)) {
          openFile(`${currentPath}/${file_name}`, true, false);
        } else if (audio_exts.includes(file_ext)) {
          openFile(`${currentPath}/${file_name}`, false, true);  // 비디오 파일
        } else if (image_exts.includes(file_ext) || code_exts.includes(file_ext) || office_exts.includes(file_ext)) {
          openFile(`${currentPath}/${file_name}`);
        } 
      });
    });  

    const $inputs = gridContent.querySelectorAll('input');
    $inputs.forEach(input => {
      if (input.checked) {
        input.closest('span').classList.remove('hidden');
        input.closest('.card').classList.add('border-primary');
      }
    });

    // 이벤트 위임 방식으로 카드의 호버 이벤트 처리
    gridContent.addEventListener('mouseover', (event) => {
      const card = event.target.closest('.card');
      if (card) {
        card.classList.add('border-primary'); // 카드 테두리 강조
        const span = card.querySelector('span');
        const checkbox = span?.querySelector('input');
        if (span) {
          span.classList.remove('hidden'); // 체크박스 보이기
        }
      }
    });

    gridContent.addEventListener('mouseout', (event) => {
      const card = event.target.closest('.card');
      if (card) {
        const span = card.querySelector('span');
        const checkbox = span?.querySelector('input');
        if (span && !checkbox.checked) {
          span.classList.add('hidden'); // 체크박스 숨기기
          card.classList.remove('border-primary'); // 카드 테두리 원래대로
        }
      }
    });

    // 각 체크박스에 이벤트 리스너 추가
    const checkboxes = document.querySelectorAll('#grid_content .form-check-input');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('click', (event) => {
        event.stopPropagation();
      });
      checkbox.addEventListener('change', (event) => {
        const itemValue = checkbox.getAttribute('value'); // checkbox 자체에서 속성을 가져옴
        const loc = event.target.closest('div').dataset.loc;

        let targetFullPath = null;
        if (loc === 'undefined') {
          targetFullPath = current_path + '/' + itemValue;
        } else if (loc.endsWith('/')) {
          targetFullPath = loc.slice(1) + itemValue;
        } else {
          targetFullPath = loc.slice(1);
        }

        if (event.target.checked) { // 체크 상태인 경우에만 실행
          document.getElementById('rp_title').textContent = itemValue;
          fetchItemThumbnailAndDetails(targetFullPath);
          store.dispatch({ type: "ADD_SELECTED_ITEM", payload: targetFullPath });
        } else { // 체크 해제된 경우
          store.dispatch({ type: "REMOVE_SELECTED_ITEM", payload: targetFullPath });
        }
      });
    });
  }

  let search_word = null;
  let allowSubscriptionCall = true;
  async function generateBreadcrumbFromPath() {
    const current_path = store.getState().current_path;
    const $breadcrumb = document.getElementById('breadcrumb');
    const splited_path = current_path.split('/').filter(path => path);
 
    const html_for_crumb = splited_path.map((_, index) => {
      const path = splited_path.slice(0, index + 1).join('/');
      const dir_name = splited_path[index];
      const isActive = index === splited_path.length - 1;
      
      return `
        <li data-path="${path.startsWith('/') ? path.slice(1) : path }" class="breadcrumb-item ${isActive ? 'active fw-semibold' : 'fw-light mobile'}" ${isActive ? 'aria-current="page"' : ''}>${dir_name}</li>
      `;
    }).join('');

    if (!allowSubscriptionCall) {
      $breadcrumb.innerHTML = `<li data-path="" id="home" class="breadcrumb-item fw-semibold" >파일 검색 결과 <span style="color: #4078FF;">${search_word}</span></li>`
    } else {
      $breadcrumb.innerHTML = '<li data-path="" id="home" class="breadcrumb-item fw-light" >Home</li>' + html_for_crumb;
      await updateAndActivateDirectoryTreeItem();
    }
    const $breadcrumbs = document.querySelectorAll('#breadcrumb li');
    $breadcrumbs.forEach(li => {
      li.addEventListener('click', async (e) => {
        e.stopPropagation();
        toc_flag = false;
        await fetchDirectoryDetails(li.dataset.path);
        toc_flag = true;
      });
    });
  }

  async function updateAndActivateDirectoryTreeItem() {
    const state = store.getState();
    const currentPath = state.current_path.startsWith('/') 
      ? state.current_path.substring(1) 
      : state.current_path;
      
    const splitedPath = currentPath.split('/');
    const onWayPaths = splitedPath.map((item, idx) => splitedPath.slice(0, idx + 1).join('/'));
    
    const directoryItemIds = state.directoryTree.filter(item => onWayPaths.includes(item.path)).map(item => item.id);
    
    directoryItemIds.forEach(el => {
      const $elem = document.querySelector(`#toc a[data-id="${el}"]`);
      const $icon = $elem.querySelector('.fa-solid');
      if ((!$icon.classList.contains('fa-folder-open')) && (JSON.parse($elem.dataset.subids).length > 0)) {
        $elem.click();
      }
    });
  }

  function reducer(state, action) {
    if (state === undefined) {
      return {
        directoryTree: [],
        view_contents: [],
        current_path: '',
        selectedItems: [], // 선택된 항목들
        checkedFilePathsForMove: [],
        checkedFilePathsForCopy: [],
      }
    }
    let newState;
    if (action.type === 'UPDATE'){
      if (action.target === 'nav_dir') {
        const newContents = [...action.content];
        newState = Object.assign({}, state, {
          directoryTree: newContents,
        });
      } else if (action.target === 'file_list') {
        const newContents = [...action.content];
        newState = Object.assign({}, state, {
          view_contents: newContents,
          current_path: action.dir,
          selectedItems: [],
        });
      } else if (action.target === 'breadcrumb') {
        const pathLen = state.current_path.split('/');
        if (pathLen.length > 0) {
          const updatedPath = pathLen.slice(0, pathLen.length - 1).join('/');
          newState = Object.assign({}, state, {
            current_path: updatedPath,
            selectedItems: [],
          });
        }
      } else if (action.target === 'sort_table') {
        const sortByRule = (rule, oddEven) => (a, b) => {
          const num = oddEven == 'odd' ? -1 : 1;
          if (a[rule] === b[rule]) {
            return 0;
          } 
          return a[rule] > b[rule] ? 1 * num : -1 * num;
        }
        let key = null;
        switch (action.rule) {
          case 'type':
            key = '_type';
            break;
          case 'size':
            key = '_size';
            break;
          case 'name':
            key = '_name';
            break;
          case 'date':
            key = '_modified'
            break;
          default:
            return;
        }
        const newContents = [...state.view_contents].sort(sortByRule(key, action.count));
        newState = Object.assign({}, state, {
          view_contents: newContents,
        });        
      }
    } else if (action.type === 'ADD_SELECTED_ITEM') {
      newState = {
        ...state,
        selectedItems: [...state.selectedItems, action.payload],
      };
    } else if (action.type === 'REMOVE_SELECTED_ITEM') {
      newState ={
        ...state,
        selectedItems: state.selectedItems.filter(
          (item) => item != action.payload
        ),
      };
    } else if (action.type === 'ADD_SELECTED_ITEMS') {
      newState = {
        ...state,
        selectedItems: [...state.selectedItems, ...action.payload],
      };
    } else if (action.type === 'REMOVE_SELECTED_ITEMS') {
      newState ={
        ...state,
        selectedItems: [...state.selectedItems].filter(
          (item) => ![...action.payload].includes(item)
        ),
      };
    } else if (action.type === 'DELETE_SELECTED_ITEMS') {
      newState = {
        ...state,
        view_contents: [...state.view_contents].filter(
          (item) => !(action.payload || []).includes(item['_name']) // undefined 방지
        ),
        directoryTree: [...state.directoryTree].filter(
          (item) => !(action.dir || []).includes(item['id'])
        ),
      };
    } else if (action.type === 'RENEW_TRANSFER_ITEMS') {
      newState = {
        ...state,
        checkedFilePathsForMove: action.payload,
        checkedFilePathsForCopy: [],
      }
    } else if (action.type === 'RENEW_COPY_ITEMS') {
      newState = {
        ...state,
        checkedFilePathsForMove: [],
        checkedFilePathsForCopy: action.payload,
      }
    } else if (action.type === 'COMPLETE_TRANSFER_ITEMS') {
      newState = {
        ...state,
        checkedFilePathsForMove: [],
        checkedFilePathsForCopy: [],
      }
    }
    return newState;
  }

  const productionURL = 'http://121.189.157.152:8080';
  const testURL = 'http://127.0.0.1:8080';
  const localURL = 'http://172.30.1.25:8080';
  let _URL = null;
  if (window.location.href.split('/')[2] === '127.0.0.1:8080'){
    _URL = testURL;
  } else if (window.location.href.split('/')[2] === '172.30.1.25:8080'){
    _URL = localURL;
  } else {
    _URL = productionURL;
  }

  const fetchDirectoryContents = async () => {
    const state = store.getState();
    const url = `${_URL}/cloudstorage/directoryContents/`;
    
    try {
      const response = await fetch(url, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`Error: ${response.status}`);
      }
      if (response.status === 204) {
        console.log('No Content');
        return;
      }

      const res = await response.json();
      const directoryTree = res.message.map((item, idx) => {
        const isFile = item.includes('.');
        const num = item.split('/').length - 1; 
        const _path = item.split('/').pop();
        return {
          id: idx + 1,
          path: item,
          pathForDisplay: _path,
          subdirectoryDepth: num,
          type: isFile ? 'file' : 'directory',
          children: [],
        };
      });

      directoryTree.forEach((elem) => {
        const children = directoryTree.filter(item => 
          item.path.startsWith(`${elem.path}/`) && item.path !== elem.path
          && !item.path.split(`${elem.path}/`)[1].includes('/')
        );
        const children_ids = children.map(child => child.id);
        elem.children = children_ids;
      });

      store.dispatch({ type: 'UPDATE', target: 'nav_dir', content: directoryTree });
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const fetchDirectoryDetails = async (dir_path) => {
    const $target = document.getElementById('my_table').classList.contains('invisible') ? document.getElementById('my_grid') : document.getElementById('my_table');
    $target.classList.add('invisible');
    document.getElementById('placeholder').classList.add('d-flex');
    document.getElementById('placeholder').classList.remove('invisible');
    
    const state = store.getState();
    const url = `${_URL}/cloudstorage/listDirectoryDetails/${dir_path}`;
    
    try {
      const response = await fetch(url, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`Error: ${response.status}`);
      }
      if (response.status === 204) {
        console.log('No Content');
        return;
      }

      const res = await response.json();
      $target.classList.remove('invisible');
      document.getElementById('placeholder').classList.add('invisible');
      document.getElementById('placeholder').classList.remove('d-flex');
      store.dispatch({ type: 'UPDATE', target: 'file_list', content: res.message, dir: dir_path });
      initializeTableHeader();
      document.getElementById('rp_title').textContent = dir_path;
      await fetchItemThumbnailAndDetails(dir_path);
    } catch (error) {
      console.error('Error:', error);
    }
  };

  const fetchDriveStorageInfo = async () => {
    const state = store.getState();
    const url = `${_URL}/cloudstorage/getDriveUsage/`;
    
    try {
      const response = await fetch(url, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`Error: ${response.status}`);
      }
      if (response.status === 204) {
        console.log('No Content');
        return;
      }

      const res = await response.json();
      // used, total, storage_bar
      const used_percentage = parseInt(parseFloat(res.message.used_gb) / parseFloat(res.message.total_gb) * 100);
      document.getElementById('used').textContent = res.message.used_gb.toFixed(2) + 'GB';
      document.getElementById('total').textContent = res.message.total_gb.toFixed(2) + 'GB';
      document.getElementById('storage_bar').style.width = used_percentage + '%';
      document.getElementById('storage_bar').textContent = used_percentage + '%';
    } catch (error) {
      console.error('Error:', error);
    }
  }

  const store = createStore(reducer, window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__());
  window.store = store;
  // store.subscribe(TOC);
  store.subscribe(article);
  store.subscribe(grid_article);
  store.subscribe(updateButtonIconBasedOnCheckboxes);
  store.subscribe(generateBreadcrumbFromPath);

  window.onload = async function(){
    fetchDriveStorageInfo();
    fetchDirectoryDetails('');
    await fetchDirectoryContents();
    TOC();
    
    
    document.getElementById('toggleButton').addEventListener('click', () => {
      store.dispatch({ type: 'UPDATE', target: 'breadcrumb'});
      fetchDirectoryDetails(store.getState().current_path);
    });

    const rightPanel = document.getElementById('right_panel');
    document.getElementById('infoToggleBtn').addEventListener('click', () => {
      rightPanel.classList.toggle('hidden'); // .hidden 클래스 추가
    });
    
    const $my_table = document.getElementById('my_table');
    const $my_grid = document.getElementById('my_grid');
    const $tableBtn = document.getElementById('tableBtn');
    const $gridBtn = document.getElementById('gridBtn');

    // 버튼 및 콘텐츠 전환 함수
    function toggleMode(activeBtn, inactiveBtn, showElement, hideElement) {
      activeBtn.classList.add('currentMode');
      inactiveBtn.classList.remove('currentMode');
      showElement.classList.remove('invisible');
      hideElement.classList.add('invisible');
    }

    // 이벤트 리스너 설정
    $tableBtn.addEventListener('click', () => {
      if (!$tableBtn.classList.contains('currentMode')) {
        toggleMode($tableBtn, $gridBtn, $my_table, $my_grid);
      }
    });

    $gridBtn.addEventListener('click', () => {
      if (!$gridBtn.classList.contains('currentMode')) {
        toggleMode($gridBtn, $tableBtn, $my_grid, $my_table);
      }
    });

    document.getElementById('toggleAllCheckboxId').addEventListener('click', (e) => {
      const { selectedItems, view_contents, current_path } = store.getState();
      const $checkboxes = document.querySelectorAll('#my_table td input');
      let itemName = [];
      $checkboxes.forEach(checkbox => {
        itemName.push(checkbox.dataset.loc === 'undefined' ? `${current_path}/${checkbox.value}` : checkbox.dataset.type === 'directory' ? checkbox.dataset.loc : `${checkbox.dataset.loc}${checkbox.value}`);
      });
      if (selectedItems.length == 0) { // 모든 요소 선택 후, 체크박스 아이콘으로 변경
        store.dispatch({ type: "ADD_SELECTED_ITEMS", payload: itemName });
      } else { // 모든 요소 해제 후, 빈 상자 아이콘으로 변경
        store.dispatch({ type: "REMOVE_SELECTED_ITEMS", payload: itemName });
      }
    });
    
    document.getElementById('downloadBtn').addEventListener('click', async () => {
      const state = store.getState();
      const { selectedItems, current_path } = state;
      const progressBar = document.getElementById('downloadProgress'); // 진행률 바
      const progressBar2 = document.getElementById('downloadProgress2');
      const progressDiv = document.getElementById('progressDiv');
      progressDiv.classList.remove('invisible');
      const $p = progressDiv.querySelector('p');

      let idx = 0;
      let progress2 = 0; 
      const num_of_items = selectedItems.length;

      try {
        for (const file_name of selectedItems) {
          idx += 1;
          const file_path = file_name;
          $p.textContent = file_name.split('/').pop();
          
          const url = `${_URL}/cloudstorage/sendFileResponse/${file_path}`;
          
          // fetch 요청 (HEADERS 포함)
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

          // 파일 크기 가져오기
          const contentLength = response.headers.get('Content-Length');
          if (!contentLength) throw new Error("Cannot determine file size.");
          const totalSize = parseInt(contentLength, 10);

          // 스트리밍 다운로드 설정
          const reader = response.body.getReader();
          let receivedSize = 0; // 받은 데이터 크기
          let chunks = []; // 청크 저장

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            chunks.push(value);
            receivedSize += value.length;

            // 진행률 계산 및 표시
            const progress = Math.round((receivedSize / totalSize) * 100); 
            progressBar.style.width = progress + "%";
            progressBar.innerText = progress + "%";
            
          }
          progress2 = Math.round((idx / num_of_items) * 100);
          progressBar2.style.width = progress2 + "%";
          progressBar2.innerText = progress2 + "%";

          // Blob 생성 및 다운로드 실행
          const blob = new Blob(chunks);
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = file_name.split('/').pop();
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        // 다운로드 완료 후 진행률 초기화
        progressBar.style.width = "0%";
        progressBar.innerText = "0%";
        progressBar2.style.width = "0%";
        progressBar2.innerText = "0%";
        $p.textContent = '';
        progressDiv.classList.add('invisible');

        $('#toggleAllCheckboxId').click();
      } catch (error) {
        console.error('Error: ', error);
      }
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      const state = store.getState();
      const { selectedItems, current_path, directoryTree } = state;
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;

      if (selectedItems.length === 0) {
        console.warn("No items selected for deletion.");
        return;  // 선택된 항목이 없으면 실행하지 않음
      }

      $('#toggleAllCheckboxId').click();

      try {
        const url = `${_URL}/cloudstorage/deleteResource/`;
        // Promise.all을 사용하여 여러 개의 삭제 요청을 병렬로 처리
        const responses = await Promise.all(selectedItems.map(async (file_name) => {
          // const file_path = currentPath ? `${currentPath}/${file_name}` : file_name;
          const data = { path: file_name };

          const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };

          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`Failed to delete ${file_name}: ${response.statusText}`);
          }
          return response.json();  // JSON 응답 반환
        }));

        updateUI(currentPath, directoryTree);
        $('#deleteModal').modal('hide');
      } catch (error) {
        console.error('Error deleting files:', error);
      }
    });

    // '새 폴더' 모달창의 세부 항목의 내용 지정하기
    const $createFolderModal = document.getElementById('createFolderModal')
    if ($createFolderModal) {
      $createFolderModal.addEventListener('show.bs.modal', event => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $createFolderModal.querySelector('.modal-title')
        const modalBodyInput = $createFolderModal.querySelector('.modal-body input')
        modalTitle.textContent = `새 폴더 만들기`;
        modalBodyInput.value = '';
      })
    }

    // '삭제' 모달창의 세부 항목의 내용 지정하기
    const $deleteModal = document.getElementById('deleteModal');
    if ($deleteModal) {
      $deleteModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const recipient = button.getAttribute('data-bs-whatever');
        const state = store.getState();
        const { selectedItems, current_path } = state;
        
        if (selectedItems.length == 1 && !selectedItems[0].includes('.')) {
          $('#deleteModalLabel').html(`<i class="fa-solid fa-triangle-exclamation" style="color: red;"></i>&nbsp;${JSON.stringify(selectedItems).slice(1, -1)}과(와) 모든 하위폴더를 삭제하시겠습니까?`);
        } else {
          $('#deleteModalLabel').html(`<i class="fa-solid fa-triangle-exclamation" style="color: red;"></i>&nbsp;${selectedItems.length}개의 항목을 삭제합니다.`);
        }
      });
    }

    document.getElementById('pasteBtn').addEventListener('click', async () => {
      const { current_path, checkedFilePathsForMove, checkedFilePathsForCopy, directoryTree } = store.getState();
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      
      let url = null;
      let _resource_path = null;
      if (checkedFilePathsForCopy.length > 0 && checkedFilePathsForMove.length == 0) {
        url = `${_URL}/cloudstorage/copyResourcesToDirectory/`;
        _resource_path = checkedFilePathsForCopy;
      } else if (checkedFilePathsForCopy.length == 0 && checkedFilePathsForMove.length > 0) {
        url = `${_URL}/cloudstorage/moveResourcesToDirectory/`;
        _resource_path = checkedFilePathsForMove;
      } else {
        alert('선택된 파일이 없습니다.');
        return
      }

      try {
        const data = { 
          resource_path: _resource_path,
          target_path: currentPath,
        };

        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Failed to transfer ${data['resource_path']} to ${currentPath}: ${response.statusText}`);
        }
        const msg = await response.json();
        console.log(msg.message);
        store.dispatch({ type: 'COMPLETE_TRANSFER_ITEMS' });
        updateUI(currentPath, directoryTree);
      } catch (error) {
        console.error('Error transfering:', error);
      }
    });

    document.getElementById('transferFilesBtn').addEventListener('click', () => {
      const { current_path, selectedItems, directoryTree } = store.getState();
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      // const fileFullPathForTransfer = selectedItems.map(item => `${currentPath}/${item}`);
      store.dispatch({ type: 'RENEW_TRANSFER_ITEMS', payload: selectedItems });
      $('#toggleAllCheckboxId').click();
    });

    document.getElementById('copyFilesBtn').addEventListener('click', () => {
      const { current_path, selectedItems, directoryTree } = store.getState();
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      // const fileFullPathForTransfer = selectedItems.map(item => `${currentPath}/${item}`);
      store.dispatch({ type: 'RENEW_COPY_ITEMS', payload: selectedItems });
      $('#toggleAllCheckboxId').click();      
    });

    document.getElementById('moveFilesBtn').addEventListener('click', () => {
      $('#moveResourcesBtnForModal').click();
    });

    document.getElementById('changeNameBtn').addEventListener('click', () => {
      $('#changeNameBtnForModal').click();
    });

    document.getElementById('toc_modal_confirm').addEventListener('click', async(e) => {
      const { current_path, selectedItems, directoryTree } = store.getState();
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      // const fileFullPathForTransfer = selectedItems.map(item => `${currentPath}/${item}`);
      store.dispatch({ type: 'RENEW_TRANSFER_ITEMS', payload: selectedItems });
      $('#toggleAllCheckboxId').click();

      const { checkedFilePathsForMove } = store.getState();
      
      const url = `${_URL}/cloudstorage/moveResourcesToDirectory/`;
      const _resource_path = checkedFilePathsForMove;
      const target_dir = directoryTree.find(item => item.id == clickedElemId)?.path;

      try {
        const data = { 
          resource_path: _resource_path,
          target_path: target_dir,
        };

        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Failed to transfer ${data['resource_path']} to ${target_dir}: ${response.statusText}`);
        }
        const msg = await response.json();
        console.log(msg.message);
        store.dispatch({ type: 'COMPLETE_TRANSFER_ITEMS' });
        $('#moveResourcesModal').modal('hide');
        updateUI(currentPath, directoryTree);
      } catch (error) {
        console.error('Error transfering:', error);
      }
    });

    // '이름 바꾸기' 모달창의 세부 항목의 내용 지정하기
    const $changeNameModal = document.getElementById('changeNameModal');
    if ($changeNameModal) {
      $changeNameModal.addEventListener('show.bs.modal', event => {
        const { selectedItems } = store.getState();
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $changeNameModal.querySelector('.modal-title')
        const modalBodyInput = $changeNameModal.querySelector('.modal-body input')
        modalTitle.textContent = `이름 바꾸기`;
        modalBodyInput.value = `${selectedItems[0].split('/').pop()}`;
      });
    }

    let toc_modal_flag = true;
    let clickedElemId = null;
    const $moveResourcesModal = document.getElementById('moveResourcesModal');
    if ($moveResourcesModal) {
      $moveResourcesModal.addEventListener('show.bs.modal', event => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $moveResourcesModal.querySelector('.modal-title')
        const modalBody = $moveResourcesModal.querySelector('.modal-body')
        modalTitle.textContent = `위치 선택`;

        const { directoryTree } = store.getState();
        const html_for_toc = directoryTree
          .filter(item => item.type === 'directory')
          .map(({ id, path, children, pathForDisplay, subdirectoryDepth }) => `
            <a href='#' data-id="${id}" data-subids="${JSON.stringify(children)}" class="list-group-item ${path.includes('/') ? 'invisible' : ''}">
              ${getStyledDirectoryName(pathForDisplay, subdirectoryDepth, path)}
            </a>
          `).join('');

        const $toc_modal = document.getElementById('toc_modal');   
        $toc_modal.innerHTML = html_for_toc;

        $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });

        if (!toc_modal_flag) {
          return
        }   
        
        $toc_modal.addEventListener('click', function(e) {
          e.preventDefault();
          $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });
          const elem = e.target.closest('.list-group-item');
          if (elem) {
            clickedElemId = elem.dataset.id;
            elem.querySelector('i').style.color = "#4078FF";
            elem.style.color = "#4078FF";
            elem.style.fontWeight = "bold";
            const subIds = JSON.parse(elem.dataset.subids);
            if (subIds.length > 0) {
              if (!elem.classList.contains('open')) {
                toggleFolderIcon(elem, true);
                elem.classList.add('open');
              } else {
                toggleFolderIcon(elem, false);
                elem.classList.remove('open');
              }
              displayTagsById(subIds, true);
            }
          }
        });
        toc_modal_flag = false;
      });
    } 

    document.getElementById('extractBtn').addEventListener('click', async(e) => {
      const { current_path, selectedItems, directoryTree } = store.getState();
      // console.log(selectedItems);
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      // const temp = selectedItems[0].split('.');
      const ext = selectedItems[0].split('.').pop();
      const idx = selectedItems.length;

      if (idx !== 1 || ext !== 'zip') {
        alert('압축 풀기는 한 개의 zip 형식의 파일을 대상으로만 가능합니다.');
        return
      }

      try {
        const url = `${_URL}/cloudstorage/unzipAndStoreResources/`;

        const data = { 
          resource_path: selectedItems[0],
          current_path: currentPath,
        };

        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Failed to extrct ${data['resource_path']}: ${response.statusText}`);
        }
        const msg = await response.json();
        console.log(msg.message);
        updateUI(currentPath, directoryTree);
      } catch (error) {
        console.error('Error extracting:', error);
      }
    });

    document.getElementById('compressBtn').addEventListener('click', async(e) => {
      const { current_path, selectedItems, directoryTree } = store.getState();
      // console.log(selectedItems);
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      // const resource_paths = selectedItems.map(item => `${currentPath}/${item}`);
      try {
        // console.log(resource_paths);
        const url = `${_URL}/cloudstorage/zipAndSaveResources/`;

        const data = { 
          resource_paths: selectedItems,
          current_path: currentPath,
        };

        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Failed to compress ${data['resource_paths']}: ${response.statusText}`);
        }
        const msg = await response.json();
        console.log(msg.message);
        updateUI(currentPath, directoryTree);
      } catch (error) {
        console.error('Error compressing:', error);
      }
    });

    // '이름 바꾸기' 모달창에서 '정하기'를 클릭했을 시, 사용자가 입력한 이름으로 폴더 또는 파일의 이름이 바뀌게 할 것
    document.getElementById('changeNameForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = e.target.querySelector('input').value;
      const { current_path, directoryTree, selectedItems } = store.getState();
      if (selectedItems.length !== 1) {
        alert('한 개의 폴더 또는 파일의 이름만을 바꿀 수 있습니다.')
        return
      }
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      const selectedItem = selectedItems[0].startsWith('/') ? selectedItems[0].slice(1) : selectedItems[0];
      const pathArray = selectedItem.split('/');
      
      try {
        const url = `${_URL}/cloudstorage/renameResource/`;
        const data = { 
          resource_path: selectedItem,
          renamed_path: `${pathArray.slice(0, pathArray.length - 1).join('/')}/${name}`,
        };

        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Failed to rename ${data['resource_path']}: ${response.statusText}`);
        }
        const msg = await response.json();
        console.log(msg.message);
        updateUI(currentPath, directoryTree);
        $('#changeNameModal').modal('hide');
      } catch (error) {
        console.error('Error renaming:', error);
      }
    });

    // '새 폴더 만들기' 모달창에서 '정하기'를 클릭했을 시, 입력한 이릉의 폴더가 current_path 하위에 생성되도록 서버에 요청하기
    document.getElementById('createFolderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dir_name = e.target.querySelector('input').value;
      const { current_path, directoryTree } = store.getState();
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;

      try {
        const url = `${_URL}/cloudstorage/createFolderAtPath/`;
        const dir_path = `${currentPath}/${dir_name}`;
        const data = { path: dir_path };

        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Failed to create ${dir_path}: ${response.statusText}`);
        }
        const msg = await response.json();
        updateUI(currentPath, directoryTree);
        $('#createFolderModal').modal('hide');
      } catch (error) {
        console.error('Error creating new folder:', error);
      }
    });

    let isComposing = false; // IME 입력 중 여부를 저장

    // 모든 입력 필드에 대해 이벤트 리스너 추가
    document.querySelectorAll('.inputField').forEach(input => {
      input.addEventListener('compositionstart', () => {
        isComposing = true;
      });

      input.addEventListener('compositionend', (event) => {
        isComposing = false;
        event.target.value = event.target.value.replace(/[^a-zA-Z0-9가-힣\s._-]/g, ''); // 최종 검증
      });

      input.addEventListener('input', (event) => {
        if (!isComposing) {
          event.target.value = event.target.value.replace(/[^a-zA-Z0-9가-힣\s._-]/g, '');
        }
      });
    });

    // 파일 크기에 따른 청크 크기 설정 (사이즈: 청크 크기)
    // CHUNK_SIZES = {
    //   1 * 1024 * 1024: 1024 * 64,   # 1MB 이상 100MB 미만 → 64KB
    //   100 * 1024 * 1024: 1024 * 128,  # 100MB 이상 500MB 이하 → 128KB
    //   500 * 1024 * 1024: 1024 * 512,  # 500MB 이상 1GB 미만 → 512KB
    //   1 * 1024 * 1024 * 1024: 1024 * 1024  # 1GB 이상 → 1MB
    // }

    // 📂 폴더 선택 시 이벤트
    document.getElementById('inputFolder').addEventListener('change', async function (event) {
      const fileList = Array.from(event.target.files).map(file => ({
        file,
        relativePath: file.webkitRelativePath
      }));
      await handleFileUpload(fileList, _URL + '/cloudstorage/saveUploadedFolderFromChunks/', true);
      this.value = '';
    });

    // 📄 파일 선택 시 이벤트
    document.getElementById('inputFiles').addEventListener('change', async function (event) {
      const fileList = Array.from(event.target.files).map(file => ({ file })); // 파일도 동일한 구조로 맞춤
      await handleFileUpload(fileList, _URL + '/cloudstorage/saveUploadedFileFromChunks/');
      this.value = '';
    });

    document.getElementById('file_list').addEventListener("dragover", (event) => {
      event.preventDefault();
      event.currentTarget.style.border = "5px solid red";
    });

    document.getElementById('file_list').addEventListener("dragleave", (event) => {
      event.currentTarget.style.border = "";
    });

    document.getElementById('file_list').addEventListener("drop", async function (event) {
      event.preventDefault();
      this.style.border = "";

      let items = event.dataTransfer.items;
      if (!items) return;

      let fileList = [];
      for (const item of items) {
        const entry = item.webkitGetAsEntry();
        if (entry) await getAllFilesFromDirectory(entry, fileList);
      }

      if (fileList.length === 0) {
        alert("업로드할 파일이 없습니다.");
        return;
      }

      // 🛠 단순 파일 드래그&드롭 처리
      if (fileList.every(item => !item.relativePath)) {
        fileList = fileList.map(fileObj => ({ file: fileObj.file }));
      }

      await handleFileUpload(fileList, _URL + '/cloudstorage/saveUploadedFolderFromChunks/', true);
    });

    async function handleFileUpload(files, uploadUrl, isFolder = false) {
      if (!files || files.length === 0) {
        alert("업로드할 파일이 없습니다.");
        return;
      }

      const { current_path, directoryTree } = store.getState();
      const chunkSize = 1 * 1024 * 1024;
      const currentPath = current_path.startsWith('/') ? current_path.slice(1) : current_path;
      const progressBar = document.getElementById('downloadProgress');
      const progressBar2 = document.getElementById('downloadProgress2');
      const progressDiv = document.getElementById('progressDiv');
      const $p = progressDiv.querySelector('p');

      progressDiv.classList.remove('invisible');

      let idx = 0;
      const num_of_items = files.length;

      for (const fileObj of files) {
        if (!fileObj || !fileObj.file) {
          console.warn("⚠ 잘못된 파일 객체 발견, 건너뜁니다.", fileObj);
          continue;
        }

        const file = fileObj.file;
        const filePath = isFolder ? fileObj.relativePath : currentPath;
        idx += 1;

        const totalChunks = Math.ceil(file.size / chunkSize);
        $p.textContent = file.name;

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
          const start = chunkIndex * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          const formData = new FormData();
          formData.append('file', chunk);
          formData.append('fileName', file.name);
          formData.append('filePath', filePath);
          formData.append('chunkIndex', chunkIndex);
          formData.append('totalChunks', totalChunks);
          formData.append('currentPath', currentPath);

          try {
            const response = await fetch(uploadUrl, {
              method: 'POST',
              body: formData
            });

            const res = await response.json();
            // console.log(`Chunk ${chunkIndex + 1}/${totalChunks} uploaded:`, res.message);

            const progress = Math.round((chunkIndex / totalChunks) * 100);
            progressBar.style.width = progress + "%";
            progressBar.innerText = progress + "%";
          } catch (error) {
            console.error("❌ 파일 업로드 중 오류 발생:", error);
          }
        }

        progressBar.style.width = "0%";
        progressBar.innerText = "0%";
        progressBar2.style.width = Math.round((idx / num_of_items) * 100) + "%";
        progressBar2.innerText = Math.round((idx / num_of_items) * 100) + "%";
        $p.textContent = '';
      }

      progressDiv.classList.add('invisible');
      updateUI(currentPath, directoryTree);
    }

    async function updateUI(currentPath, directoryTree) {
      const links = document.querySelectorAll('#toc > a:not(.invisible)');
      const dataIds = Array.from(links, link => link.getAttribute('data-id'));
      const pathForDisplay = directoryTree.filter(item => dataIds.includes(item.id.toString())).map(item => item.path);
      
      await fetchDirectoryDetails(currentPath);
      await fetchDriveStorageInfo();
      await fetchDirectoryContents();
      TOC();

      const state = store.getState();
      const newDirTree = state.directoryTree;
      const pathFromDirTree = directoryTree.map(item => item.path);
      const pathFromNewDirTree = newDirTree.map(item => item.path);
      const addedItems = pathFromNewDirTree.filter(item => !pathFromDirTree.includes(item))
      const renewedIds = newDirTree.filter(item => pathForDisplay.includes(item.path) || addedItems.includes(item.path)).map(item => item.id.toString());

      document.querySelectorAll('#toc > a').forEach(link => {
        renewedIds.includes(link.dataset.id) ? link.classList.remove("invisible") : link.classList.add("invisible");
      });
    }

    async function getAllFilesFromDirectory(entry, fileList, path = "") {
      return new Promise((resolve, reject) => {
        if (entry.isFile) {
          entry.file(file => {
            fileList.push({ file, relativePath: path + file.name });
            resolve();
          }, reject);
        } else if (entry.isDirectory) {
          const reader = entry.createReader();
          reader.readEntries(async entries => {
            if (!entries.length) return resolve();
            await Promise.all(entries.map(subEntry => getAllFilesFromDirectory(subEntry, fileList, path + entry.name + "/")));
            resolve();
          }, reject);
        }
      });
    }

    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const searchWord = e.target.querySelector('input').value;
      if (searchWord.length < 2) {
        alert('두 글자 이상의 검색어를 입력해 주세요.');
        return
      }
      e.target.querySelector('input').value = '';

      const { current_path } = store.getState();
      let dir_path = current_path.startsWith('/') ? current_path.slice(1) : current_path; 
      
      const $target = document.getElementById('my_table').classList.contains('invisible') ? document.getElementById('my_grid') : document.getElementById('my_table');
      $target.classList.add('invisible');
      document.getElementById('placeholder').classList.add('d-flex');
      document.getElementById('placeholder').classList.remove('invisible');

      const url = `${_URL}/cloudstorage/searchResourcesInfoList/${searchWord}`;
      try {
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) {
          throw new Error(`Error: ${response.status}`);
        }
        if (response.status === 204) {
          console.log('No Content');
          return;
        }
        const res = await response.json();

        $target.classList.remove('invisible');
        document.getElementById('placeholder').classList.add('invisible');
        document.getElementById('placeholder').classList.remove('d-flex');
        if (res.message.length > 0) {
          store.dispatch({ type: 'UPDATE', target: 'file_list', content: res.message, dir: '' });
          initializeTableHeader();
        } else {
          const $table_header = document.getElementById('table_header');
          const $table_body = document.getElementById('table_body');
          const $ths = $table_header.querySelectorAll('th');
          const $grid_table = document.getElementById('grid_content');
          $ths.forEach(th => {
            th.remove();
          });
          $table_body.innerHTML = `<p class="mt-5" style="text-align: center;"><span class="fw-semibold" style="color: #4078FF">${searchWord}</span>에 대한 파일 및 폴더 검색 결과가 없습니다.</p>`;
          $grid_table.innerHTML = `<p class="mt-2" style="text-align: center; margin-left: 26.5rem;"><span class="fw-semibold" style="color: #4078FF">${searchWord} </span>에 대한 파일 및 폴더 검색 결과가 없습니다.</p>`;
        }
        
        search_word = searchWord;
        allowSubscriptionCall = false;
        generateBreadcrumbFromPath();
        document.getElementById('right_panel').innerHTML = `
          <div id="rp_header" class="fs-5">
            <span id="rp_title" class="fw-semibold"></span>
          </div>
          <div id="rp_thumb"></div>
          <table class="table">
            <tbody id="rp_text_info">
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error:', error);
      }
    });
  }
</script>
{% endblock %}