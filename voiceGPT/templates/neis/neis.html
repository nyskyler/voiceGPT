{% extends "base2.html" %}
{% block content %}
<style>
  #mainRow {
    display: flex;
    flex-direction: row;
    height: 94vh;
  }

  .sideBar {
    display: flex;
    flex-direction: column;
    flex: auto;
    border-right: 2px solid #cecfd1;
    overflow-y: auto;
  }

  .sideBar-hidden {
    display: none;
    padding: 0px;
  }

  .contentWindow {
    display: flex;
    flex-direction: column;
    flex: auto;
    /* border-left: 1px solid #cecfd1; */
    transition: flex 0.5s ease;
    /* 슬라이드 애니메이션 */
  }

  .contentWindow-expanded {
    flex-grow: 1;
    /* 부모 너비를 기준으로 남은 공간 채우기 */
    transition: flex-grow 0.5s ease;
  }

  #content_header {
    display: flex;
    flex-flow: row nowrap;
    justify-content: space-between;
    padding: 1rem 0.5rem 0.2rem 0;
  }

  #select_form {
    display: flex;
    flex-flow: row wrap;
    align-items: baseline;
    justify-content: start;
    background-color: #f3f4f8;
    padding: 0.5rem 1rem 0.5rem 2rem;
    position: relative;
    margin-left: 0.3rem;
    margin-right: 1rem;
  }

  #content_wrapper {
    padding: 0.5rem 1rem 0.5rem 0.3rem;
    flex-grow: 1;
  }

  .achievementStandardsAndAssessment {
    display: flex;
    flex-direction: row;
    font-size: 0.75rem;
    color: #3a5877;
    margin-top: 0.3rem;
  }

  .achievementStandardsAndAssessment>div {
    padding: 1rem 0 1rem 0;
    border-top: 1.5px solid #74787d;
    border-bottom: 1px solid #e7e8e8;
  }

  .achievementStandardsAndAssessment>div:nth-child(2n+1) {
    background-color: #eff0f5;
    text-align: center;
  }

  .toggleAllcheckboxes {
    padding: 0px;
    border: none;
  }

  .inputField,
  .inputField:focus {
    border: 1px solid #bb395a;
    box-shadow: none;
  }

  #menu_e2_content,
  #menu_k_content,
  #menu_m_content,
  #menu_n_content {
    display: flex;
    flex-flow: row wrap;
    height: 100%;
  }

  #menu_e2_content_left,
  #menu_k_content_left,
  #menu_m_content_left,
  #menu_n_content_left,
  #menu_b_content_table1,
  #menu_b_content_table2 {
    position: relative;
    display: flex;
    flex-direction: column;
    /* padding-right: 0.4rem; */
  }

  #menu_e2_content_right,
  #menu_k_content_right,
  #menu_m_content_right,
  #menu_n_content_right {
    position: relative;
    display: flex;
    flex-direction: column;
    padding-left: 0.8rem;
  }

  #menu_e1_content,
  #menu_g_content,
  #menu_h_content,
  #menu_i_content,
  #menu_j_content,
  #menu_b_content,
  #menu_c_content,
  #menu_d_content {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  #menu_g_table {
    margin-top: 0.5rem;
  }

  #menu_e1_table,
  #menu_e2_table_1,
  #menu_e2_table_2,
  #menu_g_table,
  #menu_h_table,
  #menu_i_table,
  #menu_j_table,
  #menu_k_table_1,
  #menu_k_table_2,
  #menu_m_table_1,
  #menu_n_table_1,
  #menu_n_table_2,
  #menu_b_table,
  #menu_c_table,
  #menu_d_table {
    flex-grow: 1;
  }

  .accordion-body {
    padding: 0.3rem 0rem 0.3rem 0.6rem;
    border-top: 0.5px solid #cecfd1;
  }

  .list-group-item:hover,
  .accordion-button:hover {
    color: #3d64dc;
  }

  .list-group-item {
    font-size: 0.8rem;
    color: #68758E;
    padding: 0.3rem 0rem 0.3rem 0.5rem;
    border: none;
    cursor: pointer;
  }

  #nav_dir_modal {
    flex: auto;
    padding: 1rem;
    overflow-y: auto;
    background-color: #F6F7FA;
  }
  #toc_modal {
    white-space: nowrap; /* 줄 바꿈 방지 */
    overflow-x: auto;    /* 가로 스크롤 표시 */
    display: block;      /* ul 기본 블록 요소로 설정 */
    max-height: 400px;
    overflow: auto;
  }
  #toc_modal li {
    display: inline-block; /* 목록 항목을 인라인 블록으로 설정하여 한 줄에 표시 */
  }
  .invisible {
    display: none;
  }
  #nav_dir .list-group-item, #nav_dir_modal .list-group-item {
    border: none;
    background-color: #F6F7FA;
    font-size: 0.85rem;
    padding-top: 0.2rem;
    padding-bottom: 0.2rem;
  }

  .accordion-button {
    color: #393372;
    padding: 0.5rem 1rem 0.5rem 0.6rem;
  }

  .list-group-item.active {
    color: #3d64dc;
    background-color: transparent;
  }

  #toggle-button {
    /* position: absolute; */
    position: relative;
    top: 45%;
    border: none;
    /* left: 16.669%; */
  }

  #toggle-button button {
    color: #ffffff;
    background-color: #263574;
    border-radius: 0% 13% 13% 0%;
    height: 3.5rem;
    padding: 1.5px;
  }

  .form-select-sm {
    font-size: 0.8rem;
    padding: 0;
    padding-left: 1rem;
  }

  .select-width-sm {
    width: 6.5rem;
    height: 1.4rem;
  }

  .select-width-md {
    width: 7.9rem;
    height: 1.4rem;
  }

  .select-width-lg {
    width: 9.3rem;
    height: 1.4rem;
  }

  .select-width-xl {
    width: 10.7rem;
    height: 1.4rem;
  }

  .select-width-xxl {
    width: 12.1rem;
    height: 1.4rem;
  }

  .select-width-full {
    width: 100%;
    height: 1.4rem;
  }

  .form-label {
    color: #bb395a;
    font-size: 0.8rem;
  }

  .form-select,
  .form-select:focus {
    border: 1px solid #bb395a;
    outline: none;
    box-shadow: none;
    display: inline-block;
    vertical-align: middle;
  }

  textarea, textarea:focus {
    border: 1px solid #bb395a;
    border-radius: 5px;
    outline: none;
    box-shadow: none;
    display: inline-block;
    vertical-align: middle;
  }

  #submitBtn {
    position: absolute;
    width: 3.5rem;
    padding: 0.1rem;
    bottom: 0.7rem;
    right: 0.7rem;
    font-size: 0.8rem;
  }

  .fixed-label {
    display: inline-block;
    width: 100px;
    /* 원하는 너비 */
  }

  #subselection {
    display: flex;
    flex-flow: row nowrap;
    justify-content: flex-start;
    align-items: center;
    margin-left: 0.3rem;
    margin-right: 1rem;
  }

  .subselectionBtn {
    flex: auto;
    height: 3rem;
    background-color: transparent;
    border: 1px solid #8a8e98;
    color: #8a8e98;
    border-radius: 8px;
    margin-top: 0.4rem;
    padding: 0.5rem 0.8rem;
    font-weight: normal;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }

  /* 클릭되었을 때 스타일 (예: .active 클래스 추가 시) */
  .subselectionBtn.active {
    border: 2px solid #3772ff;
    color: black;
    font-weight: bold;
  }

  .btn {
    margin-left: 0.4rem;
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem 0.2rem 0.4rem;
  }

  .table-banner {
    display: inline-block;
    position: absolute;
    right: 0rem;
  }

  .table_caption {
    font-weight: 500;
    font-size: 0.75rem;
    color: #3a5877;
  }

  .table thead th {
    position: sticky;
    top: 0;
    background-color: #eff0f5;
    /* 헤더 배경색 설정 */
    z-index: 1;
    /* 다른 콘텐츠보다 위에 표시되도록 설정 */
    font-weight: 500;
    font-size: 0.75rem;
    color: #3a5877;
  }

  .table tbody td {
    font-weight: 500;
    font-size: 0.75rem;
    color: #3a5877;
  }

  input[type="text"],
  input[type="number"] {
    font-size: 0.8rem;
    text-align: center;
  }

  .form-check-input:focus {
    box-shadow: none;
  }

  #dob {
    font-size: 0.8rem;
  }
  input.eval_input, input.eval_input:focus {
    border: 0px;
    outline: none;
    box-shadow: none;
  }
</style>
<div class="container-fluid" style="padding: 0px;">
  <div id="mainRow">
    <div id="nav" class="sideBar col-12 col-sm-3 col-xl-2">
      <div class="accordion accordion-flush" id="accordionFlushExample">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse"
              data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true"
              aria-controls="panelsStayOpen-collapseOne">
              학교정보
            </button>
          </h2>
          <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
            <div class="accordion-body">
              <ul class="list-group fw-semibold">
                <li class="list-group-item">기준년도/학기관리</li>
                <li class="list-group-item">학년/반정보관리</li>
                <li class="list-group-item">학생개별자료삭제</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse"
              data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false"
              aria-controls="panelsStayOpen-collapseTwo">
              평가계획
            </button>
          </h2>
          <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
            <div class="accordion-body">
              <ul class="list-group fw-semibold">
                <li class="list-group-item">평가계획(안)관리</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse"
              data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false"
              aria-controls="panelsStayOpen-collapseThree">
              학생평가
            </button>
          </h2>
          <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse">
            <div class="accordion-body">
              <ul class="list-group fw-semibold">
                <li class="list-group-item">성취기준별 평가</li>
                <li class="list-group-item">영역별 평가</li>
                <li class="list-group-item">교과별 평가</li>
                <li class="list-group-item">학기말종합의견</li>
                <li class="list-group-item">교과학습발달상황</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse"
              data-bs-target="#panelsStayOpen-collapseFour" aria-expanded="false"
              aria-controls="panelsStayOpen-collapseFour">
              성적조회
            </button>
          </h2>
          <div id="panelsStayOpen-collapseFour" class="accordion-collapse collapse">
            <div class="accordion-body">
              <ul class="list-group fw-semibold">
                <li class="list-group-item">교과별 성적조회</li>
                <li class="list-group-item">개인별 성적조회</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse"
              data-bs-target="#panelsStayOpen-collapseFive" aria-expanded="false"
              aria-controls="panelsStayOpen-collapseFive">
              관찰기록관리
            </button>
          </h2>
          <div id="panelsStayOpen-collapseFive" class="accordion-collapse collapse">
            <div class="accordion-body">
              <ul class="list-group fw-semibold">
                <li class="list-group-item">관찰내용관리</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="toggle-button">
      <button><i id="btnIcon" class="fa-solid fa-caret-left fs-6"></i></button>
    </div>
    <div id="content_window" class="contentWindow col-12 col-sm-9 col-xl-10">
      <div id="content_header"></div>
      <div id="subselection" class="mb-2"></div>
      <form id="select_form">
        <div class="d-flex col col-xl-11">
          <div id="select_wrapper" style="flex-grow: 1;" class="row row-cols-xxl-5"></div>
        </div>
        <div id="submit_div" class="col col-xl-1">
          <!-- <button id="submitBtn" type="sumbit" class="btn btn-primary fw-semibold" form="select_form"><i class="fa-solid fa-magnifying-glass"></i>&ensp;조회</button> -->
        </div>
      </form>
      <div id="content_wrapper"></div>
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="module">
  import { createStore } from 'https://cdnjs.cloudflare.com/ajax/libs/redux/5.0.1/redux.legacy-esm.js';

  const MENU = {
    B: '기준년도/학기관리',
    C: '학년/반정보관리',
    D: '학생개별자료삭제',
    E: '평가계획(안)관리',
    G: '성취기준별 평가',
    H: '영역별 평가',
    I: '교과별 평가',
    J: '학기말종합의견',
    K: '교과학습발달상황',
    L: '교과별 성적조회',
    M: '개인별 성적조회',
    N: '관찰내용관리'
  };

  const productionURL = 'http://121.189.157.152:8080';
  const testURL = 'http://127.0.0.1:8080';
  const localURL = 'http://172.30.1.25:8080';
  let _URL = null;
  if (window.location.href.split('/')[2] === '127.0.0.1:8080') {
    _URL = testURL;
  } else if (window.location.href.split('/')[2] === '172.30.1.25:8080') {
    _URL = localURL;
  } else {
    _URL = productionURL;
  }

  function removeActiveClassFromListItems(target) {
    // list-group-item 클래스를 가진 모든 li 태그를 대상으로 active 클래스을 갖고 있다면 모두 제거
    const $elem = document.querySelector('li.list-group-item.active');
    if ($elem === target) {
      return
    }
    $elem?.classList.remove('active');
    target?.classList.add('active');
  }

  function updateAccordionCssOnClick(target) {
    // 클릭한 부트스트랩 아코디언 컴포넌트의 css를 변경
    const $btns = document.querySelectorAll('.accordion-button');
    $btns.forEach(btn => {
      const flag = (btn === target) && (btn.getAttribute('aria-expanded') === 'true')
      const background_color = flag ? '#EFF3FB' : 'transparent';
      const font_color = flag ? '#3B4ED9' : '#433D79';
      btn.style.backgroundColor = background_color;
      btn.style.color = font_color;
    });
  }

  function toggleAccordionButtonCss(target) {
    // 클릭한 list-group-item에서 가장 가까운(closest) accordion-button 요소를 찾아 css를 추가하며, 그 대신 다른 accord-button 요소의 css는 초기화
    const $btns = document.querySelectorAll('.accordion-button');
    const $elem = target.closest('.accordion-item')?.querySelector('button');
    $btns.forEach(btn => {
      const flag = (btn === $elem)
      const background_color = flag ? '#EFF3FB' : 'transparent';
      const font_color = flag ? '#3B4ED9' : '#433D79';
      btn.style.backgroundColor = background_color;
      btn.style.color = font_color;
    });
  }

  function renderHeaderSection(menu) {
    // 웹페이지에서 header(각 페이지의 맨 윗부분에 자동으로 붙는 부분)를 렌더링
    const html = `
      <span class="fw-bold fs-5" style="color: #2b4065;">
        <button style="border: none; color: #263574; background-color: #ffffff;">
          <i class="fa-solid fa-cube"></i>    
        </button>
        ${menu}</span>
      <span>temp</span>
    `;
    return html;
  }

  function renderSubselectionMenu(menu) {
    // 평가계획과 관련한 메뉴 선택 시에만 활성화되는 id가 'subselection'인 div 태그를 렌더링
    return `
      <button type="button" class="subselectionBtn active"><i class="fa-solid fa-rotate fs-6"></i>&ensp;성취기준관리</button>
      <i class="fa-solid fa-caret-right" style="padding: 0.2rem; color: #777c87;"></i>
      <button type="button" class="subselectionBtn"><i class="fa-regular fa-file-lines fs-6"></i>&ensp;성취기준(평가기준)관리</button>
    `;
  }

  function createLabeledSelectSpan(label, id, width) {
    // 이름과 아이디 값을 인자로 받아 label과 select 태그가 포함된 일정한 형식의 span 태그를 반환
    if (label === undefined) {
      return `<span></span>`;
    }
    return `
      <span class="d-flex">
        <label for="${id}" class="form-label fw-bold me-3 text-end fixed-label">*${label}</label>
        <select id="${id}" class="form-select form-select-sm select-width-${width}" style="text-overflow: ellipsis; padding-left: 0.5rem; padding-right: 1.5rem;">
        </select>
      </span>
    `;
  }

  function renderSelectFormForGETRequest(menu) {
    // 서버측에 GET 요청을 하기에 앞서 원하는 항목을 지정하기 위해 필요한 여러 개의 select 태그로 구성된 form을 렌더링
    let html = null;
    let arrayForHTML = null;
    const $submitDiv = document.getElementById('submit_div');
    $submitDiv.innerHTML = '';
    $submitDiv.innerHTML = `<button id="submitBtn" type="sumbit" class="btn btn-primary fw-semibold" form="select_form"><i class="fa-solid fa-magnifying-glass"></i>&ensp;조회</button>`;
    document.getElementById('select_form').style.display = 'block';
    switch (menu) {
      case MENU.B:
      case MENU.C:
        document.getElementById('select_form').style.display = 'none';
        return
      case MENU.D:
        return `
          <span class="d-flex">
            <label for="name" class="form-label fw-bold me-3 text-end fixed-label">*성명</label>
            <input type="text" class="form-control inputField select-width-lg" id="name" maxlength="50" placeholder="" autocomplete="off">
          </span>
          <span class="d-flex">
            <label for="dob" class="form-label fw-bold me-3 text-end fixed-label">*생년월일</label>
            <input type="date" class="form-control inputField select-width-lg" id="dob" placeholder="" autocomplete="off">
          </span>
        `;
      case MENU.E:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학기', 'semester', 'sm'], ['학년', 'grade', 'sm'], ['교과(목)', 'subject', 'sm'], ['영역', 'field', 'md']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      case MENU.G:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학기', 'semester', 'sm'], ['학년', 'grade', 'sm'], ['반', 'class', 'sm'], ['교과(목)', 'subject', 'sm'],
        ['영역', 'field', 'md'], ['성취기준', 'standard', 'full']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      case MENU.H:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학기', 'semester', 'sm'], ['학년', 'grade', 'sm'], ['반', 'class', 'sm'], ['교과(목)', 'subject', 'sm'],
        ['영역', 'field', 'md']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      case MENU.I:
      case MENU.J:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학기', 'semester', 'sm'], ['학년', 'grade', 'sm'], ['반', 'class', 'sm'], ['교과(목)', 'subject', 'sm']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      case MENU.K:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학년', 'grade', 'sm'], ['반', 'class', 'sm']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      case MENU.L:
      case MENU.M:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학기', 'semester', 'sm'], ['학년', 'grade', 'sm'], ['반', 'class', 'sm'], ['영역', 'field', 'lg']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      case MENU.N:
        arrayForHTML = [['학년도', 'year', 'sm'], ['학기', 'semester', 'sm'], ['학년', 'grade', 'sm'], ['반', 'class', 'sm'], ['교과(목)', 'subject', 'sm']];
        html = arrayForHTML.map(arr => {
          return createLabeledSelectSpan(...arr);
        });
        return html.join('');
      default:
        return
    }
  }

  function renderSelectAllCheckboxButton(width) {
    // 테이블의 header에 위치한 checkbox 요소로 체크할 시, tbody에 있는 모든 행을 전체 선택하는 데 쓰이는 버튼을 렌더링
    return `
      <th scope="col" style="width: ${width}%;"><button class="toggleAllcheckboxes"><i class="fa-regular fa-square fs-6" style="color: #979aa4; background-color: white; padding: 0px;"></i></button></th>
    `;
  }

  function renderEmptyTbodyWithMessage(colspan, str="데이터를 조회해 주십시오.") {
    // 데이터를 조회하기 전 테이블 tbody의 빈 공간에 '데이터를 조회해 주십시오.'라는 디폴트 문구가 나타나는 화면을 렌더링
    return `
      <tr>
        <td colspan="${colspan}" class="text-center text-muted" style="vertical-align: middle;">
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" 
                fill="none" viewBox="0 0 24 24" stroke-width="1.5" 
                stroke="currentColor" class="mb-2" style="width: 48px; height: 48px; color: #6c757d;">
              <path stroke-linecap="round" stroke-linejoin="round" 
                    d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z" />
            </svg>
            <br />
            ${str}
          </div>
        </td>
      </tr>
    `;
  }

  const VISIBLE_STATUS_MAP = { // 데이터베이스 상의 데이터(true, false)를 화면에 보여지는 데이터('O', 'X')로 전환하기 위해, 화면 상의 데이터를 키로 전달하면 화면에 보여지는 데이터(값)으로 전환해주는 자바스크립트 객체 상수
    true: 'O',
    false: 'X',
    null: '',
    undefined: ''
  };

  const updateButtonStatesWithStyles = (...btnArr) => {
    // [[$btn, true], [$btn2, false]]와 같이 버튼 태그의 선택자와 boolean 값을 요소로 하는 2차원 배열을 인자로 받아 각각의 버튼 태그의 활성화 여부 및 css 스타일을 변화시키는 자바스크립트 함수
    btnArr.forEach(arr => {
      if (arr[1] == true) {
        arr[0].classList.replace('btn-primary', 'btn-secondary');
        arr[0].disabled = true;
      } else {
        arr[0].classList.replace('btn-secondary', 'btn-primary');
        arr[0].disabled = false;
      }
    });
  }

  function toggleAllTableCheckboxes(tableSelector, sideEffect = undefined) {
    // 테이블의 선택자를 인자로 받아 해당 테이블 내부에 있는 체크박스를 일괄로 선택하거나 해제하는 toogleAllCheckboxes 토글 버튼의 조작을 정의
    const $tbody = document.querySelector(`${tableSelector} tbody`);
    const $toggleBtn = document.querySelector(`${tableSelector} button.toggleAllcheckboxes`);
    $tbody.addEventListener('click', event => {
      if (event.target.classList.contains('form-check-input')) {
        const totalRowCnt = $tbody.rows.length;
        const checkedNum = $tbody.querySelectorAll('input.form-check-input:checked').length;
        if (checkedNum == 0) {
          $toggleBtn.innerHTML = `<i class="fa-regular fa-square fs-6" style="color: #979aa4; background-color: white;"></i>`;
        } else if (checkedNum == totalRowCnt) {
          $toggleBtn.innerHTML = `<i class="fa-solid fa-square-check fs-6" style="color: #4078FF;"></i>`;
        } else {
          $toggleBtn.innerHTML = `<i class="fa-solid fa-square-minus fs-6" style="color: #4078FF;"></i>`;
        }
      }
    });
    $toggleBtn.addEventListener('click', event => {
      event.preventDefault();
      const classList = Array.from(event.target.classList);
      const checkboxes = $tbody.querySelectorAll('input.form-check-input');
      if (classList.includes('fa-square')) {
        checkboxes.forEach(cb => {
          cb.checked = true;
        });
        $toggleBtn.innerHTML = `<i class="fa-solid fa-square-check fs-6" style="color: #4078FF;"></i>`;
      } else {
        checkboxes.forEach(cb => {
          cb.checked = false;
        });
        $toggleBtn.innerHTML = `<i class="fa-regular fa-square fs-6" style="color: #979aa4; background-color: white;"></i>`;
      }
      if (sideEffect) {
        sideEffect($tbody);
      }
    });
  }

  // function sortArray(arr, ...keys) {
  //   return arr.sort(function (a, b) {
  //     for (let key of keys) {
  //       let aValue = a[key];
  //       let bValue = b[key];
  //       // console.log(aValue, bValue);

  //       // 불리언 비교 시 false < true로 정렬하려면 아래와 같이 처리
  //       if (typeof aValue === 'boolean' && typeof bValue === 'boolean') {
  //         if (aValue !== bValue) {
  //           return aValue > bValue ? 1 : -1;
  //         }
  //       } else if ((aValue !== bValue)) {
  //         // 문자열 등 비교 처리
  //         return aValue.localeCompare(bValue);
  //       }
  //       // 같으면 다음 우선순위로 넘어감
  //     }
  //     return 0; // 전 항목 동일 시
  //   });
  // }

  function sortArray(arr, ...keys) {
    return arr.sort(function (a, b) {
      for (let key of keys) {
        let aValue = a[key];
        let bValue = b[key];

        if (typeof aValue === 'boolean' && typeof bValue === 'boolean') {
          if (aValue !== bValue) {
            return aValue > bValue ? 1 : -1;
          }
        } else if (aValue !== bValue) {
          // 문자열 또는 기타 타입을 문자열로 변환하여 비교
          return String(aValue ?? '').localeCompare(String(bValue ?? ''));
        }
      }
      return 0; // 모든 키가 동일할 경우
    });
  }

  function populateSelectOptionsAndSetDisabled(options, $selector, disabled_state = false) {
    const arr = Array.isArray(options) ? options : [options];
    const $fragment = document.createDocumentFragment();

    arr.forEach(el => {
      const $option = document.createElement('option');
      $option.value = el;
      $option.textContent = el;  // 필수: 사용자에게 보이는 값 설정
      $fragment.appendChild($option);
    });

    $selector.innerHTML = ''; // 기존 옵션 초기화
    $selector.appendChild($fragment);

    // 유효한 인덱스만 선택하도록 보호
    if (arr.length > 0) {
      $selector.selectedIndex = 0;
    }

    $selector.disabled = disabled_state;
    $selector.dispatchEvent(new Event('change'));
  }

  function renderAcademicYearSemesterTable() { // 애플리케이션이 현재 사용하고 있거나 과거에 사용한 기준년도 및 학기에 관한 기록을 데이터베이스로부터 조회를 통해 얻어낸 후, 이를 테이블 형태로 렌더링 --> MENU.B
    let html = null;
    html = `
      <div id="menu_b_content">
        <form>
          <div class="achievementStandardsAndAssessment fw-semibold mb-3">
            <div class="col col-12 col-xl-1">학교명</div>
            <div class="col col-12 col-xl-1 d-flex justify-content-evenly">
              <input name="school" type="text" class="form-control inputField select-width-sm" minlength="2" maxlength="50" placeholder="" autocomplete="off">
            </div>
            <div class="col col-12 col-xl-1">학년도</div>
            <div class="col col-12 col-xl-1 d-flex justify-content-evenly">            
              <input name="year" type="number" class="form-control inputField select-width-sm" min="2025" max="2050" placeholder="" autocomplete="off">
            </div>
            <div class="col col-12 col-xl-1">학기</div>
            <div class="col col-12 col-xl-2 d-flex justify-content-evenly">
              <div class="form-check form-check-inline">
                <input class="form-check-input semester" type="radio" name="semester" value="1" id="first_semester">
                <label class="form-check-label" for="first_semester">
                  1학기
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input semester" type="radio" name="semester" value="2" id="second_semester">
                <label class="form-check-label" for="second_semester">
                  2학기
                </label>
              </div>
            </div>
            <div class="col col-12 col-xl-1">학년</div>
            <div class="col col-12 col-xl-1 d-flex justify-content-evenly">
              <select name="grade" class="form-select form-select-sm select-width-sm">
                <option value="" selected disabled hidden></option>
                <option value="1학년">1학년</option>
                <option value="2학년">2학년</option>
                <option value="3학년">3학년</option>
                <option value="4학년">4학년</option>
                <option value="5학년">5학년</option>
                <option value="6학년">6학년</option>
              </select>
            </div>
            <div class="col col-12 col-xl-1">교과</div>
            <div class="col col-12 col-xl-1 d-flex justify-content-evenly">
              <select name="subject" class="form-select form-select-sm select-width-sm">
              </select>
            </div>
            <div class="col col-xl-1">
              <button id="enroll" type="sumbit" class="btn btn-primary fw-semibold" form="select_form">등록하기</button>
            </div>
          </div>
        </form>
        <section style="height: 73vh; overflow-y: auto;">
          <div id="menu_b_content_table1">
            <div class="table-banner mt-1">
              <button id="btnB1" type="button" class="btn btn-sm btn-secondary" disabled>DB 생성하기</button>
              <button id="btnB2" type="button" class="btn btn-sm btn-secondary" disabled>DB 활성화하기</button>
            </div>
            <table id="menu_b_table1" class="table table-hover caption-top table-bordered">
              <caption class="table_caption">등록완료</caption>
              <thead>
                <tr>
                  ${renderSelectAllCheckboxButton(3)}
                  <th scope="col style="width: 12%;">순번</th>
                  <th scope="col" style="width: 15%;">학교명</th>
                  <th scope="col" style="width: 15%;">학년도</th>
                  <th scope="col" style="width: 13%;">학기</th>
                  <th scope="col" style="width: 15%;">학년</th>
                  <th scope="col" style="width: 15%;">교과</th>
                  <th scope="col style="width: 12%;">반영여부</th>
                </tr>
              </thead>
              <tbody id="menu_b_tbody1" class="text-center">
              </tbody>
            </table>
          </div>
          <div id="menu_b_content_table2">
            <div class="table-banner mt-1">
              <button id="btnB3" type="button" class="btn btn-sm btn-secondary" disabled>DB 비활성화</button>
            </div>
            <table id="menu_b_table2" class="table table-hover caption-top table-bordered">
              <caption class="table_caption">활성화 중인 데이터베이스</caption>
              <thead>
                <tr>
                  ${renderSelectAllCheckboxButton(3)}
                  <th scope="col style="width: 16%;">순번</th>
                  <th scope="col" style="width: 17%;">학교명</th>
                  <th scope="col" style="width: 16%;">학년도</th>
                  <th scope="col" style="width: 16%;">학기</th>
                  <th scope="col" style="width: 16%;">학년</th>
                  <th scope="col" style="width: 16%;">교과</th>
                </tr>
              </thead>
              <tbody id="menu_b_tbody2" class="text-center">
              </tbody>
            </table>
          </div>
        </section>
      </div>
    `;
    return html;
  }

  async function script_renderAcademicYearSemesterTable() {
    let tbody1_arr = [];
    let tbody2_arr = [];
    let tbody1_checked_arr = [];
    let tbody2_checked_arr = [];
    let checkedIdx_tbody1 = [];
    let checkedIdx_tbody2 = [];
    const $tbody1 = document.getElementById('menu_b_tbody1');
    const $tbody2 = document.getElementById('menu_b_tbody2');
    const $selects = document.getElementById('menu_b_content').querySelectorAll('select');

    const updateDbButtonsBasedOnSelection = () => { // tbody1에서 체크된 항목을 분석하고, 두 개의 버튼 (btnB1, btnB2)의 활성화 상태를 제어함. 또한 특정 조건 하에 다른 테이블 데이터(tbody2_arr)와 비교도 수행
      const $btn1 = document.getElementById('btnB1');
      const $btn2 = document.getElementById('btnB2');
      const checked = $tbody1.querySelectorAll('input:checked');
      checkedIdx_tbody1 = Array.from(checked).map(el => el.parentElement.nextElementSibling.textContent - 1);
      tbody1_checked_arr = tbody1_arr.filter((_, idx) => checkedIdx_tbody1.includes(idx));
      if (tbody1_checked_arr.length !== 0 && tbody1_checked_arr.every(record => !record.isRecordSavedToDb)) {
        // 'DB 생성하기' 버튼 활성화
        updateButtonStatesWithStyles([$btn1, false], [$btn2, true]);
      } else if (tbody1_checked_arr.length !== 0 && tbody1_checked_arr.every(record => record.isRecordSavedToDb)) {
        // 활성화 중인 항목과 비교하여 활성화 여부 검증하기
        const serialize = ({ school, year, semester }) => `${school}-${year}-${semester}`;
        const s = new Set(tbody1_checked_arr.map(serialize));
        const s2 = new Set(tbody2_arr.map(serialize));
        const [key1] = s;
        const [key2] = s2;
        const btn_flag = (s.size === 1 && (tbody2_arr.length === 0 || (s2.size === 1 && key1 === key2)));
        if (btn_flag) {
          // 'DB 활성화하기' 버튼 활성화
          updateButtonStatesWithStyles([$btn2, true], [$btn2, false]);
        } else {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, true]);
        }
      } else {
        // 'DB 생성하기' 버튼 비활성화, 'DB 활성화하기' 버튼 비활성화
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true]);
      }
    }

    const updateDeactivateButtonState = () => { // tbody2에서 체크된 항목이 있는지 확인하고, 그에 따라 ‘DB 비활성화’ 버튼 (btnB3)의 활성화 상태를 설정
      const $btn3 = document.getElementById('btnB3');
      const checked = $tbody2.querySelectorAll('input:checked');
      checkedIdx_tbody2 = Array.from(checked).map(el => el.parentElement.nextElementSibling.textContent - 1);
      tbody2_checked_arr = tbody2_arr.filter((_, idx) => checkedIdx_tbody2.includes(idx));
      if (tbody2_checked_arr.length > 0) {
        // 'DB 비활성화' 버튼 활성화
        updateButtonStatesWithStyles([$btn3, false]);
      } else {
        // 'DB 비활성화' 버튼 비활성화
        updateButtonStatesWithStyles([$btn3, true]);
      }
    };

    const renderTableFromData = (tbody1_arr, tbody2_arr) => { // 테이블의 컬럼명과 값을 담은 객체들의 배열 내용에 따라 tbody의 innerHTML을 바꾸어 테이블을 리렌더링
      $tbody1.innerHTML = '';
      const tbody1_arr_sorted = sortArray(tbody1_arr, 'school', 'year', 'semester', 'grade', 'subject', 'isRecordSavedToDb');
      tbody1_arr_sorted.forEach((obj, idx) => {
        const rowHtml = `
          <tr>
            <td scope="row" data-id="${idx + 1}"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
            <td>${idx + 1}</td>
        `;
        // const tds = Object.entries(obj).map(el => `<td>${VISIBLE_STATUS_MAP[el[1]] || el[1]}</td>`).join('');
        const tds = ['school', 'year', 'semester', 'grade', 'subject', 'isRecordSavedToDb'].map(el => `<td>${VISIBLE_STATUS_MAP[obj[el]] || obj[el]}</td>`).join('');
        $tbody1.insertAdjacentHTML('beforeend', rowHtml.concat(tds, "</tr>"));
      });
      $tbody1.querySelectorAll('td:nth-child(1)').forEach(el => {
        el.addEventListener('click', event => {
          if (event.target.tagName !== 'INPUT') return;
          updateDbButtonsBasedOnSelection();
        });
      });
      $tbody2.innerHTML = '';
      const tbody2_arr_sorted = sortArray(tbody2_arr, 'school', 'year', 'semester', 'grade', 'subject');
      tbody2_arr_sorted.forEach((obj, idx) => {
        const rowHtml = `
          <tr>
            <td scope="row" data-id="${idx + 1}"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
            <td>${idx + 1}</td>
        `;
        // const tds = Object.entries(obj).map(el => `<td>${VISIBLE_STATUS_MAP[el[1]] || el[1]}</td>`).join('');
        const tds = ['school', 'year', 'semester', 'grade', 'subject'].map(el => `<td>${VISIBLE_STATUS_MAP[obj[el]] || obj[el]}</td>`).join('');
        $tbody2.insertAdjacentHTML('beforeend', rowHtml.concat(tds, "</tr>"));
      });
      $tbody2.querySelectorAll('td:nth-child(1)').forEach(el => {
        el.addEventListener('click', event => {
          if (event.target.tagName !== 'INPUT') return;
          updateDeactivateButtonState();
        });
      });
    }

    $selects[0].addEventListener('change', event => {
      let options = null;
      const selected = event.target.value;
      switch (selected) {
        case '1학년':
        case '2학년':
          options = `
            <option value="담임">담임</option>
            <option value="국어">국어</option>
            <option value="수학">수학</option>
            <option value="바른 생활">바른 생활</option>
            <option value="슬기로운 생활">슬기로운 생활</option>
            <option value="즐거운 생활">즐거운 생활</option>
          `;
          break;
        case '3학년':
        case '4학년':
          options = `
            <option value="담임">담임</option>
            <option value="국어">국어</option>
            <option value="도덕">도덕</option>
            <option value="사회">사회</option>
            <option value="수학">수학</option>
            <option value="과학">과학</option>
            <option value="체육">체육</option>
            <option value="음악">음악</option>
            <option value="미술">미술</option>
            <option value="영어">영어</option>
      `;
          break;
        case '5학년':
        case '6학년':
          options = `
            <option value="담임">담임</option>
            <option value="국어">국어</option>
            <option value="도덕">도덕</option>
            <option value="사회">사회</option>
            <option value="수학">수학</option>
            <option value="과학">과학</option>
            <option value="실과">실과</option>
            <option value="체육">체육</option>
            <option value="음악">음악</option>
            <option value="미술">미술</option>
            <option value="영어">영어</option>
          `;
          break;
        default:
          break;
      }
      $selects[1].innerHTML = options;
    });

    document.getElementById('enroll').addEventListener('click', event => {
      event.preventDefault();
      const myForm = event.target.closest('form');
      const { school, year, grade, subject } = myForm.elements;
      const semester = myForm.querySelector('input.semester:checked');
      const is_validate = [school, year, semester, grade, subject].every(el => el?.value || false);
      if (!is_validate) {
        alert('누락된 입력값이 있거나 형식이 올바르지 않습니다.');
        return
      }
      const exists = [...tbody1_arr, ...tbody2_arr].some(obj => obj.school === school.value.trim() && obj.year == year.value &&
        obj.semester == semester.value && obj.grade == grade.value && obj.subject == subject.value);
      if (exists) {
        alert('같은 내용으로 등록된 항목이 있습니다.');
        return
      }
      tbody1_arr = [...tbody1_arr, {
        'school': school.value.trim(),
        'year': year.value,
        'semester': semester.value,
        'grade': grade.value,
        'subject': subject.value,
        'isRecordSavedToDb': false,
      }];
      renderTableFromData(tbody1_arr, tbody2_arr);
      school.value = '';
      year.value = '';
      semester.checked = false;
      grade.value = '';
      subject.value = '';
    });

    const sideEffect = tbody => {
      updateDbButtonsBasedOnSelection();
    };

    const sideEffect2 = tbody => {
      updateDeactivateButtonState();
    }

    toggleAllTableCheckboxes('#menu_b_table1', sideEffect);
    toggleAllTableCheckboxes('#menu_b_table2', sideEffect2);

    document.querySelector('#btnB1').addEventListener('click', async (event) => {
      // 서버에 DB 반영하기 요청
      try {
        const url = `${_URL}/neis/createNewAcademicRecords/`;
        const data = tbody1_checked_arr;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        // console.log("success: ", res.successful_indices);
        // console.log("failed: ", res.failed_indices);
        // console.log("invalid: ", res.invalid_subjects);

        // 요청 성공 시 아래 코드 실행
        tbody1_arr.forEach((el, idx) => {
          if (checkedIdx_tbody1.includes(idx)) { el.isRecordSavedToDb = true; }
        });
        tbody1_checked_arr = [];
        renderTableFromData(tbody1_arr, tbody2_arr);
        document.querySelector('#menu_b_table1 button.toggleAllcheckboxes').click();
      } catch (error) {
        console.error('Error:', error);
      }
    });

    document.querySelector('#btnB2').addEventListener('click', async (event) => {
      // 서버에 DB 활성화하기 요청
      try {
        // console.log(tbody1_checked_arr);
        const active = { 'is_active': true };
        const data = tbody1_checked_arr.map(el => ({ ...el, ...active }));
        // console.log(data);
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        };
        const response = await fetch(`${_URL}/neis/updateSubjectActivation/`, options);
        if (!response.ok) {
          throw new Error(response.status);
        }
        const answer = await response.json();
        console.log(answer.message);

        // 요청 성공 시 아래 코드 실행
        tbody1_arr.forEach((el, idx) => {
          if (checkedIdx_tbody1.includes(idx)) {
            tbody2_arr = [...tbody2_arr, {
              'school': el['school'],
              'year': el['year'],
              'semester': el['semester'],
              'grade': el['grade'],
              'subject': el['subject'],
            }];
          }
        });
        checkedIdx_tbody1.sort((a, b) => b - a);
        checkedIdx_tbody1.forEach(idx => { tbody1_arr.splice(idx, 1); });
        tbody1_checked_arr = [];
        checkedIdx_tbody1 = [];
        renderTableFromData(tbody1_arr, tbody2_arr);
        document.querySelector('#menu_b_table1 button.toggleAllcheckboxes').click();
      } catch (error) {
        console.error('Error: ', error);
      }
    });

    document.querySelector('#btnB3').addEventListener('click', async (event) => {
      // 서버에 DB 비활성화 요청
      try {
        // console.log(tbody2_checked_arr);
        const inactive = { 'is_active': false };
        const data = tbody2_checked_arr.map(el => ({ ...el, ...inactive }));
        // console.log(data);
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        };
        const response = await fetch(`${_URL}/neis/updateSubjectActivation/`, options);
        if (!response.ok) {
          throw new Error(response.status);
        }
        const answer = await response.json();
        console.log(answer.message);

        // 요청 성공 시 아래 코드 실행
        tbody2_arr.forEach((el, idx) => {
          if (checkedIdx_tbody2.includes(idx)) {
            tbody1_arr = [...tbody1_arr, {
              'school': el['school'],
              'year': el['year'],
              'semester': el['semester'],
              'grade': el['grade'],
              'subject': el['subject'],
              'isRecordSavedToDb': true,
            }];
          }
        });
        checkedIdx_tbody2.sort((a, b) => b - a);
        checkedIdx_tbody2.forEach(idx => { tbody2_arr.splice(idx, 1); });
        tbody2_checked_arr = [];
        checkedIdx_tbody2 = [];
        renderTableFromData(tbody1_arr, tbody2_arr);
        document.querySelector('#menu_b_table2 button.toggleAllcheckboxes').click();
      } catch (error) {
        console.error('Error: ', error);
      }
    });

    // 서버로 fetch 요청을 통해 데이터베이스에 저장된 등록 및 활성화된 항목을 가져와 테이블에 렌더링하는 코드가 들어와야 함. 
    try {
      const response = await fetch(`${_URL}/neis/getRegisteredSubjects/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      console.log(res.message);
      // 요청 성공 시 아래 코드 실행
      tbody1_arr = [...res.inactiveSubjects];
      tbody2_arr = [...res.activeSubjects];
      renderTableFromData(tbody1_arr, tbody2_arr);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function renderAcademicYearClassInfoTable() { // 특정 학년도의 학년, 반, 학생 수 등의 정보를 등록하거나 조회 및 수정하는 테이블을 렌더링 --> MENU.C
    let html = null;
    html = `
      <div id="menu_c_content">
        <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
          <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="class_count">0</span></div>
          <div> 
            <button id="btnC1" type="button" class="btn btn-sm btn-primary">가져오기</button>
            <button id="btnC2" type="button" class="btn btn-sm btn-secondary" disabled>반영하기</button>
            <button id="btnC3" type="button" class="btn btn-sm btn-secondary" disabled>삭제하기</button>
          </div>
        </div>
        <div style="height: 81vh; overflow-y: auto;">
          <table id="menu_c_table" class="table table-hover table-bordered">
            <thead>
              <tr>
                ${renderSelectAllCheckboxButton(3)}
                <th scope="col style="width: 5%;">순번</th>
                <th scope="col" style="width: 15%;">학년도</th>
                <th scope="col" style="width: 15%;">학년</th>
                <th scope="col" style="width: 12%;">반명</th>
                <th scope="col" style="width: 12%;">학생수</th>
                <th scope="col" style="width: 19%;">등록일자</th>
                <th scope="col" style="width: 19%;">수정일자</th>
              </tr>
            </thead>
            <tbody id="menu_c_tbody" class="text-center">
              ${renderEmptyTbodyWithMessage(8)}
            </tbody>
          </table>
        </div>
      </div>
    `;
    return html;
  }

  async function script_renderAcademicYearClassInfoTable() {
    let tbody_arr = [];
    let tbody_checked_arr = [];
    let checkedIdx_tbody = [];
    let params = null;
    let clickable = true;
    const $tbody = document.getElementById('menu_c_tbody');
    const $table = document.getElementById('menu_c_table');
    const $btn1 = document.getElementById('btnC1');
    const $btn2 = document.getElementById('btnC2');
    const $btn3 = document.getElementById('btnC3');
    const $cnt = document.getElementById('class_count');

    const updateDbButtonsBasedOnSelection = () => { // tbody에서 체크된 항목을 분석하고, 세 개의 버튼 (btnC1, btnC2, btnC3)의 활성화 상태를 제어함.
      const checked = $tbody.querySelectorAll('input:checked');
      checkedIdx_tbody = Array.from(checked).map(el => el.parentElement.nextElementSibling.textContent - 1);
      tbody_checked_arr = tbody_arr.filter((_, idx) => checkedIdx_tbody.includes(idx));

      if (tbody_checked_arr.length === 0 && clickable) {
        // '가져오기' 버튼 활성화
        updateButtonStatesWithStyles([$btn1, false], [$btn2, true], [$btn3, true]);
      } else if (tbody_checked_arr.length !== 0 && tbody_checked_arr.every(record => !record.created_at)) {
        // '반영하기' 버튼 활성화
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true]);
      } else if (tbody_checked_arr.length !== 0 && tbody_checked_arr.every(record => record.created_at)) {
        // '삭제하기' 버튼 활성화
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, false]);
      } else {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, true]);
      }
    }

    const renderTableFromData = tbody_arr => { // 테이블의 컬럼명과 값을 담은 객체들의 배열 내용에 따라 tbody의 innerHTML을 바꾸어 테이블을 리렌더링
      $tbody.innerHTML = '';
      $cnt.textContent = tbody_arr.length;
      const tbody_arr_sorted = sortArray(tbody_arr, 'year', 'grade', 'className', 'numOfStudents');
      tbody_arr_sorted.forEach((obj, idx) => {
        const rowHtml = `
          <tr>
            <td scope="row" data-id="${idx + 1}"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
            <td>${idx + 1}</td>
        `;
        const tds = ['year', 'grade', 'className', 'numOfStudents', 'created_at', 'updated_at'].map(el => `<td>${VISIBLE_STATUS_MAP[obj[el]] || obj[el]}</td>`).join('');
        $tbody.insertAdjacentHTML('beforeend', rowHtml.concat(tds, "</tr>"));
      });
      tbody_arr = [...tbody_arr_sorted];
      $tbody.querySelectorAll('td:nth-child(1)').forEach(el => {
        el.addEventListener('click', event => {
          if (event.target.tagName !== 'INPUT') return;
          updateDbButtonsBasedOnSelection();
        });
      });
    }

    const getGradeClassesAndStudentCounts = async () => {
      const response = await fetch(`${_URL}/neis/getGradeClassesAndStudentCounts/?${params.toString()}`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      console.log(res.message);
      // console.log(res2.classes);
      // console.log(res2.total);
      tbody_arr = [...res.classes];
      renderTableFromData(tbody_arr);
      $table.style.flexGrow = '0';
    }

    // 서버로 fetch 요청을 통해 데이터베이스에 저장된 활성화된 교과 항목과 관계된 학교명, 연도, 학기 정보 등을 가져오는 코드가 들어와야 함. 
    try {
      const response = await fetch(`${_URL}/neis/getRegisteredSubjects/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      console.log(res.message);
      // 요청 성공 시 아래 코드 실행
      if (res.activeSubjects.length === 0) {
        return
      }
      const { school, year, semester } = res.activeSubjects?.[0];
      const grades = Array.from(new Set(res.activeSubjects?.map(el => el.grade)));
      params = new URLSearchParams();
      params.append('school', school);
      params.append('year', year);
      params.append('semester', semester);
      grades.forEach(g => params.append('grades', g));

      getGradeClassesAndStudentCounts();
    } catch (error) {
      console.error('Error:', error);
    }

    $btn1.addEventListener('click', async (event) => { // 가져오기
      if (!clickable) { return; }
      try {
        const response = await fetch(`${_URL}/neis/analyzeStudentListByClassInfo/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        // console.log(res.message);
        // console.log(res.classList);
        tbody_arr = [...tbody_arr, ...res.classList];
        renderTableFromData(tbody_arr);
        updateButtonStatesWithStyles([$btn1, true]);
        clickable = false;
        $table.style.flexGrow = '0';
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn2.addEventListener('click', async (event) => { // 반영하기
      try {
        const url = `${_URL}/neis/processGradeClassAndStudentRecords/`;
        const data = tbody_checked_arr.map(el => ({ ...el, 'school': params.get('school'), 'semester': params.get('semester') }));
        // console.log(data);
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log("message: ", res.message);
        console.log("created_classes: ", res.created_classes);
        console.log("created_students: ", res.created_students);
        console.log("linked_relations: ", res.linked_relations);
        console.log("missing_files: ", res.missing_files);

        // 요청 성공 시 아래 코드 실행
        tbody_checked_arr = [];
        document.querySelector('#menu_c_table button.toggleAllcheckboxes').click();

        getGradeClassesAndStudentCounts();
        updateButtonStatesWithStyles([$btn1, false]);
        clickable = true;
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn3.addEventListener('click', async (event) => { // 삭제하기
      if (confirm(`${tbody_checked_arr.length}개의 학급을 삭제하시겠습니까? 학급을 삭제해도 소속 학생의 정보는 삭제되지 않습니다.`)) {
        try {
          const url = `${_URL}/neis/deleteGradeClassBySchoolYearSemesterAndName/`;
          const data = tbody_checked_arr.map(el => ({ ...el, 'school': params.get('school'), 'semester': params.get('semester') }));
          console.log(data);
          const options = {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log("message: ", res.message);
          console.log("deleted: ", res.deleted);
          console.log("not_found: ", res.not_found);

          // 요청 성공 시 아래 코드 실행
          if (res.deleted.length === 0) {
            alert("삭제할 학급이 존재하지 않습니다.");
          } else {
            alert(`${res.deleted.length}개의 학급을 삭제하였습니다.`);
            if (res.not_found.length > 0) {
              alert(`${res.not_found.length}개의 학급은 존재하지 않아 삭제되지 않았습니다.`);
            }
          }
          tbody_checked_arr = [];
          document.querySelector('#menu_c_table button.toggleAllcheckboxes').click();

          getGradeClassesAndStudentCounts();
          updateButtonStatesWithStyles([$btn1, false]);
          clickable = true;
        } catch (error) {
          console.error('Error: ', error);
          alert("삭제 중 오류가 발생하였습니다.");
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    const sideEffect = tbody => {
      updateDbButtonsBasedOnSelection();
    };
    toggleAllTableCheckboxes('#menu_c_table', sideEffect);
  }

  function renderStudentRecordDeletionTable() {
    // 특정 학생의 학적을 비롯한 학업성적 등 일체의 자료를 삭제하기 위한 테이블을 렌더링 --> MENU.D
    let html = null;
    html = `
      <div id="menu_d_content">
        <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
          <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="student_count">0</span></div>
          <div>
            <button id="btnD1" class="btn btn-sm btn-secondary" disabled>학생자료 삭제 승인요청</button>
            <button id="btnD2" class="btn btn-sm btn-secondary" disabled>학생자료 복원하기</button>
          </div>
        </div>
        <div style="height: 77vh; overflow-y: auto;">
          <table id="menu_d_table" class="table table-hover table-bordered">
            <thead>
              <tr>
                ${renderSelectAllCheckboxButton(4)}
                <th scope="col" style="width: 12%;">재학구분</th>
                <th scope="col" style="width: 12%;">학년</th>
                <th scope="col" style="width: 12%;">반</th>
                <th scope="col" style="width: 12%;">번호</th>
                <th scope="col" style="width: 12%;">성명</th>
                <th scope="col" style="width: 18%;">생년월일</th>
                <th scope="col" style="width: 18%;">승인날짜</th>
              </tr>
            </thead>
            <tbody id="menu_d_tbody" class="text-center">
            </tbody>
          </table>
        </div>
      </div>
    `;
    return html;
  }

  async function script_renderStudentRecordDeletionTable() {
    let tbody_arr = [];
    let tbody_checked_arr = [];
    let checkedIdx_tbody = [];
    let params = null;
    const $tbody = document.getElementById('menu_d_tbody');
    const $table = document.getElementById('menu_d_table');
    const $btn1 = document.getElementById('btnD1');
    const $btn2 = document.getElementById('btnD2');
    const $cnt = document.getElementById('student_count');

    const updateDbButtonsBasedOnSelection = () => { // tbody에서 체크된 항목을 분석하고, 두 개의 버튼 (btnD1, btnD2)의 활성화 상태를 제어함.
      const checked = $tbody.querySelectorAll('input:checked');
      checkedIdx_tbody = Array.from(checked).map(el => el.parentElement.getAttribute('data-id') - 1);
      // console.log(checkedIdx_tbody);
      tbody_checked_arr = tbody_arr.filter((_, idx) => checkedIdx_tbody.includes(idx));

      if (tbody_checked_arr.length !== 0 && tbody_checked_arr.every(record => record.is_enrolled)) {
        // '학생자료 삭제 승인요청' 버튼 활성화
        updateButtonStatesWithStyles([$btn1, false], [$btn2, true]);
      } else if (tbody_checked_arr.length !== 0 && tbody_checked_arr.every(record => !record.is_enrolled)) {
        // '학생자료 복원하기' 버튼 활성화
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false]);
      } else {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true]);
      }
    }

    const renderTableFromData = tbody_arr => { // 테이블의 컬럼명과 값을 담은 객체들의 배열 내용에 따라 tbody의 innerHTML을 바꾸어 테이블을 리렌더링
      $tbody.innerHTML = '';
      $cnt.textContent = tbody_arr.length;
      const tbody_arr_sorted = sortArray(tbody_arr, 'grade', 'class_name', 'name');
      tbody_arr_sorted.forEach((obj, idx) => {
        const rowHtml = `
            <tr>
              <td scope="row" data-id="${idx + 1}"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
          `;
        const tds = ['is_enrolled', 'grade', 'class_name', 'student_num', 'name', 'date_of_birth', 'untracked_date'].map(el => `<td>${VISIBLE_STATUS_MAP[obj[el]] || obj[el] || ''}</td>`).join('');
        $tbody.insertAdjacentHTML('beforeend', rowHtml.concat(tds, "</tr>"));
      });
      tbody_arr = [...tbody_arr_sorted];
      $tbody.querySelectorAll('td:nth-child(1)').forEach(el => {
        el.addEventListener('click', event => {
          if (event.target.tagName !== 'INPUT') return;
          updateDbButtonsBasedOnSelection();
        });
      });
    }

    async function handleToggleEnrollmentRequest(button) {
      try {
        const data = tbody_checked_arr;
        console.log(data);
        const options = {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        };

        const response = await fetch(`${_URL}/neis/toggle_student_enrollment_status_bulk/`, options);
        if (!response.ok) throw new Error(response.status);

        const res = await response.json();
        // 요청 성공 시 테이블 갱신
        checkedIdx_tbody.sort((a, b) => b - a);
        checkedIdx_tbody.forEach(idx => { tbody_arr.splice(idx, 1); });
        renderTableFromData(tbody_arr);
        tbody_checked_arr = [];
        checkedIdx_tbody = [];
        document.querySelector('#menu_d_table button.toggleAllcheckboxes').click();
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true]);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    document.getElementById('submitBtn').addEventListener('click', async (event) => {
      event.preventDefault();
      const myForm = event.target.closest('form');
      const { name, dob } = myForm.elements;
      params = new URLSearchParams();
      params.append('name', name.value);
      params.append('dob', dob.value);

      try {
        const response = await fetch(`${_URL}/neis/search_students_by_partial_name_and_birthdate/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        // console.log(res.student_list);
        tbody_arr = [...res.student_list];
        if (tbody_arr.length === 0) {
          alert('입력한 조건과 일치하는 학생이 없습니다.');
        }
        renderTableFromData(tbody_arr);
        tbody_checked_arr = [];
        checkedIdx_tbody = [];
        document.querySelector('#menu_d_table button.toggleAllcheckboxes').click();
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true]);
        name.value = '';
        dob.value = '';
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn1.addEventListener('click', () => handleToggleEnrollmentRequest($btn1)); // 삭제 승인요청
    $btn2.addEventListener('click', () => handleToggleEnrollmentRequest($btn2)); // 복원하기

    const sideEffect = tbody => {
      updateDbButtonsBasedOnSelection();
    };
    toggleAllTableCheckboxes('#menu_d_table', sideEffect);

    try {
      params = new URLSearchParams();
      params.append('name', '');
      params.append('dob', '');
      const response = await fetch(`${_URL}/neis/search_students_by_partial_name_and_birthdate/?${params.toString()}`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      // console.log(res.student_list);
      tbody_arr = [...res.student_list];
      renderTableFromData(tbody_arr);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function renderAssessmentCriteriaTable() {
    // 학생 평가에 필요한 성취기준 및 평가요소를 관리하기 위한 테이블을 화면에 렌더링 --> MENU.E
    const $subselection = document.getElementById('subselection');
    const $btns = $subselection.querySelectorAll('button');
    if (!$btns[0].dataset.clickAttached) {
      $btns.forEach((btn, idx) => {
        btn.addEventListener('click', () => {
          $btns.forEach(el => {
            el.classList.remove('active');
          });
          btn.classList.add('active');
        });
      });
      $btns[0].dataset.clickAttached = 'true';
    }

    let html = null;
    html = `
    <div id="menu_e1_content">
      <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
        <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="assessment_count_1">0</span></div>
        <div>
          <button id="btnE1" type="button" class="btn btn-sm btn-primary">영역명관리</button>
          <button id="btnE2" type="button" class="btn btn-sm btn-secondary" disabled>행추가</button>
          <button id="btnE3" type="button" class="btn btn-sm btn-secondary" disabled>저장</button>
          <button id="btnE4" type="button" class="btn btn-sm btn-secondary" disabled>삭제</button>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; height: 70vh; overflow-y: auto;">
        <table id="menu_e1_table" class="table table-hover table-bordered">
          <thead>
            <tr>
              ${renderSelectAllCheckboxButton(3)}
              <th scope="col" style="width: 6%;">영역순번</th>
              <th scope="col" style="width: 14%;">영역명</th>
              <th scope="col" style="width: 37%;">성취기준</th>
              <th scope="col" style="width: 28%;">평가요소</th>
              <th scope="col" style="width: 6%;">교과평가</th>
              <th scope="col" style="width: 6%;">정렬순서</th>
            </tr>
          </thead>
          <tbody id="menu_e1_tbody" class="text-center">
            ${renderEmptyTbodyWithMessage(8)}
          </tbody>
        </table>
      </div>
    </div>
    <!-- 영역명관리를 위한 모달창 -->
    <button type="button" id="fieldBtn" style="display: none;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#fieldModal"></button>
    <div class="modal fade" id="fieldModal" tabindex="-1" aria-labelledby="fieldModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="fieldModalLabel">영역명관리</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="fieldForm">
              <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
                <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;"><span id="field_span"></span>Total <span id="field_count">0</span></div>
                <div> 
                  <button id="btnE_1" type="button" class="btn btn-sm btn-primary">행추가</button>
                  <button id="btnE_2" type="button" class="btn btn-sm btn-primary">저장</button>
                  <button id="btnE_3" type="button" class="btn btn-sm btn-secondary" disabled>삭제</button>
                </div>
              </div>
              <div style="height: 50vh; overflow-y: auto;">
                <table id="menu_e_sub_table" class="table table-hover table-bordered">
                  <thead>
                    <tr>
                      ${renderSelectAllCheckboxButton(3)}
                      <th scope="col style="width: 17%;">순번</th>
                      <th scope="col" style="width: 80%;">영역명</th>
                    </tr>
                  </thead>
                  <tbody id="menu_e_sub_tbody" class="text-center">
                  </tbody>
                </table>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div id="menu_e2_content" style="display: none;">
      <div id="menu_e2_content_left" class="col-12 col-xl-8">
        <div class="table-header sticky-top bg-white p-0 mt-2 mb-2 d-flex justify-content-between align-items-center">
          <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="assessment_count_2">0</span></div>
        </div>
        <div style="display: flex; flex-direction: column; height: 70vh; overflow-y: auto;">
          <table id="menu_e2_table_1" class="table table-hover table-bordered">
            <thead>
              <tr>
                <th scope="col" style="width: 20%;">영역명</th>
                <th scope="col" style="width: 45%;">성취기준</th>
                <th scope="col" style="width: 30%;">평가요소</th>
              </tr>
            </thead>
            <tbody id="menu_e2_tbody_1">
              ${renderEmptyTbodyWithMessage(4)}
            </tbody>
          </table>
        </div>
      </div>
      <div id="menu_e2_content_right" class="col-12 col-xl-4">
        <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
          <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;"><span class="fw-bold fs-6">평가기준</span>&ensp;Total <span id="evaluation_count">0</span></div>
          <div> 
            <button id="btnE5" type="button" class="btn btn-sm btn-secondary" disabled>저장</button>
            <button id="btnE6" type="button" class="btn btn-sm btn-secondary" disabled>삭제</button>
          </div>
        </div>
        <div style="padding: 0.4rem 0.7rem 0.5rem 0.7rem; background-color: #f3f4f8;">
          <select id="eval_range" class="form-select form-select-sm select-width-sm" disabled>
            <option value="0">단계선택</option>
            <option value="2">2단계</option>
            <option value="3">3단계</option>
            <option value="4">4단계</option>
            <option value="5">5단계</option>
            <option value="7">7단계</option>
          </select>
        </div>
        <div style="display: flex; flex-direction: column; height: 65.5vh; overflow-y: auto;">
          <table id="menu_e2_table_2" class="table table-hover table-bordered">
            <thead>
              <tr>
                <th scope="col" style="width: 33.3%;">평가단계</th>
                <th scope="col" style="width: 66.6%;">평가결과</th>
              </tr>
            </thead>
            <tbody id="menu_e2_tbody_2">
              ${renderEmptyTbodyWithMessage(2)}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    `;
    return html;
  }

  async function script_renderAssessmentCriteriaTable() {
    let params = null;
    let fieldArr = [];
    let lastIdx = null;
    let criteriaArr = [];
    let mainLastIdx = null;
    let currentGrade = null;
    let currentSubject = null;
    let currentField = null;
    let currentCriterionId = null;
    let currentModdable = null;
    const $submitBtn = document.getElementById('submitBtn');
    const $year = document.getElementById('year');
    const $semester = document.getElementById('semester');
    const $grade = document.getElementById('grade');
    const $subject = document.getElementById('subject');
    const $field = document.getElementById('field');
    const fieldModal = document.getElementById('fieldModal');
    const $btn1 = document.getElementById('btnE1'); // 영역명관리
    const $btn2 = document.getElementById('btnE2'); // 행추가
    const $btn3 = document.getElementById('btnE3'); // 저장
    const $btn4 = document.getElementById('btnE4'); // 삭제
    const $btn5 = document.getElementById('btnE5'); // 평가기준 저장
    const $btn6 = document.getElementById('btnE6'); // 평가기준 삭제

    $('#subselection').on('click', (event) => {
      const isAttached = event.target.dataset?.clickAttached;
      $('#menu_e1_content').css({
        display: isAttached ? 'flex' : 'none',
        flexGrow: isAttached ? '1' : ''
      });
      $('#menu_e2_content').css('display', isAttached ? 'none' : 'flex');
    });

    const updateFieldButtonsBasedOnSelection = (tbody) => {
      let delete_flag = false;
      const $subBtn_2 = document.getElementById('btnE_3'); // 삭제
      const checked_arr = Array.from(tbody.querySelectorAll('input:checked'));

      const checked_obj = Object.fromEntries(
        checked_arr.map(el => [
          el.parentElement.getAttribute('data-id') - 1,
          el.closest('tr').querySelector('input[type="text"]').value.trim()
        ])
      );

      if (checked_arr.length === 0) {
        updateButtonStatesWithStyles([$subBtn_2, true]);
        return;
      }

      for (let i = 0; i < fieldArr.length; i++) {
        const [, children] = fieldArr[i];
        if (children == 0 && checked_obj.hasOwnProperty(i.toString())) {
          delete_flag = false;
          break;
        }
        delete_flag = true;
      }

      updateButtonStatesWithStyles([$subBtn_2, delete_flag]);
    };

    const updateCriteriaButtonsBasedOnSelection = () => {
      let delete_flag = true;
      if ($("#menu_e1_tbody input:checked").length === 0) { 
        updateButtonStatesWithStyles([$btn4, delete_flag]);
        return 
      }

      delete_flag = $("#menu_e1_tbody input:checked").map(function() {
        return $(this).closest("tr").find("td").slice(5,7).map(function() {
          return $(this).text();
        }).get().join('');
      }).get().join('').includes('O');

      // console.log(delete_flag);
      updateButtonStatesWithStyles([$btn4, delete_flag]);
    };

    const renderAssessmentFieldsBySubject = async () => {
      const response = await fetch(`${_URL}/neis/get_fields_by_subject/?${params.toString()}`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { subject, fields } = res;
      const labels = fields.filter(el => !el[0]?.startsWith('-'));
      fieldArr = [...labels];
      // console.log(fieldArr);

      const rowHtml = labels.map(([label, editable], i) => `
        <tr>
          <td scope="row" data-id="${i + 1}">
            <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
          </td>
          <td>${i + 1}</td>
          <td>
            <input type="text" class="form-control inputField select-width-full" maxlength="50"
                  placeholder="" autocomplete="off" value="${label}" ${editable !== 0 ? 'readonly' : ''}>
          </td>
        </tr>
      `).join('');
      $('#menu_e_sub_tbody').html(rowHtml);
      $('#field_span').text(`${$year.value}학년도 ${$semester.value}학기 ${$grade.value} ${$subject.value}`);
      $('#field_span').css({
        'color': '#294065',
        'font-size': '0.9rem',
        'margin-right': '0.5rem'
      });
      $('#field_count').text($('#menu_e_sub_tbody tr').length);
    }

    const renderAssessmentCriteriaTable1 = async () => {
      const params = new URLSearchParams();
      params.set('grade', $grade.value);
      params.set('subject', $subject.value);

      try {
        // 1차 요청: 영역명 목록 가져오기
        const response1 = await fetch(`${_URL}/neis/get_fields_by_subject/?${params.toString()}`);
        if (!response1.ok) throw new Error(`서버 오류: ${response1.status}`);

        const { fields } = await response1.json();
        fields.shift(); // '-전체-' 제거

        // 2차 요청: 성취기준 정보 가져오기
        params.set('field', $field.value);
        const response2 = await fetch(`${_URL}/neis/get_achievement_criteria_by_grade_subject_area/?${params.toString()}`);
        if (!response2.ok) throw new Error(`서버 오류: ${response2.status}`);

        const { message, criteria } = await response2.json();
        // console.log(message);

        let html = '';

        // 테이블 HTML 생성
        fields.forEach(([label, editable], i) => {
          const safeLabel = label.replace(/[^\uAC00-\uD7A3\w]+/g, '_');
          const items = criteria[label] || [];
          items.forEach(([crit_text, eval_item, assessed], j) => {
            html += `
              <tr>
                <td><input class="form-check-input fs-6" type="checkbox"></td>
                <td class="${safeLabel}">${i + 1}</td>
                <td>
                  <select class="form-select form-select-sm select-width-full"
                    ${assessed || $field.value !== '-전체-' ? 'disabled' : ''}>
                    ${fields.map(([fLabel]) => `
                      <option value="${fLabel}" ${fLabel === label ? 'selected' : ''}>${fLabel}</option>
                    `).join('')}
                  </select>
                </td>
                <td>
                  <textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false" ${assessed ? 'readonly' : ''}>${crit_text}</textarea>
                </td>
                <td>
                  <textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false" ${assessed ? 'readonly' : ''}>${eval_item}</textarea>
                </td>
                <td>${VISIBLE_STATUS_MAP[assessed]}</td>
                <td>
                  <input type="number" class="form-control inputField select-width-full"
                        min="1" max="${editable}" value="${j + 1}">
                </td>
              </tr>
            `;
          });
        });

        // 테이블 렌더링
        document.querySelector('#menu_e1_tbody').innerHTML = html;

        let html2 = '';

        // 테이블 HTML 생성
        fields.forEach(([label, editable], i) => {
          const items = criteria[label] || [];
          items.forEach(([crit_text, eval_item, assessed]) => {
            html2 += `
              <tr>
                <td class="text-center">${label}</td>
                <td>${crit_text}</td>
                <td>${eval_item}</td>
              </tr>
            `;
          });
        });

        // 테이블 렌더링
        document.querySelector('#menu_e2_tbody_1').innerHTML = html2;

        // rowspan 적용 및 중복 셀 제거
        fields.forEach(([label]) => {
          const safeLabel = label.replace(/[^\uAC00-\uD7A3\w]+/g, '_');
          const tds = Array.from(document.getElementsByClassName(safeLabel));
          if (tds.length > 1) {
            tds[0].setAttribute('rowspan', tds.length);
            tds.slice(1).forEach(td => td.remove());
          }
        });

        // assessment_count 업데이트
        $('#assessment_count_1').text($('#menu_e1_tbody tr').length);
        $('#assessment_count_2').text($('#menu_e2_tbody_1 tr').length);
      

        // 버튼 상태 업데이트
        updateButtonStatesWithStyles([$btn2, false]);
        updateButtonStatesWithStyles([$btn3, false]);
      } catch (error) {
        console.error('성취기준 렌더링 실패:', error);
      }
    };

    const renderEvaluationCriteriaTable = (arr, moddable) => {
      const tableHtml = $.map(arr, function(el, i) {
        const rowHtml = `
          <tr>
            <td>
              <div style="display: flex; align-items: center; justify-content: center; height: 3.8rem; width: 100%; border: 1px solid #bb395a; border-radius: 5px;">
                <input type="text" style="background-color: #ffffff;" class="eval_input" maxlength="10" value="${el[0]}" ${moddable ? "" : "disabled"} />
              </div>
            </td>
            <td>
              <textarea rows="3" maxlength="500" style="background-color: #ffffff; width: 100%; height: 3.8rem; overflow: auto; resize: none;" spellcheck="false" ${moddable ? "" : "disabled"}>${el[1]}</textarea>
            </td>
          </tr>      
        `;
        return rowHtml;
      }).join('');
      
      // console.log(tableHtml);
      $("#menu_e2_tbody_2").html(tableHtml);
      $("#evaluation_count").text($("#menu_e2_tbody_2 tr").length);
    };

    $btn1.addEventListener('click', async (event) => { // 영역명관리 버튼 클릭 시
      params = new URLSearchParams();
      params.append('grade', $grade.value);
      params.append('subject', $subject.value);

      try {
        renderAssessmentFieldsBySubject();
        $('#fieldBtn').click();
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $('#btnE_1').on('click', () => { // '영역명관리' 모달창의 '행추가' 버튼 클릭 시
      lastIdx = $('#menu_e_sub_tbody tr:last td:nth-child(2)').text() || 0
      lastIdx = parseInt(lastIdx);
      const rowHtml = `
        <tr>
          <td scope="row" data-id="${lastIdx + 1}"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
          <td>${lastIdx + 1}</td>
          <td><input type="text" class="form-control inputField select-width-full" maxlength="50" placeholder="" autocomplete="off"></td>
        </tr>
      `;
      $('#menu_e_sub_tbody').append(rowHtml);
      fieldArr = [...fieldArr, ['', 0]];
      $('#field_count').text($('#menu_e_sub_tbody tr').length);
    });

    $('#btnE2').on('click', () => { // '행추가' 버튼 클릭 시
      lastIdx = $("#menu_e1_tbody").index($("tr:last")) === -1 ? 0 : $("#menu_e1_tbody").index($("tr:last"));
      const tdForField = currentField.startsWith('-') ? `
        <select class="form-select form-select-sm select-width-full">
          ${$("#field option:gt(0)").map(function() {
            return this.outerHTML;
          }).get().join('')};
        </select>
      ` : `<select class="form-select form-select-sm select-width-full" disabled>
            <option value="${currentField}">${currentField}</option>
          </select>`;

      const rowHtml = `
        <tr>
          <td scope="row" data-id="${lastIdx + 1}"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
          <td></td>
          <td>${tdForField}</td>
          <td><textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false"></textarea></td>
          <td><textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false"></textarea></td>
          <td></td>
          <td></td>
          <td><input type="text" class="form-control inputField select-width-full" maxlength="3" placeholder="" autocomplete="off" readonly></input></td>
          
        </tr>
      `;

      $("#menu_e1_tbody").append(rowHtml);
      $('#assessment_count_1').text($('#menu_e1_tbody tr').length);
    });

    $('#btnE_2').on('click', async (event) => { // '영역명관리' 모달창의 '저장' 버튼 클릭 시
      let save_flag = false;
      const tbody = document.getElementById('menu_e_sub_table');
      const tbody_arr = Array.from(tbody.querySelectorAll('input[type="text"]'));
      const tbody_obj = Object.fromEntries(
        tbody_arr.map(el => [
          el.closest('tr').querySelector('td').getAttribute('data-id') - 1,
          el.value.trim()
        ])
      );

      if (fieldArr.length > 0) {
        save_flag = fieldArr.every((el, idx) => el[0] === tbody_obj[idx.toString()]);
      }

      const data = $('#fieldForm input[type="text"]').map((i, el) => $(el).val().trim()).get();
      if (save_flag && (fieldArr.length === data.length)) {
        alert('변경된 내용이 없습니다.');
        return
      } else if (data.some(el => !el)) {
        alert('비어있는 셀이 있어 저장할 수 없습니다.');
        return
      }

      // 서버에 fetch 요청 후 갱신된 영역명 리스트를 받아 변수를 재할당하고 데이터를 화면에 렌더링하기
      let fetchData = {};
      $('#menu_e_sub_table tr:gt(0)').each(function () {
        const $tds = $(this).find("td");
        const idx = $tds.eq(1).text().trim();
        const field = $tds.eq(2).find("input").val()?.trim() || '';
        const temp = { [idx]: field };
        fetchData = { ...fetchData, ...temp };
      })

      const tempInfo = { 'grade': $('#grade').val(), 'subject': $('#subject').val() };
      fetchData = { ...fetchData, extraInfo: { ...tempInfo } };
      // console.log(fetchData);

      try {
        const url = `${_URL}/neis/manage_assessment_areas_by_grade_subject/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fetchData),
        };
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        // renderAssessmentFieldsBySubject();
        $('#fieldModal button.btn-close').first().click();
        $subject.dispatchEvent(new Event('change'));
      } catch (error) {
        console.error('Error:', error);
      }
    });

  
    $('#btnE3').on('click', async (event) => { // 성취기준 관리 테이블의 '저장' 버튼 클릭 시
      const info = {
        basicInfo: {
          grade: $("#grade").val(),
          subject: $("#subject").val(),
        }
      };

      // 고유 분야명 수집
      const fieldList = [...new Set(
        $("#menu_e1_tbody td:nth-child(3) select :selected").map(function() {
          return $(this).val();
        }).get()
      )];

      const dataObj = {};

      fieldList.forEach((fieldName) => {
        let tempObj = {};
        let idx = 1;

        $("#menu_e1_tbody td:nth-last-child(6)").each(function() {
          const selectedVal = $(this).find(":selected").val();
          if (selectedVal === fieldName) {
            const $tr = $(this).closest("tr");
            const textareaItems = $tr.find("textarea").map(function() {
              return $(this).val().trim();
            }).get();
            const lastInputVal = $tr.find("input").last().val();  // sort_order가 마지막 input이라면
            tempObj[idx] = [...textareaItems, lastInputVal];
            idx++;
          }
        });

        dataObj[fieldName] = tempObj;
      });

      const data = { ...info, ...dataObj };
      // console.log(data);

      try {
        const url = `${_URL}/neis/update_achievement_criteria_records/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        // console.log(res.message);
        renderAssessmentCriteriaTable1();
        alert("성취기준 저장 완료");
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $('#btnE_3').on('click', async () => { // '영역명관리' 모달창의 '삭제' 버튼 클릭 시
      $('#menu_e_sub_tbody input:checked').closest("tr").remove();
      $('#field_count').text($('#menu_e_sub_tbody tr').length);
      $('#menu_e_sub_table button.toggleAllcheckboxes').click();
    });

    $('#btnE4').on('click', async () => { // 성취기준 관리 테이블의 '삭제' 버튼 클릭 시
      $('#menu_e1_tbody input:checked').each(function() {
        const label = $(this).closest('tr').find('td:nth-last-child(6)').find(':selected').val();
        const firstRow = $(this).closest('tr').find('td').length === 8 ? true : false; 
        const hasRowspan = $(this).closest('tr').find('td:nth-child(2)').attr("rowspan");
        const safeLabel = label.replace(/[^\uAC00-\uD7A3\w]+/g, '_');
        const $cell = $(`.${safeLabel}`).first();
        const currentRowspan = parseInt($cell.attr('rowspan'), 10);
        // console.log('current: ', currentRowspan);
        if (!firstRow) {
          $cell.attr('rowspan', currentRowspan - 1);
        } else if (hasRowspan) {  
          const idx = $cell.text();
          $cell.closest('tr').next().find('td:eq(0)').after(`<td class="${safeLabel}" rowspan="${currentRowspan - 1}">${idx}</td>`);
          console.log("hasRowspan");
        } 

        $(this).closest("tr").remove();
      });
      // $('#menu_e1_tbody input:checked').closest("tr").remove();
      $('#criteria_count').text($('#menu_e1_tbody tr').length);
      $('#menu_e1_table button.toggleAllcheckboxes').click();
    });

    $grade.addEventListener('change', async (event) => {
      try {
        const response = await fetch(`${_URL}/neis/get_subjects_by_grade/${$grade.value}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { grade, subjects } = res;
        populateSelectOptionsAndSetDisabled(subjects, $subject);
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $subject.addEventListener('change', async (event) => {
      params = new URLSearchParams();
      params.append('grade', $grade.value);
      params.append('subject', $subject.value);

      try {
        const response = await fetch(`${_URL}/neis/get_fields_by_subject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { subject, fields } = res;

        populateSelectOptionsAndSetDisabled(fields.map(el => el[0]), $field, fields[0][0] == '-없음-' ? true : false);
        // 이어서 '조회' 버튼 활성화 여부를 판단하는 코드가 들어와야 함. 

      } catch (error) {
        console.error('Error:', error);
      }
    });

    $field.addEventListener('change', () => {
      if ($field.value === '-없음-') {
        updateButtonStatesWithStyles([$submitBtn, true]);
      } else {
        updateButtonStatesWithStyles([$submitBtn, false]);
      }
      updateButtonStatesWithStyles([$btn1, false]);
    });

    try {
      const response = await fetch(`${_URL}/neis/get_active_grades/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { year, semester, active_grades } = res;
      populateSelectOptionsAndSetDisabled(year, $year, true);
      populateSelectOptionsAndSetDisabled(semester, $semester, true);
      populateSelectOptionsAndSetDisabled(active_grades, $grade);
    } catch (error) {
      console.error('Error:', error);
    }

    const sideEffect = tbody => {
      updateFieldButtonsBasedOnSelection(tbody);
    };

    toggleAllTableCheckboxes('#menu_e_sub_table', sideEffect);
    $('#menu_e_sub_tbody').on('click', 'input.form-check-input', function (event) {
      updateFieldButtonsBasedOnSelection(document.getElementById('menu_e_sub_tbody'));
    });

    const sideEffect2 = () => {
      updateCriteriaButtonsBasedOnSelection();
    };
    toggleAllTableCheckboxes('#menu_e1_table', sideEffect2);
    $('#menu_e1_tbody').on('click', 'input.form-check-input', function (event) {
      updateCriteriaButtonsBasedOnSelection();
    });

    $submitBtn.addEventListener('click', async (event) => { // '조회' 버튼 클릭 시
      event.preventDefault();
      // const btnText = $('button.subselectionBtn.active').text().trim();
      currentGrade = $('#grade').val();
      currentSubject = $('#subject').val();
      currentField = $("#field").val();
      $("#menu_e1_table").css({ "flex-grow": "0" });
      $("#menu_e2_table_1").css({ "flex-grow": "0" });
       renderAssessmentCriteriaTable1();
      $("#menu_e2_tbody_2").html(`${renderEmptyTbodyWithMessage(2)}`);
      $("#menu_e2_table_2").css({ "flex-grow": "1" });

    });

    $("#menu_e2_tbody_1").on("click", "td", async function() {
      const row_info = $(this).closest("tr").find("td").map(function() {
       return $(this).text();
      }).get();

      $("#menu_e2_tbody_1 tr.table-active").removeClass("table-active");
      $(this).closest("tr").addClass("table-active");

      const data = {
        'grade': currentGrade,
        'subject': currentSubject,
        'field': row_info[0],
        'criterion': row_info[1],
        'evaluation': row_info[2],
      }

      try {
        const url = `${_URL}/neis/get_evaluation_criteria_by_achievement_criterion/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        // console.log(res.message);
        // console.log(res.criterion_id);
        // console.log(res.moddable); // false
        // console.log(res.result);
        currentCriterionId = res.criterion_id;
        currentModdable = !res.moddable;

        if (Object.keys(res.result).length > 0 && !currentModdable) { // 객체에 유효한 값이 들어있으며 수정이 불가능할 시
          $("#eval_range").prop("disabled", true);
          updateButtonStatesWithStyles([$btn5, true], [$btn6, true]);
        } else if (Object.keys(res.result).length > 0 && currentModdable) { // 객체에 유효한 값이 들어있으며 수정이 가능할 시
          $("#eval_range").prop("disabled", false);
          updateButtonStatesWithStyles([$btn5, false], [$btn6, false]);
        } else { // 객체가 비어있을 경우
          $("#eval_range").prop("disabled", false);
          $("#eval_range option:selected").prop("selected", false);
          $("#eval_range option").eq(0).prop("selected", true);
        }
        $("#menu_e2_table_2").css({ "flex-grow" : 0 });

        renderEvaluationCriteriaTable(res.result, currentModdable);
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $("#eval_range").on("change", function() {
      // #menu_e2_tbody_2에 활성화 된 tr의 개수를 확인하고, 부족한 수만큼 새로 생성하거나, 불필요한 만큼 삭제 수행
      const rows_exists = $("#menu_e2_tbody_2 tr").length;
      const rows_result = $("#eval_range").val();
      const diff = rows_result - rows_exists;
      const rowHtml = `
        <tr>
          <td>
            <div style="display: flex; align-items: center; justify-content: center; height: 3.8rem; width: 100%; border: 1px solid #bb395a; border-radius: 5px;">
              <input type="text" class="eval_input" maxlength="10" />
            </div>
          </td>
          <td>
            <textarea rows="3" maxlength="500" style="width: 100%; height: 3.8rem; overflow: auto; resize: none;" spellcheck="false"></textarea>
          </td>
        </tr>
      `;
      if (diff > 0) { // diff에 해당하는 숫자만큼의 행을 tbody의 마지막 행에 이어 순차적으로 생성
        for (let i = 0; i < diff; i++) {
          $("#menu_e2_tbody_2").append(rowHtml);
        }
      } else if (diff < 0) { // diff에 해당하는 숫자만큼의 행을 tbody의 마지막 행부터 순차적으로 삭제
        for (let i = 0; i < Math.abs(diff); i++) {
          $("#menu_e2_tbody_2 tr:last").remove();
        }
      }

      if (rows_result === '0') {
        updateButtonStatesWithStyles([$btn5, true], [$btn6, true]);
      } else {
        updateButtonStatesWithStyles([$btn5, false], [$btn6, false]);
      }

      $("#evaluation_count").text($("#menu_e2_tbody_2 tr").length);
    });

    $("#btnE6").on("click", function(){ // 평가기준 테이블의 삭제 버튼 클릭 시
      $("#eval_range option:selected").prop("selected", false);
      $("#eval_range option").eq(0).prop("selected", true);
      $("#menu_e2_tbody_2").html("");
      updateButtonStatesWithStyles([$btn5, true], [$btn6, true]);
    });

    $("#btnE5").on("click", async function () { // 평가기준 테이블의 저장 버튼 클릭 시
      const keys = $("#menu_e2_tbody_2 input").map((i, el) => $(el).val().trim()).get();
      const values = $("#menu_e2_tbody_2 textarea").map((i, el) => $(el).val().trim()).get();

      const is_valid = [...keys, ...values].every(el => el?.trim() !== "");

      if (!is_valid) {
        alert("비어있는 셀이 있어 저장할 수 없습니다.");
        return;
      }

      const rawData = keys.map((item, i) => [item, values[i]]);
      const data = rawData.reduce((obj, value, i) => {
        obj[i + 1] = value;
        return obj;
      }, {});

      data['criterionId'] = currentCriterionId;
      
      try {
        const url = `${_URL}/neis/manage_evaluation_criteria_records/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        alert(res.message);
        console.log(res.result);
        console.log(res.saved);
        console.log(res.deleted);

        renderEvaluationCriteriaTable(res.result, currentModdable);
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
    });
  }

  const html_searchResourcesModal = () => {
    return `
      <div class="modal fade" id="searchResourcesModal" tabindex="-1" aria-labelledby="searchResourcesModalLabel">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="searchResourcesModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table table-hover table-bordered">
                <thead>
                  <tr>
                    <th scope="col style="width: 8;">삭제</th>
                    <th scope="col style="width: 8;">수정</th>
                    <th scope="col style="width: 64;">경로</th>
                    <th scope="col" style="width: 20%;">등록일자</th>
                  </tr>
                </thead>
                <tbody id="menu_g_modal_tbody" class="text-center">
                </tbody>
              </table>
              <div id="nav_dir_modal">
                <ul id="toc_modal" class="list-group list-group-flush"></ul>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" id="toc_modal_confirm" class="btn btn-secondary disabled">업로드</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderAchievementEvaluationScreen() {
    // 학생이 특정한 성취기준에 따른 평가요소를 어느 정도 수준까지 달성했는지 평가결과를 기록 및 관리하는 화면을 렌더링 --> MENU.G
    let html = null;
    html = `
    <div id="menu_g_content" class="col col-xl-12">
      <div class="achievementStandardsAndAssessment fw-semibold">
        <div class="col col-12 col-xl-1">성취기준</div>
        <div class="col col-12 col-xl-5" style="padding-left: 0.3rem;"></div>
        <div class="col col-12 col-xl-1">평가요소</div>
        <div class="col col-12 col-xl-5" style="padding-left: 0.3rem;"></div>
      </div>
      <div class="table-header sticky-top bg-white p-0 mt-1 mb-1 d-flex justify-content-between align-items-center">
        <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="student_count">0</span></div>
        <div id="menu_g_btns">
          <button id="btnG1" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#searchResourcesModal" data-bs-whatever="{{ g.user.username }}">평가근거자료</button>
          <button id="btnG2" type="button" class="btn btn-sm btn-secondary" disabled>저장</button>
          <button id="btnG3" type="button" class="btn btn-sm btn-secondary" disabled>삭제</button>
          <button id="btnG4" type="button" class="btn btn-sm btn-secondary" disabled>출력</button>
        </div>
      </div>
      ${html_searchResourcesModal()}
      <div style="padding: 0.5rem 0.5rem 0.5rem 0.5rem; background-color: #f3f4f8;">
        <select id="batchApply" class="form-select form-select-sm select-width-xxl"></select>
      </div>  
      <div style="display: flex; flex-direction: column; height: 64vh; overflow-y: auto;">
        <table id="menu_g_table" class="table table-hover table-bordered" style="margin-top: 0;">
          <thead>
            <tr>
              ${renderSelectAllCheckboxButton(3)}
              <th scope="col" style="width: 6%;">반/번호</th>
              <th scope="col" style="width: 12%;">성명</th>
              <th scope="col" style="width: 12%;">단계</th>
              <th scope="col" style="width: 60%;">평가결과</th>
              <th scope="col" style="width: 7%;">평가근거자료</th>
            </tr>
          </thead>
          <tbody id="menu_g_tbody">
            ${renderEmptyTbodyWithMessage(6)}
          </tbody>
        </table>
      </div>    
    </div>
    `;
    return html;
  }

  function getStyledDirectoryName(d_path, depth, path, type) {
    return '&emsp;'.repeat(depth) + `${type === 'directory' ? icons['folder'] : icons[d_path.split('.').pop()] || `<i class="fa-regular fa-file"></i>`}` + '&emsp;' + d_path; 
  }

  const icons = {
    'folder': '<i class="fa-solid fa-folder" style="color: #4078FF;"></i>',
    'pdf': '<i class="fa-solid fa-file-pdf" style="color: #DA5A37"></i>',
    'zip': '<i class="fa-solid fa-file-zipper" style="color: #968069"></i>',
    'doc': '<i class="fa-solid fa-file-word" style="color: #457DD8"></i>',
    'docx': '<i class="fa-solid fa-file-word" style="color: #457DD8"></i>',
    'ppt': '<i class="fa-solid fa-file-powerpoint" style="color: #E76C4E"></i>',
    'pptx': '<i class="fa-solid fa-file-powerpoint" style="color: #E76C4E"></i>',
    'xls': '<i class="fa-solid fa-file-excel" style="color: #30A364"></i>',
    'xlsx': '<i class="fa-solid fa-file-excel" style="color: #30A364"></i>',
    'hwp': '<i class="fa-solid fa-file-signature" style="color: #43A6DD"></i>',
    'hwpx': '<i class="fa-solid fa-file-signature" style="color: #43A6DD"></i>',
    'video': '<i class="fa-solid fa-file-video" style="color: #01C75A"></i>',
    'mp3': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'webm': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'aac': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'm4a': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'wav': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'flac': '<i class="fa-solid fa-file-audio" style="color: #6F42C1"></i>',
    'html': '<i class="fa-solid fa-file-code" style="color: #1DB45B"></i>',
    'png': '<i class="fa-solid fa-file-image" style="color: #4078FF;"></i>',
    'jpeg': '<i class="fa-solid fa-file-image" style="color: #4078FF;"></i>',
    'jpg': '<i class="fa-solid fa-file-image" style="color: #4078FF;"></i>',
    'webp': '<i class="fa-solid fa-file-image" style="color: #4078FF;"></i>',
    'csv': '<i class="fa-solid fa-file-csv" tyle="color: #4078FF;"></i>',
  }


  // 'invisible' 클래스를 토글하는 함수
  function toggleVisibility(item, isInvisible) {
    if (isInvisible) {
      item.classList.add('invisible');
      const icon = item.querySelector('.fa-solid');
      if (icon && icon.classList.contains('fa-folder-open')) {
        icon.classList.remove('fa-folder-open');
        icon.classList.add('fa-folder');
        item.classList.remove('open');
      }
    } else {
      item.classList.remove('invisible');
    }
  }

  // 하위 아이템을 숨기거나 표시하는 함수
  function handleSubItems(item, shouldDisplay) {
    const targetIds = JSON.parse(item.dataset.subids);
    targetIds.forEach(id => {
      const subItem = document.querySelector(`.list-group-item[data-id='${id}']`);
      if (subItem) {
        toggleVisibility(subItem, shouldDisplay);
        // 하위 항목이 토글되었으면, 그 하위 아이템의 subids도 처리
        if (shouldDisplay) {
          handleSubItems(subItem, shouldDisplay);
        }
      }
    });
  }

  // 특정 ID들의 항목을 표시하는 함수
  function displayTagsById(subids, modal=undefined) {
    let listItems = null;
    if (modal) {
      listItems = document.querySelectorAll('#toc_modal .list-group-item');
    } else {
      listItems = document.querySelectorAll('#toc .list-group-item');
    }
    
    listItems.forEach(item => {
      const itemId = parseInt(item.dataset.id, 10);
      
      // 클릭된 ID가 포함된 아이템만 처리
      if (subids.includes(itemId)) {
        const isCurrentlyInvisible = item.classList.contains('invisible');
        const shouldDisplay = !isCurrentlyInvisible;  // 서브 요소가 가려져 있을 경우, shouldDisplay에 false가 담김
        
        toggleVisibility(item, shouldDisplay);
        
        // 하위 항목을 표시하려면, 하위 아이템이 보이도록 처리
        if (shouldDisplay) {
          handleSubItems(item, shouldDisplay);
        }
      }
    });
  }

  // 아이콘을 변경하는 함수
  function toggleFolderIcon(item, isOpen) {
    const icon = item.querySelector('.fa-solid');
    if (icon) {
      if (isOpen) {
        icon.classList.remove('fa-folder');
        icon.classList.add('fa-folder-open');
      } else {
        icon.classList.remove('fa-folder-open');
        icon.classList.add('fa-folder');
      }
    }
  }

  function openFile(filename, isVideo = false, isAudio = false, files = []) {
    const url = `${_URL}/cloudstorage/view/${filename}`;
    
    if (isVideo) {
      // 동영상 플레이어 창 열기
        const videoPage = `
        <html>
          <head><title>동영상 플레이어</title></head>
          <body style="margin:0; overflow:hidden;">
            <video id="videoPlayer" controls autoplay style="width: 100%; height: 100vh;">
              <source src="${url}" type="video/mp4">
              브라우저가 비디오 태그를 지원하지 않습니다.
            </video>
            <script>
              document.addEventListener('DOMContentLoaded', function () {
                const video = document.getElementById('videoPlayer');
                video.requestFullscreen?.();
              });
          </body>
        </html>`;
      const videoWindow = window.open("", "_blank");
      videoWindow.document.write(videoPage);
    } else if (isAudio) {
      // 오디오 플레이어 창 열기
      const temp = filename.split('.').pop();
      const ext = temp === 'm4a' ? 'mp4' : temp;
      const audioPage = `
        <html>
          <head><title>오디오 플레이어</title></head>
          <body>
            <audio controls autoplay style="width: 100%;">
              <source src="${url}" type="audio/${ext}">
              브라우저가 오디오 태그를 지원하지 않습니다.
            </audio>
          </body>
        </html>`;
      
      const audioWindow = window.open("", "_blank");
      audioWindow.document.write(audioPage);
    } else if (files.length > 0) {
      // 일반 파일 열기
      const imagePage = `
        <html>
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
            <style>
              html, body {
                margin: 0;
                padding: 0;
                background: #111;
                overflow: hidden;
                height: 100%;
              }

              .main-swiper {
                width: 100vw;
                height: 92vh;
              }

              .thumb-swiper {
                height: 8vh;
                padding: 10px 0;
              }

              .swiper-slide {
                overflow: auto;
                display: flex;
                align-items: center;
                justify-content: center;
              }

              .zoomable {
                height: 100%;
                width: auto;
                max-width: none;
                max-height: none;
                cursor: grab;
                transition: transform 0.2s ease;
              }

              .thumb-swiper .swiper-slide {
                opacity: 0.4;
                transition: opacity 0.3s ease;
                cursor: pointer;
              }

              .thumb-swiper .swiper-slide-thumb-active {
                opacity: 1;
              }

              .swiper-button-next,
              .swiper-button-prev {
                background-color: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.2s ease, background-color 0.2s ease;
              }

              .swiper-button-next:hover,
              .swiper-button-prev:hover {
                transform: scale(1.2);
                background-color: rgba(255, 255, 255, 0.5);
              }

              .swiper-button-next::after,
              .swiper-button-prev::after {
                font-size: 1.4rem;
                color: white;
              }

              .swiper-scrollbar {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                height: 8px;
                margin: 4px 16px;
              }

              .swiper-scrollbar-drag {
                background: linear-gradient(135deg, #00c6ff, #0072ff);
                border-radius: 10px;
              }
            </style>
          </head>
          <body>
            <div class="swiper main-swiper">
              <div class="swiper-wrapper">
                ${files.map((el, i) => `
                  <div class="swiper-slide">
                    <img src="${el}" alt="사진${i}" class="zoomable" ondblclick="toggleFullscreen(this)">
                  </div>`).join('')}
              </div>
              <div class="swiper-button-next"></div>
              <div class="swiper-button-prev"></div>
              <div class="swiper-scrollbar"></div>
            </div>

            <div class="swiper thumb-swiper">
              <div class="swiper-wrapper">
                ${files.map((el, i) => `
                  <div class="swiper-slide">
                    <img src="${el}" alt="썸네일${i}" style="height: 100%; object-fit: contain;" />
                  </div>`).join('')}
              </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></scr` + `ipt>
            <script>
              const thumbSwiper = new Swiper('.thumb-swiper', {
                spaceBetween: 10,
                slidesPerView: 25,
                freeMode: true,
                watchSlidesProgress: true,
              });

              const mainSwiper = new Swiper('.main-swiper', {
                loop: true,
                spaceBetween: 10,
                navigation: {
                  nextEl: '.swiper-button-next',
                  prevEl: '.swiper-button-prev',
                },
                scrollbar: {
                  el: '.swiper-scrollbar',
                  draggable: true,
                },
                keyboard: {
                  enabled: true,
                  onlyInViewport: true,
                },
                thumbs: {
                  swiper: thumbSwiper,
                },
                speed: 500,
              });

              // 줌 + 드래그
              document.querySelectorAll('.zoomable').forEach(img => {
                const container = img.closest('.swiper-slide');
                let scale = 1;

                img.addEventListener('wheel', (e) => {
                  e.preventDefault();
                  scale += e.deltaY < 0 ? 0.1 : -0.1;
                  scale = Math.max(1, Math.min(5, scale));
                  img.style.transform = \`scale(\${scale})\`;
                });

                let isDragging = false, startX = 0, startY = 0, scrollLeft = 0, scrollTop = 0;

                img.addEventListener('mousedown', (e) => {
                  isDragging = true;
                  container.style.cursor = 'grabbing';
                  startX = e.pageX;
                  startY = e.pageY;
                  scrollLeft = container.scrollLeft;
                  scrollTop = container.scrollTop;
                });

                img.addEventListener('mouseup', () => {
                  isDragging = false;
                  container.style.cursor = 'grab';
                });

                img.addEventListener('mouseleave', () => {
                  isDragging = false;
                  container.style.cursor = 'grab';
                });

                img.addEventListener('mousemove', (e) => {
                  if (!isDragging) return;
                  e.preventDefault();
                  const dx = e.pageX - startX;
                  const dy = e.pageY - startY;
                  container.scrollLeft = scrollLeft - dx;
                  container.scrollTop = scrollTop - dy;
                });
              });

              function toggleFullscreen(elem) {
                if (!document.fullscreenElement) {
                  elem.requestFullscreen?.();
                } else {
                  document.exitFullscreen?.();
                }
              }
            </scr` + `ipt>
          </body>
        </html>
        `;
      const imageWindow = window.open("", '_blank');
      imageWindow.document.write(imagePage);
    } else {
      window.open(url, '_blank');
    }
  }

  async function script_renderAchievementEvaluationScreen() {
    let params = null;
    let fieldArr = [];
    let achievementArr = [];
    let evaluationArr = [];
    let classArr = [];
    let studentsAchievementData = [];
    let toc_modal_flag = true;
    let clickedElemId = null;
    let student_id = null;
    let achievement_id = null;
    let directories = null;
    const $submitBtn = document.getElementById('submitBtn');
    const $year = document.getElementById('year');
    const $semester = document.getElementById('semester');
    const $grade = document.getElementById('grade');
    const $class = document.getElementById('class');
    const $subject = document.getElementById('subject');
    const $field = document.getElementById('field');
    const $achievement = document.getElementById('standard');
    const $table = document.getElementById('menu_g_table');
    const $btn1 = document.getElementById('btnG1'); // 평가근거자료 버튼
    const $btn2 = document.getElementById('btnG2'); // 저장 버튼
    const $btn3 = document.getElementById('btnG3'); // 삭제 버튼
    const $btn4 = document.getElementById('btnG4'); // 출력 버튼

    const renderAchievementEvaluationTable = info => {
      let lastIdx = 0;
      const tableHTML = info.map(({ student_id, achievement_id, name, level, description, evidence_count }) => {
        lastIdx++;
        return `
          <tr data-sid="${student_id}" data-aid="${achievement_id}">
            <td scope="row" data-id="${lastIdx}" class="text-center"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
            <td class="text-center">${lastIdx}</td>
            <td>${name}</td>
            <td>
              <select class="form-select form-select-sm select-width-full">
                ${[
                  `<option value=""></option>`,
                  ...evaluationArr.map(el => `
                    <option value="${el.step}" ${level === el.level_name ? "selected" : ""}>
                      ${el.level_name}
                    </option>
                  `)
                ].join('').concat(`<option value="${evaluationArr.length + 1}">임의입력</option>`)}
              </select>
            </td>
            <td>
              <textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false" disabled>${description ? description : ""}</textarea>
            </td>
            <td class="text-center">${VISIBLE_STATUS_MAP[!!evidence_count]}</td>
          </tr>
        `;
      }).join('');
      $("#menu_g_tbody").html(tableHTML);
      $("#student_count").text($("#menu_g_tbody tr").length);

      $("#menu_g_tbody").on("change", "input[type='checkbox']", function() {
        const checkedNum = $("#menu_g_tbody input:checked").length;
        if (checkedNum === 1) {
          updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]); 
        } else if (checkedNum === 0)  {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]); 
        } else {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, false], [$btn4, false]); 
        }
      });

      const batchHTML = [`<option value="0">-성취기준별 평가 선택적용-</option>`, ...evaluationArr.map(el => `<option value="${el.step}">${el.level_name}</option>`)].join('').concat(`<option value="${evaluationArr.length + 1}">임의입력</option>`);
      $("#batchApply").html(batchHTML);
    }

    const parseTableRowsToObjects = () => { // 테이블 tbody의 행(tr)을 순회하며 추출한 정보로 객체 리터럴을 만들고 이들을 요소로 갖는 배열을 반환하는 함수
      const data = $("#menu_g_tbody tr").map(function (idx, el) {
        const sid = $(this).attr("data-sid");
        const aid = $(this).attr("data-aid");
        return {
          student_id: sid,
          achievement_id: aid,
          name: $(this).find("td:nth-child(3)").text().trim(),
          level: $(this).find("td:nth-child(4) select option:selected").text().trim(),
          description: $(this).find("td:nth-child(5) textarea").val().trim(),
        }
      }).get();

      return data;
    }

    const get_students_achievement_results = async () => {
      const class_val = $("#class").val();
      const class_id = classArr[classArr.findIndex(el => el[0] === class_val)][1];
      const achievement_val = $("#standard").val();
      const { criterion, evaluation_item, id } = achievementArr[achievementArr.findIndex(el => el['criterion'] === achievement_val)];

      params = new URLSearchParams();
      params.append('class_id', class_id);
      params.append('achievement_id', id);
      
      try {
        const response = await fetch(`${_URL}/neis/get_students_achievement_results/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, info } = res;
        console.log(message);
        // console.log(info);
        renderAchievementEvaluationTable(info);
        studentsAchievementData = parseTableRowsToObjects();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    $("#menu_g_tbody").on("change", "select", function() {
      if ($(this).val() > evaluationArr.length) {
        $(this).parent().next().find("textarea").removeAttr("disabled").val("").focus();
      } else {
        $(this).parent().next().find("textarea").attr("disabled", true).val(evaluationArr[$(this).val() - 1]?.description || "");
      }
    });

    $("#batchApply").on("change", function() {
      const optionVal = $("#batchApply").val()
      if (optionVal === '0') { return; }
      if ($("#menu_g_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        $("#batchApply option").eq(0).attr("selected", true);
        return;
      }
      $("#menu_g_tbody input:checked").each(function() {
        $(this).closest("tr").find("select:first").val(optionVal).trigger("change");
      });
    });

    $grade.addEventListener('change', async (event) => {
      try {
        const response = await fetch(`${_URL}/neis/get_subjects_by_grade/${$grade.value}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { grade, subjects, classes } = res;
        classArr = classes;
        // console.log(classArr);
        populateSelectOptionsAndSetDisabled(classArr.map(el => el[0]), $class);
        populateSelectOptionsAndSetDisabled(subjects, $subject);
        $("#menu_g_tbody").html(renderEmptyTbodyWithMessage(6));
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $class.addEventListener('change', () => {
      updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]);
      $("#menu_g_tbody").html(renderEmptyTbodyWithMessage(6));
    })

    $subject.addEventListener('change', async (event) => {
      params = new URLSearchParams();
      params.append('grade', $grade.value);
      params.append('subject', $subject.value);

      try {
        const response = await fetch(`${_URL}/neis/get_fields_by_subject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { subject, fields } = res;
        if (fields.length > 1) {
          fields.shift();
        }
        fieldArr = fields.map(el => [el[0], el[2]]);
        populateSelectOptionsAndSetDisabled(fields.map(el => el[0]), $field, fields[0][0] == '-없음-' ? true : false);
        $("#menu_g_tbody").html(renderEmptyTbodyWithMessage(6));
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $field.addEventListener('change', async () => {
      if ($field.value === '-없음-') {
        updateButtonStatesWithStyles([$submitBtn, true]);
      } else {
        try {
          const field_val = $("#field").val();
          const fid = fieldArr[fieldArr.findIndex(el => el[0] == field_val)][1];

          const response = await fetch(`${_URL}/neis/get_achievement_criteria_by_field_id/${fid.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, criteria } = res;
          achievementArr = criteria;
          // console.log(achievementArr); // [[성취기준, 평가요소, 성취기준id], ..]
          populateSelectOptionsAndSetDisabled(achievementArr.map(el => el['criterion']), $achievement);
          $("#menu_g_tbody").html(renderEmptyTbodyWithMessage(6));
        } catch (error) {
          console.error('Error:', error);
        }
        updateButtonStatesWithStyles([$submitBtn, false]);
      }
    });

    $achievement.addEventListener('change', async () => {
      const achievement_val = $("#standard").val();
      // console.log("achievementArr: ", achievementArr);
      const { criterion, evaluation_item, id } = achievementArr[achievementArr.findIndex(el => el['criterion'] === achievement_val)];
      $("#menu_g_content div.achievementStandardsAndAssessment div").eq(1).text(criterion);
      $("#menu_g_content div.achievementStandardsAndAssessment div").eq(3).text(evaluation_item);

      try {
        const response = await fetch(`${_URL}/neis/get_evaluation_criteria_by_achievement_id/${id}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, criteria } = res;
        console.log(message);
        // console.log(criteria);
        evaluationArr = criteria;
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]);
        $("#menu_g_tbody").html(renderEmptyTbodyWithMessage(6));
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $submitBtn.addEventListener('click', async (event) => { // 조회 버튼 클릭 시
      event.preventDefault();
      get_students_achievement_results();
      updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]);

      try {
        const response = await fetch(`${_URL}/neis/get_active_school_info/`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { school, year, semester } = res;
        params = new URLSearchParams();
        params.append('school', school);
        params.append('year', year);
        params.append('semester', semester);
    
        const url = `${_URL}/cloudstorage/directoryAllContents/?${params.toString()}`;
    
        const response_2 = await fetch(url, { method: 'GET' });
        if (!response_2.ok) {
          throw new Error(`Error: ${response_2.status}`);
        }
        if (response_2.status === 204) {
          console.log('No Content');
          return;
        }

        const res_2 = await response_2.json();
        // console.log(res_2.message);

        const directoryTree = res_2.message.map((item, idx) => {
          const isFile = item.includes('.');
          const num = item.split('/').length - 1; 
          const _path = item.split('/').pop();
          return {
            id: idx + 1,
            path: item,
            pathForDisplay: _path,
            subdirectoryDepth: num,
            type: isFile ? 'file' : 'directory',
            // type: 'directory',
            children: [],
          };
        });

        directoryTree.forEach((elem) => {
          const children = directoryTree.filter(item => 
            item.path.startsWith(`${elem.path}/`) && item.path !== elem.path
            && !item.path.split(`${elem.path}/`)[1].includes('/')
          );
          const children_ids = children.map(child => child.id);
          elem.children = children_ids;
        });

        directories = directoryTree;

        const html_for_toc = directoryTree
          // .filter(item => item.type === 'directory')
          .map(({ id, path, type, children, pathForDisplay, subdirectoryDepth }) => `
            <a href='#' data-id="${id}" data-subids="${JSON.stringify(children)}" class="list-group-item ${subdirectoryDepth > 5 ? 'invisible' : ''}">
              ${getStyledDirectoryName(pathForDisplay, subdirectoryDepth, path, type)}
            </a>
          `).join('');

        const $toc_modal = document.getElementById('toc_modal');   
        $toc_modal.innerHTML = html_for_toc;

        $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });

        if (!toc_modal_flag) {
          return
        }   
        
        $toc_modal.addEventListener('click', function(e) {
          e.preventDefault();
          $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });
          const elem = e.target.closest('.list-group-item');
          if (elem) {
            clickedElemId = elem.dataset.id;
            elem.querySelector('i').style.color = "#4078FF";
            elem.style.color = "#4078FF";
            elem.style.fontWeight = "bold";
            const subIds = JSON.parse(elem.dataset.subids);
            if (subIds.length > 0) {
              if (!elem.classList.contains('open')) {
                toggleFolderIcon(elem, true);
                elem.classList.add('open');
              } else {
                toggleFolderIcon(elem, false);
                elem.classList.remove('open');
              }
              displayTagsById(subIds, true);
              $("#toc_modal_confirm").removeClass("btn-primary").addClass("btn-secondary").addClass("disabled");
            } else {
              $("#toc_modal_confirm").removeClass("btn-secondary").addClass("btn-primary").removeClass("disabled");
            }
          }
        });
        toc_modal_flag = false;
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn2.addEventListener('click', async () => { // 저장 버튼 클릭 시
      const data = parseTableRowsToObjects();
      const isEqual = JSON.stringify(studentsAchievementData) === JSON.stringify(data);
      if (isEqual) {
        alert("변경된 내용이 없습니다.");
        return
      }

      if (!confirm("변경된 내용을 저장하시겠습니까?")) {
        return
      }

      try {
        const url = `${_URL}/neis/update_student_achievement_levels/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(`${res.message}: , created: ${res.created}, updated: ${res.updated}, total: ${res.total}`);
        alert("저장을 완료했습니다.");
        get_students_achievement_results();
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
    });    

    $btn3.addEventListener('click', () => { // 삭제 버튼 클릭 시 
      if ($("#menu_g_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        return;
      }

      if (!confirm("해당자료를 삭제하시겠습니까?\n등록 또는 수정된 항목은 반영되지 않으며 삭제처리만 반영됩니다.")) {
        return
      }

      $("#menu_g_tbody input:checked").each(function(idx, el) {
        $(el).closest("tr").find("td:nth-child(4) select").val("");
        $(el).closest("tr").find("td:nth-child(5) textarea").val("");
      });
    });

    $btn4.addEventListener('click', async () => { // 출력 버튼 클릭 시
      if ($("#menu_g_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        return;
      }

      let data = {};
      $("#menu_g_tbody input:checked").each(function() {    
        const student_id = $(this).closest("tr").attr("data-sid");
        const achievementIds = data[student_id] || [];
        data[student_id] = [...achievementIds, $(this).closest("tr").attr("data-aid")];
      });
      // console.log("data: ", data);

      try {
        const url = `${_URL}/neis/get_image_resource_paths_by_student_and_achievementIds_Obj/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, info } = res;
        console.log(message);
        // console.log(info);

        const result = Object.values(info) // 최상위 value들 (객체)
          .flatMap(obj => Object.values(obj)) // 각 객체의 value들 (배열)
          .flat(); // 배열들을 평탄화
        // console.log(result);

        if (result.length === 0) {
          alert("등록된 평가근거자료가 없습니다.");
          $("#menu_g_table button.toggleAllcheckboxes").click();
          return
        } 

        const images = result.map(el => `${_URL}/cloudstorage/view/${el}`);
        // console.log(images);
        openFile(images[0], false, false, images);
        $("#menu_g_table button.toggleAllcheckboxes").click();
      } catch (error) {
        console.error('Error:', error);
      }  
    });

    $("#toc_modal_confirm").on("click", async function () { // 모달창의 업로드 버튼 클릭 시
      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      const data = {
        'student_id': student_id, 
        'achievement_id': achievement_id,
        'resource_path': path,
        'ext': file_ext,
      }

      // console.log(data);
      try {
        const url = `${_URL}/neis/create_evaluation_evidence/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        // alert("저장을 완료했습니다.");
        $("#menu_g_tbody input:checked:first").closest("tr").find("td:last").text("O");
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
      $("#searchResourcesModal").modal('hide');
      $("button.toggleAllcheckboxes").click();
    });

    try {
      const response = await fetch(`${_URL}/neis/get_active_grades/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { year, semester, active_grades } = res;
      populateSelectOptionsAndSetDisabled(year, $year, true);
      populateSelectOptionsAndSetDisabled(semester, $semester, true);
      populateSelectOptionsAndSetDisabled(active_grades, $grade);
    } catch (error) {
      console.error('Error:', error);
    }

    const updateBtnsBasedOnSelection = () => {
      const checkedNum = $("#menu_g_tbody input:checked").length;
      if (checkedNum === 1) {
        updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]); 
      } else if (checkedNum === 0)  {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]); 
      } else {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, false], [$btn4, false]); 
      }
    }

    const sideEffect = () => {
      updateBtnsBasedOnSelection();
    };

    toggleAllTableCheckboxes('#menu_g_table', sideEffect);

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(3)", function() {
      const path = $(this).text();
      const file_ext = path.split('.').pop().toLowerCase();
      const image_exts = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'tiff', 'webp'];
      const video_exts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'];
      const audio_exts = ['mp3', 'aac', 'm4a', 'ogg', 'wav', 'flac', 'webm'];
      const code_exts = ['html', 'css', 'js', 'py'];
      const office_exts = ['hwp', 'hwpx', 'pdf', 'ppt', 'pptx'];

      if (video_exts.includes(file_ext)) {
        openFile(path, true, false);
      } else if (audio_exts.includes(file_ext)) {
        openFile(path, false, true);  // 비디오 파일
      } else if (code_exts.includes(file_ext) || office_exts.includes(file_ext)) {
        openFile(path)
      } else if (image_exts.includes(file_ext)) {  
        openFile(path);
      } 
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(1)", async function() { // 삭제 아이콘 클릭 시
      if (confirm(`삭제하시겠습니까? 자료를 삭제해도 원격저장소에 저장된 원자료는 삭제되지 않습니다.`)) {
        try {
          const url = `${_URL}/neis/delete_evaluation_evidence_by_id/`;
          const data = {
            eid: $(this).closest("tr").attr("data-eid"),
          }
          const options = {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log("message: ", res.message);
          console.log("deleted_id: ", res.deleted_id);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").remove();
          if ($("#menu_g_modal_tbody tr").length === 0) {
            $("#menu_g_tbody input:checked").closest("tr").find("td:nth-child(6)").text("X");
          }
        } catch (error) {
          console.error('Error: ', error);
          alert("삭제 중 오류가 발생하였습니다.");
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(2)", async function() { // 양방향 화살표 아이콘 클릭 시
      if ($("#toc_modal_confirm").hasClass("disabled")) { return }

      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      
      const data = {
        eid: $(this).closest("tr").attr("data-eid"),
        resource_path: path,
        ext: file_ext,
      }

      if (confirm(`평가근거자료를 다음으로 수정하시겠습니까?: ${path}`)) {
        try {
          const url = `${_URL}/neis/update_evaluation_evidence_resource/`;
          const options = {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };

          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log(res.message);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").find("td:nth-child(3)").text(path);
        } catch (error) {
          console.error('Error:', error);
          alert(error);
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    const $searchResourcesModal = document.getElementById('searchResourcesModal');
    if ($searchResourcesModal) {
      $searchResourcesModal.addEventListener('show.bs.modal', async (event) => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $searchResourcesModal.querySelector('.modal-title')
        const modalBody = $searchResourcesModal.querySelector('.modal-body')
        const student_name = $("#menu_g_tbody input:checked").parent().next().next().text();
        modalTitle.textContent = `${student_name}의 평가근거자료 선택`;

        student_id = $("#menu_g_tbody input:checked").closest("tr").attr("data-sid");
        achievement_id = $("#menu_g_tbody input:checked").closest("tr").attr("data-aid");

        params = new URLSearchParams();
        params.append('student_id', student_id);
        params.append('achievement_id', achievement_id);
        
        try {
          const response = await fetch(`${_URL}/neis/get_evaluation_evidence_by_student_and_achievement/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, info } = res;
          console.log(message);
          // console.log(info);
          const tableHtml = info.map(({evidence_id, resource_path, created_at}) => {
            return `
              <tr data-eid="${evidence_id}">
                <td><i class="fa-solid fa-trash"></i></td>
                <td><i class="fa-solid fa-right-left"></i></td>
                <td>${resource_path}</td>
                <td>${created_at}</td>
              </tr>
            `
          }).join('');
          $("#menu_g_modal_tbody").html(tableHtml);
        } catch (error) {
          console.error('Error:', error);
        }
      });
    }    
  }

  function renderFieldAssessmentResultsTable() {
    // 학생이 특정한 과목의 한 영역(field)에 부속된 평가요소를 어느 수준까지 달성했는지 평가결과를 기록 및 관리하는 테이블을 렌더링 --> MENU.H
    let html = null;
    html = `
      <div id="menu_h_content" class="col col-xl-12">
        <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
          <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="row_count">0</span></div>
          <div>
            <button id="btnH1" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#searchResourcesModal" data-bs-whatever="{{ g.user.username }}">평가근거자료</button>
            <button id="btnH2" type="button" class="btn btn-sm btn-secondary">저장</button>
            <button id="btnH3" type="button" class="btn btn-sm btn-secondary">삭제</button>
            <button id="btnH4" type="button" class="btn btn-sm btn-secondary">출력</button>
          </div>
        </div>
        ${html_searchResourcesModal()}
        <div style="padding: 0.5rem 0.5rem 0.5rem 0.5rem; background-color: #f3f4f8;">
          <select id="batchApply" class="form-select form-select-sm select-width-xxl" style="text-overflow: ellipsis; padding-left: 0.5rem; padding-right: 1.5rem;"></select>
          <select id="batchApply2" class="form-select form-select-sm select-width-xxl" style="text-overflow: ellipsis; padding-left: 0.5rem; padding-right: 1.5rem;" disabled></select>
        </div>
        <div style="display: flex; flex-direction: column; height: 70vh; overflow-y: auto;">
          <table id="menu_h_table" class="table table-hover table-bordered">
            <thead>
              <tr>
                ${renderSelectAllCheckboxButton(3)}
                <th scope="col" style="width: 6%;">반/번호</th>
                <th scope="col" style="width: 8%;">성명</th>
                <th scope="col" style="width: 18%;">성취기준</th>
                <th scope="col" style="width: 17%;">평가요소</th>
                <th scope="col" style="width: 10%;">단계</th>
                <th scope="col" style="width: 32%;">평가결과</th>
                <th scope="col" style="width: 7%;">평가근거자료</th>
              </tr>
            </thead>
            <tbody id="menu_h_tbody">
              ${renderEmptyTbodyWithMessage(8)}
            </tbody>
          </table>
        </div>
      </div>
    `;
    return html;
  }

  async function script_renderFieldAssessmentResultsTable () {
    let params = null;
    let fieldArr = [];
    let achievementArr = [];
    let classArr = [];
    let studentsAchievementData = [];
    let toc_modal_flag = true;
    let clickedElemId = null;
    let student_id = null;
    let achievement_id = null;
    let directories = null;
    const $submitBtn = document.getElementById('submitBtn');
    const $year = document.getElementById('year');
    const $semester = document.getElementById('semester');
    const $grade = document.getElementById('grade');
    const $class = document.getElementById('class');
    const $subject = document.getElementById('subject');
    const $field = document.getElementById('field');
    const $achievement = document.getElementById('standard');
    const $table = document.getElementById('menu_h_table');
    const $btn1 = document.getElementById('btnH1'); // 평가근거자료 버튼
    const $btn2 = document.getElementById('btnH2'); // 저장 버튼
    const $btn3 = document.getElementById('btnH3'); // 삭제 버튼
    const $btn4 = document.getElementById('btnH4'); // 출력 버튼

    const parseTableRowsToObjects = () => { // 테이블 tbody의 행(tr)을 순회하며 추출한 정보로 객체 리터럴을 만들고 이들을 요소로 갖는 배열을 반환하는 함수
      const data = $("#menu_h_tbody tr").map(function (idx, el) {
        const sid = $(this).attr("data-sid");
        const aid = $(this).attr("data-aid");
        return {
          student_id: sid,
          achievement_id: aid,
          level: $(this).find("td:nth-last-child(3) select option:selected").text().trim(),
          description: $(this).find("td:nth-last-child(2) textarea").val().trim(),
        }
      }).get();

      return data;
    }

    const renderAchievementEvaluationTable = async info => {
      const tableRows = [];
      let lastIdx = 0;

      for (const { student_id, name, results } of info) {
        lastIdx++; // 이름이 다를 때만 증가 (info는 학생별 그룹이므로 이곳에서 증가)
        const rowspan = results.length;

        for (let i = 0; i < results.length; i++) {
          const { criterion_id, criterion, evaluation_item, level, description, evidence_count } = results[i];

          let evaluationArr = [];
          try {
            const response = await fetch(`${_URL}/neis/get_evaluation_criteria_by_achievement_id/${criterion_id}`, {
              method: 'GET',
            });
            if (!response.ok) throw new Error(`서버 오류: ${response.status}`);
            const res = await response.json();
            evaluationArr = res.criteria;
          } catch (error) {
            console.error('Error:', error);
          }

          const rowHTML = `
            <tr data-sid="${student_id}" data-aid="${criterion_id}">
              <td scope="row" class="text-center">
                <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
              </td>
              ${i === 0 ? `
                <td class="text-center align-middle" rowspan="${rowspan}">${lastIdx}</td>
                <td class="align-middle" rowspan="${rowspan}">${name}</td>
              ` : ''}
              <td style="padding: 0px; max-height: 2.2rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; /* 최대 줄 수 */ -webkit-box-orient: vertical; white-space: normal; /* 여러 줄 표시 허용 */">${criterion}</td>
              <td class="align-middle" style="padding: 0px; max-height: 2rem;">${evaluation_item}</td>
              <td>
                <select class="eval_level form-select form-select-sm select-width-full">
                  ${[
                    `<option value=""></option>`,
                    ...evaluationArr.map(el => `
                      <option value="${el.step}" ${level === el.level_name ? "selected" : ""}>
                        ${el.level_name}
                      </option>
                    `)
                  ].join('').concat(`<option value="${evaluationArr.length + 1}">임의입력</option>`)}
                </select>
              </td>
              <td>
                <textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false" disabled>${description ? description : ""}</textarea>
              </td>
              <td class="text-center">${VISIBLE_STATUS_MAP[!!evidence_count]}</td>
            </tr>
          `;

          tableRows.push(rowHTML);
        }
      }

      $("#menu_h_tbody").html(tableRows.join(''));

      const batchHTML = [`<option value="0">-성취기준 선택-</option>`, ...achievementArr.map(el => `<option value="${el.id}">${el.criterion}</option>`)].join('');
      $("#batchApply").html(batchHTML);

      $("#batchApply").on("change", function() {
        const option_val = $(this).val();
        let option_idx = 1;
        const evalArr = achievementArr.filter(el => el.id == option_val)?.map(function(el) {
          let option_html = '';
          for (const { level_name } of el.evaluation_criteria) {
            option_html += `<option value="${option_idx}">${level_name}</option>`;
            option_idx += 1;
          }
          return option_html;
        }).join('');
        // console.log('evalArr: ', evalArr);
        const batchHTML2 = [`<option value="0">-성취기준별 평가 선택적용-</option>`, ...evalArr].join('').concat(`<option value="${option_idx}">임의입력</option>`);
        $("#batchApply2").html(batchHTML2);
        if (option_val == 0) {
          $("#batchApply2").prop("disabled", true);
        } else {
          $("#batchApply2").prop("disabled", false);
        }
      });

      $("#batchApply").change();

      $("#batchApply2").on("change", function() {
        const achievementId = $("#batchApply").val();
        const optionVal = $("#batchApply2").val();

        const targets = $(`#menu_h_tbody tr[data-aid="${achievementId}"] input:checked`);

        if (optionVal === '0') { return; }
        if (targets.length === 0) {
          alert('선택된 대상이 없습니다.');
          $("#batchApply2 option").eq(0).attr("selected", true);
          return;
        }
        targets.each(function() {
          $(this).closest("tr").find("select:first").val(optionVal).trigger("change");
        });
      });

      $("#row_count").text($("#menu_h_tbody tr").length);

      $("#menu_h_tbody").on("change", "input[type='checkbox']", function() {
        const checkedNum = $("#menu_h_tbody input:checked").length
        if (checkedNum === 0) {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]); 
        } else if (checkedNum === 1) {
          updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]); 
        } else {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, false], [$btn4, false]); 
        }
      });

      $("#menu_h_tbody").on("change", "select.eval_level", function() {
        const achievement_id = $(this).closest("tr").attr("data-aid");
        const option_val = $(this).find("option:selected").text().trim();
        const eval_criteria = achievementArr.find(el => el.id == achievement_id)?.evaluation_criteria;
        const desc = eval_criteria.find(el => el.level_name == option_val)?.description;
    
        if ($(this).val() > achievementArr.length) {
          $(this).parent().next().find("textarea").removeAttr("disabled").val("").focus();
        } else {
          $(this).parent().next().find("textarea").attr("disabled", true).val(desc || "");
        }
      });

      if (!$("#menu_h_table button.toggleAllcheckboxes").hasClass('fa-square')) {
        $("#menu_h_table button.toggleAllcheckboxes").click();
      }
      studentsAchievementData = parseTableRowsToObjects();
    };
       
    const get_students_achievement_results = async () => {
      const class_val = $("#class").val();
      const class_id = classArr[classArr.findIndex(el => el[0] === class_val)][1];
      const assessment_area_id = fieldArr[fieldArr.findIndex(el => el[0] === $("#field").val())][1];

      params = new URLSearchParams();
      params.append('class_id', class_id);
      params.append('assessment_area_id', assessment_area_id);

      // console.log("class_id: ", class_id);
      // console.log("assessment_area_id: ", assessment_area_id);
      
      try {
        const response = await fetch(`${_URL}/neis/get_students_achievement_results_by_assessment_area/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, info } = res;
        console.log(message);
        // console.log(info);
        renderAchievementEvaluationTable(info);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    $grade.addEventListener('change', async (event) => {
      try {
        const response = await fetch(`${_URL}/neis/get_subjects_by_grade/${$grade.value}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { grade, subjects, classes } = res;
        classArr = classes;
        // console.log(classArr);
        populateSelectOptionsAndSetDisabled(classArr.map(el => el[0]), $class);
        populateSelectOptionsAndSetDisabled(subjects, $subject);
        $("#menu_h_tbody").html(renderEmptyTbodyWithMessage(8));
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $class.addEventListener('change', () => {
      updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]);
      $("#menu_h_tbody").html(renderEmptyTbodyWithMessage(8));
    })

    $subject.addEventListener('change', async (event) => {
      params = new URLSearchParams();
      params.append('grade', $grade.value);
      params.append('subject', $subject.value);

      try {
        const response = await fetch(`${_URL}/neis/get_fields_by_subject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { subject, fields } = res;
        if (fields.length > 1) {
          fields.shift();
        }
        fieldArr = fields.map(el => [el[0], el[2]]);
        // console.log(fieldArr);
        populateSelectOptionsAndSetDisabled(fields.map(el => el[0]), $field, fields[0][0] == '-없음-' ? true : false);
        $("#menu_h_tbody").html(renderEmptyTbodyWithMessage(8));
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $field.addEventListener('change', async () => {
      if ($field.value === '-없음-') {
        updateButtonStatesWithStyles([$submitBtn, true]);
      } else {
        try {
          const field_val = $("#field").val();
          const fid = fieldArr[fieldArr.findIndex(el => el[0] == field_val)][1];

          const response = await fetch(`${_URL}/neis/get_achievement_and_evaluation_criteria_by_field_id/${fid.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, criteria } = res;
          achievementArr = criteria;
          // console.log(achievementArr); // [[성취기준, 평가요소, 성취기준id], ..]
          // populateSelectOptionsAndSetDisabled(achievementArr.map(el => el['criterion']), $achievement);
          $("#batchApply").html("");
          $("#batchApply2").html("").prop("disabled", true);

          $("#menu_h_tbody").html(renderEmptyTbodyWithMessage(8));
        } catch (error) {
          console.error('Error:', error);
        }
        updateButtonStatesWithStyles([$submitBtn, false]);
      }
    });

    $submitBtn.addEventListener('click', async (event) => { // 조회 버튼 클릭 시
      event.preventDefault();
      get_students_achievement_results();
      updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]);

      try {
        const response = await fetch(`${_URL}/neis/get_active_school_info/`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { school, year, semester } = res;
        params = new URLSearchParams();
        params.append('school', school);
        params.append('year', year);
        params.append('semester', semester);
    
        const url = `${_URL}/cloudstorage/directoryAllContents/?${params.toString()}`;
    
        const response_2 = await fetch(url, { method: 'GET' });
        if (!response_2.ok) {
          throw new Error(`Error: ${response_2.status}`);
        }
        if (response_2.status === 204) {
          console.log('No Content');
          return;
        }

        const res_2 = await response_2.json();
        // console.log(res_2.message);

        const directoryTree = res_2.message.map((item, idx) => {
          const isFile = item.includes('.');
          const num = item.split('/').length - 1; 
          const _path = item.split('/').pop();
          return {
            id: idx + 1,
            path: item,
            pathForDisplay: _path,
            subdirectoryDepth: num,
            type: isFile ? 'file' : 'directory',
            // type: 'directory',
            children: [],
          };
        });

        directoryTree.forEach((elem) => {
          const children = directoryTree.filter(item => 
            item.path.startsWith(`${elem.path}/`) && item.path !== elem.path
            && !item.path.split(`${elem.path}/`)[1].includes('/')
          );
          const children_ids = children.map(child => child.id);
          elem.children = children_ids;
        });

        directories = directoryTree;

        const html_for_toc = directoryTree
          // .filter(item => item.type === 'directory')
          .map(({ id, path, type, children, pathForDisplay, subdirectoryDepth }) => `
            <a href='#' data-id="${id}" data-subids="${JSON.stringify(children)}" class="list-group-item ${subdirectoryDepth > 5 ? 'invisible' : ''}">
              ${getStyledDirectoryName(pathForDisplay, subdirectoryDepth, path, type)}
            </a>
          `).join('');

        const $toc_modal = document.getElementById('toc_modal');   
        $toc_modal.innerHTML = html_for_toc;

        $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });

        if (!toc_modal_flag) {
          return
        }   
        
        $toc_modal.addEventListener('click', function(e) {
          e.preventDefault();
          $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });
          const elem = e.target.closest('.list-group-item');
          if (elem) {
            clickedElemId = elem.dataset.id;
            elem.querySelector('i').style.color = "#4078FF";
            elem.style.color = "#4078FF";
            elem.style.fontWeight = "bold";
            const subIds = JSON.parse(elem.dataset.subids);
            if (subIds.length > 0) {
              if (!elem.classList.contains('open')) {
                toggleFolderIcon(elem, true);
                elem.classList.add('open');
              } else {
                toggleFolderIcon(elem, false);
                elem.classList.remove('open');
              }
              displayTagsById(subIds, true);
              $("#toc_modal_confirm").removeClass("btn-primary").addClass("btn-secondary").addClass("disabled");
            } else {
              $("#toc_modal_confirm").removeClass("btn-secondary").addClass("btn-primary").removeClass("disabled");
            }
          }
        });
        toc_modal_flag = false;
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn2.addEventListener('click', async () => { // 저장 버튼 클릭 시
      const data = parseTableRowsToObjects();
      const isEqual = JSON.stringify(studentsAchievementData) === JSON.stringify(data);
      if (isEqual) {
        alert("변경된 내용이 없습니다.");
        return
      }

      if (!confirm("변경된 내용을 저장하시겠습니까?")) {
        return
      }

      try {
        const url = `${_URL}/neis/update_student_achievement_levels/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(`${res.message}: , created: ${res.created}, updated: ${res.updated}, total: ${res.total}`);
        alert("저장을 완료했습니다.");
        get_students_achievement_results();
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
    });    

    $btn3.addEventListener('click', () => { // 삭제 버튼 클릭 시 
      if ($("#menu_h_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        return;
      }

      if (!confirm("해당자료를 삭제하시겠습니까?\n등록 또는 수정된 항목은 반영되지 않으며 삭제처리만 반영됩니다.")) {
        return
      }

      $("#menu_h_tbody input:checked").each(function(idx, el) {
        $(el).closest("tr").find("td:nth-last-child(3) select").val("");
        $(el).closest("tr").find("td:nth-last-child(2) textarea").val("");
      });

      $("#menu_h_table button.toggleAllcheckboxes").click();
    });

    $btn4.addEventListener('click', async () => { // 출력 버튼 클릭 시
      if ($("#menu_h_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        return;
      }

      let data = {};
      $("#menu_h_tbody input:checked").each(function() {    
        const student_id = $(this).closest("tr").attr("data-sid");
        const achievementIds = data[student_id] || [];
        data[student_id] = [...achievementIds, $(this).closest("tr").attr("data-aid")];
      });
      // console.log("data: ", data);

      try {
        const url = `${_URL}/neis/get_image_resource_paths_by_student_and_achievementIds_Obj/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, info } = res;
        console.log(message);
        // console.log(info);

        const result = Object.values(info) // 최상위 value들 (객체)
          .flatMap(obj => Object.values(obj)) // 각 객체의 value들 (배열)
          .flat(); // 배열들을 평탄화

        // console.log(result);

        if (result.length === 0) {
          alert("등록된 평가근거자료가 없습니다.");
          $("#menu_h_table button.toggleAllcheckboxes").click();
          return
        } 

        const images = result.map(el => `${_URL}/cloudstorage/view/${el}`);
        openFile(images[0], false, false, images);
        $("#menu_h_table button.toggleAllcheckboxes").click();
      } catch (error) {
        console.error('Error:', error);
      }  
    });

    const updateBtnsBasedOnSelection = () => {
      const checkedNum = $("#menu_h_tbody input:checked").length
      if (checkedNum === 0) {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]); 
      } else if (checkedNum === 1) {
        updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]); 
      } else {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, false], [$btn4, false]); 
      }
    }

    const sideEffect = () => {
      updateBtnsBasedOnSelection();
    };

    toggleAllTableCheckboxes('#menu_h_table', sideEffect);

    $("#toc_modal_confirm").on("click", async function () { // 모달창의 업로드 버튼 클릭 시
      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      const data = {
        'student_id': student_id, 
        'achievement_id': achievement_id,
        'resource_path': path,
        'ext': file_ext,
      }

      // console.log(data);
      try {
        const url = `${_URL}/neis/create_evaluation_evidence/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        // alert("저장을 완료했습니다.");
        $("#menu_h_tbody input:checked:first").closest("tr").find("td:last").text("O");
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
      $("#searchResourcesModal").modal('hide');
      $("button.toggleAllcheckboxes").click();
    });

    try {
      const response = await fetch(`${_URL}/neis/get_active_grades/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { year, semester, active_grades } = res;
      populateSelectOptionsAndSetDisabled(year, $year, true);
      populateSelectOptionsAndSetDisabled(semester, $semester, true);
      populateSelectOptionsAndSetDisabled(active_grades, $grade);
    } catch (error) {
      console.error('Error:', error);
    }

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(3)", function() {
      const path = $(this).text();
      const file_ext = path.split('.').pop().toLowerCase();
      const image_exts = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'tiff', 'webp'];
      const video_exts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'];
      const audio_exts = ['mp3', 'aac', 'm4a', 'ogg', 'wav', 'flac', 'webm'];
      const code_exts = ['html', 'css', 'js', 'py'];
      const office_exts = ['hwp', 'hwpx', 'pdf', 'ppt', 'pptx'];

      if (video_exts.includes(file_ext)) {
        openFile(path, true, false);
      } else if (audio_exts.includes(file_ext)) {
        openFile(path, false, true);  // 비디오 파일
      } else if (code_exts.includes(file_ext) || office_exts.includes(file_ext)) {
        openFile(path)
      } else if (image_exts.includes(file_ext)) {  
        openFile(path);
      } 
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(1)", async function() { // 삭제 아이콘 클릭 시
      if (confirm(`삭제하시겠습니까? 자료를 삭제해도 원격저장소에 저장된 원자료는 삭제되지 않습니다.`)) {
        try {
          const url = `${_URL}/neis/delete_evaluation_evidence_by_id/`;
          const data = {
            eid: $(this).closest("tr").attr("data-eid"),
          }
          const options = {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log("message: ", res.message);
          console.log("deleted_id: ", res.deleted_id);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").remove();
          if ($("#menu_g_modal_tbody tr").length === 0) {
            $("#menu_g_tbody input:checked").closest("tr").find("td:nth-child(6)").text("X");
          }
        } catch (error) {
          console.error('Error: ', error);
          alert("삭제 중 오류가 발생하였습니다.");
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(2)", async function() { // 양방향 화살표 아이콘 클릭 시
      if ($("#toc_modal_confirm").hasClass("disabled")) { return }

      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      
      const data = {
        eid: $(this).closest("tr").attr("data-eid"),
        resource_path: path,
        ext: file_ext,
      }

      if (confirm(`평가근거자료를 다음으로 수정하시겠습니까?: ${path}`)) {
        try {
          const url = `${_URL}/neis/update_evaluation_evidence_resource/`;
          const options = {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };

          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log(res.message);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").find("td:nth-child(3)").text(path);
        } catch (error) {
          console.error('Error:', error);
          alert(error);
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    const $searchResourcesModal = document.getElementById('searchResourcesModal');
    if ($searchResourcesModal) {
      $searchResourcesModal.addEventListener('show.bs.modal', async (event) => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $searchResourcesModal.querySelector('.modal-title')
        const modalBody = $searchResourcesModal.querySelector('.modal-body')
        
        let targetRow = $("#menu_h_tbody input:checked").closest("tr");
        let td_num = null;
        while(true) {
          td_num = targetRow.find("td").length;
          if (td_num != 8) {
            targetRow = targetRow.prev();
            continue;
          } 
          break;
        }
        
        const student_name = targetRow.find("td").eq(2).text();
        modalTitle.textContent = `${student_name}의 평가근거자료 선택`;

        student_id = $("#menu_h_tbody input:checked").closest("tr").attr("data-sid");
        achievement_id = $("#menu_h_tbody input:checked").closest("tr").attr("data-aid");

        params = new URLSearchParams();
        params.append('student_id', student_id);
        params.append('achievement_id', achievement_id);
        
        try {
          const response = await fetch(`${_URL}/neis/get_evaluation_evidence_by_student_and_achievement/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, info } = res;
          console.log(message);
          // console.log(info);
          const tableHtml = info.map(({evidence_id, resource_path, created_at}) => {
            return `
              <tr data-eid="${evidence_id}">
                <td><i class="fa-solid fa-trash"></i></td>
                <td><i class="fa-solid fa-right-left"></i></td>
                <td>${resource_path}</td>
                <td>${created_at}</td>
              </tr>
            `
          }).join('');
          $("#menu_g_modal_tbody").html(tableHtml);
        } catch (error) {
          console.error('Error:', error);
        }
      });
    }   
  }


  function renderSubjectAssessmentResultsTable() {
    // 학생이 특정 교과에 배당된 모든 평가요소에 대해 어느 수준까지 성취했는지 그 평가결과를 기록 및 관리하는 테이블을 렌더링
    let html = null;
    html = `
    <div id="menu_i_content" class="col col-xl-12">
      <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
        <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="row_count">0</span></div>
        <div>
          <button id="btnI1" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#searchResourcesModal" data-bs-whatever="{{ g.user.username }}">평가근거자료</button>
          <button id="btnI2" type="button" class="btn btn-sm btn-secondary">저장</button>
          <button id="btnI3" type="button" class="btn btn-sm btn-secondary">삭제</button>
          <button id="btnI4" type="button" class="btn btn-sm btn-secondary">출력</button>
        </div>
      </div>
      ${html_searchResourcesModal()}
      <div style="padding: 0.5rem 0.5rem 0.5rem 0.5rem; background-color: #f3f4f8;">
        <select id="batchApply" class="form-select form-select-sm select-width-xxl" style="text-overflow: ellipsis; padding-left: 0.5rem; padding-right: 1.5rem;"></select>
        <select id="batchApply2" class="form-select form-select-sm select-width-xxl" style="text-overflow: ellipsis; padding-left: 0.5rem; padding-right: 1.5rem;" disabled></select>
        <select id="batchApply3" class="form-select form-select-sm select-width-xxl" style="text-overflow: ellipsis; padding-left: 0.5rem; padding-right: 1.5rem;" disabled></select>
      </div>
      <div style="display: flex; flex-direction: column; height: 73vh; overflow-y: auto;">
        <table id="menu_i_table" class="table table-hover table-bordered">
          <thead>
            <tr>
              ${renderSelectAllCheckboxButton(3)}
              <th scope="col" style="width: 5%;">반/번호</th>
              <th scope="col" style="width: 6%;">성명</th>
              <th scope="col" style="width: 7%;">영역</th>
              <th scope="col" style="width: 16%;">성취기준</th>
              <th scope="col" style="width: 15%;">평가요소</th>
              <th scope="col" style="width: 8%;">단계</th>
              <th scope="col" style="width: 24%;">평가결과</th>
              <th scope="col" style="width: 6%;">평가근거자료</th>
            </tr>
          </thead>
          <tbody id="menu_i_tbody">
            ${renderEmptyTbodyWithMessage(9)}
          </tbody>
        </table>
      </div>
    `;
    return html;
  }

  async function script_renderSubjectAssessmentResultsTable() {
    let params = null;
    let fieldArr = [];
    let achievementArr = [];
    let classArr = [];
    let subjectArr = [];
    let studentsAchievementData = [];
    let toc_modal_flag = true;
    let clickedElemId = null;
    let student_id = null;
    let achievement_id = null;
    let subjectId = null;
    let subject_ids = [];
    let directories = null;
    const $submitBtn = document.getElementById('submitBtn');
    const $year = document.getElementById('year');
    const $semester = document.getElementById('semester');
    const $grade = document.getElementById('grade');
    const $class = document.getElementById('class');
    const $subject = document.getElementById('subject');
    const $achievement = document.getElementById('standard');
    const $table = document.getElementById('menu_i_table');
    const $btn1 = document.getElementById('btnI1'); // 평가근거자료 버튼
    const $btn2 = document.getElementById('btnI2'); // 저장 버튼
    const $btn3 = document.getElementById('btnI3'); // 삭제 버튼
    const $btn4 = document.getElementById('btnI4'); // 출력 버튼

    const parseTableRowsToObjects = () => { // 테이블 tbody의 행(tr)을 순회하며 추출한 정보로 객체 리터럴을 만들고 이들을 요소로 갖는 배열을 반환하는 함수
      const data = $("#menu_i_tbody tr").map(function (idx, el) {
        const sid = $(this).attr("data-sid");
        const aid = $(this).attr("data-aid");
        return {
          student_id: sid,
          achievement_id: aid,
          level: $(this).find("td:nth-last-child(3) select option:selected").text().trim(),
          description: $(this).find("td:nth-last-child(2) textarea").val().trim(),
        }
      }).get();

      return data;
    }

    const resetBatchApplyBoxes = () => { // batchApply 1, 2, 3의 활성 상태를 초기화
      $("#batchApply").html("");
      $("#batchApply2").html("");
      $("#batchApply3").html("");
      $("#batchApply").prop("disabled", false);
      $("#batchApply2").prop("disabled", true);
      $("#batchApply3").prop("disabled", true);
    }

    const renderAchievementEvaluationTable = async info => {
      let tableRows = '';
      let lastIdx = 0;

      for (const { student_id, name, results } of info) {
        lastIdx++; // 학생별 index 증가
        let rowspan = 0;
        for (const [field_name, _] of fieldArr) {
          rowspan += results[field_name].length;
        }

        let i = 0;

        for (const [field_name, _] of fieldArr) {
          let fieldIdx = 0;
          const field_rowspan = results[field_name].length;

          for (const { criterion_id, criterion, evaluation_item, level, description, evidence_count } of results[field_name]) {
            i++;
            fieldIdx++;

            // 비동기 fetch 대기
            let evaluationArr = [];
            try {
              const response = await fetch(`${_URL}/neis/get_evaluation_criteria_by_achievement_id/${criterion_id}`, {
                method: 'GET',
              });
              if (!response.ok) throw new Error(`서버 오류: ${response.status}`);
              const res = await response.json();
              evaluationArr = res.criteria || [];
            } catch (error) {
              console.error('Error:', error);
            }

            tableRows += `
              <tr data-sid="${student_id}" data-aid="${criterion_id}">
                <td scope="row" class="text-center">
                  <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
                </td>
                ${i === 1 ? `
                  <td class="text-center align-middle" rowspan="${rowspan}">${lastIdx}</td>
                  <td class="align-middle" rowspan="${rowspan}">${name}</td>
                ` : ''}
                ${fieldIdx === 1 ? `
                  <td class="align-middle" rowspan="${field_rowspan}">${field_name}</td>
                ` : ''}
                <td style="padding: 0px; max-height: 2.2rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; white-space: normal;">
                  ${criterion}
                </td>
                <td class="align-middle" style="padding: 0px; max-height: 2rem;">${evaluation_item}</td>
                <td>
                  <select class="eval_level form-select form-select-sm select-width-full">
                    ${[
                      `<option value=""></option>`,
                      ...evaluationArr.map(el => `
                        <option value="${el.step}" ${level === el.level_name ? "selected" : ""}>
                          ${el.level_name}
                        </option>
                      `)
                    ].join('').concat(`<option value="${evaluationArr.length + 1}">임의입력</option>`)}
                  </select>
                </td>
                <td>
                  <textarea rows="1" maxlength="500" style="width: 100%; height: 1.4rem; overflow: auto; resize: none;" spellcheck="false" disabled>${description || ""}</textarea>
                </td>
                <td class="text-center">${VISIBLE_STATUS_MAP[!!evidence_count]}</td>
              </tr>
            `;
          }
        }
      }

      $("#menu_i_tbody").html(tableRows);

      const batchHTML = [`<option value="0">-영역명 선택-</option>`, ...fieldArr.map(el => `<option value="${el[1]}">${el[0]}</option>`)].join('');
      $("#batchApply").html(batchHTML);

      $("#batchApply").on("change", async function () {
        // console.log('option_Val: ', $("#batchApply option:selected").val());
        if ($("#batchApply").val() === '0') {
          const batchHTML2 = '<option value="0">-성취기준 선택-</option>';
          const batchHTML3 = '<option value="0">-성취기준별 평가 선택적용-</option>';
          $("#batchApply2").html(batchHTML2);
          $("#batchApply2").prop("disabled", true);
          $("#batchApply3").html(batchHTML3);
          $("#batchApply3").prop("disabled", true);
          return
        } else {
          try {
            const fid = $("#batchApply option:selected").val();
            const response = await fetch(`${_URL}/neis/get_achievement_and_evaluation_criteria_by_field_id/${fid.toString()}`, {
              method: 'GET',
            });
            if (!response.ok) {
              throw new Error(`서버 오류: ${response.status}`);
            }
            
            const res = await response.json();
            const { message, criteria } = res;
            achievementArr = criteria;
            // console.log('achievementArr: ', achievementArr); // [[성취기준, 평가요소, 성취기준id], ..]
            
            const batchHTML2 = [`<option value="0">-성취기준 선택-</option>`, ...achievementArr.map(el => `<option value="${el.id}">${el.criterion}</option>`)].join('');
            $("#batchApply2").html(batchHTML2);
            $("#batchApply2").prop("disabled", false);
            const batchHTML3 = '<option value="0">-성취기준별 평가 선택적용-</option>';
            $("#batchApply3").html(batchHTML3);
            $("#batchApply3").prop("disabled", true);
          } catch (error) {
            console.error('Error:', error);
          }
        }
      });

      $("#batchApply").change();

      $("#batchApply2").on("change", function() {
        const option_val = $(this).val();
        let option_idx = 1;
        const evalArr = achievementArr.filter(el => el.id == option_val)?.map(function(el) {
          let option_html = '';
          for (const { level_name } of el.evaluation_criteria) {
            option_html += `<option value="${option_idx}">${level_name}</option>`;
            option_idx += 1;
          }
          return option_html;
        }).join('');
        // console.log('evalArr: ', evalArr);
        const batchHTML3 = [`<option value="0">-성취기준별 평가 선택적용-</option>`, ...evalArr].join('').concat(`<option value="${option_idx}">임의입력</option>`);
        $("#batchApply3").html(batchHTML3);
        if (option_val == 0) {
          $("#batchApply3").prop("disabled", true);
        } else {
          $("#batchApply3").prop("disabled", false);
        }
      });

      $("#batchApply3").on("change", function() {
        const achievementId = $("#batchApply2").val();
        const optionVal = $("#batchApply3").val();
        if (optionVal === '0') { return; }

        const targets = $(`#menu_i_tbody tr[data-aid="${achievementId}"] input:checked`);
        if (targets.length === 0) {
          alert('선택된 대상이 없습니다.');
          $("#batchApply3 option").eq(0).attr("selected", true);
          return;
        }
        targets.each(function() {
          $(this).closest("tr").find("select:first").val(optionVal).trigger("change");
        });
      });

      $("#row_count").text($("#menu_i_tbody tr").length);

      $("#menu_i_tbody").on("change", "input[type='checkbox']", function() {
        const checkedNum = $("#menu_i_tbody input:checked").length
        if (checkedNum === 0) {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]); 
        } else if (checkedNum === 1) {
          updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]); 
        } else {
          updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, false], [$btn4, false]); 
        }
      });

      $("#menu_i_tbody").on("change", "select.eval_level", function() {
        const achievement_id = $(this).closest("tr").attr("data-aid");
        const option_val = $(this).find("option:selected").text().trim();
        const eval_criteria = achievementArr.find(el => el.id == achievement_id)?.evaluation_criteria;
        const desc = eval_criteria.find(el => el.level_name == option_val)?.description;
    
        if ($(this).val() > achievementArr.length) {
          $(this).parent().next().find("textarea").removeAttr("disabled").val("").focus();
        } else {
          $(this).parent().next().find("textarea").attr("disabled", true).val(desc || "");
        }
      });

      if (!$("#menu_i_table button.toggleAllcheckboxes").hasClass('fa-square')) {
        $("#menu_i_table button.toggleAllcheckboxes").click();
      }
      studentsAchievementData = parseTableRowsToObjects();
    };
       
    const get_students_achievement_results = async () => {
      const class_val = $("#class").val();
      const class_id = classArr[classArr.findIndex(el => el[0] === class_val)][1];
      // const assessment_area_id = fieldArr[fieldArr.findIndex(el => el[0] === $("#field").val())][1];

      params = new URLSearchParams();
      params.append('class_id', class_id);
      params.append('subject_id', subjectId);
      
      try {
        const response = await fetch(`${_URL}/neis/get_students_achievement_results_by_subjectId/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, info } = res;
        console.log(message);
        // console.log(info);
        renderAchievementEvaluationTable(info);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    $grade.addEventListener('change', async (event) => {
      try {
        const response = await fetch(`${_URL}/neis/get_subjects_by_grade/${$grade.value}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { grade, subjects, subjectIds, classes } = res;
        classArr = classes;
        subject_ids = subjectIds;
        subjectArr = subjects.map((el, idx) => [el, subject_ids[idx]]);
        // console.log("classArr: ", classArr);
        // console.log("subjectIds: ", subject_ids);
        // console.log("subjectArr: ", subjectArr);
        populateSelectOptionsAndSetDisabled(classArr.map(el => el[0]), $class);
        populateSelectOptionsAndSetDisabled(subjects, $subject);
        $("#menu_i_tbody").html(renderEmptyTbodyWithMessage(9));
        resetBatchApplyBoxes();
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $class.addEventListener('change', () => {
      updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]);
      $("#menu_i_tbody").html(renderEmptyTbodyWithMessage(9));
      resetBatchApplyBoxes();
    })

    $subject.addEventListener('change', async (event) => {
      subjectId = subjectArr.filter(el => el[0] === $subject.value)?.flat()[1];
      // console.log("subjectId: ", subjectId);
      params = new URLSearchParams();
      params.append('grade', $grade.value);
      params.append('subject', $subject.value);

      try {
        const response = await fetch(`${_URL}/neis/get_fields_by_subject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { subject, fields } = res;
        if (fields.length > 1) {
          fields.shift();
        }
        fieldArr = fields.map(el => [el[0], el[2]]);
        // console.log(fieldArr);
        // populateSelectOptionsAndSetDisabled(fields.map(el => el[0]), $field, fields[0][0] == '-없음-' ? true : false);
        $("#menu_i_tbody").html(renderEmptyTbodyWithMessage(9));
        resetBatchApplyBoxes();
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $submitBtn.addEventListener('click', async (event) => { // 조회 버튼 클릭 시
      event.preventDefault();
      get_students_achievement_results();
      updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]);

      try {
        const response = await fetch(`${_URL}/neis/get_active_school_info/`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { school, year, semester } = res;
        params = new URLSearchParams();
        params.append('school', school);
        params.append('year', year);
        params.append('semester', semester);
    
        const url = `${_URL}/cloudstorage/directoryAllContents/?${params.toString()}`;
    
        const response_2 = await fetch(url, { method: 'GET' });
        if (!response_2.ok) {
          throw new Error(`Error: ${response_2.status}`);
        }
        if (response_2.status === 204) {
          console.log('No Content');
          return;
        }

        const res_2 = await response_2.json();
        // console.log(res_2.message);

        const directoryTree = res_2.message.map((item, idx) => {
          const isFile = item.includes('.');
          const num = item.split('/').length - 1; 
          const _path = item.split('/').pop();
          return {
            id: idx + 1,
            path: item,
            pathForDisplay: _path,
            subdirectoryDepth: num,
            type: isFile ? 'file' : 'directory',
            // type: 'directory',
            children: [],
          };
        });

        directoryTree.forEach((elem) => {
          const children = directoryTree.filter(item => 
            item.path.startsWith(`${elem.path}/`) && item.path !== elem.path
            && !item.path.split(`${elem.path}/`)[1].includes('/')
          );
          const children_ids = children.map(child => child.id);
          elem.children = children_ids;
        });

        directories = directoryTree;

        const html_for_toc = directoryTree
          // .filter(item => item.type === 'directory')
          .map(({ id, path, type, children, pathForDisplay, subdirectoryDepth }) => `
            <a href='#' data-id="${id}" data-subids="${JSON.stringify(children)}" class="list-group-item ${subdirectoryDepth > 5 ? 'invisible' : ''}">
              ${getStyledDirectoryName(pathForDisplay, subdirectoryDepth, path, type)}
            </a>
          `).join('');

        const $toc_modal = document.getElementById('toc_modal');   
        $toc_modal.innerHTML = html_for_toc;

        $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });

        if (!toc_modal_flag) {
          return
        }   
        
        $toc_modal.addEventListener('click', function(e) {
          e.preventDefault();
          $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });
          const elem = e.target.closest('.list-group-item');
          if (elem) {
            clickedElemId = elem.dataset.id;
            elem.querySelector('i').style.color = "#4078FF";
            elem.style.color = "#4078FF";
            elem.style.fontWeight = "bold";
            const subIds = JSON.parse(elem.dataset.subids);
            if (subIds.length > 0) {
              if (!elem.classList.contains('open')) {
                toggleFolderIcon(elem, true);
                elem.classList.add('open');
              } else {
                toggleFolderIcon(elem, false);
                elem.classList.remove('open');
              }
              displayTagsById(subIds, true);
              $("#toc_modal_confirm").removeClass("btn-primary").addClass("btn-secondary").addClass("disabled");
            } else {
              $("#toc_modal_confirm").removeClass("btn-secondary").addClass("btn-primary").removeClass("disabled");
            }
          }
        });
        toc_modal_flag = false;
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn2.addEventListener('click', async () => { // 저장 버튼 클릭 시
      const data = parseTableRowsToObjects();
      const isEqual = JSON.stringify(studentsAchievementData) === JSON.stringify(data);
      if (isEqual) {
        alert("변경된 내용이 없습니다.");
        return
      }

      if (!confirm("변경된 내용을 저장하시겠습니까?")) {
        return
      }

      try {
        const url = `${_URL}/neis/update_student_achievement_levels/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(`${res.message}: , created: ${res.created}, updated: ${res.updated}, total: ${res.total}`);
        alert("저장을 완료했습니다.");
        get_students_achievement_results();
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
    });    

    $btn3.addEventListener('click', () => { // 삭제 버튼 클릭 시 
      if ($("#menu_i_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        return;
      }

      if (!confirm("해당자료를 삭제하시겠습니까?\n등록 또는 수정된 항목은 반영되지 않으며 삭제처리만 반영됩니다.")) {
        return
      }

      $("#menu_i_tbody input:checked").each(function(idx, el) {
        $(el).closest("tr").find("td:nth-last-child(3) select").val("");
        $(el).closest("tr").find("td:nth-last-child(2) textarea").val("");
      });

      $("#menu_i_table button.toggleAllcheckboxes").click();
    });

    $btn4.addEventListener('click', async () => { // 출력 버튼 클릭 시
      if ($("#menu_i_tbody input:checked").length === 0) {
        alert('선택된 대상이 없습니다.');
        return;
      }

      let data = {};
      $("#menu_i_tbody input:checked").each(function() {    
        const student_id = $(this).closest("tr").attr("data-sid");
        const achievementIds = data[student_id] || [];
        data[student_id] = [...achievementIds, $(this).closest("tr").attr("data-aid")];
      });
      // console.log("data: ", data);

      try {
        const url = `${_URL}/neis/get_image_resource_paths_by_student_and_achievementIds_Obj/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, info } = res;
        console.log(message);
        // console.log(info);

        const result = Object.values(info) // 최상위 value들 (객체)
          .flatMap(obj => Object.values(obj)) // 각 객체의 value들 (배열)
          .flat(); // 배열들을 평탄화

        // console.log(result);

        if (result.length === 0) {
          alert("등록된 평가근거자료가 없습니다.");
          $("#menu_i_table button.toggleAllcheckboxes").click();
          return
        } 

        const images = result.map(el => `${_URL}/cloudstorage/view/${el}`);
        openFile(images[0], false, false, images);
        $("#menu_i_table button.toggleAllcheckboxes").click();
      } catch (error) {
        console.error('Error:', error);
      }  
    });

    const updateBtnsBasedOnSelection = () => {
      const checkedNum = $("#menu_i_tbody input:checked").length
      if (checkedNum === 0) {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, true], [$btn4, true]); 
      } else if (checkedNum === 1) {
        updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]); 
      } else {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, false], [$btn3, false], [$btn4, false]); 
      }
    }

    const sideEffect = () => {
      updateBtnsBasedOnSelection();
    };

    toggleAllTableCheckboxes('#menu_i_table', sideEffect);

    $("#toc_modal_confirm").on("click", async function () { // 모달창의 업로드 버튼 클릭 시
      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      const data = {
        'student_id': student_id, 
        'achievement_id': achievement_id,
        'resource_path': path,
        'ext': file_ext,
      }

      // console.log(data);
      try {
        const url = `${_URL}/neis/create_evaluation_evidence/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        // alert("저장을 완료했습니다.");
        $("#menu_i_tbody input:checked:first").closest("tr").find("td:last").text("O");
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
      $("#searchResourcesModal").modal('hide');
      $("button.toggleAllcheckboxes").click();
    });

    try {
      const response = await fetch(`${_URL}/neis/get_active_grades/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { year, semester, active_grades } = res;
      populateSelectOptionsAndSetDisabled(year, $year, true);
      populateSelectOptionsAndSetDisabled(semester, $semester, true);
      populateSelectOptionsAndSetDisabled(active_grades, $grade);
    } catch (error) {
      console.error('Error:', error);
    }

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(3)", function() {
      const path = $(this).text();
      const file_ext = path.split('.').pop().toLowerCase();
      const image_exts = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'tiff', 'webp'];
      const video_exts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'];
      const audio_exts = ['mp3', 'aac', 'm4a', 'ogg', 'wav', 'flac', 'webm'];
      const code_exts = ['html', 'css', 'js', 'py'];
      const office_exts = ['hwp', 'hwpx', 'pdf', 'ppt', 'pptx'];

      if (video_exts.includes(file_ext)) {
        openFile(path, true, false);
      } else if (audio_exts.includes(file_ext)) {
        openFile(path, false, true);  // 비디오 파일
      } else if (code_exts.includes(file_ext) || office_exts.includes(file_ext)) {
        openFile(path)
      } else if (image_exts.includes(file_ext)) {  
        openFile(path);
      } 
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(1)", async function() { // 삭제 아이콘 클릭 시
      if (confirm(`삭제하시겠습니까? 자료를 삭제해도 원격저장소에 저장된 원자료는 삭제되지 않습니다.`)) {
        try {
          const url = `${_URL}/neis/delete_evaluation_evidence_by_id/`;
          const data = {
            eid: $(this).closest("tr").attr("data-eid"),
          }
          const options = {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log("message: ", res.message);
          console.log("deleted_id: ", res.deleted_id);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").remove();
          if ($("#menu_g_modal_tbody tr").length === 0) {
            $("#menu_i_tbody input:checked").closest("tr").find("td:nth-last-child(1)").text("X");
          }
        } catch (error) {
          console.error('Error: ', error);
          alert("삭제 중 오류가 발생하였습니다.");
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(2)", async function() { // 양방향 화살표 아이콘 클릭 시
      if ($("#toc_modal_confirm").hasClass("disabled")) { return }

      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      
      const data = {
        eid: $(this).closest("tr").attr("data-eid"),
        resource_path: path,
        ext: file_ext,
      }

      if (confirm(`평가근거자료를 다음으로 수정하시겠습니까?: ${path}`)) {
        try {
          const url = `${_URL}/neis/update_evaluation_evidence_resource/`;
          const options = {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };

          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log(res.message);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").find("td:nth-child(3)").text(path);
        } catch (error) {
          console.error('Error:', error);
          alert(error);
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    const $searchResourcesModal = document.getElementById('searchResourcesModal');
    if ($searchResourcesModal) {
      $searchResourcesModal.addEventListener('show.bs.modal', async (event) => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $searchResourcesModal.querySelector('.modal-title')
        const modalBody = $searchResourcesModal.querySelector('.modal-body')
        
        let targetRow = $("#menu_i_tbody input:checked").closest("tr");
        let td_num = null;
        while(true) {
          td_num = targetRow.find("td").length;
          if (td_num != 9) {
            targetRow = targetRow.prev();
            continue;
          } 
          break;
        }
        
        const student_name = targetRow.find("td").eq(2).text();
        modalTitle.textContent = `${student_name}의 평가근거자료 선택`;

        student_id = $("#menu_i_tbody input:checked").closest("tr").attr("data-sid");
        achievement_id = $("#menu_i_tbody input:checked").closest("tr").attr("data-aid");

        params = new URLSearchParams();
        params.append('student_id', student_id);
        params.append('achievement_id', achievement_id);
        
        try {
          const response = await fetch(`${_URL}/neis/get_evaluation_evidence_by_student_and_achievement/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, info } = res;
          console.log(message);
          // console.log(info);
          const tableHtml = info.map(({evidence_id, resource_path, created_at}) => {
            return `
              <tr data-eid="${evidence_id}">
                <td><i class="fa-solid fa-trash"></i></td>
                <td><i class="fa-solid fa-right-left"></i></td>
                <td>${resource_path}</td>
                <td>${created_at}</td>
              </tr>
            `
          }).join('');
          $("#menu_g_modal_tbody").html(tableHtml);
        } catch (error) {
          console.error('Error:', error);
        }
      });
    }   
  }

  function renderSemesterSubjectFeedbackTable() {
    // 학생의 특정 교과에 대한 해당 학기의 종합의견을 기록 및 관리하는 테이블을 렌더링 --> MENU.J
    let html = null;
    html = `
    <div id="menu_j_content" class="col col-xl-12">
      <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
        <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="student_count">0</span></div>
        <div>
          <button id="btnJ1" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#strConversionModal" data-bs-whatever="{{ g.user.username }}">문자열바꾸기</button>
          <button id="btnJ2" type="button" class="btn btn-sm btn-secondary" disabled>교과평가일괄복사</button>
          <button id="btnJ3" type="button" class="btn btn-sm btn-secondary" disabled>저장</button>
          <button id="btnJ4" type="button" class="btn btn-sm btn-secondary" disabled>삭제</button>
        </div>
      </div>
      <div style="height: 77vh; overflow-y: auto;" class="d-flex">
        <table id="menu_j_table" class="table table-hover table-bordered">
          <thead>
            <tr>
              ${renderSelectAllCheckboxButton(2)}
              <th scope="col" style="width: 5%;">반/번호</th>
              <th scope="col" style="width: 11%;">성명</th>
              <th scope="col" style="width: 8%;">참고자료</th>
              <th scope="col" style="width: 74%;">학기말 종합의견</th>
            </tr>
          </thead>
          <tbody id="menu_j_tbody">
            ${renderEmptyTbodyWithMessage(5)}
          </tbody>
        </table>
      </div>
      <!-- 문자열바꾸기를 위한 모달창 -->
      <div class="modal fade" id="strConversionModal" tabindex="-1" aria-labelledby="strConversionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="strConversionModalLabel">문자열바꾸기</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="fieldForm">
                <div class="mb-3">
                  <label for="strInput" class="col-form-label"><i class="fa-solid fa-text-slash"></i>&nbsp;&nbsp;원래 문자열</label>
                  <input maxlength="100" id="strInput" name="strInput" class="form-control inputField" aria-label="Message" aria-describedby="send-button" autocomplete="off""></input> 
                </div>
                <div class="mb-3">
                  <label for="strOutput" class="col-form-label"><i class="fa-solid fa-t"></i>&nbsp;&nbsp;변환 문자열</label>
                  <input maxlength="100" id="strOutput" name="strOutput" class="form-control inputField" aria-label="Message" aria-describedby="send-button" autocomplete="off""></input> 
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" id="str_modal_confirm" class="btn btn-primary">바꾸기</button>
            </div>
          </div>
        </div>
      </div>  
      <!-- 조회/가져오기를 위한 모달창 -->
      <div class="modal fade" id="fetchGPTModal" tabindex="-1" aria-labelledby="fetchGPTModalLabel">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 80vw; width: 90%;">
          <div class="modal-content" style="height: 85vh;">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="fetchGPTModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column">
              <div class="table-header sticky-top bg-white p-0 mb-2 d-flex flex-row-reverse">
                <button id="btnJ8" class="btn btn-sm btn-secondary" disabled>복사(줄바꿈 없음)</button>
                <button id="btnJ7" class="btn btn-sm btn-secondary" disabled>복사</button>
                <button id="btnJ6" class="btn btn-sm btn-primary">초기화</button>
                <button id="btnJ5" class="btn btn-sm btn-secondary" disabled>ChatGPT</button>
                <button id="btnSpinner" class="btn btn-primary invisible" type="button" disabled>
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                  <span role="status">ChatGPT</span>
                </button>
              </div>
              <div class="flex-grow-1 d-flex flex-row" style="height: 65vh;">
                <div class="d-flex flex-column" style="width: 70%;">
                  <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-start align-items-center">
                    <div>
                      <span class="fw-semibold fs-6">관찰내용 </span>
                      <span class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total </span>
                      <span id="observation_record_count" class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">0</span>
                    </div>
                  </div>
                  <div style="padding: 0.5rem 0.5rem 0.5rem 0.5rem; margin-top: 0.2rem; background-color: #f3f4f8; width: 97.5%;" class="mb-2">
                    <span class="semi-bold" style="font-size: 0.8rem;">&emsp;영역&ensp;</span>
                    <select id="main_select" class="form-select form-select-sm select-width-lg"></select>
                    <select id="sub_select" class="form-select form-select-sm select-width-xl"></select>
                  </div>
                  <div style="display: flex; flex-direction: column; height: 40%; overflow-y: auto;">
                    <table id="menu_j_inner_table_1" class="table table-hover table-bordered" style="margin-top: 0; table-layout: fixed; width: 97.5%;">
                      <colgroup>
                        <col style="width: 4%;">   <!-- 선택 체크박스 열 -->
                        <col style="width: 13%;">  <!-- 일자 -->
                        <col style="width: 53%;">  <!-- 관찰내용 -->
                        <col style="width: 10%;">  <!-- 영역명 - 첫 번째 셀 -->
                        <col style="width: 20%;">  <!-- 영역명 - 두 번째 셀 -->
                      </colgroup>
                      <thead>
                        <tr>
                          ${renderSelectAllCheckboxButton(4)}
                          <th scope="col" style="width: 13%;">일자</th>
                          <th scope="col" style="width: 53%;">관찰내용</th>
                          <th scope="col" style="width: 30%;" colspan="2">영역명</th>
                        </tr>
                      </thead>
                      <tbody id="menu_j_inner_tbody_1">
                        ${renderEmptyTbodyWithMessage(6)}
                      </tbody>
                    </table>
                  </div>
                  <div class="table-header sticky-top bg-white p-0 mt-2 mb-2 d-flex justify-content-start align-items-center">
                    <div>
                      <span class="fw-semibold fs-6">교과평가 </span>
                      <span class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total </span>
                      <span id="evaluation_record_count" class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">0</span>
                    </div>
                  </div>
                  <div style="display: flex; flex-direction: column; height: 40%; overflow-y: auto;">
                    <table id="menu_j_inner_table_2" class="table table-hover table-bordered" style="margin-top: 0; table-layout: fixed; width: 97.5%;">
                      <colgroup>
                        <col style="width: 4%;">   <!-- 선택 체크박스 열 -->
                        <col style="width: 17%;">  <!-- 영역명 -->
                        <col style="width: 30%;">  <!-- 성취기준 -->
                        <col style="width: 10%;">  <!-- 평가기준 - 첫 번째 셀 -->
                        <col style="width: 39%;">  <!-- 평가기준 - 두 번째 셀 -->
                      </colgroup>
                      <thead>
                        <tr>
                          ${renderSelectAllCheckboxButton(4)}
                          <th scope="col" style="width: 15%;">영역명</th>
                          <th scope="col" style="width: 30%;">성취기준</th>
                          <th scope="col" style="width: 51%;" colspan="2">평가기준</th>
                        </tr>
                      </thead>
                      <tbody id="menu_j_inner_tbody_2">
                        ${renderEmptyTbodyWithMessage(6)}
                      </tbody>
                    </table>
                  </div>  
                </div>
                <div class="d-flex flex-column" style="width: 30%;">
                  <div class="fs-6 fw-semibold mb-2"><span id="summary_info"></span><span>학기말 종합의견</span></div>
                  <div id="semesterReport" style="border: 1px solid #6D757D; border-radius: 5px;" class="flex-grow-1"></div>
                  <div class="d-flex justify-content-end" style="font-size: 0.8rem;"><span id="chars_length"></span><span>/4000</span></div>
                </div>
              </div>
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" id="gpt_modal_confirm" class="btn btn-primary">반영</button>
              <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">닫기</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    `;
    return html;
  }

  async function script_renderSemesterSubjectFeedbackTable() {
    let params = null;
    let achievementArr = [];
    let evaluationArr = [];
    let fieldArr = [];
    let classArr = [];
    let studentId = null;
    let subjectId = null;
    let summaryId = null;
    let subjectName = null;
    let currentSemester = null;
    let main_select_val = null;
    let sub_select_val = null;
    let isEmpty = true;
    let ChatGPT = false;
    let combinedStr = null;
    let observation_id = null;
    let gptInfo = null;
    const gpt_title = 'NEIS 학기말종합의견 작성 도우미';
    const $submitBtn = document.getElementById('submitBtn');
    const $year = document.getElementById('year');
    const $semester = document.getElementById('semester');
    const $grade = document.getElementById('grade');
    const $class = document.getElementById('class');
    const $subject = document.getElementById('subject');
    const $btn1 = document.getElementById('btnJ1'); // 문자열바꾸기 버튼
    const $btn2 = document.getElementById('btnJ2'); // 교과평가일괄복사 버튼
    const $btn3 = document.getElementById('btnJ3'); // 저장 버튼
    const $btn4 = document.getElementById('btnJ4'); // 삭제 버튼
    const $btn5 = document.getElementById('btnJ5'); // ChatGPT 버튼
    const $btn6 = document.getElementById('btnJ6'); // 초기화 버튼
    const $btn7 = document.getElementById('btnJ7'); // 복사 버튼
    const $btn8 = document.getElementById('btnJ8'); // 복사(줄바꿈 없음) 버튼
    const $btn9 = document.getElementById('gpt_modal_confirm'); // 반영 버튼

    const updateBtnsBasedOnSelection = () => {
      const $checked = $("#menu_j_tbody input:checked");
      if ($checked.length === 0) {
        updateButtonStatesWithStyles([$btn1, true], [$btn2, true], [$btn3, false], [$btn4, true]); 
      } else {
        updateButtonStatesWithStyles([$btn1, false], [$btn2, false], [$btn3, false], [$btn4, false]);
      } 
    }

    const updateInnerBtnsBasedOnSelection = () => {
      const $checked_1 = $("#menu_j_inner_tbody_1 input:checked"); // 관찰내용 
      const $checked_2 = $("#menu_j_inner_tbody_2 input:checked"); // 교과평가
      if ($checked_1.length > 2) {
        updateButtonStatesWithStyles([$btn5, false], [$btn7, false], [$btn8, false]); 
      } else if ($checked_1.length + $checked_2.length > 0) {
        updateButtonStatesWithStyles([$btn5, true], [$btn7, false], [$btn8, false]);
      } else {
        updateButtonStatesWithStyles([$btn5, true], [$btn7, true], [$btn8, true]);
      }
    }

    const countChars = () => {
      const length = $("#semesterReport textarea").val().trim().length;
      $("#chars_length").text(length);
    }

    const getCombinedStr = () => {
      const combined_str_1 = $("#menu_j_inner_tbody_1 input:checked").closest("tr").find("td:nth-child(3) > p").map(function() {
        return $(this).text();
      }).get().join(' ');

      const combined_str_2 = $("#menu_j_inner_tbody_2 input:checked").closest("tr").find("td:nth-child(5) p").map(function() {
        return $(this).text();
      }).get().join(' ');

      return [combined_str_1, combined_str_2].join(' ').trim();
    }

    const combineStr = (char) => {
      const combined_str_1 = $("#menu_j_inner_tbody_1 input:checked").closest("tr").find("td:nth-child(3) > p").map(function() {
        return $(this).text();
      }).get().join(char);

      const combined_str_2 = $("#menu_j_inner_tbody_2 input:checked").closest("tr").find("td:nth-child(5) p").map(function() {
        return $(this).text();
      }).get().join(char);

      const val = $("#semesterReport textarea").val();
      $("#semesterReport textarea").val([val, combined_str_1, combined_str_2].join(char).trim());
      countChars();

      if (!$("#menu_j_inner_table_1 button.toggleAllcheckboxes").hasClass('fa-square')) {
        $("#menu_j_inner_table_1 button.toggleAllcheckboxes").click();
      }

      if (!$("#menu_j_inner_table_2 button.toggleAllcheckboxes").hasClass('fa-square')) {
        $("#menu_j_inner_table_2 button.toggleAllcheckboxes").click();
      }
    }

    const renderSubjectObservationsTable = (student_info) => {
      const _height = '2';
      const table_html = student_info.map(({ aid, category, created_at, desc, oid }) => {
        const td_4th_html = `
          <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
            <span style="font-size: 0.75rem; padding: 0px; margin: 0 auto;">${category}</span>  
          </div>
        `;

        const td_5th_html = category === '평가내용' ? `
          ${fieldArr.filter(el => el[0] == aid).map(el => `
            <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
              <span style="font-size: 0.75rem; padding: 0px; margin: 0 auto;">${el[1]}</span>`).join('')}
            </div>
        ` : `
            <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
              <span style="font-size: 0.75rem; padding: 0px; margin: 0 auto;"></span>  
            </div>
        `;

        const rowHtml = `
          <tr data-id="${oid}">
            <td scope="col" class="text-center">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
              </div>
            </td>
            <td scope="col">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <span style="font-size: 0.75rem; padding: 0px; margin: 0 auto;">${created_at}</span>  
              </div>
            </td>
            <td scope="col">
              <p style="width: 100%; height: ${_height}rem; line-height: 1rem; overflow: hidden; padding: 0px; margin: 0 auto;">${desc}</p>              
            </td>
            <td scope="col">
              ${td_4th_html}
            </td>
            <td scope="col">
              ${td_5th_html}
            </td>
          </tr>
        `;

        return rowHtml;
      }).join('');;
      $("#menu_j_inner_tbody_1").html(table_html);
    }

    const renderSubjectEvaluationResultTable = (result_info) => {
      const _height = '2';
      const table_html = result_info.map(({ area_id, criterion, description, level }) => {
        const rowHtml = `
          <tr>
            <td scope="col" class="text-center">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
              </div>
            <td scope="col">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <span style="font-size: 0.75rem; padding: 0px; margin: 0 auto;">${fieldArr.filter(el => el[0] == area_id)[0][1]}</span>  
              </div>
            </td>
            <td scope="col">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <p style="width: 100%; height: ${_height}rem; line-height: 1rem; overflow: hidden; padding: 0px; margin: 0 auto;">${criterion}</p>              
              </div>
            </td>
            <td scope="col">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <span style="font-size: 0.75rem; padding: 0px; margin: 0 auto;">${level}</span>  
              </div>
            </td>
            <td scope="col">
              <div style="display: flex; align-items: center; justify-content: center; height: ${_height}rem; width: 100%; border: none;">
                <p style="width: 100%; height: ${_height}rem; line-height: 1rem; overflow: hidden; padding: 0px; margin: 0 auto;">${description}</p>  
              </div>
            </td>
          </tr>
        `;
        return rowHtml;
      }).join('');;
      $("#menu_j_inner_tbody_2").html(table_html);
    }

    $grade.addEventListener('change', async (event) => {
      try {
        const response = await fetch(`${_URL}/neis/get_subjects_by_grade/${$grade.value}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { grade, subjects, classes } = res;
        classArr = classes;
        // console.log(classArr);
        populateSelectOptionsAndSetDisabled(classArr.map(el => el[0]), $class);
        populateSelectOptionsAndSetDisabled(subjects, $subject);
        $("#menu_j_tbody").html(renderEmptyTbodyWithMessage(5));
        $("#student_count").text("0");
        updateButtonStatesWithStyles(
          [$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]
        );
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $class.addEventListener('change', () => {
      $("#menu_j_tbody").html(renderEmptyTbodyWithMessage(5));
      $("#student_count").text("0");
      // $("#menu_n_table_2").css({ "flex-grow" : 1 });
      updateButtonStatesWithStyles(
        [$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]
      );
    })

    $subject.addEventListener('change', () => {
      $("#menu_j_tbody").html(renderEmptyTbodyWithMessage(5));
      $("#student_count").text("0");
      // $("#menu_n_table_2").css({ "flex-grow" : 1 });
      updateButtonStatesWithStyles(
        [$btn1, true], [$btn2, true], [$btn3, true], [$btn4, true]
      );
    });

    $submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      params = new URLSearchParams();
      params.append('grade', $("#grade").val());
      params.append('class', $("#class").val());
      params.append('subject', $("#subject").val());
      
      try {
        const response = await fetch(`${_URL}/neis/get_students_semester_summary_by_class_and_subject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, student_info, subject_id, areaIds } = res;
        // console.log(message);
        // console.log(student_info);
        // console.log(subject_id);
        // console.log(areaIds);
        subjectId = subject_id;
        subjectName = $("#subject").val();
        evaluationArr = areaIds;
        
        const tableHtml = student_info.map(({student_id, student_name, summary_id, summary_desc }, idx) => {
          return `
            <tr data-id="${summary_id}" data-sid="${student_id}">
              <td class="text-center">
                <div style="display: flex; align-items: center; justify-content: center; height: 5.9rem; width: 100%; border: 0px solid #ffffff;">
                  <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
                </div>
              </td>
              <td class="text-center text-decoration-underline">
                <div style="display: flex; align-items: center; justify-content: center; height: 5.9rem; width: 100%; border: 0px solid #ffffff;">
                  <span>
                     ${idx + 1}
                  </span>
                </div>
              </td>
              <td>
                <div style="display: flex; align-items: center; height: 5.9rem; width: 100%; border: 0px solid #ffffff;">
                  <span>
                    ${student_name}
                  </span>
                </div>
              </td>
              <td style="padding: 0.5rem 0.3rem 0.5rem 0rem;">
                <div style="display: flex; align-items: center; justify-content: center; height: 5.9rem; width: 100%; border: 0px solid #ffffff;">
                  <button type="button" class="btn btn-sm btn-primary summary" data-bs-toggle="modal" data-bs-target="#fetchGPTModal" data-bs-whatever="{{ g.user.username }}">조회/가져오기</button>
                </div>
              </td>
              <td>
                <textarea rows="5" maxlength="4000" style="background-color: #ffffff; width: 100%; height: 5.9rem; overflow: auto; resize: none;" spellcheck="false">${summary_desc || ''}</textarea>
              </td>
            </tr>
          `
        }).join('');
        $("#menu_j_tbody").html(tableHtml);
        $("#student_count").text($("#menu_j_tbody tr").length);
        $("#menu_j_tbody").on("change", "td:nth-child(1)", function() {
          updateBtnsBasedOnSelection();
        })
        updateBtnsBasedOnSelection();
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $("#str_modal_confirm").on("click", function () { // 문자열바꾸기 모달창의 '바꾸기' 버튼 클릭 시
      const strInput = $("#strInput").val();
      const strOutput = $("#strOutput").val();
      if (strInput === '') {
        alert("원래 문자열 항목은 필수입니다.");
        return;
      }

      // 특수문자 등 정규식 안전 처리
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]<span>\</span>]/g, '<span>\</span>$&amp;');
      }

      let total_replacements = 0;

      $("#menu_j_tbody input:checked").each(function() {
        const $textarea = $(this).closest("tr").find("td:nth-child(5) textarea");
        const target_str = $textarea.val();

        // strInput이 여러 번 나올 수 있으니 교체 횟수 집계
        const regex = new RegExp(escapeRegExp(strInput), 'g'); // 대소문자 구분, 원하면 'gi'
        const matches = target_str.match(regex);

        if (matches) {
          total_replacements += matches.length;
          $textarea.val(target_str.replace(regex, strOutput));
        }
      });

      // 처리 결과 알림
      alert("총 " + total_replacements + "개의 항목이 변경되었습니다.");

      $("#strConversionModal").modal('hide');
      $("#strInput").val('');
      $("#strOutput").val('');
      $("#menu_j_table button.toggleAllcheckboxes").click();
    });

    $btn2.addEventListener("click", async () => { // 교과평가일괄복사 클릭 시
      const params = new URLSearchParams();
      const studentIds = $("#menu_j_tbody input:checked").closest("tr").map(function() {
        return $(this).attr("data-sid");
      }).get();

      // console.log(studentIds);
      // console.log(evaluationArr);
      params.append('student_ids', studentIds.join(','));  // ← 핵심: 쉼표 구분
      params.append('evaluation_ids', evaluationArr.join(',')); // ← 핵심: 쉼표 구분

      try {
        const response = await fetch(`${_URL}/neis/getAssessmentResultsByStudentIdsAndAreaIds/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, result } = res;
        console.log(message);
        // console.log(result);

        Object.keys(result).forEach(el => {
          const targetId = el;
          const description = result[el];
          const targetEl = $(`#menu_j_tbody tr[data-id="${targetId}"]`).find("td:nth-child(5) textarea");
          targetEl.val(targetEl.val().concat(description));
        }); 

        $("#menu_j_table button.toggleAllcheckboxes").click();
        alert("교과평가 일괄복사가 완료되었습니다.");
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $btn3.addEventListener("click", async () => { // 저장 버튼 클릭 시
      const data = $("#menu_j_tbody tr").map(function () {
        return {
          id: parseInt($(this).attr("data-id")) || 0,
          sid: parseInt($(this).attr("data-sid")) || 0,
          desc: $(this).find("td:nth-child(5)").find("textarea").val().trim(),
        };
      }).get();

      const params = new URLSearchParams();
      params.append('grade_subject_id', subjectId);
      // console.log(data);

      try {
        const url = `${_URL}/neis/upsert_semester_summary_by_student_and_subject/?${params.toString()}`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData?.error || `서버 오류: ${response.status}`);
        }

        const res = await response.json();
        console.log(res.message);
        $("#submitBtn").click();
        alert("학기말종합의견의 저장이 완료되었습니다.");
      } catch (error) {
        console.error('Error:', error);
        alert(`오류 발생: ${error.message}`);
      }
    });

    $btn4.addEventListener("click", () => { // 삭제 버튼 클릭 시
      $("#menu_j_tbody input:checked").closest("tr").find("td:nth-child(5) textarea").val('');
      $("#menu_j_table button.toggleAllcheckboxes").click();
    });

    $btn5.addEventListener("click", async () => { // ChatGPT 버튼 클릭 시
      $("#btnJ5").toggleClass("invisible");
      $("#btnSpinner").toggleClass("invisible");
      
      try {
        const response = await fetch(`${_URL}/textgpt/get_subject_info_by_title/${gpt_title}`, {
          method: 'GET',
        });
        if (!response.ok) throw new Error(`서버 오류: ${response.status}`);

        const res = await response.json();
        gptInfo = res.info;
        const { subject_id, system, model, range } = gptInfo;
        // console.log(res.info);
        combinedStr = getCombinedStr();

        const question = {
          'model': model,
          'system': system,
          'content': combinedStr,
          'range': range,
          'images': [],
          'subject_id': subject_id,
        };

        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(question),
        };

        const response2 = await fetch(_URL + '/textgpt/question/', options);
        
        if(!response2.ok){
          throw new Error(response2.status);
        }

        const answer = await response2.json();
        ChatGPT = true;
        
        const val = $("#semesterReport textarea").val();
        $("#semesterReport textarea").val([val, answer.response].join('\n').trim());
        countChars();

        $("#btnJ5").toggleClass("invisible");
        $("#btnSpinner").toggleClass("invisible");

        if (!$("#menu_j_inner_table_1 button.toggleAllcheckboxes").hasClass('fa-square')) {
          $("#menu_j_inner_table_1 button.toggleAllcheckboxes").click();
        }

        if (!$("#menu_j_inner_table_2 button.toggleAllcheckboxes").hasClass('fa-square')) {
          $("#menu_j_inner_table_2 button.toggleAllcheckboxes").click();
        }
      } catch (error) {
        console.error("Error:", error);
      }
    });

    $btn6.addEventListener("click", () => { // 초기화 버튼 클릭 시
      $("#semesterReport textarea").val("");
      $("#chars_length").text("0");
    });

    $btn7.addEventListener("click", () => { // 복사 버튼 클릭 시
      combineStr('\n');
    });

    $btn8.addEventListener("click", () => { // 복사(줄바꿈 없음) 버튼 클릭 시
      combineStr(' ');
    });

    $btn9.addEventListener("click", async () => { // 반영 버튼 클릭 시
      const data = [
        {
          id: parseInt(summaryId) || 0,
          sid: parseInt(studentId) || 0,
          desc: $("#semesterReport textarea").val().trim(),
        }
      ];

      const params = new URLSearchParams();
      params.append('grade_subject_id', subjectId);
      // console.log(data);

      try {
        const url = `${_URL}/neis/upsert_semester_summary_by_student_and_subject/?${params.toString()}`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData?.error || `서버 오류: ${response.status}`);
        }

        const res = await response.json();
        console.log(res.message);
        $("#fetchGPTModal").modal('hide');
        $("#submitBtn").click();
        alert("학기말종합의견의 저장이 완료되었습니다.");
      } catch (error) {
        console.error('Error:', error);
        alert(`오류 발생: ${error.message}`);
      }

      if (ChatGPT) {
        try {
          const latestContents = [
            {
              author: 'user',
              desc: combinedStr,
              imgUrl: [],
            },
            {
              author: 'assistant',
              desc: $("#semesterReport textarea").val().trim(),
              imgUrl: [],
            }
          ]

          const { subject_id, system, model, range } = gptInfo;
          const _body = {
            "subject": gpt_title, // 여기서는 문자열을 기대하고 있음.
            "model": model,
            "range": range, 
            "system": system,
            "images": [], 
            "content": latestContents,
          };
          const options = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(_body),
          };
          const response = await fetch(_URL + '/textgpt/upload/', options);
          if(!response.ok){
            throw new Error(response.status);
          }
          const { message, msgIds, subjectId } = await response.json();
          // console.log(message);
          // console.log(msgIds);
          // console.log(subjectId);
        } catch(error) {
          console.error('Error: ', error);
        }
      }
    });
    
    async function handleSelectChange() {
      main_select_val = $("#main_select option:selected").val();
      sub_select_val = $("#sub_select option:selected").val();

      if (main_select_val === '평가내용') {
        $("#sub_select").prop("disabled", false);
        sub_select_val = sub_select_val === '전체' ? 0 : sub_select_val;
      } else {
        $("#sub_select")
          .val($("#sub_select option:first").val())
          .prop("disabled", true);
        sub_select_val = 0;   
      }

      const params = new URLSearchParams();
      params.append('student_id', studentId);
      params.append('grade_subject_id', subjectId);
      params.append('main_select', main_select_val);
      params.append('sub_select', sub_select_val);
      
      try {
        const response = await fetch(`${_URL}/neis/getStudentObservationsBySubject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) throw new Error(`서버 오류: ${response.status}`);

        const res = await response.json();
        // console.log(res.observation_info);

        if (res.observation_info.length === 0) {
          $("#menu_j_inner_tbody_1").html(renderEmptyTbodyWithMessage(6, "조회된 데이터가 없습니다."));
          $("#menu_j_inner_table_1").css({ "flex-grow" : 1 });
        } else {
          // 여기에 데이터 렌더링 로직 추가 가능
          renderSubjectObservationsTable(res.observation_info);
          $("#menu_j_inner_table_1").css({ "flex-grow" : 0 });
        }

        $("#menu_j_inner_table_1 button.toggleAllcheckboxes").prop("checked", false);
      } catch (error) {
        console.error("Error:", error);
      }
    }

    const $fetchGPTModal = document.getElementById('fetchGPTModal');
    if ($fetchGPTModal) {
      $fetchGPTModal.addEventListener('show.bs.modal', async (event) => {
        // Button that triggered the modal
        const $button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = $button.getAttribute('data-bs-whatever')
        const modalTitle = $fetchGPTModal.querySelector('.modal-title')
        const modalBody = $fetchGPTModal.querySelector('.modal-body')
        modalTitle.textContent = '참고자료조회';
        
        const student_name = $button.closest('tr').querySelector('td:nth-child(3) > div').textContent;
        const report_text = $button.closest('tr').querySelector('td:nth-child(5) > textarea').value;
        studentId = $button.closest('tr').getAttribute('data-sid');
        summaryId = $button.closest('tr').getAttribute('data-id');
        ChatGPT = false;
        combinedStr = null;

        if ($("#btnJ5").hasClass("invisible")) {
          $("#btnJ5").toggleClass("invisible");
          $("#btnSpinner").toggleClass("invisible");
        }
        // console.log(studentId);
        $("#summary_info").text(`${student_name} ${subjectName} ${currentSemester}`);

        params = new URLSearchParams();
        params.append('grade', $("#grade").val());
        params.append('class', $("#class").val());
        params.append('subject', $("#subject").val());
        
        try {
          const response = await fetch(`${_URL}/neis/get_grade_class_students_assessment_areas_and_subject_id/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { fields_info } = res;
          // console.log(fields_info);
          fieldArr = fields_info;
        } catch (error) {
          console.error('Error:', error);
        }

        params = new URLSearchParams();
        params.append('student_id', studentId);
        params.append('grade_subject_id', subjectId);
        params.append('main_select', '전체');
        params.append('sub_select', 0);
        
        try {
          const response = await fetch(`${_URL}/neis/getStudentObservationsBySubject/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          // console.log(res.observation_info);

          // updateButtonStatesWithStyles(
          //   [$btn1, false], [$btn2, true], [$btn3, true], 
          //   [$btn4, true], [$btn5, false], [$btn6, true]
          // );
          const main_select_html = `
            <option value="전체">전체</option>
            <option value="미선택">미선택</option>
            <option value="수업내용">수업내용</option>
            <option value="평가내용">평가내용</option>
          `;
          const sub_select_html = fieldArr.map(
            el => `<option value="${el[0]}">${el[1]}</option>`
          ).join('');
          
          $("#main_select").html(main_select_html).attr("disabled", false);
          $("#sub_select").html('<option value="전체">전체</option>'.concat(sub_select_html));

          // console.log(res.observation_info);
          
          if (res.observation_info.length === 0) {
            $("#menu_j_inner_tbody_1").html(renderEmptyTbodyWithMessage(5, "조회된 데이터가 없습니다."));
            $("#menu_j_inner_table_1").css({ "flex-grow" : 1 });
            $("#observation_record_count").text("0");
            // isEmpty = true;
          } else {
            renderSubjectObservationsTable(res.observation_info);
            $("#menu_j_inner_table_1").css({ "flex-grow" : 0 });
            // isEmpty = false;
            $("#observation_record_count").text($("#menu_j_inner_tbody_1 tr").length);
          }

          $("#main_select, #sub_select").on("change", handleSelectChange);
          toggleAllTableCheckboxes('#menu_j_inner_table_1');

        } catch (error) {
          console.error('Error:', error);
        }

        params = new URLSearchParams();
        params.append('student_id', studentId);
        params.append('area_ids', fieldArr.map(el => el[0]).join(','));  // ← 핵심: 쉼표 구분
        
        try {
          const response = await fetch(`${_URL}/neis/get_student_assessment_results_by_areaIds/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const { message, result } = await response.json();
          // console.log(message);
          // console.log(result);

          if (result.length === 0) {
            $("#menu_j_inner_tbody_2").html(renderEmptyTbodyWithMessage(5, "조회된 데이터가 없습니다."));
            $("#menu_j_inner_table_2").css({ "flex-grow" : 1 });
            $("#evaluation_record_count").text("0");
            // isEmpty = true;
          } else {
            renderSubjectEvaluationResultTable(result);
            $("#menu_j_inner_table_2").css({ "flex-grow" : 0 });
            // isEmpty = false;
            $("#evaluation_record_count").text($("#menu_j_inner_tbody_2 tr").length);
          }
          
          toggleAllTableCheckboxes('#menu_j_inner_table_2');
        } catch (error) {
          console.error('Error:', error);
        }

        $("#semesterReport").html(`<textarea maxlength="4000" style="background-color: #ffffff; font-size: 0.85rem; width: 100%; height: 60vh; overflow: auto; resize: none; border: 0px solid #ffffff;" spellcheck="false">${report_text}</textarea>`);
        countChars();
        $("#semesterReport textarea").on("input", countChars);
        
        $("#menu_j_inner_tbody_1").on("click", "td:nth-child(1)", updateInnerBtnsBasedOnSelection);
        $("#menu_j_inner_tbody_2").on("click", "td:nth-child(1)", updateInnerBtnsBasedOnSelection);
        toggleAllTableCheckboxes('#menu_j_inner_table_1', updateInnerBtnsBasedOnSelection);
        toggleAllTableCheckboxes('#menu_j_inner_table_2', updateInnerBtnsBasedOnSelection);
      });
    }

    const sideEffect = () => {
      updateBtnsBasedOnSelection();
    };

    toggleAllTableCheckboxes('#menu_j_table', sideEffect);

    try {
      const response = await fetch(`${_URL}/neis/get_active_grades/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { year, semester, active_grades } = res;
      currentSemester = semester;
      populateSelectOptionsAndSetDisabled(year, $year, true);
      populateSelectOptionsAndSetDisabled(semester, $semester, true);
      populateSelectOptionsAndSetDisabled(active_grades, $grade);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  function renderAnnualSubjectProgressTable() {
    // 학생의 특정 교과에 대한 한 해동안의 발달상황을 기록하고 관리하는 테이블을 렌더링 --> MENU.K
    let html = null;
    html = `
      <div id="menu_k_content">
        <div id="menu_k_content_left" class="col-12 col-xl-3">
          <div class="table-banner">
            <button type="button" class="btn btn-sm btn-secondary">일괄저장</button>
            <button type="button" class="btn btn-sm btn-secondary">일괄삭제</button>
          </div>
          <table id="menu_k_table_1" class="table table-hover caption-top table-bordered">
            <caption class="table_caption">Total <span>0</span></caption>
            <thead>
              <tr>
                <th scope="col" style="width: 40%;">번호</th>
                <th scope="col" style="width: 60%;">성명</th>
              </tr>
            </thead>
            <tbody id="menu_k_tbody_1">
              ${renderEmptyTbodyWithMessage(2)}
            </tbody>
          </table>
        </div>
        <div id="menu_k_content_right" class="col-12 col-xl-9">
          <div class="table-banner">
          </div>
          <table id="menu_k_table_2" class="table table-hover caption-top table-bordered">
            <caption class="table_caption mt-1 mb-1" style="padding: 5px 0px 5px 0px;">
            </caption>
            <thead>
            </thead>
            <tbody id="menu_k_tbody_2">
            </tbody>
          </table>
        </div>
      </div>
      `;
    return html;
  }

  function renderClassSubjectGradesTable() {
    // 특정 학급 학생들 전체의 교과별 성적을 조회하는 테이블을 렌더링 --> MENU.L
    return ``;
  }

  function renderStudentGradesTable() {
    // 학급 명단에서 학생 이름을 클릭함으로써 특정 학생의 개인별 성적을 조회하는 테이블을 렌더링 --> MENU.M
    let html = null;
    html = `
      <div id="menu_m_content">
        <div id="menu_m_content_left" class="col-12 col-xl-3">
          <div class="table-banner">
            <button type="button" class="btn btn-sm btn-secondary">일괄출력</button>
          </div>
          <table id="menu_m_table_1" class="table table-hover caption-top table-bordered">
            <caption class="table_caption">Total <span>0</span></caption>
            <thead>
              <tr>
                ${renderSelectAllCheckboxButton(10)}
                <th scope="col" style="width: 30%;">번호</th>
                <th scope="col" style="width: 60%;">성명</th>
              </tr>
            </thead>
            <tbody id="menu_m_tbody_1">
              ${renderEmptyTbodyWithMessage(3)}
            </tbody>
          </table>
        </div>
        <div id="menu_m_content_right" class="col-12 col-xl-9">
        </div>
      </div>
      `;
    return html;
  }

  function renderStudentObservationsTable() {
    // 학생에 대한 관찰내용을 일자별로 기록 및 관리하는 테이블을 렌더링 --> MENU.N
    let html = null;
    html = `
      <div id="menu_n_content">
        <div id="menu_n_content_left" class="col-12 col-xl-2">
          <div class="table-header sticky-top bg-white p-0 mt-1 mb-2 d-flex justify-content-between align-items-center">
            <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="student_count">0</span></div>
            <button id="btnN7" type="button" class="btn btn-sm btn-secondary" disabled>출력</button>
          </div>
          <div style="display: flex; flex-direction: column; height: 77vh; overflow-y: auto;">
            <table id="menu_n_table_1" class="table table-hover table-bordered" style="margin-top: 0;">
              <thead>
                <tr>
                  ${renderSelectAllCheckboxButton(10)}
                  <th scope="col" style="width: 25%;">반/번호</th>
                  <th scope="col" style="width: 65%;">성명</th>
                </tr>
              </thead>
              <tbody id="menu_n_tbody_1">
                ${renderEmptyTbodyWithMessage(3)}
              </tbody>
            </table>
          </div>
        </div>
        <div id="menu_n_content_right" class="col-12 col-xl-10">
          <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
            <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;">Total <span id="record_count">0</span></div>
            <div id="menu_n_btns">
              <button id="btnN1" type="button" class="btn btn-sm btn-secondary" disabled>행추가</button>
              <button id="btnN2" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#searchResourcesModal" data-bs-whatever="{{ g.user.username }}">관찰근거자료</button>
              <button id="btnN3" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#strConversionModal" data-bs-whatever="{{ g.user.username }}">문자열바꾸기</button>
              <button id="btnN4" type="button" class="btn btn-sm btn-secondary" disabled data-bs-toggle="modal" data-bs-target="#batchInputModal" data-bs-whatever="{{ g.user.username }}">일괄입력</button>
              <button id="btnN5" type="button" class="btn btn-sm btn-secondary" disabled>저장</button>
              <button id="btnN6" type="button" class="btn btn-sm btn-secondary" disabled>삭제</button>
            </div>
          </div>
          <div style="padding: 0.5rem 0.5rem 0.5rem 0.5rem; margin-top: 0.2rem; background-color: #f3f4f8;">
            <span class="semi-bold" style="font-size: 0.8rem;">&emsp;영역&ensp;</span>
            <select id="main_select" class="form-select form-select-sm select-width-lg"></select>
            <select id="sub_select" class="form-select form-select-sm select-width-lg"></select>
          </div>
          <div style="display: flex; flex-direction: column; height: 72.2vh; overflow-y: auto;">
            <table id="menu_n_table_2" class="table table-hover table-bordered" style="margin-top: 0; table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  ${renderSelectAllCheckboxButton(3)}
                  <th scope="col" style="width: 12%;">일자</th>
                  <th scope="col" style="width: 50%;">내용</th>
                  <th scope="col" style="width: 28%;" colspan="2">영역</th>
                  <th scope="col" style="width: 7%;">관찰근거자료</th>
                </tr>
              </thead>
              <tbody id="menu_n_tbody_2">
                ${renderEmptyTbodyWithMessage(6)}
              </tbody>
            </table>
          </div> 
        </div>
        <!-- 문자열바꾸기를 위한 모달창 -->
        <div class="modal fade" id="strConversionModal" tabindex="-1" aria-labelledby="strConversionModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="strConversionModalLabel">문자열바꾸기</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="fieldForm">
                  <div class="mb-3">
                    <label for="strInput" class="col-form-label"><i class="fa-solid fa-text-slash"></i>&nbsp;&nbsp;원래 문자열</label>
                    <input maxlength="100" id="strInput" name="strInput" class="form-control inputField" aria-label="Message" aria-describedby="send-button" autocomplete="off""></input> 
                  </div>
                  <div class="mb-3">
                    <label for="strOutput" class="col-form-label"><i class="fa-solid fa-t"></i>&nbsp;&nbsp;변환 문자열</label>
                    <input maxlength="100" id="strOutput" name="strOutput" class="form-control inputField" aria-label="Message" aria-describedby="send-button" autocomplete="off""></input> 
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" id="str_modal_confirm" class="btn btn-primary">바꾸기</button>
              </div>
            </div>
          </div>
        </div>
        <!-- 관찰근거자료 선택을 위한 모달창 -->
        ${html_searchResourcesModal()}
        <!-- 일괄입력을 위한 모달창 -->
        <div class="modal fade" id="batchInputModal" tabindex="-1" aria-labelledby="batchInputModalLabel">
          <div class="modal-dialog modal-dialog-centered" style="max-width: 60vw; width: 90%;">
            <div class="modal-content" style="height: 80vh;">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="batchInputModalLabel"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div id="menu_n_inner_content" class="col-12 col-xl-12">
                  <div class="table-header sticky-top bg-white p-0 mb-2 d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="font-size: 0.75rem; color: #536D89;"><span id="inner_subject"></span> Total <span id="inner_record_count">0</span></div>
                    <div id="menu_n_btns">
                      <button id="btnNi1" type="button" class="btn btn-sm btn-primary">행추가</button>
                      <button id="btnNi2" type="button" class="btn btn-sm btn-secondary" disabled>행삭제</button>
                    </div>
                  </div>
                  <div style="display: flex; flex-direction: column; height: 60vh; overflow-y: auto;">
                  <table id="menu_n_inner_table" class="table table-hover table-bordered" style="margin-top: 0; table-layout: fixed; width: 100%;">
                    <thead>
                      <tr>
                        ${renderSelectAllCheckboxButton(4)}
                        <th scope="col" style="width: 14%;">일자</th>
                        <th scope="col" style="width: 41%;" colspan="2">영역</th>
                        <th scope="col" style="width: 41%;">내용</th>
                      </tr>
                    </thead>
                    <tbody id="menu_n_inner_tbody">
                    </tbody>
                  </table>
                </div> 
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" id="batch_modal_confirm" class="btn btn-secondary" disabled>일괄저장</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
              </div>
            </div>
          </div>
        </div>   
      </div>
      `;
    return html;
  }

  async function script_renderStudentObservationsTable() {
    let params = null;
    let achievementArr = [];
    let evaluationArr = [];
    let classArr = [];
    let studentsAchievementData = [];
    let toc_modal_flag = true;
    let clickedElemId = null;
    let studentId = null;
    let subjectId = null;
    let subjectName = null;
    let fieldArr = [];
    let main_select_val = null;
    let sub_select_val = null;
    let isEmpty = true;
    let observation_id = null;
    let directories = null;
    const $submitBtn = document.getElementById('submitBtn');
    const $year = document.getElementById('year');
    const $semester = document.getElementById('semester');
    const $grade = document.getElementById('grade');
    const $class = document.getElementById('class');
    const $subject = document.getElementById('subject');
    $("#main_select").prop("disabled", true);
    $("#sub_select").prop("disabled", true);
    const $btn1 = document.getElementById('btnN1'); // 행추가 버튼
    const $btn2 = document.getElementById('btnN2'); // 관찰근거자료 버튼
    const $btn3 = document.getElementById('btnN3'); // 문자열바꾸기 버튼
    const $btn4 = document.getElementById('btnN4'); // 일괄입력 버튼
    const $btn5 = document.getElementById('btnN5'); // 저장 버튼
    const $btn6 = document.getElementById('btnN6'); // 삭제 버튼
    const $btn7 = document.getElementById('btnN7'); // 출력 버튼
    const $btn8 = document.getElementById('batch_modal_confirm'); // 모달창 내부의 일괄저장 버튼
    const $btni1 = document.getElementById('btnNi1');
    const $btni2 = document.getElementById('btnNi2');


    const renderSubjectObservationsTable = (student_info) => {
      const table_html = student_info.map(({ aid, category, created_at, desc, oid, evidence_count }) => {
        const td_4th_html = $("#main_select").val() === '전체' ? `
          <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
            <option value="미선택" ${category === "미선택" ? "selected" : ""}>미선택</option>
            <option value="수업내용" ${category === "수업내용" ? "selected" : ""}>수업내용</option>
            <option value="평가내용" ${category === "평가내용" ? "selected" : ""}>평가내용</option>
          </select>
        ` : `
          <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
            <option value="${category}" selected>${category}</option>
          </select>
        `;

        const td_5th_html = category === '평가내용' ? `
          <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
            ${fieldArr.filter(el => el[0] == aid).map(el => `<option value="${el[0]}">${el[1]}</option>`).join('')}
          </select>
        ` : `
          <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
            <option value="" selected></option>
          </select>
        `;

        const rowHtml = `
          <tr data-id="${oid}">
            <td class="text-center">
              <div style="display: flex; align-items: center; justify-content: center; height: 3.8rem; width: 100%; border: none;">
                <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
              </div>
            <td>
              <input type="date" class="form-control inputField select-width-full" style="height: 3.8rem; font-size: 0.75rem;" autocomplete="off" value="${created_at}">
            </td>
            <td>
              <textarea rows="3" maxlength="500" style="background-color: #ffffff; width: 100%; height: 3.8rem; overflow: auto; resize: none;" spellcheck="false">${desc}</textarea>
            </td>
            <td>
              ${td_4th_html}
            </td>
            <td>
              ${td_5th_html}
            </td>
            <td class="text-center">
              <div style="display: flex; align-items: center; justify-content: center; height: 3.8rem; width: 100%; border: none;">
                ${VISIBLE_STATUS_MAP[!!evidence_count]}
              </div>
            </td>
          </tr>
        `;

        return rowHtml;
      }).join('');;
      $("#menu_n_tbody_2").html(table_html);
    }

    $grade.addEventListener('change', async (event) => {
      try {
        const response = await fetch(`${_URL}/neis/get_subjects_by_grade/${$grade.value}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { grade, subjects, classes } = res;
        classArr = classes;
        // console.log(classArr);
        populateSelectOptionsAndSetDisabled(classArr.map(el => el[0]), $class);
        populateSelectOptionsAndSetDisabled(subjects, $subject);
        $("#menu_n_tbody_1").html(renderEmptyTbodyWithMessage(3));
        $("#student_count").text("0");
        updateButtonStatesWithStyles(
          [$btn1, true], [$btn2, true], [$btn3, true],
          [$btn4, true], [$btn5, true], [$btn6, true]
        );
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $class.addEventListener('change', () => {
      $("#menu_n_tbody_1").html(renderEmptyTbodyWithMessage(3));
      $("#menu_n_tbody_2").html(renderEmptyTbodyWithMessage(6));
      $("#student_count").text("0");
      $("#record_count").text("0");
      $("#menu_n_table_2").css({ "flex-grow" : 1 });
      updateButtonStatesWithStyles(
        [$btn1, true], [$btn2, true], [$btn3, true],
        [$btn4, true], [$btn5, true], [$btn6, true]
      );
    })

    $subject.addEventListener('change', () => {
      $("#menu_n_tbody_1").html(renderEmptyTbodyWithMessage(3));
      $("#menu_n_tbody_2").html(renderEmptyTbodyWithMessage(6));
      $("#student_count").text("0");
      $("#record_count").text("0");
      $("#menu_n_table_2").css({ "flex-grow" : 1 });
      updateButtonStatesWithStyles(
        [$btn1, true], [$btn2, true], [$btn3, true],
        [$btn4, true], [$btn5, true], [$btn6, true]
      );
    });

    $submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      params = new URLSearchParams();
      params.append('grade', $("#grade").val());
      params.append('class', $("#class").val());
      params.append('subject', $("#subject").val());
      
      try {
        const response = await fetch(`${_URL}/neis/get_grade_class_students_assessment_areas_and_subject_id/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { message, student_info, fields_info, subject_id } = res;
        // console.log(message);
        // console.log(student_info);
        // console.log(fields_info);
        // console.log(subject_id);
        subjectId = subject_id;
        subjectName = $("#subject").val();
        fieldArr = fields_info;
        
        const tableHtml = student_info.map(([ student_id, student_name ], idx) => {
          return `
            <tr data-sid="${student_id}">
              <td data-sid="${student_id}" class="text-center"><input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;"></td>
              <td class="text-center">${idx + 1}</td>
              <td class="text-decoration-underline">${student_name}</td>
            </tr>
          `
        }).join('');
        $("#menu_n_tbody_1").html(tableHtml);
        $("#student_count").text($("#menu_n_tbody_1 tr").length);

        $("#menu_n_tbody_1").on("change", "td:nth-child(1)", function() {
          updateBtnsBasedOnSelection2();
        })

        updateButtonStatesWithStyles(
          [$btn1, true], [$btn2, true], [$btn3, true],
          [$btn4, true], [$btn5, true], [$btn6, true]
        );
      } catch (error) {
        console.error('Error:', error);
      }

      try {
        const response = await fetch(`${_URL}/neis/get_active_school_info/`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        const { school, year, semester } = res;
        params = new URLSearchParams();
        params.append('school', school);
        params.append('year', year);
        params.append('semester', semester);
    
        const url = `${_URL}/cloudstorage/directoryAllContents/?${params.toString()}`;
    
        const response_2 = await fetch(url, { method: 'GET' });
        if (!response_2.ok) {
          throw new Error(`Error: ${response_2.status}`);
        }
        if (response_2.status === 204) {
          console.log('No Content');
          return;
        }

        const res_2 = await response_2.json();
        // console.log(res_2.message);

        const directoryTree = res_2.message.map((item, idx) => {
          const isFile = item.includes('.');
          const num = item.split('/').length - 1; 
          const _path = item.split('/').pop();
          return {
            id: idx + 1,
            path: item,
            pathForDisplay: _path,
            subdirectoryDepth: num,
            type: isFile ? 'file' : 'directory',
            // type: 'directory',
            children: [],
          };
        });

        directoryTree.forEach((elem) => {
          const children = directoryTree.filter(item => 
            item.path.startsWith(`${elem.path}/`) && item.path !== elem.path
            && !item.path.split(`${elem.path}/`)[1].includes('/')
          );
          const children_ids = children.map(child => child.id);
          elem.children = children_ids;
        });

        directories = directoryTree;

        const html_for_toc = directoryTree
          // .filter(item => item.type === 'directory')
          .map(({ id, path, type, children, pathForDisplay, subdirectoryDepth }) => `
            <a href='#' data-id="${id}" data-subids="${JSON.stringify(children)}" class="list-group-item ${subdirectoryDepth > 5 ? 'invisible' : ''}">
              ${getStyledDirectoryName(pathForDisplay, subdirectoryDepth, path, type)}
            </a>
          `).join('');

        const $toc_modal = document.getElementById('toc_modal');   
        $toc_modal.innerHTML = html_for_toc;

        $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });

        if (!toc_modal_flag) {
          return
        }   
        
        $toc_modal.addEventListener('click', function(e) {
          e.preventDefault();
          $toc_modal.querySelectorAll('.list-group-item > i').forEach(el => {
            el.style.color = '#9A9FA8';
            el.parentElement.style.color = 'black';
            el.parentElement.style.fontWeight = "400";
          });
          const elem = e.target.closest('.list-group-item');
          if (elem) {
            clickedElemId = elem.dataset.id;
            elem.querySelector('i').style.color = "#4078FF";
            elem.style.color = "#4078FF";
            elem.style.fontWeight = "bold";
            const subIds = JSON.parse(elem.dataset.subids);
            if (subIds.length > 0) {
              if (!elem.classList.contains('open')) {
                toggleFolderIcon(elem, true);
                elem.classList.add('open');
              } else {
                toggleFolderIcon(elem, false);
                elem.classList.remove('open');
              }
              displayTagsById(subIds, true);
              $("#toc_modal_confirm").removeClass("btn-primary").addClass("btn-secondary").addClass("disabled");
            } else {
              $("#toc_modal_confirm").removeClass("btn-secondary").addClass("btn-primary").removeClass("disabled");
            }
          }
        });
        toc_modal_flag = false;
      } catch (error) {
        console.error('Error:', error);
      }
    });

    $("#menu_n_tbody_1").on("click", "td:nth-child(3)", async function() {
      studentId = $(this).closest("tr").attr("data-sid");
      $("#menu_n_table_1 tr.table-active").removeClass("table-active");
      $(this).closest("tr").addClass("table-active");
      params = new URLSearchParams();
      params.append('student_id', studentId);
      params.append('grade_subject_id', subjectId);
      params.append('main_select', '전체');
      params.append('sub_select', 0);
      
      try {
        const response = await fetch(`${_URL}/neis/getStudentObservationsBySubject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        // console.log(res.observation_info);

        updateButtonStatesWithStyles(
          [$btn1, false], [$btn2, true], [$btn3, true], 
          [$btn4, true], [$btn5, false], [$btn6, true]
        );
        const main_select_html = `
          <option value="전체">전체</option>
          <option value="미선택">미선택</option>
          <option value="수업내용">수업내용</option>
          <option value="평가내용">평가내용</option>
        `;
        const sub_select_html = fieldArr.map(
          el => `<option value="${el[0]}">${el[1]}</option>`
        ).join('');
        
        $("#main_select").html(main_select_html).attr("disabled", false);
        $("#sub_select").html('<option value="전체">전체</option>'.concat(sub_select_html));
        
        if (res.observation_info.length === 0) {
          $("#menu_n_tbody_2").html(renderEmptyTbodyWithMessage(6, "조회된 데이터가 없습니다."));
          $("#menu_n_table_2").css({ "flex-grow" : 1 });
          $("#record_count").text("0");
          isEmpty = true;
        } else {
          renderSubjectObservationsTable(res.observation_info);
          $("#menu_n_table_2").css({ "flex-grow" : 0 });
          isEmpty = false;
          $("#record_count").text($("#menu_n_tbody_2 tr").length);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    async function handleSelectChange() {
      main_select_val = $("#main_select option:selected").val();
      sub_select_val = $("#sub_select option:selected").val();

      if (main_select_val === '평가내용') {
        $("#sub_select").prop("disabled", false);
        sub_select_val = sub_select_val === '전체' ? 0 : sub_select_val;
      } else {
        $("#sub_select")
          .val($("#sub_select option:first").val())
          .prop("disabled", true);
        sub_select_val = 0;   
      }

      const params = new URLSearchParams();
      params.append('student_id', studentId);
      params.append('grade_subject_id', subjectId);
      params.append('main_select', main_select_val);
      params.append('sub_select', sub_select_val);
      
      // console.log("main_select_val: ", main_select_val);
      // console.log("sub_select_val: ", sub_select_val);
      
      try {
        const response = await fetch(`${_URL}/neis/getStudentObservationsBySubject/?${params.toString()}`, {
          method: 'GET',
        });
        if (!response.ok) throw new Error(`서버 오류: ${response.status}`);

        const res = await response.json();
        // console.log(res.observation_info);

        updateButtonStatesWithStyles(
          [$btn1, false], [$btn2, true], [$btn3, true],
          [$btn4, true], [$btn5, false], [$btn6, true]
        );

        if (res.observation_info.length === 0) {
          $("#menu_n_tbody_2").html(renderEmptyTbodyWithMessage(6, "조회된 데이터가 없습니다."));
          $("#menu_n_table_2").css({ "flex-grow" : 1 });
          isEmpty = true;
        } else {
          isEmpty = false;
          // 여기에 데이터 렌더링 로직 추가 가능
          renderSubjectObservationsTable(res.observation_info);
          $("#menu_n_table_2").css({ "flex-grow" : 0 });
        }

      } catch (error) {
        console.error("Error:", error);
      }
    }

    $("#main_select, #sub_select").on("change", handleSelectChange);

    $btn1.addEventListener('click', () => { // 행추가 버튼 클릭 시
      const td_4th_html = $("#main_select").val() === '전체' ? `
        <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
          <option value="미선택">미선택</option>
          <option value="수업내용">수업내용</option>
          <option value="평가내용">평가내용</option>
        </select>
      ` : `
        <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
          <option value="${$("#main_select").val()}" selected>${$("#main_select").val()}</option>
        </select>
      `;

      const td_5th_html = $("#main_select").val() === '평가내용' ? `
        <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
          ${$("#sub_select").val() === '전체' ? fieldArr.map(el => `<option value="${el[0]}">${el[1]}</option>`).join('') 
          : fieldArr.filter(el => el[0] == $("#sub_select").val()).map(el => `<option value="${el[0]}">${el[1]}</option>`).join('')}
        </select>
      ` : `
        <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
          <option value="" selected></option>
        </select>
      `;

      const rowHtml = `
        <tr>
          <td class="text-center">
            <div style="display: flex; align-items: center; justify-content: center; height: 3.8rem; width: 100%; border: none;">
              <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
            </div>
          <td>
            <input type="date" class="form-control inputField select-width-full" style="height: 3.8rem; font-size: 0.75rem;" autocomplete="off">
          </td>
          <td>
            <textarea rows="3" maxlength="500" style="background-color: #ffffff; width: 100%; height: 3.8rem; overflow: auto; resize: none;" spellcheck="false"></textarea>
          </td>
          <td>
            ${td_4th_html}
          </td>
          <td>
            ${td_5th_html}
          </td>
        </tr>
      `;

      if (isEmpty) {
        $("#menu_n_tbody_2").html(rowHtml).closest("table").css({ "flex-grow" : 0 });
        isEmpty = false;
        $('#menu_n_tbody_2 input[type="date"]:last').val(new Date().toISOString().substring(0, 10));        
      } else {
        $("#menu_n_tbody_2").append(rowHtml);
        $('#menu_n_tbody_2 input[type="date"]:last').val(new Date().toISOString().substring(0, 10));
      }
      
      $("#record_count").text($("#menu_n_tbody_2 tr").length);
    });

    $("#menu_n_tbody_2").on("change", "td:nth-child(4)", function() {
      // console.log("nth-child(4) changed!");
      const select_val = $(this).find("select").val();
      if (select_val === '평가내용') {
        $(this).next().html(`
          <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
            ${fieldArr.map(el => `<option value="${el[0]}">${el[1]}</option>`).join('')} 
          </select>
        `);
      } else {
        $(this).next().html(`
          <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
            <option value="" selected></option>
          </select>
        `);
      }
    });

    try {
      const response = await fetch(`${_URL}/neis/get_active_grades/`, {
        method: 'GET',
      });
      if (!response.ok) {
        throw new Error(`서버 오류: ${response.status}`);
      }
      const res = await response.json();
      const { year, semester, active_grades } = res;
      populateSelectOptionsAndSetDisabled(year, $year, true);
      populateSelectOptionsAndSetDisabled(semester, $semester, true);
      populateSelectOptionsAndSetDisabled(active_grades, $grade);
    } catch (error) {
      console.error('Error:', error);
    }

    const updateBtnsBasedOnSelection = () => {
      const $checked = $("#menu_n_tbody_2 input:checked");
      
      if ($checked.length === 1 && $checked.closest("tr").attr("data-id")) {
        updateButtonStatesWithStyles([$btn2, false], [$btn3, false], [$btn6, false]); 
      } else if ($checked.length === 1 && !$checked.closest("tr").attr("oid")) {
        updateButtonStatesWithStyles([$btn2, true], [$btn3, false], [$btn6, false]); 
      } else if ($checked.length > 1) {
        updateButtonStatesWithStyles([$btn2, true], [$btn3, false], [$btn6, false]); 
      } else if ($checked.length === 0) {
        updateButtonStatesWithStyles([$btn2, true], [$btn3, true], [$btn6, true]); 
      }
    }

    const updateBtnsBasedOnSelection2 = () => { // 좌측 패널의 출력 버튼 및 우측 일괄입력 버튼 활성화 처리
      const $checked = $("#menu_n_tbody_1 input:checked");
      
      if ($checked.length === 0) {
        updateButtonStatesWithStyles([$btn4, true], [$btn7, true]); 
      } else if ($checked.length === 1) {
        updateButtonStatesWithStyles([$btn4, true], [$btn7, false]); 
      } else {
        updateButtonStatesWithStyles([$btn4, false], [$btn7, true]); 
      }

      $("#menu_n_tbody_2").html(renderEmptyTbodyWithMessage(6));
      $("#record_count").text("0");
      $("#menu_n_table_2").css({ "flex-grow" : 1 });
      updateButtonStatesWithStyles(
        [$btn1, true], [$btn2, true], [$btn3, true], [$btn5, true], [$btn6, true]
      );
      $("#menu_n_table_1 tr.table-active")?.removeClass("table-active");
    }
    
    $("#menu_n_tbody_2").on("click", 'input[type="checkbox"]', function() {
      updateBtnsBasedOnSelection();
    });


    toggleAllTableCheckboxes('#menu_n_table_2', updateBtnsBasedOnSelection);
    toggleAllTableCheckboxes('#menu_n_table_1', updateBtnsBasedOnSelection2);

    $("#str_modal_confirm").on("click", function () { // 문자열바꾸기 모달창의 '바꾸기' 버튼 클릭 시
      const strInput = $("#strInput").val();
      const strOutput = $("#strOutput").val();
      if (strInput === '') {
        alert("원래 문자열 항목은 필수입니다.");
        return;
      }

      // 특수문자 등 정규식 안전 처리
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]<span>\</span>]/g, '<span>\</span>$&amp;');
      }

      let total_replacements = 0;

      $("#menu_n_tbody_2 input:checked").each(function() {
        const $textarea = $(this).closest("tr").find("td:nth-child(3) textarea");
        const target_str = $textarea.val();

        // strInput이 여러 번 나올 수 있으니 교체 횟수 집계
        const regex = new RegExp(escapeRegExp(strInput), 'g'); // 대소문자 구분, 원하면 'gi'
        const matches = target_str.match(regex);

        if (matches) {
          total_replacements += matches.length;
          $textarea.val(target_str.replace(regex, strOutput));
        }
      });

      // 처리 결과 알림
      alert("총 " + total_replacements + "개의 항목이 변경되었습니다.");

      $("#strConversionModal").modal('hide');
      $("#strInput").val('');
      $("#strOutput").val('');
      $("#menu_n_table_2 button.toggleAllcheckboxes").click();
    });

    $btn5.addEventListener("click", async () => { // 저장 버튼 클릭 시
      const str_list = $("#menu_n_tbody_2 tr td:nth-child(3)").map(function () {
        return $(this).find("textarea").val().trim();
      }).get();

      const isValid = str_list.every(el => !!el);
      if (!isValid) {
        alert("비어있는 내용 셀이 있어 저장할 수 없습니다.");
        return;
      }

      const data = $("#menu_n_tbody_2 tr").map(function() {
        return {
          id: parseInt($(this).attr("data-id")) || 0,
          created_at: $(this).find("td:nth-child(2)").find("input").val(),
          desc: $(this).find("td:nth-child(3)").find("textarea").val().trim(),
          classification: $(this).find("td:nth-child(4)").find("select").val(),
          area_id: parseInt($(this).find("td:nth-child(5)").find("select").val()) || 0,
        };
      }).get();

      const params = new URLSearchParams();
      params.append('student_id', studentId);
      params.append('grade_subject_id', subjectId);
      params.append('main_select', $("#main_select").val());
      params.append('sub_select', $("#sub_select").val());

      try {
        const url = `${_URL}/neis/manageObservationsBatch/?${params.toString()}`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData?.error || `서버 오류: ${response.status}`);
        }

        const res = await response.json();
        console.log(res.message);
        alert("저장이 완료되었습니다.");
        $("#menu_n_tbody_1 tr.table-active").find("td:nth-child(3)").click();
      } catch (error) {
        console.error('Error:', error);
        alert(`오류 발생: ${error.message}`);
      }
    });

    $btn6.addEventListener("click", () => { // 삭제 버튼 클릭 시
      $("#menu_n_tbody_2 input:checked").closest("tr").remove();
      $("#menu_n_table_2 button.toggleAllcheckboxes").click();
      $("#record_count").text($("#menu_n_tbody_2 tr").length);
      if ($("#menu_n_tbody_2 tr").length === 0) {
        isEmpty = true;
      }
    });

    const $searchResourcesModal = document.getElementById('searchResourcesModal');
    if ($searchResourcesModal) {
      $searchResourcesModal.addEventListener('show.bs.modal', async (event) => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $searchResourcesModal.querySelector('.modal-title')
        const modalBody = $searchResourcesModal.querySelector('.modal-body')
        const student_name = $("#menu_n_tbody_1 tr.table-active").find("td:nth-child(3)").text();
        
        modalTitle.textContent = `${student_name}의 관찰근거자료 선택`;
        observation_id = $("#menu_n_tbody_2 input:checked").closest("tr").attr("data-id");

        params = new URLSearchParams();
        params.append('observation_id', observation_id);
        
        try {
          const response = await fetch(`${_URL}/neis/get_observation_evidence_by_observation_id/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, info } = res;
          console.log(message);
          // console.log(info);
          const tableHtml = info.map(({evidence_id, resource_path, created_at}) => {
            return `
              <tr data-eid="${evidence_id}">
                <td><i class="fa-solid fa-trash"></i></td>
                <td><i class="fa-solid fa-right-left"></i></td>
                <td>${resource_path}</td>
                <td>${created_at}</td>
              </tr>
            `
          }).join('');
          $("#menu_g_modal_tbody").html(tableHtml);
        } catch (error) {
          console.error('Error:', error);
        }
      });
    }

    const $batchInputModal = document.getElementById('batchInputModal');
    if ($batchInputModal) {
      $batchInputModal.addEventListener('show.bs.modal', async (event) => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = $batchInputModal.querySelector('.modal-title')
        const modalBody = $batchInputModal.querySelector('.modal-body')
        let innerEmpty = true;
        
        modalTitle.textContent = '관찰기록 일괄입력';
        $("#inner_subject").text(`교과:${subjectName}`);
        $("#inner_record_count").text("0");
        $("#menu_n_inner_table").css({ "flex-grow" : 1 });
        $("#menu_n_inner_tbody").empty();
      });

      $("#btnNi1").on('click', () => { // 행추가 버튼 클릭 시
        const td_4th_html = `
          <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
            <option value="미선택">미선택</option>
            <option value="수업내용">수업내용</option>
            <option value="평가내용">평가내용</option>
          </select>
        `;

        const td_5th_html = `
          <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
            <option value="" selected></option>
          </select>
        `;

        const rowHtml = `
          <tr>
            <td class="text-center">
              <div style="display: flex; align-items: center; justify-content: center; height: 3.8rem; width: 100%; border: none;">
                <input class="form-check-input fs-6" type="checkbox" style="color: #979aa4;">
              </div>
            <td>
              <input type="date" class="form-control inputField select-width-full" style="height: 3.8rem; font-size: 0.75rem;" autocomplete="off">
            </td>
            <td>
              ${td_4th_html}
            </td>
            <td>
              ${td_5th_html}
            </td>
            <td>
              <textarea rows="3" maxlength="500" style="background-color: #ffffff; width: 100%; height: 3.8rem; overflow: auto; resize: none;" spellcheck="false"></textarea>
            </td>
          </tr>
        `;

        $("#menu_n_inner_tbody").append(rowHtml);
        $('#menu_n_inner_tbody input[type="date"]:last').val(new Date().toISOString().substring(0, 10));
        $("#inner_record_count").text($("#menu_n_inner_tbody tr").length);
        
        $("#menu_n_inner_table").css({ "flex-grow" : 0 });
        $("#batch_modal_confirm").prop("disabled", false);
        updateButtonStatesWithStyles([$btn8, false]);
      });

      $("#btnNi2").on("click", () => { // 행삭제 버튼 클릭 시
        $("#menu_n_inner_tbody input:checked").closest("tr").remove();
        $("#menu_n_inner_tbody button.toggleAllcheckboxes").click();
        $("#inner_record_count").text($("#menu_n_inner_tbody tr").length);
        if ($("#menu_n_inner_tbody tr").length === 0) {
          $("#batch_modal_confirm").prop("disabled", true);
          updateButtonStatesWithStyles([$btn8, true]);
          updateButtonStatesWithStyles([$btni2, true]);
        }
        $("#menu_n_inner_table button.toggleAllcheckboxes").click();
      });
      
      $("#menu_n_inner_tbody").on("click", "td:nth-child(1)", function() {
        const checked_len = $("#menu_n_inner_tbody input:checked").length;
        if (checked_len > 0) {
          updateButtonStatesWithStyles([$btni2, false]);
        } else {
          updateButtonStatesWithStyles([$btni2, true]);
        }
      });

      $("#menu_n_inner_tbody").on("change", "td:nth-child(3)", function() {
        // console.log("nth-child(3) changed!");
        const select_val = $(this).find("select").val();
        if (select_val === '평가내용') {
          $(this).next().html(`
            <select class="form-select form-select-sm select-width-full" style="height: 3.8rem;">
              ${fieldArr.map(el => `<option value="${el[0]}">${el[1]}</option>`).join('')} 
            </select>
          `);
        } else {
          $(this).next().html(`
            <select class="form-select form-select-sm select-width-full" disabled style="height: 3.8rem;">
              <option value="" selected></option>
            </select>
          `);
        }
      });

      $btn7.addEventListener("click", async () => { // 출력 버튼 클릭 시
        params = new URLSearchParams();
        params.append('student_id', $("#menu_n_tbody_1 input:checked").closest("tr").attr("data-sid"));
        params.append('grade_subject_id', subjectId);
        
        try {
          const response = await fetch(`${_URL}/neis/get_image_resource_paths_by_student_and_subjectId/?${params.toString()}`, {
            method: 'GET',
          });
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          const { message, info } = res;
          console.log(message);
          // console.log(info);

          if (info.length === 0) {
            alert("등록된 관찰근거자료가 없습니다.");
            $("#menu_n_table_1 button.toggleAllcheckboxes").click();
            return
          } 
          const images = info.map(el => `${_URL}/cloudstorage/view/${el}`);
          openFile(images[0], false, false, images);
          $("#menu_n_table_1 button.toggleAllcheckboxes").click();
        } catch (error) {
          console.error('Error:', error);
        }  
      });

      $btn8.addEventListener("click", async () => { // 모달창 내부의 저장 버튼 클릭 시
        const str_list = $("#menu_n_inner_tbody tr td:nth-child(5)").map(function () {
          return $(this).find("textarea").val().trim();
        }).get();

        const isValid = str_list.every(el => !!el);
        if (!isValid) {
          alert("비어있는 내용 셀이 있어 저장할 수 없습니다.");
          return;
        }

        const data = $("#menu_n_inner_tbody tr").map(function() {
          return {
            id: parseInt($(this).attr("data-id")) || 0,
            created_at: $(this).find("td:nth-child(2)").find("input").val(),
            classification: $(this).find("td:nth-child(3)").find("select").val(),
            area_id: parseInt($(this).find("td:nth-child(4)").find("select").val()) || 0,
            desc: $(this).find("td:nth-child(5)").find("textarea").val().trim(),
          };
        }).get();

        const studentIds = $("#menu_n_tbody_1 input:checked").map(function() {
          return $(this).closest("tr").attr("data-sid");
        }).get();

        if (studentIds.length === 0) {
          alert("선택된 학생이 없습니다.");
          return;
        }

        // console.log(studentIds);
        // console.log(data);

        const params = new URLSearchParams();
        params.append('student_ids', studentIds.join(','));  // ← 핵심: 쉼표 구분
        params.append('grade_subject_id', subjectId);

        try {
          const url = `${_URL}/neis/manageObservationsBatchBySids/?${params.toString()}`;
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData?.error || `서버 오류: ${response.status}`);
          }

          const res = await response.json();
          console.log(res.message);
          alert("저장이 완료되었습니다.");
          $("#batchInputModal").modal('hide');
          $("#menu_n_table_1 button.toggleAllcheckboxes").click();
        } catch (error) {
          console.error('Error:', error);
          alert(`오류 발생: ${error.message}`);
        }
      });

      const innerEffect = () => {
        const checked_len = $("#menu_n_inner_tbody input:checked").length;
        if (checked_len > 0) {
          updateButtonStatesWithStyles([$btni2, false]);
        } else {
          updateButtonStatesWithStyles([$btni2, true]);
        }
      }

      toggleAllTableCheckboxes('#menu_n_inner_table', innerEffect);
    }
    
    $("#toc_modal_confirm").on("click", async function () { // 모달창의 업로드 버튼 클릭 시
      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      const data = {
        'observation_id': observation_id,
        'resource_path': path,
        'ext': file_ext,
      }

      // console.log(data);
      try {
        const url = `${_URL}/neis/create_observation_evidence/`;
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        };

        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }
        const res = await response.json();
        console.log(res.message);
        // alert("저장을 완료했습니다.");
        $("#menu_n_tbody_2 input:checked:first").closest("tr").find("td:last div").text("O");
      } catch (error) {
        console.error('Error:', error);
        alert(error);
      }
      $("#searchResourcesModal").modal('hide');
      $("#menu_n_table_2 button.toggleAllcheckboxes").click();
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(3)", function() {
      const path = $(this).text();
      const file_ext = path.split('.').pop().toLowerCase();
      const image_exts = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'tiff', 'webp'];
      const video_exts = ['mp4', 'avi', 'mov', 'mkv', 'wmv', 'flv'];
      const audio_exts = ['mp3', 'aac', 'm4a', 'ogg', 'wav', 'flac', 'webm'];
      const code_exts = ['html', 'css', 'js', 'py'];
      const office_exts = ['hwp', 'hwpx', 'pdf', 'ppt', 'pptx'];

      if (video_exts.includes(file_ext)) {
        openFile(path, true, false);
      } else if (audio_exts.includes(file_ext)) {
        openFile(path, false, true);  // 비디오 파일
      } else if (code_exts.includes(file_ext) || office_exts.includes(file_ext)) {
        openFile(path)
      } else if (image_exts.includes(file_ext)) {  
        openFile(path);
      } 
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(1)", async function() { // 삭제 아이콘 클릭 시
      if (confirm(`삭제하시겠습니까? 자료를 삭제해도 원격저장소에 저장된 원자료는 삭제되지 않습니다.`)) {
        try {
          const url = `${_URL}/neis/delete_observation_evidence_by_id/`;
          const data = {
            eid: $(this).closest("tr").attr("data-eid"),
          }
          const options = {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log("message: ", res.message);
          console.log("deleted_id: ", res.deleted_id);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").remove();
          if ($("#menu_g_modal_tbody tr").length === 0) {
            $("#menu_n_tbody_2 input:checked").closest("tr").find("td:nth-child(6) div").text("X");
          }
        } catch (error) {
          console.error('Error: ', error);
          alert("삭제 중 오류가 발생하였습니다.");
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });

    $("#menu_g_modal_tbody").on("click", "tr td:nth-child(2)", async function() { // 양방향 화살표 아이콘 클릭 시
      if ($("#toc_modal_confirm").hasClass("disabled")) { return }

      const { path } = directories.filter(el => el.id === parseInt(clickedElemId))[0];
      const file_ext = path.includes('.') ? path.split('.').pop() : undefined;
      
      const data = {
        eid: $(this).closest("tr").attr("data-eid"),
        resource_path: path,
        ext: file_ext,
      }

      if (confirm(`관찰근거자료를 다음으로 수정하시겠습니까?: ${path}`)) {
        try {
          const url = `${_URL}/neis/update_observation_evidence_resource/`;
          const options = {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          };

          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(`서버 오류: ${response.status}`);
          }
          const res = await response.json();
          console.log(res.message);

          // 요청 성공 시 아래 코드 실행
          $(this).closest("tr").find("td:nth-child(3)").text(path);
        } catch (error) {
          console.error('Error:', error);
          alert(error);
        }
      } else {
        alert("작업을 취소하셨습니다.")
      }
    });
  }

  function renderDataFromGETResponse(menu) {
    // 서버측에 전달한 GET 요청의 결과로 반환받은 데이터를 적절한 레이아웃으로 화면에 렌더링
    switch (menu) {
      case MENU.B:
        return renderAcademicYearSemesterTable();
      case MENU.C:
        return renderAcademicYearClassInfoTable();
      case MENU.D:
        return renderStudentRecordDeletionTable();
      case MENU.E:
        return renderAssessmentCriteriaTable();
      case MENU.G:
        return renderAchievementEvaluationScreen();
      case MENU.H:
        return renderFieldAssessmentResultsTable();
      case MENU.I:
        return renderSubjectAssessmentResultsTable();
      case MENU.J:
        return renderSemesterSubjectFeedbackTable();
      case MENU.K:
        return renderAnnualSubjectProgressTable();
      case MENU.L:
        return renderClassSubjectGradesTable();
      case MENU.M:
        return renderStudentGradesTable();
      case MENU.N:
        return renderStudentObservationsTable();
      default:
        return ''
    }
  }

  function attachEventsAfterRenderByMenu(menu) {
    // 사용자로부터 전달받은 메뉴에 따라 화면 렌더링을 마친 후, 렌더링 된 화면에 따라 요소에 필요한 이벤트 등을 덧붙이기
    switch (menu) {
      case MENU.B:
        script_renderAcademicYearSemesterTable();
        return;
      case MENU.C:
        script_renderAcademicYearClassInfoTable();
        return;
      case MENU.D:
        script_renderStudentRecordDeletionTable();
        return;
      case MENU.E:
        script_renderAssessmentCriteriaTable();
        return;
      case MENU.G:
        script_renderAchievementEvaluationScreen();
        return;
      case MENU.H:
        script_renderFieldAssessmentResultsTable();
        return;
      case MENU.I:
        script_renderSubjectAssessmentResultsTable();
        return;
      case MENU.J:
        script_renderSemesterSubjectFeedbackTable();
        return;
      case MENU.K:
        return;
      case MENU.L:
        return;
      case MENU.M:
        return;
      case MENU.N:
        script_renderStudentObservationsTable();
        return;
      default:
        return;
    }
  }

  async function renderSelectedMenuScreen() {
    // 여러 개의 메뉴 항목 중 하나를 선택했을 때, 해당 메뉴와 관련된 화면을 렌더링
    const { menu } = store.getState();
    document.getElementById('content_header').innerHTML = renderHeaderSection(menu);
    document.getElementById('select_wrapper').innerHTML = renderSelectFormForGETRequest(menu);
    document.getElementById('subselection').innerHTML = menu == MENU.E ? renderSubselectionMenu(menu) : '';
    document.getElementById('content_wrapper').innerHTML = renderDataFromGETResponse(menu);
    attachEventsAfterRenderByMenu(menu);
  }

  function reducer(state, action) {
    if (state == undefined) {
      return {
        menu: null,
      }
    }
    let newState;
    if (action.type === 'MENU') {
      newState = {
        ...state,
        menu: action.menu,
      }
    }
    return newState;
  }
  const store = createStore(reducer, window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__());
  window.store = store;
  store.subscribe(renderSelectedMenuScreen);

  window.onload = function () {
    const $list_group_items = document.querySelectorAll('li.list-group-item');
    $list_group_items.forEach(elem => {
      elem.addEventListener('click', (e) => {
        removeActiveClassFromListItems(e.target);
        toggleAccordionButtonCss(e.target);
        store.dispatch({ type: 'MENU', menu: e.target.textContent });
      });
    });

    const $accordion_btns = document.querySelectorAll('.accordion-button');
    $accordion_btns.forEach(elem => {
      elem.style.boxShadow = 'none';
      elem.addEventListener('click', (e) => {
        updateAccordionCssOnClick(e.target);
      });
    });

    const $accordion_bodies = document.querySelectorAll('.accordion-body');
    const $lastElem = $accordion_bodies[$accordion_bodies.length - 1];
    if ($lastElem) {
      $lastElem.style.borderBottom = '0.5px solid #cecfd1';
    }

    const $toggleBtn = document.getElementById('toggle-button');
    const $nav = document.getElementById('nav');
    const $window = document.getElementById('content_window');
    const $btnIcon = document.getElementById('btnIcon');
    const $select_wrapper = document.getElementById('select_wrapper');
    $toggleBtn.addEventListener('click', () => {
      if ($btnIcon.classList.contains('fa-caret-left')) {
        $btnIcon.classList.replace('fa-caret-left', 'fa-caret-right');
        $select_wrapper.classList.replace('row-cols-xxl-5', 'row-cols-xxl-6');
      } else {
        $btnIcon.classList.replace('fa-caret-right', 'fa-caret-left');
        $select_wrapper.classList.replace('row-cols-xxl-6', 'row-cols-xxl-5');
      }
      $nav.classList.toggle('sideBar-hidden');
      $window.classList.toggle('contentWindow-expanded');
    });
  }
</script>
{% endblock %}