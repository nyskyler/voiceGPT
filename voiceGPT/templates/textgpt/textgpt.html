{% extends "base2.html" %}
{% block content %}
<link href="https://hangeul.pstatic.net/hangeul_static/css/maru-buri.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic-coding.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic-eco.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-myeongjo.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-myeongjo-eco.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/NanumMyeongjoYetHangul.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-barun-gothic.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/NanumBarunGothicYetHangul.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-barun-pen.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-brush.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-pen.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-neo.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
<link href="https://hangeul.pstatic.net/hangeul_static/css/NanumHuman.css" rel="stylesheet">
<style>
  #myRow {
    display: flex;
    flex-direction: row;
  }
  #sidebar {
    display: flex;
    flex-direction: column;
    height: 95vh;
    border-right: 1px solid black;
    transform: translateX(0); /* ê¸°ë³¸ ìœ„ì¹˜ */
    transition: transform 0.5s ease, width 0.5s ease; /* ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
  }
  .sideItem {
    height: 87vh;
    /* flex: 1; */
    /* padding: 0.1rem; */
    overflow-y: auto;
  }
  .chat-window {
    display: flex;
    flex-direction: column;
    flex: auto;
    height: 95vh;
    transition: flex 0.5s ease; /* ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
  }
  .sidebar-hidden {
    transform: translateX(-100%);
    transition: transform 0.5s ease, width 0.5s ease;
    width: 0%;
    padding: 0px;
  }
  .chat-expanded {
    flex-grow: 1; /* ë¶€ëª¨ ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚¨ì€ ê³µê°„ ì±„ìš°ê¸° */
    transition: flex-grow 0.5s ease;
  }
  .invisible {
    width: 0%;
    display: none;
  }
  .thumbnails {
    display: flex;
    /* flex-direction: row; */
    /* flex-wrap: wrap; */
    overflow-x: scroll;
    white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
  }
  /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (ì›¹í‚· ë¸Œë¼ìš°ì €ìš©) */
  .thumbnails::-webkit-scrollbar {
    height: 8px; /* ìŠ¤í¬ë¡¤ë°” ë†’ì´ */
  }

  .thumbnails::-webkit-scrollbar-thumb {
    background-color: #888; /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ */
    border-radius: 4px; /* ìŠ¤í¬ë¡¤ë°” ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
  }

  .thumbnails::-webkit-scrollbar-thumb:hover {
    background-color: #555; /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ (í˜¸ë²„ ì‹œ) */
  }
  .banner {
    flex: 0 0 auto;
    padding-top: 0.9rem;
    padding-bottom: 0.5rem;
  }
  .sideBanner {
    flex: 0 0 auto;
    padding-top: 0.6rem;
    padding-bottom: 0.6rem;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0 10px;
  }
  .modeChange {
    display: none;
  }
  .cursor-pointer {
    cursor: pointer; /* í¬ì¸í„° ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
  }
  .messages {
    flex: auto;
    padding: 1rem;
    overflow-y: auto;
  }
  .input-area {
    padding: 0rem 1rem 0.6rem 1rem;
  }
  .input-group {
    display: flex;
    align-items: center;
    /* border: 1px solid #ccc; */
    border-radius: 5px;
    padding: 5px;
    width: 100%;
  }
  #myInput {
    flex-grow: 1;
    border: none;
    border-radius: 5px;
    outline: none;
    resize: none;
    max-height: 300px;
    overflow-y: auto;
  }
  #myInput:focus, #systemInput:focus {
    outline: none;
    box-shadow: none;
    border-color: black;
  }
  .attach-icon {
    margin-left: 3px;
    margin-right: 10px;
    cursor: pointer;
  }
  #myBtn {
    background-color: transparent;
    border: none;
    cursor: pointer;
  }

  #myBtn i {
    color: #007bff;
    font-size: 1.5em;
  }

  #myBtn:hover i {
    color: #0056b3;
  }
  p {
    margin-bottom: 0;
  }
  .card-body {
    position: relative;
  }
  .card {
    border: 1px solid;
    border-radius: 2px;
  }
  .delete_message {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ë³´ì´ì§€ ì•Šê²Œ ì„¤ì • */
    width: 5px; /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
    height: 5px; /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
  }
  .card-body:hover .delete_message {
    display: block; /* hover ì‹œì—ë§Œ ë²„íŠ¼ ë³´ì´ê¸° */
  }
  .imgContainer, .imgCard {
    margin: 5px;
  }
  .imgContainer:hover .delete_message {
    top: 10px;
    right: 10px;
    display: block; /* hover ì‹œì—ë§Œ ë²„íŠ¼ ë³´ì´ê¸° */
  }

  /* Toggle Button */
  .toggle-btn {
    border: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    outline: none;
    margin-right: 0.3rem;
  }
  .toggle-btn i {
    font-size: 1.2rem;
  }
  .btn-margin {
    margin-left: 0.8rem;
  }
  #searchInput:focus, #searchInput2:focus, #topicInput:focus {
    outline: none;
    box-shadow: none;
    border-color: black;
  }
  #article {
    font-family: 'inherit';
  }
  .btn-transparent {
    background-color: transparent;
    border: none;
  }
  .btn-transparent:hover {
    background-color: rgba(0, 0, 0, 0.1); /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
  }
  .bg-3030 {
    background-color: #303030 !important;
  }
  .list-group-item-dark {
    background-color: #212121 !important;
    color: #fff; /* í•„ìš”ì‹œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
    border: none !important;
  }
  .list-group-item-dark.active, .list-group-item-dark:hover {
    background-color: #303030 !important;
    border-radius: 1rem !important;
    color: #fff; /* í•„ìš”ì‹œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
  }
  ul.gpt_ul {
    font-size: 0.8rem;
  }
  /* ì½”ë“œ ë¸”ë¡ ìŠ¤íƒ€ì¼ */
  pre code {
    display: block;
    padding: 1rem;
    border-radius: 0.5rem;
    background-color: #1e1e1e; /* VSCode ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
    color: #dcdcdc; /* ê¸°ë³¸ í°íŠ¸ ìƒ‰ìƒ */
    font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
    font-size: 0.9rem;
    overflow-x: auto;
  }

  /* ì¤„ ë²ˆí˜¸ ìŠ¤íƒ€ì¼ */
  .hljs-ln-numbers {
    text-align: right;
    color: #888;
    border-right: 1px solid #444;
    vertical-align: top;
    padding-right: 10px;
    user-select: none;
  }

  .hljs-ln-code {
    padding-left: 10px;
  }

  .markDown > p:not(:last-child) {
    white-space: pre-line;  /* \n â†’ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³´ì¡´ */
    margin-bottom: 1rem;    /* ë§ˆì§€ë§‰ pë¥¼ ì œì™¸í•˜ê³ ë§Œ ì—¬ë°± ì ìš© */
  }

  .attached-files {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .file-download {
    display: flex;
    align-items: center;
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(0,0,0,0.05);
    cursor: pointer;
    transition: 0.15s;
    max-width: 100%;
  }

  .file-download i {
    margin-right: 6px;
    font-size: 1rem;
  }

  .file-download span {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .file-download:hover {
    background: rgba(0,0,0,0.12);
  }


  @media (min-width: 1024px) and (max-width: 1366px) {
  /* ì•„ì´íŒ¨ë“œ í”„ë¡œ 12.9ì¸ì¹˜ í™”ë©´ì—ë§Œ ì ìš©í•  ìŠ¤íƒ€ì¼ */
    #sidebar {
      height: 94vh;
    }
    .sideItem {
      height: 86vh;
    }
    .chat-window {
      height: 94vh;
    }
    .input-area {
      padding-right: 1rem;
    }
  } 

  @media (max-width: 767.98px) and (orientation: portrait) {
    .chat-window {
      height: 80vh; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì „ì²´ í™”ë©´ ë†’ì´ë¡œ ì„¤ì • */
    }
    .toggle-btn {
      display: none;
    }
    #fontIncrease, #fontDecrease {
      display: none;
    }
    .input-area {
      padding-right: 1rem;
    }
  }
</style>
<!-- ì˜¤í”„ìº”ë²„ìŠ¤ ì‚¬ì´ë“œë°” -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasSidebarLabel"></h5>
    <button type="button" style="margin-right: 1rem;" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    <button id="chatBtn2" class="btn btn-light chatBtn" style="padding: 0.5rem; margin-right: 0.8rem;"><i class="fa-regular fa-pen-to-square"></i></button>
    <form id="searchForm2" style="display: flex; align-items: center;">
      <div class="input-group" style="display: flex; align-items: center; border: none; outline: none;">
        <input type="text" style="border: 1px solid black; border-right: 0; border-radius: 4px 0 0 4px;" maxlength="12" id="searchInput2" name="serachInput" class="form-control" aria-label="Message" aria-describedby="send-button" autocomplete="off" rows="1">
        <button id="searchBtn2" class="btn btn-light" style="margin-left: 0; border: 1px solid black; border-left: 0; border-radius: 0 4px 4px 0;" type="submit">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </div>
    </form>
  </div>
  <div class="offcanvas-body p-0">
    <ul class="list-group list-group-flush toc gpt_ul">
    </ul>
  </div>
</div>
<div class="container-fluid">
  <div id="myRow" class="row">
    <div id="sidebar" class="col-12 col-md-3 col-xl-2 sidebar d-none d-md-block">
      <div class="sideBanner" style="display: flex; align-items: center;">
        <button id="chatBtn" class="btn btn-transparent chatBtn" style="padding: 0.5rem; margin-right: 0.8rem;"><i class="fa-regular fa-pen-to-square"></i></button>
        <form id="searchForm" style="display: flex; align-items: center;">
          <div class="input-group" style="display: flex; align-items: center; border: none; outline: none;">
            <input type="text" style="border: 1px solid black; border-right: 0; border-radius: 4px 0 0 4px;" maxlength="12" id="searchInput" name="serachInput" class="form-control" aria-label="Message" aria-describedby="send-button" autocomplete="off" rows="1">
            <button id="searchBtn" class="btn btn-light" style="margin-left: 0; border: 1px solid black; border-left: 0; border-radius: 0 4px 4px 0;" type="submit">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </div>
        </form>
      </div>
      <ul class="list-group list-group-flush toc gpt_ul">
      </ul>
    </div>
    <div id="chatWindow" class="col-12 col-md-9 col-xl-10 chat-window p-0">
      <div class="banner">
        <div class="header">
          <span>
            <button id="toggleButton" class="toggle-btn btn btn-transparent">
              <i class="fa-regular fa-square-caret-left"></i><!-- FontAwesome icon -->
            </button>
            <span id="currentModel" class="fs-5"></span>
          </span>
          <span>
            <button id="fontIncrease" class="btn btn-transparent"><i class="fa-regular fa-square-plus"></i></button>
            <button id="fontDecrease" class="btn btn-transparent"><i class="fa-regular fa-square-minus"></i></button>
            <button id="paletteBtn" class="btn btn-transparent"><i class="fa-solid fa-palette"></i></i></button>
            <button id="settingBtn" class="btn btn-transparent"><i class="fa-solid fa-gear"></i></button>
            <button id="dalleSettingBtn" class="btn btn-transparent modeChange"><i class="fa-solid fa-gears"></i></button>
            <button id="deleteBtn" class="btn btn-transparent"><i class="fa-regular fa-trash-can"></i></button>
            <!-- ëª¨ë°”ì¼ì—ì„œ ì˜¤í”„ìº”ë²„ìŠ¤ë¥¼ ì—¬ëŠ” ë²„íŠ¼ -->
            <div class="d-md-none p-1" style="display: inline;">
              <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                <i class="fa-brands fa-stack-exchange"></i>
              </button>
            </div>
          </span>
        </div>
      </div>
      <div class="messages">
        <div id="article"></div>
        <div id="mySpinner" class="spinner-grow text-dark" role="status" style="display:none;">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <!-- ìƒˆë¡œ ì±„íŒ…ì°½ì„ ì‹œì‘í•  ë•Œ ì£¼ì œë¥¼ ì…ë ¥ë°›ëŠ” ëª¨ë‹¬ì°½ -->
      <button type="button" id="modalBtn" style="display: none;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="{{ g.user.username }}"></button>
      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="modalForm">
                <div class="mb-3">
                  <label for="chatTopic" class="col-form-label">ì±„íŒ… ì£¼ì œ</label>
                  <input type="text" class="form-control" id="chatTopic" minlength="2" maxlength="30" placeholder="ì£¼ì œë¥¼ 30ì ì´ë‚´ë¡œ ì…ë ¥" autocomplete="off">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
              <button type="submit" class="btn btn-primary" form="modalForm">ì •í•˜ê¸°</button>
            </div>
          </div>
        </div>
      </div>
      <!-- íŠ¹ì • ì£¼ì œì— ëŒ€í•œ GPT ì—­í• ì„ ì§€ì •í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ëª¨ë‹¬ì°½ -->
      <button type="button" id="systemBtn" style="display: none;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#systemModal" data-bs-whatever="{{ g.user.username }}"></button>
      <div class="modal fade" id="systemModal" tabindex="-1" aria-labelledby="systemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="systemModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="systemForm">
                <p class="fs-6"><i class="fa-regular fa-square-check"></i>&nbsp;&nbsp;GPT ëª¨ë¸</p>
                <div id="models" class="mb-3" style="display: flex; justify-content: space-evenly;">
                </div>
                <label for="memoryRange" class="form-label"><i class="fa-regular fa-comment-dots"></i>&nbsp;&nbsp;ê¸°ì–µí•˜ëŠ” ìµœê·¼ ë¬¸ë‹µì˜ ìˆ˜(0~5)</label>
                <input type="range" class="form-range" min="0" max="5" step="1" id="memoryRange" value="1">
                <p class="mt-3 fs-6"><i class="fa-regular fa-image"></i>&nbsp;&nbsp;ì´ë¯¸ì§€ í•´ìƒë„</p>
                <div class="mb-3" style="display: flex; justify-content: space-evenly;">
                  <input type="radio" class="btn-check" name="resolution" id="resolution1" autocomplete="off">
                  <label class="btn" for="resolution1">512</label>
                  <input type="radio" class="btn-check" name="resolution" id="resolution2" autocomplete="off">
                  <label class="btn" for="resolution2">1024</label>
                  <input type="radio" class="btn-check" name="resolution" id="resolution3" autocomplete="off">
                  <label class="btn" for="resolution3">2048</label>
                </div>
                <div class="mb-3">
                  <label for="topicInput" class="col-form-label"><i class="fa-solid fa-t"></i>&nbsp;&nbsp;ëŒ€í™” ì£¼ì œ</label>
                  <input maxlength="100" id="topicInput" name="topic" class="form-control" aria-label="Message" aria-describedby="send-button" autocomplete="off""></input> 
                </div>
                <div class="mb-3">
                  <label for="systemInput" class="col-form-label"><i class="fa-regular fa-keyboard"></i>&nbsp;&nbsp;GPT ì—­í• </label>
                  <textarea maxlength="1500" id="systemInput" name="message" class="form-control" placeholder="1500ì ì´ë‚´ë¡œ ì…ë ¥" aria-label="Message" aria-describedby="send-button" autocomplete="off" rows="5" style="resize: none; overflow-y: auto;"></textarea> 
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
              <button type="submit" class="btn btn-primary" form="systemForm">ì •í•˜ê¸°</button>
            </div>
          </div>
        </div>
      </div>
      <!-- DALL-E API ì„¤ì •ì„ ì§€ì •í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ëª¨ë‹¬ì°½ -->
      <button type="button" id="dalleBtn" style="display: none;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#dalleModal" data-bs-whatever="{{ g.user.username }}"></button>
      <div class="modal fade" id="dalleModal" tabindex="-1" aria-labelledby="dalleModalLabel" aria-hidden="true">   
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="dalleModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="dalleForm">
                <p class="fs-6"><i class="fa-regular fa-square-check"></i>&nbsp;&nbsp;DALL-E ëª¨ë¸</p>
                <div id="imageModelSelection" class="mb-3" style="display: flex; justify-content: space-evenly;">
                </div>
                <label for="numberRange" class="form-label"><i class="fa-solid fa-n"></i>&nbsp;&nbsp;ìƒì„±ë˜ëŠ” ì´ë¯¸ì§€ì˜ ê°œìˆ˜(1~10)</label>
                <input type="range" class="form-range" min="1" max="10" step="1" id="numberRange" value="1">
                <p class="mt-3 fs-6"><i class="fa-regular fa-image"></i>&nbsp;&nbsp;í’ˆì§ˆ</p>
                <div class="mb-3" style="display: flex; justify-content: space-evenly;">
                  <input type="radio" class="btn-check" name="quality" id="quality1" autocomplete="off">
                  <label class="btn" for="quality1">standard</label>
                  <input type="radio" class="btn-check" name="quality" id="quality2" autocomplete="off">
                  <label class="btn" for="quality2">hd</label>
                </div>
                <label for="dalleSize" class="form-label mt-3"><i class="fa-solid fa-expand"></i>&nbsp;&nbsp;í¬ê¸°</label>
                <select id="dalleSize" class="form-select form-select-sm">
                  <option value="256x256">256x256</option>
                  <option value="512x512">512x512</option>
                  <option value="1024x1024">1024x1024</option>
                  <option value="1792x1024">1792x1024</option>
                  <option value="1024x1792">1024x1792</option>
                </select>
                <p class="mt-4 fs-6"><i class="fa-solid fa-pen-fancy"></i>&nbsp;&nbsp;ìŠ¤íƒ€ì¼</p>
                <div class="mb-3" style="display: flex; justify-content: space-evenly;">
                  <input type="radio" class="btn-check" name="dalleStyle" id="style1" autocomplete="off">
                  <label class="btn" for="style1">vivid</label>
                  <input type="radio" class="btn-check" name="dalleStyle" id="style2" autocomplete="off">
                  <label class="btn" for="style2">natural</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
              <button type="submit" class="btn btn-primary" form="dalleForm">ì •í•˜ê¸°</button>
            </div>
          </div>
        </div>
      </div>
      <!-- ê¸€ê¼´ ë° ë°°ê²½ ë””ìì¸ì„ ë³€ê²½í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ëª¨ë‹¬ì°½ -->
      <button type="button" id="designBtn" style="display: none;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paletteModal" data-bs-whatever="{{ g.user.username }}"></button>
      <div class="modal fade" id="paletteModal" tabindex="-1" aria-labelledby="paletteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="paletteModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="paletteForm">
                <label for="fontSelect" class="form-label"><i class="fa-solid fa-font"></i>&nbsp;&nbsp;ê¸€ê¼´</label>
                <select id="fontSelect" class="form-select form-select-sm mb-2" aria-label="Large select example">
                  <option value="inherit">ì‹œìŠ¤í…œ ê¸€ê¼´</option>
                  <option value="MaruBuriExtraLight">ë§ˆë£¨ë¶€ë¦¬ ì•„ì£¼ ê°€ëŠ”</option>
                  <option value="MaruBuriLight">ë§ˆë£¨ë¶€ë¦¬ ê°€ëŠ”</option>
                  <option value="MaruBuri">ë§ˆë£¨ë¶€ë¦¬</option>
                  <option value="MaruBuriBold">ë§ˆë£¨ë¶€ë¦¬ êµµì€</option>
                  <option value="MaruBuriSemiBold">ë§ˆë£¨ë¶€ë¦¬ ì¡°ê¸ˆ êµµì€</option>
                  <option value="NanumGothicLight">ë‚˜ëˆ”ê³ ë”• ê°€ëŠ”</option>
                  <option value="NanumGothic">ë‚˜ëˆ”ê³ ë”• ì¤‘ê°„</option>
                  <option value="NanumGothicBold">ë‚˜ëˆ”ê³ ë”• êµµì€</option>
                  <option value="NanumGothicExtraBold">ë‚˜ëˆ”ê³ ë”• ì•„ì£¼ êµµì€</option>
                  <option value="NanumGothicCodingLigature">ë‚˜ëˆ”ê³ ë”• D2coding ligature</option>
                  <option value="NanumGothicCodingLigatureBold">ë‚˜ëˆ”ê³ ë”• D2coding ligatureBold</option>
                  <option value="NanumGothicCoding">ë‚˜ëˆ”ê³ ë”• D2coding ì¤‘ê°„</option>
                  <option value="NanumGothicCodingBold">ë‚˜ëˆ”ê³ ë”• D2coding êµµì€</option>
                  <option value="NanumGothicEco">ë‚˜ëˆ”ê³ ë”•ì—ì½” ì¤‘ê°„</option>
                  <option value="NanumGothicEcoBold">ë‚˜ëˆ”ê³ ë”•ì—ì½” êµµì€</option>
                  <option value="NanumGothicEcoExtraBold">ë‚˜ëˆ”ê³ ë”•ì—ì½” ì•„ì£¼ êµµì€</option>
                  <option value="NanumMyeongjo">ë‚˜ëˆ”ëª…ì¡° ì¤‘ê°„</option>
                  <option value="NanumMyeongjoBold">ë‚˜ëˆ”ëª…ì¡° êµµì€</option>
                  <option value="NanumMyeongjoExtraBold">ë‚˜ëˆ”ëª…ì¡° ì•„ì£¼ êµµì€</option>
                  <option value="NanumMyeongjoEco">ë‚˜ëˆ”ëª…ì¡°ì—ì½” ì¤‘ê°„</option>
                  <option value="NanumMyeongjoEcoBold">ë‚˜ëˆ”ëª…ì¡°ì—ì½” êµµì€</option>
                  <option value="NanumMyeongjoEcoExtraBold">ë‚˜ëˆ”ëª…ì¡°ì—ì½” ì•„ì£¼ êµµì€</option>
                  <option value="NanumMyeongjoYetHangul">ë‚˜ëˆ”ëª…ì¡°ì˜›í•œê¸€</option>
                  <option value="NanumBarunGothicUltraLight">ë‚˜ëˆ”ë°”ë¥¸ê³ ë”• ì•„ì£¼ ê°€ëŠ”</option>
                  <option value="NanumBarunGothicLight">ë‚˜ëˆ”ë°”ë¥¸ê³ ë”• ê°€ëŠ”</option>
                  <option value="NanumBarunGothic">ë‚˜ëˆ”ë°”ë¥¸ê³ ë”• ì¤‘ê°„</option>
                  <option value="NanumBarunGothicBold">ë‚˜ëˆ”ë°”ë¥¸ê³ ë”• êµµì€</option>
                  <option value="NanumBarunGothicYetHangul">ë‚˜ëˆ”ë°”ë¥¸ê³ ë”•ì˜›í•œê¸€</option>
                  <option value="NanumBarunPen">ë‚˜ëˆ”ë°”ë¥¸íœ ì¼ë°˜ìš© ì¤‘ê°„</option>
                  <option value="NanumBarunPenBold">ë‚˜ëˆ”ë°”ë¥¸íœ ì¼ë°˜ìš© êµµì€</option>
                  <option value="NanumBrush">ë‚˜ëˆ”ì†ê¸€ì”¨ ë¶“</option>
                  <option value="NanumPen">ë‚˜ëˆ”ì†ê¸€ì”¨ íœ</option>
                  <option value="NanumSquareLight">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ê°€ëŠ”</option>
                  <option value="NanumSquare">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ì¤‘ê°„</option>
                  <option value="NanumSquareBold">ë‚˜ëˆ”ìŠ¤í€˜ì–´ êµµì€</option>
                  <option value="NanumSquareExtraBold">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ì•„ì£¼ êµµì€</option>
                  <option value="NanumSquareAcb">ë‚˜ëˆ”ìŠ¤í€˜ì–´ acB</option>
                  <option value="NanumSquareAceb">ë‚˜ëˆ”ìŠ¤í€˜ì–´ acEB</option>
                  <option value="NanumSquareAcl">ë‚˜ëˆ”ìŠ¤í€˜ì–´ acL</option>
                  <option value="NanumSquareAcr">ë‚˜ëˆ”ìŠ¤í€˜ì–´ acR</option>
                  <option value="NanumSquareNeoLight">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ë„¤ì˜¤ ê°€ëŠ”</option>
                  <option value="NanumSquareNeo">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ë„¤ì˜¤</option>
                  <option value="NanumSquareNeoBold">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ë„¤ì˜¤ êµµì€</option>
                  <option value="NanumSquareNeoExtraBold">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ë„¤ì˜¤ ì•„ì£¼ êµµì€</option>
                  <option value="NanumSquareNeoHeavy">ë‚˜ëˆ”ìŠ¤í€˜ì–´ ë„¤ì˜¤ ë¬´ê±°ìš´</option>
                  <option value="NanumSquareRoundLight">ë‚˜ëˆ”ìŠ¤í€˜ì–´ë¼ìš´ë“œ ê°€ëŠ”</option>
                  <option value="NanumSquareRound">ë‚˜ëˆ”ìŠ¤í€˜ì–´ë¼ìš´ë“œ</option>
                  <option value="NanumSquareRoundBold">ë‚˜ëˆ”ìŠ¤í€˜ì–´ë¼ìš´ë“œ êµµì€</option>
                  <option value="NanumSquareRoundExtraBold">ë‚˜ëˆ”ìŠ¤í€˜ì–´ë¼ìš´ë“œ ì•„ì£¼ êµµì€</option>
                  <option value="NanumHumanheavy">ë‚˜ëˆ”íœ´ë¨¼ ë¬´ê±°ìš´</option>
                  <option value="NanumHumanEB">ë‚˜ëˆ”íœ´ë¨¼ ì•„ì£¼ êµµì€</option>
                  <option value="NanumHumanbold">ë‚˜ëˆ”íœ´ë¨¼ êµµì€</option>
                  <option value="NanumHuman">ë‚˜ëˆ”íœ´ë¨¼ ì¤‘ê°„</option>
                  <option value="NanumHumanlight">ë‚˜ëˆ”íœ´ë¨¼ ê°€ëŠ”</option>
                  <option value="NanumHumanEL">ë‚˜ëˆ”íœ´ë¨¼ ì•„ì£¼ ê°€ëŠ”</option>
                </select>
                <p id="fontSample" class="mb-2" style="font-family: 'inherit'; text-align: center;">ì•ˆë…•í•˜ì„¸ìš” | Hello | ä½ å¥½ | ã“ã‚“ã«ã¡ã¯</p>
                <label for="borderSelect" class="form-label mt-3"><i class="fa-regular fa-square"></i>&nbsp;&nbsp;í…Œë‘ë¦¬</label>
                <select id="borderSelect" class="form-select form-select-sm mb-2">
                  <option value="none">í…Œë‘ë¦¬ ì—†ìŒ</option>
                  <option value="border-primary">Primary</option>
                  <option value="border-secondary">Secondary</option>
                  <option value="border-success">Success</option>
                  <option value="border-danger">Danger</option>
                  <option value="border-warning">Warning</option>
                  <option value="border-info">Info</option>
                  <option value="border-light">Light</option>
                  <option value="border-dark">Dark</option>
                </select> 
                <label for="themeSelect" class="form-label mt-3"><i class="fa-solid fa-brush"></i>&nbsp;&nbsp;í…Œë§ˆ</label>
                <select id="themeSelect" class="form-select form-select-sm">
                  <option value="bg-warning text-dark bg-opacity-25">í–‡ì‚´ ë…¸ë‘</option>
                  <option value="bg-light text-dark bg-opacity-50">êµ¬ë¦„ í°ìƒ‰</option>
                  <option value="bg-primary text-dark bg-opacity-10">í•˜ëŠ˜ íŒŒë‘</option>
                  <option value="bg-3030 text-light bg-opacity-75">ì°¨ì½œ ë¸”ë™</option>
                  <option value="bg-secondary text-dark bg-opacity-50">ìŠ¤í‹¸ ê·¸ë ˆì´</option>
                  <option value="bg-black text-white bg-opacity-25">ì€ì€í•œ ì–´ë‘ </option>
                  <option value="bg-success text-dark bg-opacity-25">ì‹±ê·¸ëŸ¬ìš´ ì´ˆë¡</option>
                  <option value="bg-danger text-dark bg-opacity-10">ë”°ëœ»í•œ ë ˆë“œ</option>
                  <option value="bg-info text-dark bg-opacity-50">ë§‘ì€ ë¬¼ë¹›</option>
                  <option value="bg-success text-dark bg-opacity-10">ë§‘ì€ ì•„ì¹¨</option>
                </select>
                <label for="bg-colorSelect" class="form-label mt-3"><i class="fa-solid fa-fill"></i>&nbsp;&nbsp;ë°°ê²½ìƒ‰</label>
                <select id="bg-colorSelect" class="form-select form-select-sm">
                  <option value="#ffcdd2">ì—°í•œ ë¶‰ì€ìƒ‰</option>
                  <option value="#dcedc8">ì—°í•œ ì˜¬ë¦¬ë¸Œ ê·¸ë¦°</option>
                  <option value="#c8e6c9">ì—°í•œ ë…¹ìƒ‰</option>
                  <option value="#d1c4e9">ì—°í•œ ë³´ë¼ìƒ‰</option>
                  <option value="#fce4ec">ì—°í•œ ë¶„í™ìƒ‰</option>
                  <option value="#e3f2fd">í•˜ëŠ˜ìƒ‰</option>
                  <option value="#f8f9fa">ë°ì€ íšŒìƒ‰</option>
                  <option value="#ffffff">í°ìƒ‰</option>
                  <option value="#212121">ê²€ì •</option>
                  <option value="#ffeb3b">ë°ì€ ë…¸ë€ìƒ‰</option>
                  <option value="#90a4ae">ì–´ë‘ìš´ íšŒìƒ‰</option>
                  <option value="#e9ecef">ì°¨ë¶„í•œ íšŒìƒ‰</option>
                </select>
                <label for="toc-styleSelect" class="form-label mt-3"><i class="fa-solid fa-list"></i>&nbsp;&nbsp;ëŒ€í™”ëª©ë¡ ìŠ¤íƒ€ì¼</label>
                <select id="toc-styleSelect" class="form-select form-select-sm">
                  <option value="list-group-item-primary">Primary</option>
                  <option value="list-group-item-secondary">Secondary</option>
                  <option value="list-group-item-success">Success</option>
                  <option value="list-group-item-danger">Danger</option>
                  <option value="list-group-item-warning">Warning</option>
                  <option value="list-group-item-info">Info</option>
                  <option value="list-group-item-light">Light</option>
                  <option value="list-group-item-dark">Dark</option>
                </select>
                <label for="widthRange" class="form-label mt-3"><i class="fa-solid fa-text-width"></i>&nbsp;&nbsp;GPT ë‹µë³€ì°½ì˜ ë„ˆë¹„(6~12)</label>
                <input type="range" class="form-range" min="6" max="12" step="1" id="widthRange" value="9">
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
              <button type="submit" class="btn btn-primary" form="paletteForm">ì •í•˜ê¸°</button>
            </div>
          </div>
        </div>
      </div>
      <div class="input-area">
        <form id="messageForm" style="border: 1px solid black; border-radius: 4px 4px 4px 4px; background-color: #f8f9fa;;">
          <div id="thumbnails">
            <div id="imgSpinner" class="spinner-border" role="status" style="display:none;">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div class="input-group" style="border: none; outline: none;">
            <label id="img-label" for="img"><i class="fa-solid fa-paperclip attach-icon"></i></label>
            <input id="img" type="file" accept="image/*" style="display:none" multiple>
            <textarea required minlength="3" maxlength="15000" id="myInput" name="message" class="form-control" placeholder="í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”" aria-label="Message" aria-describedby="send-button" autocomplete="off" rows="1" style="resize: none; overflow-y: auto;"></textarea> 
            <button id="myBtn" class="btn btn-primary" type="submit" id="send-button"><i class="fa-solid fa-circle-arrow-up"></i></button>
          </div>          
        </form>
      </div>  
    </div>
  </div>
</div>
{% endblock %}
{% block script %}
<script type="module">
  const MODELS = {
    'model1': 'gpt-5.1',
    'model2': 'gpt-5-mini',
    'model3': 'gpt-5-nano',
  }

  const IMAGE_MODELS = {
    'model1': 'dall-e-2',
    'model2': 'dall-e-3',
  }

  const special_characters = {
    'image_generation': '!!',
    'web_search': '??',
    'file_input': '>>',
    'code_interpreter': '%%',
  }

  const defaultModel = MODELS['model1'];
  document.querySelector('body').classList.replace('mt-4', 'mt-2');
  import { createStore } from 'https://cdnjs.cloudflare.com/ajax/libs/redux/5.0.1/redux.legacy-esm.js';
  
  let fontSize = 16; // ê¸°ë³¸ í¬ê¸° (px)
  const articles = document.getElementById("article");

  document.getElementById('fontSelect').addEventListener('change', function () {
    const selectedFont = this.value;
    const fontSample = document.getElementById('fontSample');
    fontSample.style.fontFamily = selectedFont || 'inherit';
  });

  const updateFontSize = () => {
    const textElements = articles.querySelectorAll("*");
    textElements.forEach(el => {
      el.style.fontSize = fontSize + "px";
    });
  };

  function Initialize_textareaTag(sizeDefault = 16){
    const $thumbnails = document.getElementById('thumbnails');
    const children = $thumbnails.children;
    while (children.length > 1) {
      $thumbnails.removeChild(children[0]);
    }
    const $imgInput = document.getElementById('img');
    $imgInput.value = '';

    const $myInput = document.getElementById('myInput')
    $myInput.value = '';
    // $myInput.focus();
    if (sizeDefault != null) {
      fontSize = sizeDefault;
      updateFontSize();
    } 
  }

  function TOC(){
    const state = store.getState();
    const itemStyle = localStorage.getItem('toc-style') || 'list-group-item-secondary';
    let liTags = state.list_items.map(({ id, title }) => `
      <div class="position-relative"><a href='#' data-id=${id} class="subjectItem list-group-item list-group-item-action ${itemStyle} ${state.subject === title ? 'active' : ''}">${title}</a></div>
    `).join('');
    // liTags = '<div class="sideBanner"><button class="btn btn-light chatBtn" style="padding: 0.5rem; margin-top: 0.8rem;"><i class="fa-regular fa-pen-to-square"></i></button></div>' + '<div class="sideItem">' + liTags + '</div>';
    liTags = '<div class="sideItem">' + liTags + '</div>';     
    document.querySelectorAll('.toc').forEach(el => { el.innerHTML = `${liTags}`; });
    // chatBtn í´ë¦­ ì‹œ stateì˜ subjectë¥¼ nullë¡œ, contentë¥¼ ë¹ˆ ë°°ì—´ë¡œ, list_itemsëŠ” ê·¸ëŒ€ë¡œ ë‘ëŠ” dispatch ìš”ì²­ì´ ë“¤ì–´ê°€ì•¼ í•  ê²ƒ. ê·¸ë¦¬ê³  ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì…ë ¥ì°½ì´ í™œì„±í™”ë˜ë©´ì„œ ì‚¬ìš©ì ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ê²Œ í•  ê²ƒ.
    document.querySelectorAll('.chatBtn').forEach(el => {
      el.addEventListener('click', () => {
        store.dispatch({ type: 'UPDATE', content: 'newChat' });
        Initialize_textareaTag(); 
      });
    });
    // ì´ë²¤íŠ¸ ìœ„ì„ì„ ìœ„í•œ ë‹¨ì¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
    document.querySelectorAll('ul.toc').forEach(toc => {
      if (!toc.dataset.listenerAdded) {
        toc.addEventListener('click', async function(e) {
          const subjectItem = e.target.closest('.subjectItem');
          if (!subjectItem) {
            return;
          }
          e.preventDefault();
          const itemId = subjectItem.getAttribute('data-id');
          // data-idê°€ nullì´ ì•„ë‹ ê²½ìš°, ì¦‰ í•´ë‹¹ ëª©ë¡ì´ ì´ë¯¸ ì„œë²„ì¸¡ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ë¼ ìˆëŠ” í•­ëª©ì´ë¼ë©´ fetch ìš”ì²­ ì‹œ idê°’ì„ ì¸ìë¡œ ì „ë‹¬í•´ ëŒ€í™” ë‚´ìš©ì„ ë°›ì•„ì™€ dispatch ìš”ì²­
          // id, subject_id, create_date, role, content
          try {
            const response = await fetch(_URL + `/textgpt/content/${itemId}`);
            if (!response.ok) {
              throw new Error(response.status);
            }

            let answer = null;
            try {
              answer = await response.json(); // JSON íŒŒì‹± ì˜¤ë¥˜ë¥¼ ë¬´ì‹œ
            } catch (jsonError) {
              console.warn('JSON parsing error, continuing:', jsonError);
            }
            // const answer = await response.json();
            // console.log(answer.data);
            store.dispatch({ 
              type: 'UPDATE', 
              content: 'chat', 
              subject: subjectItem.textContent, 
              items: answer ? answer.data : [] // ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ì „ë‹¬
            });

            // store.dispatch({ type: 'UPDATE', content: 'chat', subject: subjectItem.textContent, items: answer.data });
            Initialize_textareaTag();
          } catch (error) {
            console.error('Error:', error);
          }
        }); 
      }
      toc.dataset.listenerAdded = 'true';
    }); 
  }

  // marked ê¸°ë³¸ ì„¤ì •
  marked.setOptions({
    gfm: true,
    breaks: true,
    headerIds: false,
    mangle: false,
    highlight: function(code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      }
      return hljs.highlightAuto(code).value;
    }
  });

  // del(<del>) ë¬´ë ¥í™”
  marked.use({
    renderer: {
      del(text) {
        return text; // <del> íƒœê·¸ë¡œ ë³€í™˜í•˜ì§€ ì•Šê³  ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë§Œ ë°˜í™˜
      }
    },
    tokenizer: {
      del(src) {
        return; // ì•„ì˜ˆ í† í°ì„ ë§Œë“¤ì§€ ì•ŠìŒ
      }
    }
  });

  async function article(){
    const state = store.getState();

    async function fetchThumbnail(url) {
      try {
        const response = await fetch(url.replace('_image', '_thumbnail'));
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }
        const blob = await response.blob();
        return URL.createObjectURL(blob);
      } catch (error) {
        console.error(error);
        return null;  
      }
    }

    async function fetchOriginalImage(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }
        const blob = await response.blob();
        return URL.createObjectURL(blob);
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    const border = localStorage.getItem('border');
    const theme = localStorage.getItem('theme');
    const width = localStorage.getItem('width') || 9;

    const content = state.contents.map(el => {
      // Markdown íŒŒì‹±
      let renderedDesc = marked.parse(el.desc);

      return `
        <div class="row mb-3 ${el.author === 'user' ? 'justify-content-end' : 'justify-content-start'}">
          <div class="col-md-${el.author === 'user' ? 6 : width} col-11">
            <div class="card ${border == 'none' ? '' : border} mb-2">
              <div class="card-body ${theme == '' ? 'bg-light text-dark bg-opacity-50' : theme}">

                <div class="thumbnails" data-url="${el.imgUrl}"></div>

                 <!-- ğŸ“Œ ì²¨ë¶€ íŒŒì¼ ì˜ì—­ -->
                ${el.files && el.files.length > 0 ? `
                  <div class="attached-files mb-2" data-files="${encodeURIComponent(JSON.stringify(el.files))}">
                    ${el.files.map(([id, filename]) => `
                      <div class="file-download" data-id="${id}" title="${filename}">
                        <i class="bi bi-paperclip"></i>
                        <span>${filename}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}

                ${el.imgUrl.length > 0 && el.author === 'assistant'
                  ? `<span style="position: absolute; top: 1.2rem; left: 1.3rem;">
                      <input class="imgCheckBoxes form-check-input" type="checkbox" aria-label="...">
                    </span>`
                  : ''
                }
                <div data-id="${el.id}" class="markDown card-text text-start fs-6 lh-base" style="margin:0;">
                  ${renderedDesc}
                </div>

                <button type="button" class="btn-close delete_message" aria-label="Close"></button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('article').innerHTML = content;

    // MathJax ì²˜ë¦¬
    if (window.MathJax) {
      MathJax.typesetPromise();
    }

    // highlight.js ì‹¤í–‰ + ì¤„ ë²ˆí˜¸ ì ìš©
    document.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
    });
    hljs.initLineNumbersOnLoad();
    updateFontSize();

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
    document.querySelectorAll(".file-download").forEach(el => {
      el.addEventListener("click", async function () {
        const id = this.dataset.id;
        try {
          const res = await fetch(_URL + `/textgpt/serve_file_by_id/${id}`);
          if (!res.ok) throw new Error("Could not download file");

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = this.title;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
        }
      });
    });

    const $currentModel = document.getElementById('currentModel');
    const $dalleSettingBtn = document.getElementById('dalleSettingBtn');
    
    if ($dalleSettingBtn.classList.contains('modeChange')) {
      const model_name = state.model.replace('gpt', 'GPT');
      $currentModel.textContent = model_name;
    } else {
      $currentModel.textContent = state.dalle_model.toUpperCase();
    }
  
    // ì´ë¯¸ì§€ ë¡œë”©
    const thumbnailPromises = state.contents.map(async (el) => {
      const $target = document.querySelector(`div.thumbnails[data-url="${el.imgUrl}"]`);
      if (!($target && Array.isArray(el.imgUrl) && el.imgUrl.length > 0)) {
        return null;
      }
      for (let url of el.imgUrl) {
        // '/' ë¬¸ìì—´ì´ í¬í•¨ë¼ ìˆì§€ ì•Šë‹¤ë©´ _URLì„ ì¶”ê°€í•  ê²ƒ
        if (!(url.includes('/'))) {
          url = _URL + '/textgpt/get_thumbnail/' + url;
        }
        const imgSrc = await fetchThumbnail(url);
        if (imgSrc) {
          const $container = document.createElement('div');
          $container.style.position = 'relative';
          $container.style.display = 'inline-block';
          $container.className = 'imgCard';
          $container.setAttribute('data-id', el.id);

          const $imgElement = document.createElement('img');
          $imgElement.src = imgSrc;
          $imgElement.style.width = '100%;'
          $imgElement.style.paddingBottom = '0.8rem';
          $container.appendChild($imgElement);

          $container.addEventListener('click', async function() {
            url = url.replace("/get_thumbnail/", "/get_image/");
            const originalImageUrl = await fetchOriginalImage(url);
            const img = new Image();
            img.onload = function() {
              const width = this.naturalWidth;
              const height = this.naturalHeight;

              // Open a new window with the size of the original image
              const newWindow = window.open('', '_blank', `width=${width}, height=${height}`);
              newWindow.document.write(`<title>Original Image</title><img src="${originalImageUrl}" style="width:100%;height:100%;object-fit:contain;">`);
              newWindow.document.close();
            };
            img.src = originalImageUrl;
          });

          $target.appendChild($container);
        } 
      }
    });
    await Promise.all(thumbnailPromises);
    // updateFontSize();

    // ìŠ¤í¬ë¡¤
    const chatWindow = document.getElementById('article');
    if (chatWindow.lastElementChild) {
      chatWindow.lastElementChild.scrollIntoView({ behavior : 'smooth' });
    }
  
    const badgeHTML = `${state.subject}<span class="position-absolute top-0 end-0 badge rounded-pill border border-light"> ${state.contents.length / 2}</span>`; 
    const $target = document.querySelectorAll('ul.toc a.active')?.[1] || undefined;
    if ($target) {
      $target.innerHTML = badgeHTML;
      $target.scrollIntoView({ behavior : 'instant' });
    }
  }
    
  function button(){
    const state = store.getState();
    const btnState = state.disabled;
    const $myInput = document.getElementById('myInput');
    const $mySpinner = document.getElementById('mySpinner');
    document.getElementById('myBtn').disabled = btnState;
    if(btnState){
      $myInput.value = '';
      $myInput.style.height = 'auto';
      $myInput.style.height = ($myInput.scrollHeight) + 'px';
      $mySpinner.style.display = 'block';
      $mySpinner.scrollIntoView({ behavior : 'smooth' });
    } else {
      $mySpinner.style.display = 'none';
    }
  }
  
  function modelReset() {
    const $settingBtn = document.getElementById('settingBtn');
    const $dalleSettingBtn = document.getElementById('dalleSettingBtn');
    if ($settingBtn.classList.contains('modeChange')) {
      $settingBtn.classList.toggle('modeChange');
      $dalleSettingBtn.classList.toggle('modeChange');
    }
  }

  function reducer(state, action){
    if(state === undefined){
      return {
        disabled: false,
        list_items:[],
        subject: null,
        system: '',
        model: defaultModel,
        range: 1,
        contents:[],
        images:[],
        resolution: 512,
        dalle_model: 'dall-e-3',
        number_of_images: 1,
        quality_of_image: 'standard',
        size_of_image: '1024x1024',
        style_of_image: 'vivid',
      }
    }
    let newState;
    if(action.type === 'CREATE'){
      // ì‚¬ìš©ì ì§ˆë¬¸ ë˜ëŠ” ChatGPT ì‘ë‹µìœ¼ë¡œ ì¸í•œ CREATE ë°œìƒ ì‹œ contentsì— ë‚´ìš©ì„ ì¶”ê°€í•˜ì—¬ ë Œë”ë§í•¨
      const newContents = [...state.contents];
      const latestImages = [...state.images]; // images ìƒíƒœë¥¼ í´ë¡œì €ë¡œ ìº¡ì²˜
      if(action.author.startsWith('user')){
        // ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³  CREATE type ë°œìƒ ì‹œ ChatGPTì— ì‘ë‹µ ìš”ì²­ì„ ë³´ë‚´ê³ , ê·¸ ì‘ë‹µì„ ë°›ì•„ ì—°ì‡„ì ìœ¼ë¡œ dispatch í˜¸ì¶œ
        newContents.push({author:'user', desc:action.desc, imgUrl:state.images});
        (async () => {
          try {
            const question = {
              'model': state.model,
              'system': state.system,
              'content': action.desc,
              'range': state.range,
              'images': latestImages, // ìº¡ì²˜ëœ images ë°°ì—´ì„ ì‚¬ìš©
              'subject_id': $('.toc a.active')[0]?.getAttribute('data-id') || '',
            };
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(question),
            };
            
            let url_for_request = null;
            switch(action.author) {
              case 'user':
                url_for_request = _URL + '/textgpt/question/';
                break;
              case 'user2':
                url_for_request = _URL + '/textgpt/pdf_file_input/';
                break;
              case 'user3':
                url_for_request = _URL + '/textgpt/web_search/';
                break;
              case 'user4':
                url_for_request = _URL + '/textgpt/code_interpreter/';
                break;
              default:
                url_for_request = _URL + '/textgpt/question/';
            }

            // console.log(action.desc);
            // return
            const response = await fetch(url_for_request, options);
            if(!response.ok){
              throw new Error(response.status);
            }
            const answer = await response.json();
            store.dispatch({type:'CREATE', author:'assistant', desc:answer.response, files:answer?.msg_files ?? []});
          } catch(error) {
            console.error('Error: ', error);
          }
        })();
        const btnFlag = action.author.startsWith('user') ? true : false;
        newState = Object.assign({}, state, {
          contents: newContents,
          disabled: btnFlag, 
        });
      } else if(action.author === 'assistant'){
        newContents.push({author:action.author, desc:action.desc, imgUrl:[], files:action.files});
        // ê°€ì¥ ìµœê·¼ì˜ ì§ˆë¬¸ê³¼ ì‘ë‹µì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê¸° ìœ„í•˜ì—¬ ì„œë²„ì¸¡ì— fetch í˜¸ì¶œ
        // ì „ë‹¬ë˜ëŠ” ì¸ìë¡œëŠ” stateì— ì„¤ì •ëœ ì£¼ì œ ë° ìµœì‹ ì˜ ì§ˆë¬¸ê³¼ ì‘ë‹µ
        (async () => {
          try {
            const latestContents = newContents.slice(-2);
            const _body = {
              "subject": state.subject, // ì—¬ê¸°ì„œëŠ” ë¬¸ìì—´ì„ ê¸°ëŒ€í•˜ê³  ìˆìŒ.
              "model": state.model,
              "range": state.range, 
              "system": state.system,
              "images": latestImages, 
              "content": latestContents,
              "files": action.files,
            };
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(_body),
            };
            const response = await fetch(_URL + '/textgpt/upload/', options);
            if(!response.ok){
              throw new Error(response.status);
            }
            const res = await response.json();
            // console.log(res.msgIds);
            // console.log(res.subjectId);
            store.dispatch({type:'CREATE', author:'initializer', msgIds: res.msgIds, subjectId: res.subjectId});
          } catch(error) {
            console.error('Error: ', error);
          }
        })();
        newState = Object.assign({}, state, {
          contents: newContents,
          images: [],
        });
      } else if (action.author === 'initializer'){
        const _contents = [...state.contents];
        _contents.slice(-2).forEach((obj, index) => {
          obj.id = action.msgIds[index];
        });
        const activeSubjectId = $('.toc a.active')[0]?.getAttribute('data-id');
        if (activeSubjectId == 'null') {
          const newListItems = [...state.list_items];
          newListItems[0].id = action.subjectId;

          // $('.toc a.active').each(function () {
          //   $(this).attr('data-id', action.subjectId);
          // });

          const activeElements = document.querySelectorAll('.toc a.active');
          activeElements.forEach((element) => {
            element.setAttribute('data-id', action.subjectId);
          });

          newState = Object.assign({}, state, {
            contents: _contents,
            list_items: newListItems,
            disabled: false, 
          });
        } else {
          newState = Object.assign({}, state, {
            contents: _contents,
            disabled: false, 
          });
        }
      }
    } else if (action.type === 'IMG_CREATE') {
      // ì‚¬ìš©ì ì§ˆë¬¸ ë˜ëŠ” ChatGPT ì‘ë‹µìœ¼ë¡œ ì¸í•œ CREATE ë°œìƒ ì‹œ contentsì— ë‚´ìš©ì„ ì¶”ê°€í•˜ì—¬ ë Œë”ë§í•¨
      const newContents = [...state.contents];
      const latestImages = [...state.images]; // images ìƒíƒœë¥¼ í´ë¡œì €ë¡œ ìº¡ì²˜
      if(action.author === 'user'){
        // ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³  CREATE type ë°œìƒ ì‹œ ChatGPTì— ì‘ë‹µ ìš”ì²­ì„ ë³´ë‚´ê³ , ê·¸ ì‘ë‹µì„ ë°›ì•„ ì—°ì‡„ì ìœ¼ë¡œ dispatch í˜¸ì¶œ
        newContents.push({author:action.author, desc:action.desc, imgUrl:state.images});
        (async () => {
          try {
            const question = {
              'prompt': action.desc,
              'images': latestImages, // ìº¡ì²˜ëœ images ë°°ì—´ì„ ì‚¬ìš©
              'subject_id': $('.toc a.active')[0]?.getAttribute('data-id') || '',
            };
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(question),
            };

            // console.log(action.desc);
            const response = await fetch(_URL + '/textgpt/generate_image/', options);
            if(!response.ok){
              throw new Error(response.status);
            }
            const answer = await response.json();
            const imgUrlArray = [];
            for (const msgId of answer.msgIds) {
              imgUrlArray.push(_URL + `/textgpt/get_image/${msgId}`);
            }
            // console.log(imgUrlArray);
            store.dispatch({type:'IMG_CREATE', author:'assistant', desc:answer.revised_prompt || '', images: imgUrlArray});
          } catch(error) {
            console.error('Error: ', error);
          }
        })();
        const btnFlag = action.author === 'user' ? true : false;
        newState = Object.assign({}, state, {
          contents: newContents,
          disabled: btnFlag, 
        });
      } else if (action.author === 'user2') {
        // ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³  CREATE type ë°œìƒ ì‹œ ChatGPTì— ì‘ë‹µ ìš”ì²­ì„ ë³´ë‚´ê³ , ê·¸ ì‘ë‹µì„ ë°›ì•„ ì—°ì‡„ì ìœ¼ë¡œ dispatch í˜¸ì¶œ
        newContents.push({author:'user', desc:action.desc, imgUrl:state.images});
        (async () => {
          try {
            const messageIds = $(".imgCheckBoxes:checked").parent().next().map(function() {
              return $(this).attr("data-id");
            }).get();
            
            const question = {
              'model': state.model,
              'images': latestImages, // ìº¡ì²˜ëœ images ë°°ì—´ì„ ì‚¬ìš©
              'prompt': action.desc.slice(2).trim(),
              'msgIds': messageIds,
            };
            
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(question),
            };

            const response = await fetch(_URL + '/textgpt/generate_image_by_imageAPI/', options);
            if(!response.ok){
              throw new Error(response.status);
            }

            const answer = await response.json();
            const imgUrlArray = [];
            for (const msgId of answer.msgIds) {
              imgUrlArray.push(_URL + `/textgpt/get_image/${msgId}`);
            }
            // console.log(imgUrlArray);
            store.dispatch({type:'IMG_CREATE', author:'assistant', desc:answer.revised_prompt || '', images: imgUrlArray});
          } catch(error) {
            console.error('Error: ', error);
          }
        })();
        const btnFlag = action.author === 'user2' ? true : false;
        newState = Object.assign({}, state, {
          contents: newContents,
          disabled: btnFlag, 
        });
      } else if(action.author === 'assistant'){
        newContents.push({author:action.author, desc:action.desc, imgUrl:action.images});
        // ê°€ì¥ ìµœê·¼ì˜ ì§ˆë¬¸ê³¼ ì‘ë‹µì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê¸° ìœ„í•˜ì—¬ ì„œë²„ì¸¡ì— fetch í˜¸ì¶œ
        // ì „ë‹¬ë˜ëŠ” ì¸ìë¡œëŠ” stateì— ì„¤ì •ëœ ì£¼ì œ ë° ìµœì‹ ì˜ ì§ˆë¬¸ê³¼ ì‘ë‹µ
        (async () => {
          try {
            const latestContents = newContents.slice(-2);
            const _body = {
              "subject": state.subject, // ì—¬ê¸°ì„œëŠ” ë¬¸ìì—´ì„ ê¸°ëŒ€í•˜ê³  ìˆìŒ.
              "images": action.images, 
              "source_images": latestImages,
              "content": latestContents,
            };
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(_body),
            };
            const response = await fetch(_URL + '/textgpt/upload_generated_image/', options);
            if(!response.ok){
              throw new Error(response.status);
            }
            const res = await response.json();
            // console.log(res.msgIds);
            // console.log(res.subjectId);
            store.dispatch({type:'CREATE', author:'initializer', msgIds: res.msgIds, subjectId: res.subjectId});
          } catch(error) {
            console.error('Error: ', error);
          }
        })();
        newState = Object.assign({}, state, {
          contents: newContents,
          images: [],
        });
      } else if (action.author === 'initializer'){
        const _contents = [...state.contents];
        _contents.slice(-2).forEach((obj, index) => {
          obj.id = action.msgIds[index];
        });
        const activeSubjectId = $('.toc a.active')[0]?.getAttribute('data-id');
        if (activeSubjectId == 'null') {
          const newListItems = [...state.list_items];
          newListItems[0].id = action.subjectId;

          // $('.toc a.active').each(function () {
          //   $(this).attr('data-id', action.subjectId);
          // });

          const activeElements = document.querySelectorAll('.toc a.active');
          activeElements.forEach((element) => {
            element.setAttribute('data-id', action.subjectId);
          });

          newState = Object.assign({}, state, {
            contents: _contents,
            list_items: newListItems,
            disabled: false, 
          });
        } else {
          newState = Object.assign({}, state, {
            contents: _contents,
            disabled: false, 
          });
        }
      }
    } else if(action.type === 'SUBJECT'){
      if (action.target === 'subject') {
        // ëª¨ë‹¬ì°½ì— ì£¼ì œë¥¼ ì…ë ¥í•˜ê³  ì •í•˜ê¸°ë¥¼ í´ë¦­í•˜ë©´ SUBJECT ë°œìƒ. ë°ì´í„°ë² ì´ìŠ¤ ë°˜ì˜ ì „ì´ë¯€ë¡œ idëŠ” ì—†ìŒ(null)ìœ¼ë¡œ ì„¤ì •.   
        const newListItems = state.list_items.slice();
        newListItems.unshift({
          'id': null,
          'title': action.subject,
        });
        newState = Object.assign({}, state, {
          list_items: newListItems,
          subject: action.subject,
          disabled: false,
        });
      } else if (action.target === 'system') {
        // system ëª¨ë‹¬ì°½ì— ì£¼ì œì— ê´€í•œ gpt ì—­í• ì„ ì…ë ¥í•˜ë©´ ì •í•˜ê¸°ë¥¼ í´ë¦­ ì‹œ
        getChatList();
        newState = Object.assign({}, state, {
          system: action.content,
          model: action.model,
          range: action.range,
          resolution: action.resolution,
          subject: action.title,
        });
      } else if (action.target === 'dalle_system') {
        getChatList();
        newState = Object.assign({}, state, {
          dalle_model: action.model,
          number_of_images: action.number,
          quality_of_image: action.quality,
          size_of_image: action.size,
          style_of_image: action.style,
        });
      }
    } else if(action.type === 'UPDATE'){
      // ì „ë‹¬ë°›ì€ ì£¼ì œ í•­ëª©ì—ì„œ subject.idì™€ subject.titleë§Œìœ¼ë¡œ êµ¬ì„±ëœ ê°ì²´ ë°°ì—´ì„ ìƒì„±í•´ list_itemsì— ì „ë‹¬í•˜ì—¬ í™”ë©´ ê°±ì‹  
      if (action.content === 'list') {
        const _items = action.items.map(el => ({ 
          'id': el.id, 
          'title': el.title,
          'system': el.system,
          'model': el.model,
          'range': el.range,
          'resolution': el.resolution,
          'dalle_model': el.dalle_model,
          'number_of_images': el.number_of_images,
          'quality_of_image': el.quality_of_image,
          'size_of_image': el.size_of_image,
          'style_of_image': el.style_of_image, 
        }));
        // console.log(_items);
        newState = Object.assign({}, state, {
          list_items: _items,
        });
      } else if (action.content === 'chat') {
        modelReset();
        // ë°ì´í„°ë² ì´ìŠ¤ì˜ Message ëª¨ë¸ë¡œë¶€í„° ì „ë‹¬ë°›ì€ ë°°ì—´ ê°ì²´ì—ì„œ contentì™€ roleë§Œì„ ì¶”ì¶œí•´ ìƒˆë¡œìš´ content ìƒì„±
        const _contents = action.items.map(el => ({
          'id': el.id,
          'author': el.role,
          'desc': el.content,
          'imgUrl': el.msg_images,
          'files': el.msg_files,
        }));
        // subjectì—ëŠ” idê°€ ì•„ë‹Œ ë¬¸ìì—´ì´ ë“¤ì–´ê°€ì•¼ í•¨. ëª©ë¡ì„ í´ë¦­í–ˆì„ ë•Œ í´ë¦­í•œ ëª©ë¡ì˜ ë¬¸ìì—´ì„ ë„£ìœ¼ë©´ ë˜ì§€ ì•Šì„ê¹Œ? 153ì¤„ ì°¸ì¡°
        const idx = state.list_items.findIndex(item => item.title === action.subject);
        newState = Object.assign({}, state, {
          subject: action.subject,
          system: state.list_items[idx].system,
          model: state.list_items[idx].model,
          range: state.list_items[idx].range,
          resolution: state.list_items[idx].resolution, 
          images: [],
          contents: _contents,
          dalle_model: state.list_items[idx].dalle_model || 'dall-e-3',
          number_of_images: state.list_items[idx].number_of_images || 1,
          quality_of_image: state.list_items[idx].quality_of_image || 'standard',
          size_of_image: state.list_items[idx].size_of_image || '1024x1024',
          style_of_image: state.list_items[idx].style_of_image || 'vivid',
          });
      } else if (action.content === 'newChat') {
        modelReset();
        // stateì˜ subjectë¥¼ nullë¡œ, contentsë¥¼ ë¹ˆ ë°°ì—´ë¡œ, list_itemsëŠ” ê·¸ëŒ€ë¡œ
        newState = Object.assign({}, state, {
          subject: null,
          system: '',
          model: defaultModel,
          range: 1,
          contents: [],
          images: [],
          resolution: 512,
          dalle_model: 'dall-e-3',
          number_of_images: 1,
          quality_of_image: 'standard',
          size_of_image: '1024x1024',
          style_of_image: 'vivid',
        });
      } else if (action.content === 'reset') {
        modelReset();
        const newList_items = [...state.list_items.slice(0, action.idx), ...state.list_items.slice(action.idx+1)];
        newState = Object.assign({}, state, {
          subject: null,
          list_items: newList_items,
          system: '',
          model: defaultModel,
          range: 1,
          contents: [],
          images: [],
          resolution: 512,
          dalle_model: 'dall-e-3',
          number_of_images: 1,
          quality_of_image: 'standard',
          size_of_image: '1024x1024',
          style_of_image: 'vivid',
        });
      } else if (action.content === 'add_images') {
        newState = Object.assign({}, state, {
          images: [...state.images, ...action.images],
        });
      } else if (action.content === 'delete_image') {
        const _idx = state.images.findIndex(item => item === action.imageStr);
        if (_idx != -1) {
          newState = Object.assign({}, state, {
            images: [...state.images.slice(0, _idx), ...state.images.slice(_idx + 1)],
          });
        } 
      } else if (action.content === 'delete_messages') {
        const targetIdsSet = new Set(action.targetIds); // Setìœ¼ë¡œ ë³€í™˜í•´ ë¹ ë¥¸ ì¡°íšŒ ê°€ëŠ¥
        newState = {
          ...state,
          contents: state.contents.filter(item => !targetIdsSet.has(item.id)), // ì‚­ì œ ëŒ€ìƒ í•„í„°ë§
        };
        // console.log('SET!');
      }
    }
    return newState;
  }
  // ì„œë²„ë¡œë¶€í„° ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ì£¼ì œ í•­ëª©ë“¤ì„ ê°€ë‚˜ë‹¤ ìˆœìœ¼ë¡œ ë°›ì•„ì˜¤ê³  dispatch í˜¸ì¶œ ì‹œ ì´ë¥¼ ì¸ìë¡œ ì „ë‹¬í•¨. 
  // id, user_id, title, system, create_date ë“±
  const getChatList = async () => {
    let response;
    try {
      const searchWord = localStorage.getItem('kw') || '';
      if (searchWord) {
        response = await fetch(_URL + `/textgpt/chatlist/${encodeURIComponent(searchWord)}`, {
          method: 'GET',
        });
      } else {
        response = await fetch(_URL + '/textgpt/chatlist/');
      }
      if(!response.ok){
        throw new Error(response.status);
      } else if(response.status === 204){
        console.log('No Content');
        return
      }
      const answer = await response.json();
      store.dispatch({type:'UPDATE', content:'list', items:answer.data});
      document.getElementById('searchInput').placeholder = searchWord;
      document.getElementById('searchInput2').placeholder = searchWord;
    } catch(error) {
      console.error('Error: ', error);
    }
  }
  
  const productionURL = 'http://121.189.157.152:8080';
  const testURL = 'http://127.0.0.1:8080';
  const localURL = 'http://172.30.1.25:8080';
  let _URL = null;
  if (window.location.href.split('/')[2] === '127.0.0.1:8080'){
    _URL = testURL;
  } else if (window.location.href.split('/')[2] === '172.30.1.25:8080'){
    _URL = localURL;
  } else {
    _URL = productionURL;
  }

  const store = createStore(reducer, window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__());
  window.store = store;
  store.subscribe(TOC);
  store.subscribe(article);
  store.subscribe(button);
  getChatList(); 

  // ì£¼ì œì— ë¬¸ìì—´ì— ì¶”ê°€í•  ì‚¬ìš©ì ì§€ì • ì‹œê°„ í¬ë§·ì„ ì •ì˜
  Date.prototype.customFormat = function() {
    const yyyy = this.getFullYear();
    const MM = this.getMonth() < 9 ? `0${this.getMonth() + 1}` : this.getMonth() + 1;
    const dd = this.getDate() < 10 ? `0${this.getDate()}` : this.getDate();
    const HH = this.getHours() < 10 ? `0${this.getHours()}` : this.getHours();
    const mm = this.getMinutes() < 10 ? `0${this.getMinutes()}` : this.getMinutes();
    const ss = this.getSeconds() < 10 ? `0${this.getSeconds()}` : this.getSeconds(); 
    return `${yyyy}${MM}${dd}_${HH}:${mm}:${ss}`;
  }

  window.onload = function(){
    const $modelsDiv = document.getElementById('models');
    const modelHTML = Object.entries(MODELS).map(item => {
      return `
        <input type="radio" class="btn-check" name="models" id="${item[0]}" autocomplete="off">
        <label class="btn" for="${item[0]}">${item[1]}</label>
      `
    }).join('');
    $modelsDiv.innerHTML = modelHTML;

    const imageModelHTML = Object.entries(IMAGE_MODELS).map(item => {
      return `
        <input type="radio" class="btn-check" name="dallemodels" id="${item[1]}" autocomplete="off">
        <label class="btn" for="${item[1].toLowerCase()}">${item[1]}</label>
      `
    }).join('');
    $("#imageModelSelection").html(imageModelHTML);

    const $myInput = document.getElementById('myInput');
    // ë©”ì‹œì§€ ì…ë ¥ì°½ì—ì„œ ì¤„ë°”ê¿ˆì´ ì¼ì–´ë‚¬ì„ ë•Œ ìŠ¤í¬ë¡¤ ë‚´ ë†’ì´ë¥¼ ì¡°ì •í•´ ì‚¬ìš©ìê°€ ì…ë ¥í•˜ëŠ” ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆë„ë¡ í•¨.
    $myInput.addEventListener('input', () => {
      $myInput.style.height = 'auto';
      $myInput.style.height = ($myInput.scrollHeight) + 'px';
    });

    document.getElementById('article').style.fontFamily = localStorage.getItem('font') || 'inherit';
    const listElems = document.querySelectorAll('.toc');
    listElems.forEach((toc) => {
      toc.style.fontFamily = localStorage.getItem('font') || 'inherit';
    });
    document.getElementById('sidebar').style.backgroundColor = localStorage.getItem('bg-color') || '#e9ecef';
    document.getElementById('chatWindow').style.backgroundColor = localStorage.getItem('bg-color') || '#e9ecef';
    const selectedBgColor = localStorage.getItem('bg-color');
    const $buttons = document.querySelectorAll('.btn-transparent');
    const $model = document.getElementById('currentModel');
    
    if (selectedBgColor === '#212121') {
      $buttons.forEach(button => {
        const icon = button.querySelector('i');
        if (icon) {
          icon.style.color = 'white';
        }
      });
      $model.style.color = 'white';
      document.getElementById('mySpinner').classList.remove('text-dark');
      document.getElementById('mySpinner').classList.add('text-light');
    } else {
      $buttons.forEach(button => {
        const icon = button.querySelector('i');
        if (icon) {
          icon.style.color = 'black';
        }
      });
      $model.style.color = 'black';
      document.getElementById('mySpinner').classList.remove('text-light');
      document.getElementById('mySpinner').classList.add('text-dark');
    }
    // 'ì „ì†¡' í´ë¦­ ì‹œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ë‚´ìš©ì„ ì •ì˜ stateì˜ subjectê°€ nullë¡œ ë¹„ì–´ìˆì„ ê²½ìš°ì—ëŠ” ë©”ì‹œì§€ ì „ì†¡ì´ ì•„ë‹Œ ëª¨ë‹¬ì°½ì´ ë„ì›Œì§€ë©°, ì´ë¯¸ subjectê°€ ìˆì„ ì‹œì—ëŠ” ì…ë ¥ì°½ì˜ ë©”ì‹œì§€ë¥¼ ChatGPTì— ì§ˆì˜í•¨.
    document.getElementById('messageForm').addEventListener('submit', function(event){
      event.preventDefault();
      if (!!store.getState().subject) {
        const _author = 'user';
        const _desc = event.target.message.value.trim();
        
        const currentModel = document.getElementById('currentModel').textContent.toLowerCase().trim();
        const imageModelFlag = Object.values(IMAGE_MODELS).includes(currentModel);
        const addtionalFeaturesFlag = Object.values(special_characters).some(el => _desc.startsWith(el));
        
        if (imageModelFlag) {
          store.dispatch({type:'IMG_CREATE', author:_author, desc: _desc});
        } else if (addtionalFeaturesFlag) {
          const featureKey = Object.keys(special_characters).find(key => _desc.startsWith(special_characters[key]));
          switch (featureKey) {
            case 'image_generation':
              console.log('ì´ë¯¸ì§€ ìƒì„± ê¸°ëŠ¥ ì‹¤í–‰');
              store.dispatch({type:'IMG_CREATE', author:'user2', desc: _desc});
              break;
            case 'file_input':
              console.log('íŒŒì¼ ì…ë ¥ ê¸°ëŠ¥ ì‹¤í–‰');
              store.dispatch({type:'CREATE', author:'user2', desc: _desc});
              break;
            case 'web_search':
              console.log('ì›¹ ê²€ìƒ‰ ê¸°ëŠ¥ ì‹¤í–‰');
              store.dispatch({type:'CREATE', author:'user3', desc: _desc});
              break;
            case 'code_interpreter':
              console.log('ì½”ë“œ ì¸í„°í”„ë¦¬í„° ê¸°ëŠ¥ ì‹¤í–‰');
              store.dispatch({type:'CREATE', author:'user4', desc: _desc});
              break;
            default:
              console.log('ì•Œ ìˆ˜ ì—†ëŠ” ê¸°ëŠ¥');
          }
        } else {
          store.dispatch({type:'CREATE', author:_author, desc: _desc});
        }
        Initialize_textareaTag(null); 
      } else {
        $('#modalBtn').click();
      }
    });

    document.getElementById('searchForm').addEventListener('submit', async function(event) {
      event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€
      const searchInput = event.target.searchInput.value.trim(); // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° ë° ê³µë°± ì œê±°
      localStorage.setItem('kw', searchInput);
      try {
        getChatList();
      } catch (error) {
        console.error('Fetch error:', error);
      }
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      event.target.searchInput.value = '';
      event.target.searchInput.placeholder = searchInput;
    });

    document.getElementById('searchForm2').addEventListener('submit', async function(event) {
      event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€
      const searchInput = event.target.searchInput2.value.trim(); // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° ë° ê³µë°± ì œê±°
      localStorage.setItem('kw', searchInput);
      try {
        getChatList();
      } catch (error) {
        console.error('Fetch error:', error);
      }
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      event.target.searchInput2.value = '';
      event.target.searchInput2.placeholder = searchInput;
    });

    // ëª¨ë‹¬ì°½ì˜ ì„¸ë¶€ í•­ëª©ì˜ ë‚´ìš© ì§€ì •í•˜ê¸°
    const exampleModal = document.getElementById('exampleModal')
    if (exampleModal) {
      exampleModal.addEventListener('show.bs.modal', event => {
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = exampleModal.querySelector('.modal-title')
        const modalBodyInput = exampleModal.querySelector('.modal-body input')
        modalTitle.textContent = `${recipient} ë‹˜, ì±„íŒ…ë°©ì˜ ì£¼ì œë¥¼ ì •í•´ì£¼ì„¸ìš”.`;
      })
    }
    // system ëª¨ë‹¬ì°½ì˜ ì„¸ë¶€ í•­ëª©ì˜ ë‚´ìš© ì§€ì •í•˜ê¸°
    const systemModal = document.getElementById('systemModal')
    if (systemModal) {
      systemModal.addEventListener('show.bs.modal', event => {
        // í¬ì»¤ìŠ¤ë¥¼ ì²« ë²ˆì§¸ ì…ë ¥ ìš”ì†Œë¡œ ì´ë™
        systemModal.querySelector('input, textarea, button').focus();
        systemModal.setAttribute('aria-hidden', 'false');
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = systemModal.querySelector('.modal-title')
        const modalBodyInput = systemModal.querySelector('.modal-body input')
        modalTitle.textContent = 'GPT Preferences';
      });

      systemModal.addEventListener('hidden.bs.modal', function () {
        // í¬ì»¤ìŠ¤ë¥¼ ëª¨ë‹¬ì„ ì—° ë²„íŠ¼ìœ¼ë¡œ ë³µì›
        document.getElementById('systemBtn').focus();
        systemModal.setAttribute('aria-hidden', 'true');
      });
    }
    // dall-e ëª¨ë‹¬ì°½ì˜ ì„¸ë¶€ í•­ëª©ì˜ ë‚´ìš© ì§€ì •í•˜ê¸°
    const dalleModal = document.getElementById('dalleModal')
    if (dalleModal) {
      dalleModal.addEventListener('show.bs.modal', event => {
        // í¬ì»¤ìŠ¤ë¥¼ ì²« ë²ˆì§¸ ì…ë ¥ ìš”ì†Œë¡œ ì´ë™
        dalleModal.querySelector('input, button').focus();
        dalleModal.setAttribute('aria-hidden', 'false');
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = dalleModal.querySelector('.modal-title')
        const modalBodyInput = dalleModal.querySelector('.modal-body input')
        modalTitle.textContent = 'DALL-E Preferences';
      });

      dalleModal.addEventListener('hidden.bs.modal', function () {
        // í¬ì»¤ìŠ¤ë¥¼ ëª¨ë‹¬ì„ ì—° ë²„íŠ¼ìœ¼ë¡œ ë³µì›
        document.getElementById('dalleBtn').focus();
        dalleModal.setAttribute('aria-hidden', 'true');
      });
    }
    // palette ëª¨ë‹¬ì°½ì˜ ì„¸ë¶€ í•­ëª©ì˜ ë‚´ìš© ì§€ì •í•˜ê¸°
    const paletteModal = document.getElementById('paletteModal')
    if (paletteModal) {
      paletteModal.addEventListener('show.bs.modal', event => {
        // í¬ì»¤ìŠ¤ë¥¼ ì²« ë²ˆì§¸ ì…ë ¥ ìš”ì†Œë¡œ ì´ë™
        paletteModal.querySelector('input, button').focus();
        paletteModal.setAttribute('aria-hidden', 'false');
        // Button that triggered the modal
        const button = event.relatedTarget
        // Extract info from data-bs-* attributes
        const recipient = button.getAttribute('data-bs-whatever')
        const modalTitle = paletteModal.querySelector('.modal-title')
        const modalBodyInput = paletteModal.querySelector('.modal-body input')
        modalTitle.textContent = 'ê¸€ê¼´ ë° ë””ìì¸ ì„¤ì •';
        // LocalStorageì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const savedFont = localStorage.getItem('font');
        const savedBorder = localStorage.getItem('border');
        const savedTheme = localStorage.getItem('theme');
        const savedColor = localStorage.getItem('bg-color');
        const savedStyle = localStorage.getItem('toc-style');
        const savedWidth = localStorage.getItem('width');

        // ê° select ìš”ì†Œ
        const fontSelect = document.getElementById('fontSelect');
        const borderSelect = document.getElementById('borderSelect');
        const themeSelect = document.getElementById('themeSelect');
        const bgcolorSelect = document.getElementById('bg-colorSelect');
        const tocstyleSelect = document.getElementById('toc-styleSelect');
        const widthSelect = document.getElementById('widthRange');

        // ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì„ íƒ
        if (savedFont) {
          fontSelect.value = savedFont;
          document.getElementById('fontSample').style.fontFamily = savedFont;
        }
        if (savedBorder) {
          borderSelect.value = savedBorder;
        }
        if (savedTheme) {
          themeSelect.value = savedTheme;
        }
        if (savedColor) {
          bgcolorSelect.value = savedColor;
        }
        if (savedStyle) {
          tocstyleSelect.value = savedStyle;
        }
        if (savedWidth) {
          widthSelect.value = savedWidth;
        }
      });

      paletteModal.addEventListener('hidden.bs.modal', function () {
        // í¬ì»¤ìŠ¤ë¥¼ ëª¨ë‹¬ì„ ì—° ë²„íŠ¼ìœ¼ë¡œ ë³µì›
        document.getElementById('paletteBtn').focus();
        paletteModal.setAttribute('aria-hidden', 'true');
      });
    }
    // ëª¨ë‹¬ì°½ì—ì„œ 'ì •í•˜ê¸°'ë¥¼ í´ë¦­í–ˆì„ ì‹œ, ì…ë ¥í•œ ì£¼ì œëª…ì— ì‚¬ìš©ì ì§€ì • ì‹œê°„ í¬ë§·ì„ ì¶”ê°€í•˜ê³  ì´ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•œ dispatch í˜¸ì¶œ. ì§ˆë¬¸ ì…ë ¥ì°½ì— ê°’ì´ ìˆì„ ì‹œì—ë§Œ 'ì „ì†¡'ì„ ìë™ìœ¼ë¡œ í´ë¦­.
    document.getElementById('modalForm').addEventListener('submit', event => {
      event.preventDefault();
      const date = new Date();
      const _subject = document.getElementById('chatTopic').value + ' ' + date.customFormat();
      store.dispatch({type:'SUBJECT', target:'subject', subject:_subject });
      $('#exampleModal').modal('hide');
      if(document.getElementById('myInput').value){
        $('#myBtn').click();
      }
    });
    // system ëª¨ë‹¬ì°½ì—ì„œ 'ì •í•˜ê¸°'ë¥¼ í´ë¦­í–ˆì„ ì‹œ, ì£¼ì œì— GPT ì—­í• ì„ ë°˜ì˜í•˜ê¸° ìœ„í•œ dispatch í˜¸ì¶œ.
    document.getElementById('systemForm').addEventListener('submit', event => {
      event.preventDefault();
      const selectedModelLabel = document.querySelector('input[name="models"]:checked').nextElementSibling.textContent;  // ì²´í¬ëœ ë¼ë””ì˜¤ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ ê°’ ê°€ì ¸ì˜¤ê¸°
      const range_val = document.getElementById('memoryRange').value;
      const selectedResolutionLabel = document.querySelector('input[name="resolution"]:checked').nextElementSibling.textContent;
      const gpt_role = document.getElementById('systemInput').value;
      const topic_val = document.getElementById('topicInput').value;
      $('#systemModal').modal('hide');
      (async () => {
        const _id = $('.toc a.active')[0].getAttribute('data-id');
        try {
          const update = {
            'id': _id,
            'system': gpt_role,
            'range': range_val,
            'resolution': selectedResolutionLabel,
            'model': selectedModelLabel,
            'topic': topic_val,
          };
          const options = {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(update),
          };
          const response = await fetch(_URL + '/textgpt/update/system/', options);
          if(!response.ok){
            throw new Error(response.status);
          }
          const answer = await response.json();
          // console.log(answer);
          store.dispatch({type:'SUBJECT', target:'system', content: gpt_role, range: range_val, model: selectedModelLabel.toLowerCase(), title: topic_val, resolution: selectedResolutionLabel});
        } catch(error) {
          console.error('Error: ', error);
        }
      })();
    });
    // dalle ëª¨ë‹¬ì°½ì—ì„œ 'ì •í•˜ê¸°'ë¥¼ í´ë¦­í–ˆì„ ì‹œ, ì£¼ì œì— dalle ì„¤ì •ì„ ë°˜ì˜í•˜ê¸° ìœ„í•œ dispatch í˜¸ì¶œ.
    document.getElementById('dalleForm').addEventListener('submit', event => {
      event.preventDefault();
      const selectedModelLabel = document.querySelector('input[name="dallemodels"]:checked').nextElementSibling.textContent.toLowerCase();  // ì²´í¬ëœ ë¼ë””ì˜¤ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ ê°’ ê°€ì ¸ì˜¤ê¸°
      const range_val = document.getElementById('numberRange').value;
      const selectedQualityInput = document.querySelector('input[name="quality"]:checked');
      const selectedQualityLabel = selectedQualityInput ? selectedQualityInput.nextElementSibling.textContent : 'standard';
      const selectedSize = document.getElementById('dalleSize').value;
      const selectedStyleInput = document.querySelector('input[name="dalleStyle"]:checked');
      const selectedStyleLabel = selectedStyleInput ? selectedStyleInput.nextElementSibling.textContent : 'vivid';
      $('#dalleModal').modal('hide');
      // console.log(`model: ${selectedModelLabel}, range_val: ${range_val}, quality: ${selectedQualityLabel}, size: ${selectedSize}, style: ${selectedStyleLabel}`);
      (async () => {
        const _id = $('.toc a.active')[0].getAttribute('data-id');
        try {
          const update = {
            'id': _id,
            'dalle_model': selectedModelLabel,
            'number_of_images': range_val,
            'quality_of_image': selectedQualityLabel,
            'size_of_image': selectedSize,
            'style_of_image': selectedStyleLabel,
          };
          const options = {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(update),
          };
          const response = await fetch(_URL + '/textgpt/update/dalle_setting/', options);
          if(!response.ok){
            throw new Error(response.status);
          }
          const answer = await response.json();
          // console.log(answer);
          store.dispatch({type:'SUBJECT', target:'dalle_system', model: selectedModelLabel, number: range_val, quality: selectedQualityLabel, size: selectedSize, style: selectedStyleLabel});
        } catch(error) {
          console.error('Error: ', error);
        }
      })();
    });
    // palette ëª¨ë‹¬ì°½ì—ì„œ 'ì •í•˜ê¸°'ë¥¼ í´ë¦­í–ˆì„ ì‹œ, ê¸€ê¼´ê³¼ ë°°ê²½ë””ìì¸ì„ í™”ë©´ì— ë°˜ì˜í•˜ê¸° ìœ„í•œ dispatch í˜¸ì¶œ
    document.getElementById('paletteForm').addEventListener('submit', event => {
      event.preventDefault();
      const selectedFont = document.getElementById('fontSelect').value;
      const selectedBorder = document.getElementById('borderSelect').value;
      const selectedTheme = document.getElementById('themeSelect').value;
      const selectedBgColor = document.getElementById('bg-colorSelect').value;
      const selectedStyle = document.getElementById('toc-styleSelect').value;
      const selectedWidth = document.getElementById('widthRange').value;
      const $sidebar = document.getElementById('sidebar');
      const $chatWindow = document.getElementById('chatWindow');
      document.getElementById('article').style.fontFamily = selectedFont;
      
      const listElems = document.querySelectorAll('.toc');
      listElems.forEach((toc) => {
        toc.style.fontFamily = selectedFont;
      });

      const subjectItems = document.querySelectorAll('.subjectItem');
      const regex = /^list-group-item-(?!a)\w*/;

      subjectItems.forEach(elem => {
        // ìš°ì„  í´ë˜ìŠ¤ ë°°ì—´ì„ ë³µì‚¬í•˜ì—¬ ë³€ê²½í•  í´ë˜ìŠ¤ëª…ë“¤ì„ ì €ì¥í•˜ê¸° ìœ„í•¨
        const classListArray = Array.from(elem.classList);
        
        classListArray.forEach(cls => {
          const flag = regex.test(cls);
          if (flag) {
            elem.classList.remove(cls); // í´ë˜ìŠ¤ ì‚­ì œ
          }
        });
        
        // ì‚¬ìš©ìê°€ ì›í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡
        elem.classList.add(selectedStyle);
      });

      const $spinner = document.getElementById('mySpinner');
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        // ê¸°ì¡´ 'border-*' í´ë˜ìŠ¤ ì œê±°
        card.classList.forEach(cls => {
          if (cls.startsWith('border-')) {
            card.classList.remove(cls);
          }
        });
        // ìƒˆë¡œìš´ 'border-dark' í´ë˜ìŠ¤ ì¶”ê°€
        if (selectedBorder != 'none') {
          card.classList.add(selectedBorder);
        }
      });
      const cardBody = document.querySelectorAll('.card-body');
      cardBody.forEach(card => {
        // ê¸°ì¡´ì˜ 'bg-* text-* bg-opacity-*' í´ë˜ìŠ¤ ì œê±°
        card.classList.remove(...Array.from(card.classList).filter(cls => 
          cls.startsWith('bg-') || cls.startsWith('text-') || cls.startsWith('bg-opacity-')
        ));

        // ì„ íƒëœ ìƒˆë¡œìš´ í´ë˜ìŠ¤ ì¶”ê°€
        card.classList.add(...selectedTheme.split(' '));
      });

      // ëª¨ë“  'justify-content-start' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ div ìš”ì†Œë¥¼ ì„ íƒ
      const startDivs = document.querySelectorAll('#article .justify-content-start');

      // ê° divì˜ ìì‹ ìš”ì†Œë¥¼ ê²€ì‚¬
      startDivs.forEach(div => {
        // col-md-ë¡œ ì‹œì‘í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìì‹ ìš”ì†Œë¥¼ ì°¾ìŒ
        const colMdElement = div.querySelector('[class*="col-md-"]');

        if (colMdElement) {
          // ê¸°ì¡´ í´ë˜ìŠ¤ ì¤‘ 'col-md-'ë¡œ ì‹œì‘í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì œê±°
          colMdElement.classList.forEach(className => {
            if (className.startsWith('col-md-')) {
              colMdElement.classList.remove(className);
            }
          });

          // 'col-md-11' í´ë˜ìŠ¤ ì¶”ê°€
          colMdElement.classList.add(`col-md-${selectedWidth}`);
        }
      });

      const $buttons = document.querySelectorAll('.btn-transparent');
      const $model = document.getElementById('currentModel');
      if (selectedBgColor === '#212121') {
        $buttons.forEach(button => {
          const icon = button.querySelector('i');
          if (icon) {
            icon.style.color = 'white';
          }
        });
        $model.style.color = 'white';
        if ($spinner.classList.contains('text-dark')) {
          document.getElementById('mySpinner').classList.remove('text-dark');
          document.getElementById('mySpinner').classList.add('text-light');
        }
      } else {
        $buttons.forEach(button => {
          const icon = button.querySelector('i');
          if (icon) {
            icon.style.color = 'black';
          }
        });
        $model.style.color = 'black';
        if ($spinner.classList.contains('text-light')) {
          document.getElementById('mySpinner').classList.remove('text-light');
          document.getElementById('mySpinner').classList.add('text-dark');
        }
      }
      
      $sidebar.style.backgroundColor = selectedBgColor;
      $chatWindow.style.backgroundColor = selectedBgColor;
      localStorage.setItem('font', selectedFont);
      localStorage.setItem('border', selectedBorder);
      localStorage.setItem('theme', selectedTheme);
      localStorage.setItem('bg-color', selectedBgColor);
      localStorage.setItem('toc-style', selectedStyle);
      localStorage.setItem('width', selectedWidth);
      $('#paletteModal').modal('hide');
    });
    // ë°°ë„ˆì— ìˆëŠ” '#deleteBtn' í´ë¦­ ì‹œ, stateì˜ subjectë¥¼ ì¸ìë¡œ ì „ë‹¬í•˜ë©° í•´ë‹¹ ì£¼ì œ ë° ëŒ€í™”ê¸€ì˜ ì‚­ì œë¥¼ ìœ„í•œ fetch ìš”ì²­ì„ ìˆ˜í–‰í•¨
    // ì‚­ì œ ìš”ì²­ ì „ ì‚¬ìš©ìì—ê²Œ ì„ íƒì— ëŒ€í•´ í™•ì¸í•˜ëŠ” ì ˆì°¨ë¥¼ ê±°ì¹  ê²ƒ
    // fetch ìš”ì²­ í›„ ì‚­ì œ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ. ì´í›„ ì´ˆê¸°í™”
    document.getElementById('deleteBtn').addEventListener('click', async event => {
      const activeItems = $('.toc a.active');
      if (!activeItems.length) {
        return;
      }
      const state = store.getState();
      const itemId = activeItems[0].getAttribute('data-id');
      if(confirm(`${state.subject} ì£¼ì œì˜ ë° ëª¨ë“  ëŒ€í™” ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
        const _idx = state.list_items.findIndex(item => item.title === state.subject);
        try {
          const response = await fetch(_URL + `/textgpt/delete/${itemId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          if (!response.ok){
            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
          }
          const result = await response.json();
          // console.log(result);
          alert("ì •ìƒì ìœ¼ë¡œ ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤.")
          // ì‚­ì œ ì™„ë£Œ í›„ ì´ˆê¸°í™” ì‘ì—…
          store.dispatch({ type: 'UPDATE', content: 'reset', idx:_idx });
        } catch (error) {
          console.error('Error: ', error);
          alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
        }
      } else {
        alert("ì‘ì—…ì„ ì·¨ì†Œí•˜ì…¨ìŠµë‹ˆë‹¤.")
      }
    });

    document.getElementById('settingBtn').addEventListener('click', () => {
      const state = store.getState();
      const activeItems = $('.toc a.active');
      if (!activeItems.length) {
        return;
      }

      const modelStr = Object.entries(MODELS).filter(model => model[1] === state.model)[0];
      const modelTag = '#'.concat(modelStr);
      const $elem = $(modelTag);
      $elem.prop('checked', true);
      
      const resolutions = {
        '512': '#resolution1',
        '1024': '#resolution2',
        '2048': '#resolution3'
      };
      let $resElem = resolutions[state.resolution.toString()];
      if($resElem) {
        $($resElem).prop('checked', true);
      }
      
      $('#systemInput').val(state.system);
      $('#memoryRange').val(state.range);
      $('#topicInput').val(state.subject);
      $('#systemBtn').click();
    });

    document.getElementById('dalleSettingBtn').addEventListener('click', () => {
      const state = store.getState();
      const activeItems = $('.toc a.active');
      if (!activeItems.length) {
        return;
      }

      const $elem = (state.dalle_model === 'dall-e-3' ? $('#dall-e-3') : $('#dall-e-2'));
      $elem.prop('checked', true);

      const $dalleForm = document.getElementById('dalleForm');
      const $dalle3Radio = document.getElementById('dall-e-3');
      const $dalle2Radio = document.getElementById('dall-e-2');
      const $numberRange = document.getElementById('numberRange');
      const $quality1 = document.getElementById('quality1');
      const $quality2 = document.getElementById('quality2');
      const $style1 = document.getElementById('style1');
      const $style2 = document.getElementById('style2');
      const $dalleSize = document.getElementById('dalleSize');
      const $sizeOptions = $dalleSize.querySelectorAll('option');

      const handleModelChange = () => {
        if ($dalle2Radio.checked) {
          // Disable 'hd', 'style' option
          $numberRange.removeAttribute('disabled');
          $quality1.checked = false;
          $quality2.checked = false;
          $style1.checked = false;
          $style2.checked = false;
          const temp = ['256x256', '512x512'];
          $sizeOptions.forEach(option => {
            if(temp.includes(option.value)) {
              option.removeAttribute('disabled');
            }
          });
          document.querySelector('select option[value="1024x1024"]').selected = true;
          $quality1.setAttribute('disabled', true);
          $quality2.setAttribute('disabled', true);
          $style1.setAttribute('disabled', true);
          $style2.setAttribute('disabled', true);
          const targets = ['1024x1792', '1792x1024'];
          $sizeOptions.forEach(option => {
            if(targets.includes(option.value)) {
              option.setAttribute('disabled', true);
            }
          });
        } else {
          // Enable 'hd', 'style' option
          const temp = ['1024x1792', '1792x1024'];
          $sizeOptions.forEach(option => {
            if(temp.includes(option.value)) {
              option.removeAttribute('disabled');
            }
          });
          document.querySelector('select option[value="1024x1024"]').selected = true;
          $numberRange.value = '1';
          $numberRange.setAttribute('disabled', true);
          $quality1.removeAttribute('disabled');
          $quality2.removeAttribute('disabled');
          $style1.removeAttribute('disabled');
          $style2.removeAttribute('disabled');
          $quality1.checked = true;
          $style1.checked = true;
          const targets = ['256x256', '512x512'];
          $sizeOptions.forEach(option => {
            if(targets.includes(option.value)) {
              option.setAttribute('disabled', true);
            }
          });
        }
      };
      $dalle3Radio.addEventListener('change', handleModelChange);
      $dalle2Radio.addEventListener('change', handleModelChange);
      handleModelChange();

      const qualities = {
        'standard': '#quality1',
        'hd': '#quality2',
      };
      let $qualElem = qualities[state.quality_of_image];
      if($qualElem) {
        $($qualElem).prop('checked', true);
      }

      const styles = {
        'vivid': '#style1',
        'natural': '#style2',
      };
      let $styleElem = styles[state.style_of_image];
      if($styleElem) {
        $($styleElem).prop('checked', true);
      }

      $('#numberRange').val(state.number_of_images);
      $('#dalleSize').val(state.size_of_image);
      $('#dalleBtn').click();
    });

    document.getElementById('paletteBtn').addEventListener('click', () => {
      $('#designBtn').click();
    });

    document.getElementById('article').addEventListener('click', async function(e) {
      if (!e.target.classList.contains('delete_message')) return; 

      const $delete_message = e.target.previousElementSibling;
      if (!$delete_message) {
        console.log('.delete_message ë²„íŠ¼ì˜ ì´ì „ ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
      e.target.setAttribute('disabled', 'true');
      
      const first_id = $delete_message.getAttribute('data-id');
      let second_id = null;
      const targetSection = $delete_message.closest('.row');

      if (!targetSection) {
        console.error('targetSectionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (targetSection.classList.contains('justify-content-end')) {
        second_id = targetSection.nextElementSibling.querySelector('.markDown')?.getAttribute('data-id');
        targetSection.nextElementSibling.remove();
      } else if (targetSection.classList.contains('justify-content-start')) {
        second_id = targetSection.previousElementSibling.querySelector('.markDown')?.getAttribute('data-id');
        targetSection.previousElementSibling.remove();
      }
      targetSection.remove();
      
      // console.log(first_id, second_id);

      try {
        const id_list = {
          'first_id': first_id,
          'second_id': second_id,
        };
        const options = {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(id_list),
        };
        const response = await fetch(_URL + '/textgpt/delete/message/', options);
        if(!response.ok){
          throw new Error(response.status);
        }
        const answer = await response.json();
        console.log('ì‚­ì œ ì„±ê³µ: ', answer);
        store.dispatch({ type:'UPDATE', content:'delete_messages', targetIds:[parseInt(first_id), parseInt(second_id)] });
      } catch(error) {
        console.error('Error: ', error);
      }
    });

    document.getElementById('img').addEventListener('change', function(e) {
      const currentModel = document.getElementById('currentModel').textContent;
      const state = store.getState();
      const maxFiles = currentModel.startsWith('GPT') ? 3 : 2;
      const files = this.files;
      const $imgContainers = document.getElementsByClassName('.imgContainer');
      const imgUrlArray = [];

      if (files.length > maxFiles || $imgContainers.length > maxFiles) {
        alert(`ìµœëŒ€ ${maxFiles}ê°œì˜ íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        this.value = "";
      } else {
        const $imgSpinner = document.getElementById('imgSpinner');
        $imgSpinner.style.display = 'inline-block';
        const formData = new FormData();
        // console.log(this, files);

        for (const file of this.files) {
          formData.append('images[]', file);
        }
        formData.append('resolution', state.resolution);
        formData.append('currentModel', currentModel);

        fetch(_URL + '/textgpt/upload_image/', {
          method: 'POST',
          body: formData,
        })
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        })
        .then(data => {
          // console.log('Success: ', data);
          Promise.all(data.msgIds.map(msgId => {
            return fetch(_URL + `/textgpt/get_thumbnail/${msgId}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                imgUrlArray.push(_URL + `/textgpt/get_image/${msgId}`);
                return response.blob();
              })
              .then(blob => {
                const imgUrl = URL.createObjectURL(blob);

                // Create container div with relative positioning
                const $container = document.createElement('div');
                $container.style.position = 'relative';
                $container.style.display = 'inline-block';
                $container.className = 'imgCard';
                $container.setAttribute('data-id', msgId);

                // Create img element
                const $imgElement = document.createElement('img');
                $imgElement.src = imgUrl;
                $imgElement.style.width = '100%'; // Adjust based on container
                $imgElement.style.paddingBottom = '0.8rem';

                // Create delete button
                const $deleteButton = document.createElement('button');
                $deleteButton.type = 'button';
                $deleteButton.className = 'btn-close delete_message';
                $deleteButton.setAttribute('aria-label', 'Close')
                $deleteButton.setAttribute('data-id', msgId);

                // Append img and button to the container
                $container.appendChild($imgElement);
                $container.appendChild($deleteButton);

                // Add event listner to open original image in a new window
                $container.addEventListener('click', async function() {
                  const originalImageUrl = await fetchOriginalImageUrl(msgId);

                  const img = new Image();
                  img.onload = function() {
                    const width = this.naturalWidth;
                    const height = this.naturalHeight;

                    // Open a new window with the size of the original image
                    const newWindow = window.open('', '_blank', `width=${width}, height=${height}`);
                    newWindow.document.write(`<title>Original Image</title><img src="${originalImageUrl}" style="width:100%;height:100%;object-fit:contain;">`);
                    newWindow.document.close();
                  };
                  img.src = originalImageUrl;
                })

                async function fetchOriginalImageUrl(msgId) {
                  const response = await fetch(_URL + `/textgpt/get_image/${msgId}`);
                  const blob = await response.blob();
                  return URL.createObjectURL(blob);
                }

                // Add event Listener to the delete button
                $deleteButton.addEventListener('click', (event) => {
                  event.stopPropagation();
                  // console.log(`Delete item with ID: ${msgId}`);
                  fetch(_URL + `/textgpt/deleteImage/${msgId}`, { method: 'DELETE' })
                    .then(res => {
                      if (!res.ok) {
                        throw Error(`HTTP error! status: ${res.status}`);
                      }
                      return res.json()
                    })
                    .then(msg => {
                      // í™”ë©´ìƒì—ì„œ í•´ë‹¹ ì´ë¯¸ì§€ê°€ ë‹´ê¸´ íƒœê·¸ë¥¼ ì‚­ì œí•˜ëŠ” ì²˜ë¦¬ë¥¼ ìˆ˜í–‰
                      // Find the div with the matching data-id attribute and remove it
                      const $target = document.querySelector(`div.imgContainer[data-id="${msgId}"]`);
                      if ($target) {
                        $target.remove();
                        e.target.value = '';
                        // console.log(`Item with ID: ${msgId} removed from the DOM`);
                        store.dispatch({ type:'UPDATE', content:'delete_image', imageStr: _URL + `/textgpt/get_image/${msgId}` });
                      } else {
                        console.error("Element not found in the DOM");
                      }
                    });
                });

                // Append container to the thumbnails div
                const $thumbnails = document.getElementById('thumbnails');
                // $thumbnails.appendChild($container);
                $thumbnails.insertBefore($container, $imgSpinner);
              });
          })).then(() => {
            // console.log(imgUrlArray);
            store.dispatch({ type:'UPDATE', content:'add_images', images: imgUrlArray });
          });
        })
        .then(() => {
          $imgSpinner.style.display = 'none';  
        })
        .catch(error => {
          console.error('Error: ', error);
          $imgSpinner.style.display = 'none';
        });
      }
    });

    const toggleButton = document.getElementById("toggleButton");
    const sidebar = document.getElementById("sidebar");
    const chatWindow = document.getElementById("chatWindow");
    const $chatBtn = document.getElementById("chatBtn");
    const $searchInput = document.getElementById("searchInput");
    const $searchBtn = document.getElementById("searchBtn");
    
    toggleButton.addEventListener("click", function () {
      sidebar.classList.toggle("sidebar-hidden");
      chatWindow.classList.toggle("chat-expanded");
      toggleButton.classList.toggle("btn-margin");

      setTimeout(() => {
        $chatBtn.classList.toggle("invisible");
        $searchInput.classList.toggle("invisible");
        $searchBtn.classList.toggle("invisible");
      }, 100);

      const icon = toggleButton.querySelector("i");
      icon.classList.toggle("fa-square-caret-left");
      icon.classList.toggle("fa-square-caret-right");
    });

    const fontIncrease = document.getElementById("fontIncrease");
    const fontDecrease = document.getElementById("fontDecrease");

    // ì´ˆê¸° í°íŠ¸ í¬ê¸° ì„¤ì •
    const articles = document.getElementById("article");

    const updateFontSize = () => {
      const textElements = articles.querySelectorAll("*");
      textElements.forEach(el => {
        el.style.fontSize = fontSize + "px";
      });
    };

    fontIncrease.addEventListener("click", function () {
      if (fontSize < 50) {
        fontSize += 2;
        updateFontSize();
      }
    });

    fontDecrease.addEventListener("click", function () {
      if (fontSize > 10) {
        fontSize -= 2;
        updateFontSize();
      }
    });

    const $currentModel = document.getElementById('currentModel');
    const $settingBtn = document.getElementById('settingBtn');
    const $dalleSettingBtn = document.getElementById('dalleSettingBtn');
    $currentModel.addEventListener('mouseenter', () => {
      $currentModel.classList.add('cursor-pointer');
    });

    $currentModel.addEventListener('mouseleave', () => {
      $currentModel.classList.remove('cursor-pointer');
    });

    $currentModel.addEventListener('click', () => {
      const state = store.getState();
      $settingBtn.classList.toggle('modeChange');
      $dalleSettingBtn.classList.toggle('modeChange');
      if ($dalleSettingBtn.classList.contains('modeChange')) {
        const model_name = state.model.replace('gpt', 'GPT');
        $currentModel.textContent = model_name;
      } else {
        $currentModel.textContent = state.dalle_model.toUpperCase();
      }
    });

    // MutationObserverì— ì‚¬ìš©í•  ì½œë°± í•¨ìˆ˜ ì •ì˜
    const observerCallback = function(mutationsList) {
      const textarea = document.getElementById('myInput');
      const imgLabel = document.getElementById('img-label');
      for (let mutation of mutationsList) {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            if ($currentModel.textContent.startsWith('GPT')) {
              // console.log('GPT');
              textarea.setAttribute('maxlength', 15000);
              textarea.setAttribute('minlength', 2);
              if (!textarea.hasAttribute('required')) {
                textarea.setAttribute('required', '');
              }
              textarea.setAttribute('placeholder', 'í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”');
              imgLabel.style.display = 'block';
            } else if ($currentModel.textContent === 'DALL-E-2') {
              // console.log('DALL-E-2');
              textarea.setAttribute('maxlength', 1000);
              textarea.removeAttribute('minlength');
              if (textarea.hasAttribute('required')) {
                textarea.removeAttribute('required');
              } 
              textarea.setAttribute('placeholder', 'ì´ë¯¸ì§€ ìƒì„± ë° í¸ì§‘, ë³€í™˜ ë“±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì˜ì–´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”');
              imgLabel.style.display = 'block';
            } else if ($currentModel.textContent === 'DALL-E-3') {
              // console.log('DALL-E-3');
              textarea.setAttribute('maxlength', 4000);
              textarea.setAttribute('minlength', 2);
              if (!textarea.hasAttribute('required')) {
                textarea.setAttribute('required', '');
              }
              textarea.setAttribute('placeholder', 'ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”');
              imgLabel.style.display = 'none';
              const $thumbnails = document.getElementById('thumbnails');
              const children = $thumbnails.children;
              while (children.length > 1) {
                $thumbnails.removeChild(children[0]);
              }
              const $imgInput = document.getElementById('img');
              $imgInput.value = '';
            }
          }
      }
    };

    // MutationObserver ìƒì„±
    const observer = new MutationObserver(observerCallback);

    // ëŒ€ìƒ ë…¸ë“œì™€ ì˜µì…˜ ì„¤ì •
    observer.observe(currentModel, {
      childList: true,   // ìì‹ ìš”ì†Œì˜ ì¶”ê°€ ë˜ëŠ” ì‚­ì œ ê°ì§€
      characterData: true // í…ìŠ¤íŠ¸ ë‚´ìš©ì˜ ë³€í™” ê°ì§€
    });
  }
</script>
{% endblock %}